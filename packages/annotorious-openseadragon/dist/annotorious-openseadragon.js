(function(Te,Fe){typeof exports=="object"&&typeof module<"u"?Fe(exports,require("openseadragon")):typeof define=="function"&&define.amd?define(["exports","openseadragon"],Fe):(Te=typeof globalThis<"u"?globalThis:Te||self,Fe(Te.AnnotoriousOSD={},Te.OpenSeadragon))})(this,function(Te,Fe){"use strict";var a1=Object.defineProperty;var l1=(Te,Fe,Ht)=>Fe in Te?a1(Te,Fe,{enumerable:!0,configurable:!0,writable:!0,value:Ht}):Te[Fe]=Ht;var Yo=(Te,Fe,Ht)=>(l1(Te,typeof Fe!="symbol"?Fe+"":Fe,Ht),Ht);var Ht=Object.prototype.hasOwnProperty;function Zt(r,e){var t,n;if(r===e)return!0;if(r&&e&&(t=r.constructor)===e.constructor){if(t===Date)return r.getTime()===e.getTime();if(t===RegExp)return r.toString()===e.toString();if(t===Array){if((n=r.length)===e.length)for(;n--&&Zt(r[n],e[n]););return n===-1}if(!t||typeof r=="object"){n=0;for(t in r)if(Ht.call(r,t)&&++n&&!Ht.call(e,t)||!(t in e)||!Zt(r[t],e[t]))return!1;return Object.keys(e).length===n}}return r!==r&&e!==e}var Ps=(r=>(r.EDIT="EDIT",r.SELECT="SELECT",r.NONE="NONE",r))(Ps||{});let An;const Qd=new Uint8Array(16);function Jd(){if(!An&&(An=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!An))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return An(Qd)}const Be=[];for(let r=0;r<256;++r)Be.push((r+256).toString(16).slice(1));function ef(r,e=0){return Be[r[e+0]]+Be[r[e+1]]+Be[r[e+2]]+Be[r[e+3]]+"-"+Be[r[e+4]]+Be[r[e+5]]+"-"+Be[r[e+6]]+Be[r[e+7]]+"-"+Be[r[e+8]]+Be[r[e+9]]+"-"+Be[r[e+10]]+Be[r[e+11]]+Be[r[e+12]]+Be[r[e+13]]+Be[r[e+14]]+Be[r[e+15]]}const tf=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),ea={randomUUID:tf};function rf(r,e,t){if(ea.randomUUID&&!e&&!r)return ea.randomUUID();r=r||{};const n=r.random||(r.rng||Jd)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,ef(n)}const nf=(r,e,t,n)=>({id:rf(),annotation:r.id,created:t||new Date,creator:n,...e}),sf=(r,e)=>{const t=new Set(r.bodies.map(n=>n.id));return e.bodies.filter(n=>!t.has(n.id))},of=(r,e)=>{const t=new Set(e.bodies.map(n=>n.id));return r.bodies.filter(n=>!t.has(n.id))},af=(r,e)=>e.bodies.map(t=>{const n=r.bodies.find(s=>s.id===t.id);return{newBody:t,oldBody:n&&!Zt(n,t)?n:void 0}}).filter(({oldBody:t})=>t).map(({oldBody:t,newBody:n})=>({oldBody:t,newBody:n})),lf=(r,e)=>!Zt(r.target,e.target),cf=(r,e)=>{const t=sf(r,e),n=of(r,e),s=af(r,e);return{oldValue:r,newValue:e,bodiesCreated:t.length>0?t:void 0,bodiesDeleted:n.length>0?n:void 0,bodiesUpdated:s.length>0?s:void 0,targetUpdated:lf(r,e)?{oldTarget:r.target,newTarget:e.target}:void 0}};var zt=(r=>(r.LOCAL="LOCAL",r.REMOTE="REMOTE",r))(zt||{});const hf=(r,e)=>{const t=new Set((r.created||[]).map(u=>u.id)),n=new Set((r.updated||[]).map(({newValue:u})=>u.id)),s=new Set((e.created||[]).map(u=>u.id)),i=new Set((e.deleted||[]).map(u=>u.id)),o=new Set((e.updated||[]).map(({oldValue:u})=>u.id)),a=new Set((e.updated||[]).filter(({oldValue:u})=>t.has(u.id)||n.has(u.id)).map(({oldValue:u})=>u.id)),l=[...(r.created||[]).filter(u=>!i.has(u.id)).map(u=>o.has(u.id)?e.updated.find(({oldValue:d})=>d.id===u.id).newValue:u),...e.created||[]],c=[...(r.deleted||[]).filter(u=>!s.has(u.id)),...(e.deleted||[]).filter(u=>!t.has(u.id))],h=[...(r.updated||[]).filter(({newValue:u})=>!i.has(u.id)).map(u=>{const{oldValue:d,newValue:f}=u;if(o.has(f.id)){const p=e.updated.find(g=>g.oldValue.id===f.id).newValue;return cf(d,p)}else return u}),...(e.updated||[]).filter(({oldValue:u})=>!a.has(u.id))];return{created:l,deleted:c,updated:h}};let uf=()=>({emit(r,...e){for(let t=0,n=this.events[r]||[],s=n.length;t<s;t++)n[t](...e)},events:{},on(r,e){var t;return((t=this.events)[r]||(t[r]=[])).push(e),()=>{var n;this.events[r]=(n=this.events[r])==null?void 0:n.filter(s=>e!==s)}}});const df=250,ff=r=>{const e=uf(),t=[];let n=-1,s=!1,i=0;const o=f=>{if(!s){const{changes:p}=f,g=performance.now();if(g-i>df)t.splice(n+1),t.push(p),n=t.length-1;else{const m=t.length-1;t[m]=hf(t[m],p)}i=g}s=!1};r.observe(o,{origin:zt.LOCAL});const a=f=>f&&f.length>0&&r.bulkDeleteAnnotation(f),l=f=>f&&f.length>0&&r.bulkAddAnnotation(f,!1),c=f=>f&&f.length>0&&r.bulkUpdateAnnotation(f.map(({oldValue:p})=>p)),h=f=>f&&f.length>0&&r.bulkUpdateAnnotation(f.map(({newValue:p})=>p)),u=f=>f&&f.length>0&&r.bulkAddAnnotation(f,!1),d=f=>f&&f.length>0&&r.bulkDeleteAnnotation(f);return{canRedo:()=>t.length-1>n,canUndo:()=>n>-1,destroy:()=>r.unobserve(o),on:(f,p)=>e.on(f,p),redo:()=>{if(t.length-1>n){s=!0;const{created:f,updated:p,deleted:g}=t[n+1];l(f),h(p),d(g),e.emit("redo",t[n+1]),n+=1}},undo:()=>{if(n>-1){s=!0;const{created:f,updated:p,deleted:g}=t[n];a(f),c(p),u(g),e.emit("undo",t[n]),n-=1}}}},pf=(r,e,t,n)=>{const{store:s,selection:i,hover:o,viewport:a}=r,l=new Map;let c=[],h,u;const d=(_,b)=>{l.has(_)?l.get(_).push(b):l.set(_,[b])},f=(_,b)=>{const y=l.get(_);y&&y.indexOf(b)>0&&y.splice(y.indexOf(b),1)},p=(_,b,y)=>{l.has(_)&&setTimeout(()=>{l.get(_).forEach(x=>{if(t){const S=Array.isArray(b)?b.map(P=>t.serialize(P)):t.serialize(b),k=y?y instanceof PointerEvent?y:t.serialize(y):void 0;x(S,k)}else x(b,y)})},1)},g=()=>{const{selected:_}=i,b=(_||[]).map(({id:y})=>s.getAnnotation(y));b.forEach(y=>{const x=c.find(S=>S.id===y.id);(!x||!Zt(x,y))&&p("updateAnnotation",y,x)}),c=c.map(y=>b.find(({id:S})=>S===y.id)||y)};i.subscribe(({selected:_})=>{if(!(c.length===0&&_.length===0)){if(c.length===0&&_.length>0)c=_.map(({id:b})=>s.getAnnotation(b));else if(c.length>0&&_.length===0)c.forEach(b=>{const y=s.getAnnotation(b.id);y&&!Zt(y,b)&&p("updateAnnotation",y,b)}),c=[];else{const b=new Set(c.map(x=>x.id)),y=new Set(_.map(({id:x})=>x));c.filter(x=>!y.has(x.id)).forEach(x=>{const S=s.getAnnotation(x.id);S&&!Zt(S,x)&&p("updateAnnotation",S,x)}),c=[...c.filter(x=>y.has(x.id)),..._.filter(({id:x})=>!b.has(x)).map(({id:x})=>s.getAnnotation(x))]}p("selectionChanged",c)}}),o.subscribe(_=>{!h&&_?p("mouseEnterAnnotation",s.getAnnotation(_)):h&&!_?p("mouseLeaveAnnotation",s.getAnnotation(h)):h&&_&&(p("mouseLeaveAnnotation",s.getAnnotation(h)),p("mouseEnterAnnotation",s.getAnnotation(_))),h=_}),a==null||a.subscribe(_=>p("viewportIntersect",_.map(b=>s.getAnnotation(b)))),s.observe(_=>{n&&(u&&clearTimeout(u),u=setTimeout(g,1e3));const{created:b,deleted:y}=_.changes;(b||[]).forEach(x=>p("createAnnotation",x)),(y||[]).forEach(x=>p("deleteAnnotation",x)),(_.changes.updated||[]).filter(x=>[...x.bodiesCreated||[],...x.bodiesDeleted||[],...x.bodiesUpdated||[]].length>0).forEach(({oldValue:x,newValue:S})=>{const k=c.find(P=>P.id===x.id)||x;c=c.map(P=>P.id===x.id?S:P),p("updateAnnotation",S,k)})},{origin:zt.LOCAL}),s.observe(_=>{if(c){const b=new Set(c.map(x=>x.id)),y=(_.changes.updated||[]).filter(({newValue:x})=>b.has(x.id)).map(({newValue:x})=>x);y.length>0&&(c=c.map(x=>y.find(k=>k.id===x.id)||x))}},{origin:zt.REMOTE});const m=_=>b=>{const{updated:y}=b;_?(y||[]).forEach(x=>p("updateAnnotation",x.oldValue,x.newValue)):(y||[]).forEach(x=>p("updateAnnotation",x.newValue,x.oldValue))};return e.on("undo",m(!0)),e.on("redo",m(!1)),{on:d,off:f,emit:p}},mf=r=>e=>e.reduce((t,n)=>{const{parsed:s,error:i}=r.parse(n);return i?{parsed:t.parsed,failed:[...t.failed,n]}:s?{parsed:[...t.parsed,s],failed:t.failed}:{...t}},{parsed:[],failed:[]}),gf=(r,e,t)=>{const{store:n,selection:s}=r,i=m=>{if(t){const{parsed:_,error:b}=t.parse(m);_?n.addAnnotation(_,zt.REMOTE):console.error(b)}else n.addAnnotation(m,zt.REMOTE)},o=()=>s.clear(),a=()=>n.clear(),l=m=>{const _=n.getAnnotation(m);return t&&_?t.serialize(_):_},c=()=>t?n.all().map(t.serialize):n.all(),h=()=>{var m;const _=(((m=s.selected)==null?void 0:m.map(b=>b.id))||[]).map(b=>n.getAnnotation(b)).filter(Boolean);return t?_.map(t.serialize):_},u=(m,_=!0)=>fetch(m).then(b=>b.json()).then(b=>(f(b,_),b)),d=m=>{if(typeof m=="string"){const _=n.getAnnotation(m);if(n.deleteAnnotation(m),_)return t?t.serialize(_):_}else{const _=t?t.parse(m).parsed:m;if(_)return n.deleteAnnotation(_),m}},f=(m,_=!0)=>{if(t){const{parsed:b,failed:y}=mf(t)(m);y.length>0&&console.warn(`Discarded ${y.length} invalid annotations`,y),n.bulkAddAnnotation(b,_,zt.REMOTE)}else n.bulkAddAnnotation(m,_,zt.REMOTE)},p=m=>{m?s.setSelected(m):s.clear()},g=m=>{if(t){const _=t.parse(m).parsed,b=t.serialize(n.getAnnotation(_.id));return n.updateAnnotation(_),b}else{const _=n.getAnnotation(m.id);return n.updateAnnotation(m),_}};return{addAnnotation:i,cancelSelected:o,canRedo:e.canRedo,canUndo:e.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:c,getSelected:h,loadAnnotations:u,redo:e.redo,removeAnnotation:d,setAnnotations:f,setSelected:p,undo:e.undo,updateAnnotation:g}},_f="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let yf=r=>crypto.getRandomValues(new Uint8Array(r)),bf=(r,e,t)=>{let n=(2<<Math.log(r.length-1)/Math.LN2)-1,s=-~(1.6*n*e/r.length);return(i=e)=>{let o="";for(;;){let a=t(s),l=s;for(;l--;)if(o+=r[a[l]&n]||"",o.length===i)return o}}},xf=(r,e=21)=>bf(r,e,yf),vf=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r));for(;r--;)e+=_f[t[r]&63];return e};const wf=()=>({isGuest:!0,id:xf("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),Sf=["#ff7c00","#1ac938","#e8000b","#8b2be2","#9f4800","#f14cc1","#ffc400","#00d7ff","#023eff"],Tf=()=>{const r=[...Sf];return{assignRandomColor:()=>{const e=Math.floor(Math.random()*r.length),t=r[e];return r.splice(e,1),t},releaseColor:e=>r.push(e)}};vf();var Ef=Object.defineProperty,Pf=(r,e,t)=>e in r?Ef(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ta=(r,e,t)=>(Pf(r,typeof e!="symbol"?e+"":e,t),t);function ge(){}function As(r,e){for(const t in e)r[t]=e[t];return r}function ra(r){return r()}function na(){return Object.create(null)}function yt(r){r.forEach(ra)}function Pe(r){return typeof r=="function"}function Oe(r,e){return r!=r?e==e:r!==e||r&&typeof r=="object"||typeof r=="function"}function Af(r){return Object.keys(r).length===0}function sa(r,...e){if(r==null){for(const n of e)n(void 0);return ge}const t=r.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function ia(r,e,t){r.$$.on_destroy.push(sa(e,t))}function Mf(r,e,t,n){if(r){const s=oa(r,e,t,n);return r[0](s)}}function oa(r,e,t,n){return r[1]&&n?As(t.ctx.slice(),r[1](n(e))):t.ctx}function Cf(r,e,t,n){if(r[2]&&n){const s=r[2](n(t));if(e.dirty===void 0)return s;if(typeof s=="object"){const i=[],o=Math.max(e.dirty.length,s.length);for(let a=0;a<o;a+=1)i[a]=e.dirty[a]|s[a];return i}return e.dirty|s}return e.dirty}function Bf(r,e,t,n,s,i){if(s){const o=oa(e,t,n,i);r.p(o,s)}}function Rf(r){if(r.ctx.length>32){const e=[],t=r.ctx.length/32;for(let n=0;n<t;n++)e[n]=-1;return e}return-1}function aa(r){const e={};for(const t in r)t[0]!=="$"&&(e[t]=r[t]);return e}function Mn(r){return r??""}const kf=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function bt(r,e){r.appendChild(e)}function Y(r,e,t){r.insertBefore(e,t||null)}function X(r){r.parentNode&&r.parentNode.removeChild(r)}function Ms(r,e){for(let t=0;t<r.length;t+=1)r[t]&&r[t].d(e)}function te(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function la(r){return document.createTextNode(r)}function ut(){return la(" ")}function xt(){return la("")}function Ee(r,e,t,n){return r.addEventListener(e,t,n),()=>r.removeEventListener(e,t,n)}function w(r,e,t){t==null?r.removeAttribute(e):r.getAttribute(e)!==t&&r.setAttribute(e,t)}function If(r){return Array.from(r.childNodes)}function pr(r,e,t){r.classList.toggle(e,!!t)}function Gf(r,e,{bubbles:t=!1,cancelable:n=!1}={}){return new CustomEvent(r,{detail:e,bubbles:t,cancelable:n})}let Wr;function Vr(r){Wr=r}function ca(){if(!Wr)throw new Error("Function called outside component initialization");return Wr}function Xr(r){ca().$$.on_mount.push(r)}function mr(){const r=ca();return(e,t,{cancelable:n=!1}={})=>{const s=r.$$.callbacks[e];if(s){const i=Gf(e,t,{cancelable:n});return s.slice().forEach(o=>{o.call(r,i)}),!i.defaultPrevented}return!0}}function At(r,e){const t=r.$$.callbacks[e.type];t&&t.slice().forEach(n=>n.call(this,e))}const gr=[],Cn=[];let _r=[];const ha=[],Uf=Promise.resolve();let Cs=!1;function Ff(){Cs||(Cs=!0,Uf.then(ua))}function Bs(r){_r.push(r)}const Rs=new Set;let yr=0;function ua(){if(yr!==0)return;const r=Wr;do{try{for(;yr<gr.length;){const e=gr[yr];yr++,Vr(e),Of(e.$$)}}catch(e){throw gr.length=0,yr=0,e}for(Vr(null),gr.length=0,yr=0;Cn.length;)Cn.pop()();for(let e=0;e<_r.length;e+=1){const t=_r[e];Rs.has(t)||(Rs.add(t),t())}_r.length=0}while(gr.length);for(;ha.length;)ha.pop()();Cs=!1,Rs.clear(),Vr(r)}function Of(r){if(r.fragment!==null){r.update(),yt(r.before_update);const e=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,e),r.after_update.forEach(Bs)}}function Df(r){const e=[],t=[];_r.forEach(n=>r.indexOf(n)===-1?e.push(n):t.push(n)),t.forEach(n=>n()),_r=e}const Bn=new Set;let Qt;function vt(){Qt={r:0,c:[],p:Qt}}function wt(){Qt.r||yt(Qt.c),Qt=Qt.p}function q(r,e){r&&r.i&&(Bn.delete(r),r.i(e))}function ee(r,e,t,n){if(r&&r.o){if(Bn.has(r))return;Bn.add(r),Qt.c.push(()=>{Bn.delete(r),n&&(t&&r.d(1),n())}),r.o(e)}else n&&n()}function br(r){return(r==null?void 0:r.length)!==void 0?r:Array.from(r)}function rt(r){r&&r.c()}function Ve(r,e,t){const{fragment:n,after_update:s}=r.$$;n&&n.m(e,t),Bs(()=>{const i=r.$$.on_mount.map(ra).filter(Pe);r.$$.on_destroy?r.$$.on_destroy.push(...i):yt(i),r.$$.on_mount=[]}),s.forEach(Bs)}function Xe(r,e){const t=r.$$;t.fragment!==null&&(Df(t.after_update),yt(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function Lf(r,e){r.$$.dirty[0]===-1&&(gr.push(r),Ff(),r.$$.dirty.fill(0)),r.$$.dirty[e/31|0]|=1<<e%31}function nt(r,e,t,n,s,i,o=null,a=[-1]){const l=Wr;Vr(r);const c=r.$$={fragment:null,ctx:[],props:i,update:ge,not_equal:s,bound:na(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:na(),dirty:a,skip_bound:!1,root:e.target||l.$$.root};o&&o(c.root);let h=!1;if(c.ctx=t?t(r,e.props||{},(u,d,...f)=>{const p=f.length?f[0]:d;return c.ctx&&s(c.ctx[u],c.ctx[u]=p)&&(!c.skip_bound&&c.bound[u]&&c.bound[u](p),h&&Lf(r,u)),d}):[],c.update(),h=!0,yt(c.before_update),c.fragment=n?n(c.ctx):!1,e.target){if(e.hydrate){const u=If(e.target);c.fragment&&c.fragment.l(u),u.forEach(X)}else c.fragment&&c.fragment.c();e.intro&&q(r.$$.fragment),Ve(r,e.target,e.anchor),ua()}Vr(l)}class st{constructor(){ta(this,"$$"),ta(this,"$$set")}$destroy(){Xe(this,1),this.$destroy=ge}$on(e,t){if(!Pe(t))return ge;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const s=n.indexOf(t);s!==-1&&n.splice(s,1)}}$set(e){this.$$set&&!Af(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const Nf="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Nf);var fe=(r=>(r.ELLIPSE="ELLIPSE",r.POLYGON="POLYGON",r.RECTANGLE="RECTANGLE",r))(fe||{});const ks={},Is=(r,e)=>ks[r]=e,Gs=r=>ks[r.type].area(r),Hf=(r,e,t)=>ks[r.type].intersects(r,e,t),Rn=r=>{let e=1/0,t=1/0,n=-1/0,s=-1/0;return r.forEach(([i,o])=>{e=Math.min(e,i),t=Math.min(t,o),n=Math.max(n,i),s=Math.max(s,o)}),{minX:e,minY:t,maxX:n,maxY:s}},zf={area:r=>Math.PI*r.geometry.rx*r.geometry.ry,intersects:(r,e,t)=>{const{cx:n,cy:s,rx:i,ry:o}=r.geometry,a=0,l=Math.cos(a),c=Math.sin(a),h=e-n,u=t-s,d=l*h+c*u,f=c*h-l*u;return d*d/(i*i)+f*f/(o*o)<=1}};Is(fe.ELLIPSE,zf);const $f={area:r=>{const{points:e}=r.geometry;let t=0,n=e.length-1;for(let s=0;s<e.length;s++)t+=(e[n][0]+e[s][0])*(e[n][1]-e[s][1]),n=s;return Math.abs(.5*t)},intersects:(r,e,t)=>{const{points:n}=r.geometry;let s=!1;for(let i=0,o=n.length-1;i<n.length;o=i++){const a=n[i][0],l=n[i][1],c=n[o][0],h=n[o][1];l>t!=h>t&&e<(c-a)*(t-l)/(h-l)+a&&(s=!s)}return s}};Is(fe.POLYGON,$f);const Wf={area:r=>r.geometry.w*r.geometry.h,intersects:(r,e,t)=>e>=r.geometry.x&&e<=r.geometry.x+r.geometry.w&&t>=r.geometry.y&&t<=r.geometry.y+r.geometry.h};Is(fe.RECTANGLE,Wf);const Vf=(r,e=!1)=>{const t=typeof r=="string"?r:r.value,n=/^(xywh)=(pixel|percent)?:?(.+?),(.+?),(.+?),(.+)*/g,s=[...t.matchAll(n)][0],[i,o,a,l,c,h,u]=s;if(o!=="xywh")throw new Error("Unsupported MediaFragment: "+t);if(a&&a!=="pixel")throw new Error(`Unsupported MediaFragment unit: ${a}`);const[d,f,p,g]=[l,c,h,u].map(parseFloat);return{type:fe.RECTANGLE,geometry:{x:d,y:f,w:p,h:g,bounds:{minX:d,minY:e?f-g:f,maxX:d+p,maxY:e?f:f+g}}}},Xf=r=>{const{x:e,y:t,w:n,h:s}=r;return{type:"FragmentSelector",conformsTo:"http://www.w3.org/TR/media-frags/",value:`xywh=pixel:${e},${t},${n},${s}`}},da="http://www.w3.org/2000/svg",fa=r=>{const e=n=>{Array.from(n.attributes).forEach(s=>{s.name.startsWith("on")&&n.removeAttribute(s.name)})},t=r.getElementsByTagName("script");return Array.from(t).reverse().forEach(n=>n.parentNode.removeChild(n)),Array.from(r.querySelectorAll("*")).forEach(e),r},Yf=r=>{const e=new XMLSerializer().serializeToString(r.documentElement).replace("<svg>",`<svg xmlns="${da}">`);return new DOMParser().parseFromString(e,"image/svg+xml").documentElement},jf=r=>{const e=new DOMParser().parseFromString(r,"image/svg+xml"),t=e.lookupPrefix(da),n=e.lookupNamespaceURI(null);return t||n?fa(e).firstChild:fa(Yf(e)).firstChild},qf=r=>{const[e,t,n]=r.match(/(<polygon points=["|'])([^("|')]*)/)||[],s=n.split(" ").map(i=>i.split(",").map(parseFloat));return{type:fe.POLYGON,geometry:{points:s,bounds:Rn(s)}}},Kf=r=>{const e=jf(r),t=parseFloat(e.getAttribute("cx")),n=parseFloat(e.getAttribute("cy")),s=parseFloat(e.getAttribute("rx")),i=parseFloat(e.getAttribute("ry")),o={minX:t-s,minY:n-i,maxX:t+s,maxY:n+i};return{type:fe.ELLIPSE,geometry:{cx:t,cy:n,rx:s,ry:i,bounds:o}}},Zf=r=>{const e=typeof r=="string"?r:r.value;if(e.includes("<polygon points="))return qf(e);if(e.includes("<ellipse "))return Kf(e);throw"Unsupported SVG shape: "+e},Qf=r=>{let e;if(r.type===fe.POLYGON){const t=r.geometry,{points:n}=t;e=`<svg><polygon points="${n.map(s=>s.join(",")).join(" ")}" /></svg>`}else if(r.type===fe.ELLIPSE){const t=r.geometry;e=`<svg><ellipse cx="${t.cx}" cy="${t.cy}" rx="${t.rx}" ry="${t.ry}" /></svg>`}if(e)return{type:"SvgSelector",value:e};throw`Unsupported shape type: ${r.type}`};let kn;const Jf=new Uint8Array(16);function ep(){if(!kn&&(kn=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!kn))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return kn(Jf)}const Re=[];for(let r=0;r<256;++r)Re.push((r+256).toString(16).slice(1));function tp(r,e=0){return Re[r[e+0]]+Re[r[e+1]]+Re[r[e+2]]+Re[r[e+3]]+"-"+Re[r[e+4]]+Re[r[e+5]]+"-"+Re[r[e+6]]+Re[r[e+7]]+"-"+Re[r[e+8]]+Re[r[e+9]]+"-"+Re[r[e+10]]+Re[r[e+11]]+Re[r[e+12]]+Re[r[e+13]]+Re[r[e+14]]+Re[r[e+15]]}const rp=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),pa={randomUUID:rp};function ma(r,e,t){if(pa.randomUUID&&!e&&!r)return pa.randomUUID();r=r||{};const n=r.random||(r.rng||ep)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,tp(n)}var ga=Object.prototype.hasOwnProperty;function Jt(r,e){var t,n;if(r===e)return!0;if(r&&e&&(t=r.constructor)===e.constructor){if(t===Date)return r.getTime()===e.getTime();if(t===RegExp)return r.toString()===e.toString();if(t===Array){if((n=r.length)===e.length)for(;n--&&Jt(r[n],e[n]););return n===-1}if(!t||typeof r=="object"){n=0;for(t in r)if(ga.call(r,t)&&++n&&!ga.call(e,t)||!(t in e)||!Jt(r[t],e[t]))return!1;return Object.keys(e).length===n}}return r!==r&&e!==e}function Us(){}function np(r,e){return r!=r?e==e:r!==e||r&&typeof r=="object"||typeof r=="function"}const xr=[];function Fs(r,e=Us){let t;const n=new Set;function s(a){if(np(r,a)&&(r=a,t)){const l=!xr.length;for(const c of n)c[1](),xr.push(c,r);if(l){for(let c=0;c<xr.length;c+=2)xr[c][0](xr[c+1]);xr.length=0}}}function i(a){s(a(r))}function o(a,l=Us){const c=[a,l];return n.add(c),n.size===1&&(t=e(s,i)||Us),a(r),()=>{n.delete(c),n.size===0&&t&&(t(),t=null)}}return{set:s,update:i,subscribe:o}}const sp=r=>{const{subscribe:e,set:t}=Fs();let n;return e(s=>n=s),r.observe(({changes:s})=>{if(n){(s.deleted||[]).some(o=>o.id===n)&&t(void 0);const i=(s.updated||[]).find(({oldValue:o})=>o.id===n);i&&t(i.newValue.id)}}),{get current(){return n},subscribe:e,set:t}};var _a=(r=>(r.EDIT="EDIT",r.SELECT="SELECT",r.NONE="NONE",r))(_a||{});const Os={selected:[]},ip=(r,e="EDIT")=>{const{subscribe:t,set:n}=Fs(Os);let s=Os;t(u=>s=u);const i=()=>n(Os),o=()=>{var u;return((u=s.selected)==null?void 0:u.length)===0},a=u=>{if(s.selected.length===0)return!1;const d=typeof u=="string"?u:u.id;return s.selected.some(f=>f.id===d)},l=(u,d)=>{const f=r.getAnnotation(u);if(f){const p=op(f,e);n(p==="EDIT"?{selected:[{id:u,editable:!0}],pointerEvent:d}:p==="SELECT"?{selected:[{id:u}],pointerEvent:d}:{selected:[],pointerEvent:d})}else console.warn("Invalid selection: "+u)},c=(u,d=!0)=>{const f=Array.isArray(u)?u:[u],p=f.map(g=>r.getAnnotation(g)).filter(Boolean);n({selected:p.map(({id:g})=>({id:g,editable:d}))}),p.length!==f.length&&console.warn("Invalid selection",u)},h=u=>{if(s.selected.length===0)return!1;const{selected:d}=s;d.filter(({id:f})=>u.includes(f)).length>0&&n({selected:d.filter(({id:f})=>!u.includes(f))})};return r.observe(({changes:u})=>h((u.deleted||[]).map(d=>d.id))),{clear:i,clickSelect:l,get selected(){return s?[...s.selected]:null},get pointerEvent(){return s?s.pointerEvent:null},isEmpty:o,isSelected:a,setSelected:c,subscribe:t}},op=(r,e)=>typeof e=="function"?e(r)||"EDIT":e||"EDIT",ap=[];for(let r=0;r<256;++r)ap.push((r+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const lp=(r,e)=>{const t=new Set(r.bodies.map(n=>n.id));return e.bodies.filter(n=>!t.has(n.id))},cp=(r,e)=>{const t=new Set(e.bodies.map(n=>n.id));return r.bodies.filter(n=>!t.has(n.id))},hp=(r,e)=>e.bodies.map(t=>{const n=r.bodies.find(s=>s.id===t.id);return{newBody:t,oldBody:n&&!Jt(n,t)?n:void 0}}).filter(({oldBody:t})=>t).map(({oldBody:t,newBody:n})=>({oldBody:t,newBody:n})),up=(r,e)=>!Jt(r.target,e.target),ya=(r,e)=>{const t=lp(r,e),n=cp(r,e),s=hp(r,e);return{oldValue:r,newValue:e,bodiesCreated:t.length>0?t:void 0,bodiesDeleted:n.length>0?n:void 0,bodiesUpdated:s.length>0?s:void 0,targetUpdated:up(r,e)?{oldTarget:r.target,newTarget:e.target}:void 0}};var _e=(r=>(r.LOCAL="LOCAL",r.REMOTE="REMOTE",r))(_e||{});const dp=(r,e)=>{var t,n;const{changes:s,origin:i}=e;if(!(!r.options.origin||r.options.origin===i))return!1;if(r.options.ignore){const{ignore:o}=r.options,a=l=>l&&l.length>0;if(!(a(s.created)||a(s.deleted))){const l=(t=s.updated)==null?void 0:t.some(h=>a(h.bodiesCreated)||a(h.bodiesDeleted)||a(h.bodiesUpdated)),c=(n=s.updated)==null?void 0:n.some(h=>h.targetUpdated);if(o==="BODY_ONLY"&&l&&!c||o==="TARGET_ONLY"&&c&&!l)return!1}}if(r.options.annotations){const o=new Set([...(s.created||[]).map(a=>a.id),...(s.deleted||[]).map(a=>a.id),...(s.updated||[]).map(({oldValue:a})=>a.id)]);return!!(Array.isArray(r.options.annotations)?r.options.annotations:[r.options.annotations]).find(a=>o.has(a))}else return!0},fp=(r,e)=>{const t=new Set((r.created||[]).map(u=>u.id)),n=new Set((r.updated||[]).map(({newValue:u})=>u.id)),s=new Set((e.created||[]).map(u=>u.id)),i=new Set((e.deleted||[]).map(u=>u.id)),o=new Set((e.updated||[]).map(({oldValue:u})=>u.id)),a=new Set((e.updated||[]).filter(({oldValue:u})=>t.has(u.id)||n.has(u.id)).map(({oldValue:u})=>u.id)),l=[...(r.created||[]).filter(u=>!i.has(u.id)).map(u=>o.has(u.id)?e.updated.find(({oldValue:d})=>d.id===u.id).newValue:u),...e.created||[]],c=[...(r.deleted||[]).filter(u=>!s.has(u.id)),...(e.deleted||[]).filter(u=>!t.has(u.id))],h=[...(r.updated||[]).filter(({newValue:u})=>!i.has(u.id)).map(u=>{const{oldValue:d,newValue:f}=u;if(o.has(f.id)){const p=e.updated.find(g=>g.oldValue.id===f.id).newValue;return ya(d,p)}else return u}),...(e.updated||[]).filter(({oldValue:u})=>!a.has(u.id))];return{created:l,deleted:c,updated:h}},pp=r=>r.id!==void 0,mp=()=>{const r=new Map,e=new Map,t=[],n=(v,R={})=>t.push({onChange:v,options:R}),s=v=>{const R=t.findIndex(I=>I.onChange==v);R>-1&&t.splice(R,1)},i=(v,R)=>{const I={origin:v,changes:{created:R.created||[],updated:R.updated||[],deleted:R.deleted||[]},state:[...r.values()]};t.forEach(C=>{dp(C,I)&&C.onChange(I)})},o=(v,R=_e.LOCAL)=>{if(r.get(v.id))throw Error(`Cannot add annotation ${v.id} - exists already`);r.set(v.id,v),v.bodies.forEach(I=>e.set(I.id,v.id)),i(R,{created:[v]})},a=(v,R)=>{const I=typeof v=="string"?R:v,C=typeof v=="string"?v:v.id,A=r.get(C);if(A){const F=ya(A,I);return C===I.id?r.set(C,I):(r.delete(C),r.set(I.id,I)),A.bodies.forEach(D=>e.delete(D.id)),I.bodies.forEach(D=>e.set(D.id,I.id)),F}else console.warn(`Cannot update annotation ${C} - does not exist`)},l=(v,R=_e.LOCAL,I=_e.LOCAL)=>{const C=pp(R)?I:R,A=a(v,R);A&&i(C,{updated:[A]})},c=(v,R=_e.LOCAL)=>{const I=v.reduce((C,A)=>{const F=a(A);return F?[...C,F]:C},[]);I.length>0&&i(R,{updated:I})},h=(v,R=_e.LOCAL)=>{const I=r.get(v.annotation);if(I){const C={...I,bodies:[...I.bodies,v]};r.set(I.id,C),e.set(v.id,C.id),i(R,{updated:[{oldValue:I,newValue:C,bodiesCreated:[v]}]})}else console.warn(`Attempt to add body to missing annotation: ${v.annotation}`)},u=()=>[...r.values()],d=(v=_e.LOCAL)=>{const R=[...r.values()];r.clear(),e.clear(),i(v,{deleted:R})},f=(v,R=!0,I=_e.LOCAL)=>{if(R){const C=[...r.values()];r.clear(),e.clear(),v.forEach(A=>{r.set(A.id,A),A.bodies.forEach(F=>e.set(F.id,A.id))}),i(I,{created:v,deleted:C})}else{const C=v.reduce((A,F)=>{const D=r.get(F.id);return D?[...A,D]:A},[]);if(C.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${C.map(A=>A.id).join(", ")}`);v.forEach(A=>{r.set(A.id,A),A.bodies.forEach(F=>e.set(F.id,A.id))}),i(I,{created:v})}},p=v=>{const R=typeof v=="string"?v:v.id,I=r.get(R);if(I)return r.delete(R),I.bodies.forEach(C=>e.delete(C.id)),I;console.warn(`Attempt to delete missing annotation: ${R}`)},g=(v,R=_e.LOCAL)=>{const I=p(v);I&&i(R,{deleted:[I]})},m=(v,R=_e.LOCAL)=>{const I=v.reduce((C,A)=>{const F=p(A);return F?[...C,F]:C},[]);I.length>0&&i(R,{deleted:I})},_=v=>{const R=r.get(v.annotation);if(R){const I=R.bodies.find(C=>C.id===v.id);if(I){e.delete(I.id);const C={...R,bodies:R.bodies.filter(A=>A.id!==v.id)};return r.set(R.id,C),{oldValue:R,newValue:C,bodiesDeleted:[I]}}else console.warn(`Attempt to delete missing body ${v.id} from annotation ${v.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${v.annotation}`)},b=(v,R=_e.LOCAL)=>{const I=_(v);I&&i(R,{updated:[I]})},y=(v,R=_e.LOCAL)=>{const I=v.map(C=>_(C)).filter(Boolean);I.length>0&&i(R,{updated:I})},x=v=>{const R=r.get(v);return R?{...R}:void 0},S=v=>{const R=e.get(v);if(R){const I=x(R).bodies.find(C=>C.id===v);if(I)return I;console.error(`Store integrity error: body ${v} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${v}`)},k=(v,R)=>{if(v.annotation!==R.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const I=r.get(v.annotation);if(I){const C=I.bodies.find(F=>F.id===v.id),A={...I,bodies:I.bodies.map(F=>F.id===C.id?R:F)};return r.set(I.id,A),C.id!==R.id&&(e.delete(C.id),e.set(R.id,A.id)),{oldValue:I,newValue:A,bodiesUpdated:[{oldBody:C,newBody:R}]}}else console.warn(`Attempt to add body to missing annotation ${v.annotation}`)},P=(v,R,I=_e.LOCAL)=>{const C=k(v,R);C&&i(I,{updated:[C]})},T=(v,R=_e.LOCAL)=>{const I=v.map(C=>k({id:C.id,annotation:C.annotation},C)).filter(Boolean);i(R,{updated:I})},E=v=>{const R=r.get(v.annotation);if(R){const I={...R,target:{...R.target,...v}};return r.set(R.id,I),{oldValue:R,newValue:I,targetUpdated:{oldTarget:R.target,newTarget:v}}}else console.warn(`Attempt to update target on missing annotation: ${v.annotation}`)};return{addAnnotation:o,addBody:h,all:u,bulkAddAnnotation:f,bulkDeleteAnnotation:m,bulkDeleteBodies:y,bulkUpdateAnnotation:c,bulkUpdateBodies:T,bulkUpdateTargets:(v,R=_e.LOCAL)=>{const I=v.map(C=>E(C)).filter(Boolean);I.length>0&&i(R,{updated:I})},clear:d,deleteAnnotation:g,deleteBody:b,getAnnotation:x,getBody:S,observe:n,unobserve:s,updateAnnotation:l,updateBody:P,updateTarget:(v,R=_e.LOCAL)=>{const I=E(v);I&&i(R,{updated:[I]})}}},gp=r=>({...r,subscribe:e=>{const t=n=>e(n.state);return r.observe(t),e(r.all()),()=>r.unobserve(t)}});let _p=()=>({emit(r,...e){for(let t=0,n=this.events[r]||[],s=n.length;t<s;t++)n[t](...e)},events:{},on(r,e){var t;return((t=this.events)[r]||(t[r]=[])).push(e),()=>{var n;this.events[r]=(n=this.events[r])==null?void 0:n.filter(s=>e!==s)}}});const yp=250,bp=r=>{const e=_p(),t=[];let n=-1,s=!1,i=0;const o=f=>{if(!s){const{changes:p}=f,g=performance.now();if(g-i>yp)t.splice(n+1),t.push(p),n=t.length-1;else{const m=t.length-1;t[m]=fp(t[m],p)}i=g}s=!1};r.observe(o,{origin:_e.LOCAL});const a=f=>f&&f.length>0&&r.bulkDeleteAnnotation(f),l=f=>f&&f.length>0&&r.bulkAddAnnotation(f,!1),c=f=>f&&f.length>0&&r.bulkUpdateAnnotation(f.map(({oldValue:p})=>p)),h=f=>f&&f.length>0&&r.bulkUpdateAnnotation(f.map(({newValue:p})=>p)),u=f=>f&&f.length>0&&r.bulkAddAnnotation(f,!1),d=f=>f&&f.length>0&&r.bulkDeleteAnnotation(f);return{canRedo:()=>t.length-1>n,canUndo:()=>n>-1,destroy:()=>r.unobserve(o),on:(f,p)=>e.on(f,p),redo:()=>{if(t.length-1>n){s=!0;const{created:f,updated:p,deleted:g}=t[n+1];l(f),h(p),d(g),e.emit("redo",t[n+1]),n+=1}},undo:()=>{if(n>-1){s=!0;const{created:f,updated:p,deleted:g}=t[n];a(f),c(p),u(g),e.emit("undo",t[n]),n-=1}}}},xp=()=>{const{subscribe:r,set:e}=Fs([]);return{subscribe:r,set:e}},vp=(r,e,t,n)=>{const{store:s,selection:i,hover:o,viewport:a}=r,l=new Map;let c=[],h,u;const d=(_,b)=>{l.has(_)?l.get(_).push(b):l.set(_,[b])},f=(_,b)=>{const y=l.get(_);y&&y.indexOf(b)>0&&y.splice(y.indexOf(b),1)},p=(_,b,y)=>{l.has(_)&&setTimeout(()=>{l.get(_).forEach(x=>{if(t){const S=Array.isArray(b)?b.map(P=>t.serialize(P)):t.serialize(b),k=y?y instanceof PointerEvent?y:t.serialize(y):void 0;x(S,k)}else x(b,y)})},1)},g=()=>{const{selected:_}=i,b=(_||[]).map(({id:y})=>s.getAnnotation(y));b.forEach(y=>{const x=c.find(S=>S.id===y.id);(!x||!Jt(x,y))&&p("updateAnnotation",y,x)}),c=c.map(y=>b.find(({id:x})=>x===y.id)||y)};i.subscribe(({selected:_})=>{if(!(c.length===0&&_.length===0)){if(c.length===0&&_.length>0)c=_.map(({id:b})=>s.getAnnotation(b));else if(c.length>0&&_.length===0)c.forEach(b=>{const y=s.getAnnotation(b.id);y&&!Jt(y,b)&&p("updateAnnotation",y,b)}),c=[];else{const b=new Set(c.map(x=>x.id)),y=new Set(_.map(({id:x})=>x));c.filter(x=>!y.has(x.id)).forEach(x=>{const S=s.getAnnotation(x.id);S&&!Jt(S,x)&&p("updateAnnotation",S,x)}),c=[...c.filter(x=>y.has(x.id)),..._.filter(({id:x})=>!b.has(x)).map(({id:x})=>s.getAnnotation(x))]}p("selectionChanged",c)}}),o.subscribe(_=>{!h&&_?p("mouseEnterAnnotation",s.getAnnotation(_)):h&&!_?p("mouseLeaveAnnotation",s.getAnnotation(h)):h&&_&&(p("mouseLeaveAnnotation",s.getAnnotation(h)),p("mouseEnterAnnotation",s.getAnnotation(_))),h=_}),a==null||a.subscribe(_=>p("viewportIntersect",_.map(b=>s.getAnnotation(b)))),s.observe(_=>{n&&(u&&clearTimeout(u),u=setTimeout(g,1e3));const{created:b,deleted:y}=_.changes;(b||[]).forEach(x=>p("createAnnotation",x)),(y||[]).forEach(x=>p("deleteAnnotation",x)),(_.changes.updated||[]).filter(x=>[...x.bodiesCreated||[],...x.bodiesDeleted||[],...x.bodiesUpdated||[]].length>0).forEach(({oldValue:x,newValue:S})=>{const k=c.find(P=>P.id===x.id)||x;c=c.map(P=>P.id===x.id?S:P),p("updateAnnotation",S,k)})},{origin:_e.LOCAL}),s.observe(_=>{if(c){const b=new Set(c.map(x=>x.id)),y=(_.changes.updated||[]).filter(({newValue:x})=>b.has(x.id)).map(({newValue:x})=>x);y.length>0&&(c=c.map(x=>y.find(S=>S.id===x.id)||x))}},{origin:_e.REMOTE});const m=_=>b=>{const{updated:y}=b;_?(y||[]).forEach(x=>p("updateAnnotation",x.oldValue,x.newValue)):(y||[]).forEach(x=>p("updateAnnotation",x.newValue,x.oldValue))};return e.on("undo",m(!0)),e.on("redo",m(!1)),{on:d,off:f,emit:p}},wp=r=>e=>e.reduce((t,n)=>{const{parsed:s,error:i}=r.parse(n);return i?{parsed:t.parsed,failed:[...t.failed,n]}:s?{parsed:[...t.parsed,s],failed:t.failed}:{...t}},{parsed:[],failed:[]}),Sp=(r,e,t)=>{const{store:n,selection:s}=r,i=m=>{if(t){const{parsed:_,error:b}=t.parse(m);_?n.addAnnotation(_,_e.REMOTE):console.error(b)}else n.addAnnotation(m,_e.REMOTE)},o=()=>s.clear(),a=()=>n.clear(),l=m=>{const _=n.getAnnotation(m);return t&&_?t.serialize(_):_},c=()=>t?n.all().map(t.serialize):n.all(),h=()=>{var m;const _=(((m=s.selected)==null?void 0:m.map(b=>b.id))||[]).map(b=>n.getAnnotation(b)).filter(Boolean);return t?_.map(t.serialize):_},u=(m,_=!0)=>fetch(m).then(b=>b.json()).then(b=>(f(b,_),b)),d=m=>{if(typeof m=="string"){const _=n.getAnnotation(m);if(n.deleteAnnotation(m),_)return t?t.serialize(_):_}else{const _=t?t.parse(m).parsed:m;if(_)return n.deleteAnnotation(_),m}},f=(m,_=!0)=>{if(t){const{parsed:b,failed:y}=wp(t)(m);y.length>0&&console.warn(`Discarded ${y.length} invalid annotations`,y),n.bulkAddAnnotation(b,_,_e.REMOTE)}else n.bulkAddAnnotation(m,_,_e.REMOTE)},p=m=>{m?s.setSelected(m):s.clear()},g=m=>{if(t){const _=t.parse(m).parsed,b=t.serialize(n.getAnnotation(_.id));return n.updateAnnotation(_),b}else{const _=n.getAnnotation(m.id);return n.updateAnnotation(m),_}};return{addAnnotation:i,cancelSelected:o,canRedo:e.canRedo,canUndo:e.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:c,getSelected:h,loadAnnotations:u,redo:e.redo,removeAnnotation:d,setAnnotations:f,setSelected:p,undo:e.undo,updateAnnotation:g}},Tp="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let Ep=r=>crypto.getRandomValues(new Uint8Array(r)),Pp=(r,e,t)=>{let n=(2<<Math.log(r.length-1)/Math.LN2)-1,s=-~(1.6*n*e/r.length);return(i=e)=>{let o="";for(;;){let a=t(s),l=s;for(;l--;)if(o+=r[a[l]&n]||"",o.length===i)return o}}},Ap=(r,e=21)=>Pp(r,e,Ep),Mp=(r=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(r));for(;r--;)e+=Tp[t[r]&63];return e};const Cp=()=>({isGuest:!0,id:Ap("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),Bp=r=>{const e=JSON.stringify(r);let t=0;for(let n=0,s=e.length;n<s;n++){let i=e.charCodeAt(n);t=(t<<5)-t+i,t|=0}return`${t}`},ba=r=>r?typeof r=="object"?{...r}:r:void 0,Rp=(r,e)=>(Array.isArray(r)?r:[r]).map(t=>{const{id:n,type:s,purpose:i,value:o,created:a,creator:l,...c}=t;return{id:n||`temp-${Bp(t)}`,annotation:e,type:s,purpose:i,value:o,created:a?new Date(a):void 0,creator:ba(l),...c}}),kp=r=>r.map(e=>{var t,n;const s={...e};return delete s.annotation,(t=s.id)!=null&&t.startsWith("temp-")&&delete s.id,{...s,created:(n=s.created)==null?void 0:n.toISOString()}});Mp();const Ip=(r,e=!1)=>({parse:t=>Gp(t,e),serialize:t=>Up(t,r)}),Gp=(r,e=!1)=>{const t=r.id||ma(),{creator:n,created:s,modified:i,body:o,...a}=r,l=Rp(o,t),c=Array.isArray(r.target)?r.target[0]:r.target,h=Array.isArray(c.selector)?c.selector[0]:c.selector,u=(h==null?void 0:h.type)==="FragmentSelector"?Vf(h,e):(h==null?void 0:h.type)==="SvgSelector"?Zf(h):void 0;return u?{parsed:{...a,id:t,bodies:l,target:{created:s?new Date(s):void 0,creator:ba(n),updated:i?new Date(i):void 0,...Array.isArray(a.target)?a.target[0]:a.target,annotation:t,selector:u}}}:{error:Error(`Invalid selector: ${JSON.stringify(h)}`)}},Up=(r,e)=>{const{selector:t,creator:n,created:s,updated:i,updatedBy:o,...a}=r.target,l=t.type==fe.RECTANGLE?Xf(t.geometry):Qf(t),c={...r,"@context":"http://www.w3.org/ns/anno.jsonld",id:r.id,type:"Annotation",body:kp(r.bodies),created:s==null?void 0:s.toISOString(),creator:n,modified:i==null?void 0:i.toISOString(),target:{...a,source:e,selector:l}};return delete c.bodies,"annotation"in c.target&&delete c.target.annotation,c};function xa(r,e,t){const n=r.slice();return n[10]=e[t],n[12]=t,n}function va(r){let e,t;return e=new Yr({props:{x:r[10][0],y:r[10][1],scale:r[3]}}),e.$on("pointerdown",function(){Pe(r[9](`HANDLE-${r[12]}`))&&r[9](`HANDLE-${r[12]}`).apply(this,arguments)}),{c(){rt(e.$$.fragment)},m(n,s){Ve(e,n,s),t=!0},p(n,s){r=n;const i={};s&16&&(i.x=r[10][0]),s&16&&(i.y=r[10][1]),s&8&&(i.scale=r[3]),e.$set(i)},i(n){t||(q(e.$$.fragment,n),t=!0)},o(n){ee(e.$$.fragment,n),t=!1},d(n){Xe(e,n)}}}function Fp(r){let e,t,n,s,i,o,a,l,c,h,u,d=br(r[4].points),f=[];for(let g=0;g<d.length;g+=1)f[g]=va(xa(r,d,g));const p=g=>ee(f[g],1,1,()=>{f[g]=null});return{c(){e=te("polygon"),s=ut(),i=te("polygon"),a=ut();for(let g=0;g<f.length;g+=1)f[g].c();l=xt(),w(e,"class","a9s-outer"),w(e,"style",t=r[1]?"display:none;":void 0),w(e,"points",n=r[4].points.map(wa).join(" ")),w(i,"class","a9s-inner a9s-shape-handle"),w(i,"style",r[1]),w(i,"points",o=r[4].points.map(Sa).join(" "))},m(g,m){Y(g,e,m),Y(g,s,m),Y(g,i,m),Y(g,a,m);for(let _=0;_<f.length;_+=1)f[_]&&f[_].m(g,m);Y(g,l,m),c=!0,h||(u=[Ee(e,"pointerdown",function(){Pe(r[9]("SHAPE"))&&r[9]("SHAPE").apply(this,arguments)}),Ee(i,"pointerdown",function(){Pe(r[9]("SHAPE"))&&r[9]("SHAPE").apply(this,arguments)})],h=!0)},p(g,m){if(r=g,(!c||m&2&&t!==(t=r[1]?"display:none;":void 0))&&w(e,"style",t),(!c||m&16&&n!==(n=r[4].points.map(wa).join(" ")))&&w(e,"points",n),(!c||m&2)&&w(i,"style",r[1]),(!c||m&16&&o!==(o=r[4].points.map(Sa).join(" ")))&&w(i,"points",o),m&536){d=br(r[4].points);let _;for(_=0;_<d.length;_+=1){const b=xa(r,d,_);f[_]?(f[_].p(b,m),q(f[_],1)):(f[_]=va(b),f[_].c(),q(f[_],1),f[_].m(l.parentNode,l))}for(vt(),_=d.length;_<f.length;_+=1)p(_);wt()}},i(g){if(!c){for(let m=0;m<d.length;m+=1)q(f[m]);c=!0}},o(g){f=f.filter(Boolean);for(let m=0;m<f.length;m+=1)ee(f[m]);c=!1},d(g){g&&(X(e),X(s),X(i),X(a),X(l)),Ms(f,g),h=!1,yt(u)}}}function Op(r){let e,t;return e=new Ca({props:{shape:r[0],transform:r[2],editor:r[5],$$slots:{default:[Fp,({grab:n})=>({9:n}),({grab:n})=>n?512:0]},$$scope:{ctx:r}}}),e.$on("change",r[6]),e.$on("grab",r[7]),e.$on("release",r[8]),{c(){rt(e.$$.fragment)},m(n,s){Ve(e,n,s),t=!0},p(n,[s]){const i={};s&1&&(i.shape=n[0]),s&4&&(i.transform=n[2]),s&8730&&(i.$$scope={dirty:s,ctx:n}),e.$set(i)},i(n){t||(q(e.$$.fragment,n),t=!0)},o(n){ee(e.$$.fragment,n),t=!1},d(n){Xe(e,n)}}}const wa=r=>r.join(","),Sa=r=>r.join(",");function Dp(r,e,t){let n,{shape:s}=e,{computedStyle:i}=e,{transform:o}=e,{viewportScale:a=1}=e;const l=(d,f,p)=>{let g;const m=d.geometry;f==="SHAPE"?g=m.points.map(([b,y])=>[b+p[0],y+p[1]]):g=m.points.map(([b,y],x)=>f===`HANDLE-${x}`?[b+p[0],y+p[1]]:[b,y]);const _=Rn(g);return{...d,geometry:{points:g,bounds:_}}};function c(d){At.call(this,r,d)}function h(d){At.call(this,r,d)}function u(d){At.call(this,r,d)}return r.$$set=d=>{"shape"in d&&t(0,s=d.shape),"computedStyle"in d&&t(1,i=d.computedStyle),"transform"in d&&t(2,o=d.transform),"viewportScale"in d&&t(3,a=d.viewportScale)},r.$$.update=()=>{r.$$.dirty&1&&t(4,n=s.geometry)},[s,i,o,a,n,l,c,h,u]}class Lp extends st{constructor(e){super(),nt(this,e,Dp,Op,Oe,{shape:0,computedStyle:1,transform:2,viewportScale:3})}}const Ds=(r,e)=>{const t=Math.abs(e[0]-r[0]),n=Math.abs(e[1]-r[1]);return Math.sqrt(Math.pow(t,2)+Math.pow(n,2))},vr=[];function Np(r,e=ge){let t;const n=new Set;function s(a){if(Oe(r,a)&&(r=a,t)){const l=!vr.length;for(const c of n)c[1](),vr.push(c,r);if(l){for(let c=0;c<vr.length;c+=2)vr[c][0](vr[c+1]);vr.length=0}}}function i(a){s(a(r))}function o(a,l=ge){const c=[a,l];return n.add(c),n.size===1&&(t=e(s,i)||ge),a(r),()=>{n.delete(c),n.size===0&&t&&(t(),t=null)}}return{set:s,update:i,subscribe:o}}const Hp=(r,e)=>{const{naturalWidth:t,naturalHeight:n}=r;if(!t&&!n){const{width:s,height:i}=r;e.setAttribute("viewBox",`0 0 ${s} ${i}`),r.addEventListener("load",o=>{const a=o.target;e.setAttribute("viewBox",`0 0 ${a.naturalWidth} ${a.naturalHeight}`)})}else e.setAttribute("viewBox",`0 0 ${t} ${n}`)},zp=(r,e)=>{Hp(r,e);const{subscribe:t,set:n}=Np(1);let s;return window.ResizeObserver&&(s=new ResizeObserver(()=>{const i=e.getBoundingClientRect(),{width:o,height:a}=e.viewBox.baseVal,l=Math.max(i.width/o,i.height/a);n(l)}),s.observe(e.parentElement)),{destroy:()=>{s&&s.disconnect()},subscribe:t}},Ta="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;function $p(r){let e,t,n,s,i,o;return{c(){e=te("rect"),w(e,"class",t=Mn(`a9s-handle ${r[8].class||""}`.trim())+" svelte-1sgkh33"),w(e,"x",n=r[0]-r[5]/2),w(e,"y",s=r[1]-r[5]/2),w(e,"width",r[5]),w(e,"height",r[5])},m(a,l){Y(a,e,l),i||(o=Ee(e,"pointerdown",r[11]),i=!0)},p(a,l){l&256&&t!==(t=Mn(`a9s-handle ${a[8].class||""}`.trim())+" svelte-1sgkh33")&&w(e,"class",t),l&33&&n!==(n=a[0]-a[5]/2)&&w(e,"x",n),l&34&&s!==(s=a[1]-a[5]/2)&&w(e,"y",s),l&32&&w(e,"width",a[5]),l&32&&w(e,"height",a[5])},d(a){a&&X(e),i=!1,o()}}}function Wp(r){let e,t,n,s,i,o,a,l,c;return{c(){e=te("g"),t=te("circle"),s=te("rect"),w(t,"cx",r[0]),w(t,"cy",r[1]),w(t,"r",n=r[3]/r[2]),w(t,"class","a9s-touch-halo svelte-1sgkh33"),pr(t,"touched",r[4]),w(s,"class",i=Mn(`a9s-handle ${r[8].class||""}`.trim())+" svelte-1sgkh33"),w(s,"x",o=r[0]-r[5]/2),w(s,"y",a=r[1]-r[5]/2),w(s,"width",r[5]),w(s,"height",r[5]),w(e,"class","a9s-touch-handle")},m(h,u){Y(h,e,u),bt(e,t),bt(e,s),l||(c=[Ee(t,"pointerdown",r[10]),Ee(t,"pointerdown",r[6]),Ee(t,"pointerup",r[7]),Ee(s,"pointerdown",r[9]),Ee(s,"pointerdown",r[6]),Ee(s,"pointerup",r[7])],l=!0)},p(h,u){u&1&&w(t,"cx",h[0]),u&2&&w(t,"cy",h[1]),u&12&&n!==(n=h[3]/h[2])&&w(t,"r",n),u&16&&pr(t,"touched",h[4]),u&256&&i!==(i=Mn(`a9s-handle ${h[8].class||""}`.trim())+" svelte-1sgkh33")&&w(s,"class",i),u&33&&o!==(o=h[0]-h[5]/2)&&w(s,"x",o),u&34&&a!==(a=h[1]-h[5]/2)&&w(s,"y",a),u&32&&w(s,"width",h[5]),u&32&&w(s,"height",h[5])},d(h){h&&X(e),l=!1,yt(c)}}}function Vp(r){let e;function t(s,i){return Ta?Wp:$p}let n=t()(r);return{c(){n.c(),e=xt()},m(s,i){n.m(s,i),Y(s,e,i)},p(s,[i]){n.p(s,i)},i:ge,o:ge,d(s){s&&X(e),n.d(s)}}}function Xp(r,e,t){let n,{x:s}=e,{y:i}=e,{scale:o}=e,{radius:a=30}=e,l=!1;const c=p=>{p.pointerType==="touch"&&t(4,l=!0)},h=()=>t(4,l=!1);function u(p){At.call(this,r,p)}function d(p){At.call(this,r,p)}function f(p){At.call(this,r,p)}return r.$$set=p=>{t(8,e=As(As({},e),aa(p))),"x"in p&&t(0,s=p.x),"y"in p&&t(1,i=p.y),"scale"in p&&t(2,o=p.scale),"radius"in p&&t(3,a=p.radius)},r.$$.update=()=>{r.$$.dirty&4&&t(5,n=10/o)},e=aa(e),[s,i,o,a,l,n,c,h,e,u,d,f]}class Yr extends st{constructor(e){super(),nt(this,e,Xp,Vp,Oe,{x:0,y:1,scale:2,radius:3})}}function Yp(r){let e,t,n,s,i,o,a,l,c,h,u,d,f,p,g,m,_,b,y,x,S,k,P,T,E,v,R,I,C,A,F,D,V,K,N,U,we,H,pe,de,L,et,Kt;return K=new Yr({props:{class:"a9s-corner-handle-topleft",x:r[4].x,y:r[4].y,scale:r[3]}}),K.$on("pointerdown",function(){Pe(r[9]("TOP_LEFT"))&&r[9]("TOP_LEFT").apply(this,arguments)}),U=new Yr({props:{class:"a9s-corner-handle-topright",x:r[4].x+r[4].w,y:r[4].y,scale:r[3]}}),U.$on("pointerdown",function(){Pe(r[9]("TOP_RIGHT"))&&r[9]("TOP_RIGHT").apply(this,arguments)}),H=new Yr({props:{class:"a9s-corner-handle-bottomright",x:r[4].x+r[4].w,y:r[4].y+r[4].h,scale:r[3]}}),H.$on("pointerdown",function(){Pe(r[9]("BOTTOM_RIGHT"))&&r[9]("BOTTOM_RIGHT").apply(this,arguments)}),de=new Yr({props:{class:"a9s-corner-handle-bottomleft",x:r[4].x,y:r[4].y+r[4].h,scale:r[3]}}),de.$on("pointerdown",function(){Pe(r[9]("BOTTOM_LEFT"))&&r[9]("BOTTOM_LEFT").apply(this,arguments)}),{c(){e=te("rect"),a=ut(),l=te("rect"),f=ut(),p=te("rect"),b=ut(),y=te("rect"),P=ut(),T=te("rect"),I=ut(),C=te("rect"),V=ut(),rt(K.$$.fragment),N=ut(),rt(U.$$.fragment),we=ut(),rt(H.$$.fragment),pe=ut(),rt(de.$$.fragment),w(e,"class","a9s-outer"),w(e,"style",t=r[1]?"display:none;":void 0),w(e,"x",n=r[4].x),w(e,"y",s=r[4].y),w(e,"width",i=r[4].w),w(e,"height",o=r[4].h),w(l,"class","a9s-inner a9s-shape-handle"),w(l,"style",r[1]),w(l,"x",c=r[4].x),w(l,"y",h=r[4].y),w(l,"width",u=r[4].w),w(l,"height",d=r[4].h),w(p,"class","a9s-edge-handle a9s-edge-handle-top"),w(p,"x",g=r[4].x),w(p,"y",m=r[4].y),w(p,"height",1),w(p,"width",_=r[4].w),w(y,"class","a9s-edge-handle a9s-edge-handle-right"),w(y,"x",x=r[4].x+r[4].w),w(y,"y",S=r[4].y),w(y,"height",k=r[4].h),w(y,"width",1),w(T,"class","a9s-edge-handle a9s-edge-handle-bottom"),w(T,"x",E=r[4].x),w(T,"y",v=r[4].y+r[4].h),w(T,"height",1),w(T,"width",R=r[4].w),w(C,"class","a9s-edge-handle a9s-edge-handle-left"),w(C,"x",A=r[4].x),w(C,"y",F=r[4].y),w(C,"height",D=r[4].h),w(C,"width",1)},m(O,G){Y(O,e,G),Y(O,a,G),Y(O,l,G),Y(O,f,G),Y(O,p,G),Y(O,b,G),Y(O,y,G),Y(O,P,G),Y(O,T,G),Y(O,I,G),Y(O,C,G),Y(O,V,G),Ve(K,O,G),Y(O,N,G),Ve(U,O,G),Y(O,we,G),Ve(H,O,G),Y(O,pe,G),Ve(de,O,G),L=!0,et||(Kt=[Ee(e,"pointerdown",function(){Pe(r[9]("SHAPE"))&&r[9]("SHAPE").apply(this,arguments)}),Ee(l,"pointerdown",function(){Pe(r[9]("SHAPE"))&&r[9]("SHAPE").apply(this,arguments)}),Ee(p,"pointerdown",function(){Pe(r[9]("TOP"))&&r[9]("TOP").apply(this,arguments)}),Ee(y,"pointerdown",function(){Pe(r[9]("RIGHT"))&&r[9]("RIGHT").apply(this,arguments)}),Ee(T,"pointerdown",function(){Pe(r[9]("BOTTOM"))&&r[9]("BOTTOM").apply(this,arguments)}),Ee(C,"pointerdown",function(){Pe(r[9]("LEFT"))&&r[9]("LEFT").apply(this,arguments)})],et=!0)},p(O,G){r=O,(!L||G&2&&t!==(t=r[1]?"display:none;":void 0))&&w(e,"style",t),(!L||G&16&&n!==(n=r[4].x))&&w(e,"x",n),(!L||G&16&&s!==(s=r[4].y))&&w(e,"y",s),(!L||G&16&&i!==(i=r[4].w))&&w(e,"width",i),(!L||G&16&&o!==(o=r[4].h))&&w(e,"height",o),(!L||G&2)&&w(l,"style",r[1]),(!L||G&16&&c!==(c=r[4].x))&&w(l,"x",c),(!L||G&16&&h!==(h=r[4].y))&&w(l,"y",h),(!L||G&16&&u!==(u=r[4].w))&&w(l,"width",u),(!L||G&16&&d!==(d=r[4].h))&&w(l,"height",d),(!L||G&16&&g!==(g=r[4].x))&&w(p,"x",g),(!L||G&16&&m!==(m=r[4].y))&&w(p,"y",m),(!L||G&16&&_!==(_=r[4].w))&&w(p,"width",_),(!L||G&16&&x!==(x=r[4].x+r[4].w))&&w(y,"x",x),(!L||G&16&&S!==(S=r[4].y))&&w(y,"y",S),(!L||G&16&&k!==(k=r[4].h))&&w(y,"height",k),(!L||G&16&&E!==(E=r[4].x))&&w(T,"x",E),(!L||G&16&&v!==(v=r[4].y+r[4].h))&&w(T,"y",v),(!L||G&16&&R!==(R=r[4].w))&&w(T,"width",R),(!L||G&16&&A!==(A=r[4].x))&&w(C,"x",A),(!L||G&16&&F!==(F=r[4].y))&&w(C,"y",F),(!L||G&16&&D!==(D=r[4].h))&&w(C,"height",D);const ct={};G&16&&(ct.x=r[4].x),G&16&&(ct.y=r[4].y),G&8&&(ct.scale=r[3]),K.$set(ct);const ht={};G&16&&(ht.x=r[4].x+r[4].w),G&16&&(ht.y=r[4].y),G&8&&(ht.scale=r[3]),U.$set(ht);const $e={};G&16&&($e.x=r[4].x+r[4].w),G&16&&($e.y=r[4].y+r[4].h),G&8&&($e.scale=r[3]),H.$set($e);const We={};G&16&&(We.x=r[4].x),G&16&&(We.y=r[4].y+r[4].h),G&8&&(We.scale=r[3]),de.$set(We)},i(O){L||(q(K.$$.fragment,O),q(U.$$.fragment,O),q(H.$$.fragment,O),q(de.$$.fragment,O),L=!0)},o(O){ee(K.$$.fragment,O),ee(U.$$.fragment,O),ee(H.$$.fragment,O),ee(de.$$.fragment,O),L=!1},d(O){O&&(X(e),X(a),X(l),X(f),X(p),X(b),X(y),X(P),X(T),X(I),X(C),X(V),X(N),X(we),X(pe)),Xe(K,O),Xe(U,O),Xe(H,O),Xe(de,O),et=!1,yt(Kt)}}}function jp(r){let e,t;return e=new Ca({props:{shape:r[0],transform:r[2],editor:r[5],$$slots:{default:[Yp,({grab:n})=>({9:n}),({grab:n})=>n?512:0]},$$scope:{ctx:r}}}),e.$on("grab",r[6]),e.$on("change",r[7]),e.$on("release",r[8]),{c(){rt(e.$$.fragment)},m(n,s){Ve(e,n,s),t=!0},p(n,[s]){const i={};s&1&&(i.shape=n[0]),s&4&&(i.transform=n[2]),s&1562&&(i.$$scope={dirty:s,ctx:n}),e.$set(i)},i(n){t||(q(e.$$.fragment,n),t=!0)},o(n){ee(e.$$.fragment,n),t=!1},d(n){Xe(e,n)}}}function qp(r,e,t){let n,{shape:s}=e,{computedStyle:i}=e,{transform:o}=e,{viewportScale:a=1}=e;const l=(d,f,p)=>{const g=d.geometry.bounds;let[m,_]=[g.minX,g.minY],[b,y]=[g.maxX,g.maxY];const[x,S]=p;if(f==="SHAPE")m+=x,b+=x,_+=S,y+=S;else{switch(f){case"TOP":case"TOP_LEFT":case"TOP_RIGHT":{_+=S;break}case"BOTTOM":case"BOTTOM_LEFT":case"BOTTOM_RIGHT":{y+=S;break}}switch(f){case"LEFT":case"TOP_LEFT":case"BOTTOM_LEFT":{m+=x;break}case"RIGHT":case"TOP_RIGHT":case"BOTTOM_RIGHT":{b+=x;break}}}const k=Math.min(m,b),P=Math.min(_,y),T=Math.abs(b-m),E=Math.abs(y-_);return{...d,geometry:{x:k,y:P,w:T,h:E,bounds:{minX:k,minY:P,maxX:k+T,maxY:P+E}}}};function c(d){At.call(this,r,d)}function h(d){At.call(this,r,d)}function u(d){At.call(this,r,d)}return r.$$set=d=>{"shape"in d&&t(0,s=d.shape),"computedStyle"in d&&t(1,i=d.computedStyle),"transform"in d&&t(2,o=d.transform),"viewportScale"in d&&t(3,a=d.viewportScale)},r.$$.update=()=>{r.$$.dirty&1&&t(4,n=s.geometry)},[s,i,o,a,n,l,c,h,u]}class Kp extends st{constructor(e){super(),nt(this,e,qp,jp,Oe,{shape:0,computedStyle:1,transform:2,viewportScale:3})}}const Ea=new Map([[fe.RECTANGLE,Kp],[fe.POLYGON,Lp]]),Pa=r=>Ea.get(r.type),Aa=(r,e)=>Ea.set(r,e),Zp=r=>({}),Ma=r=>({grab:r[0]});function Qp(r){let e,t,n,s;const i=r[7].default,o=Mf(i,r,r[6],Ma);return{c(){e=te("g"),o&&o.c(),w(e,"class","a9s-annotation selected")},m(a,l){Y(a,e,l),o&&o.m(e,null),t=!0,n||(s=[Ee(e,"pointerup",r[2]),Ee(e,"pointermove",r[1])],n=!0)},p(a,[l]){o&&o.p&&(!t||l&64)&&Bf(o,i,a,a[6],t?Cf(i,a[6],l,Zp):Rf(a[6]),Ma)},i(a){t||(q(o,a),t=!0)},o(a){ee(o,a),t=!1},d(a){a&&X(e),o&&o.d(a),n=!1,yt(s)}}}function Jp(r,e,t){let{$$slots:n={},$$scope:s}=e;const i=mr();let{shape:o}=e,{editor:a}=e,{transform:l}=e,c,h,u;const d=g=>m=>{c=g,h=l.elementToImage(m.offsetX,m.offsetY),u=o,m.target.setPointerCapture(m.pointerId),i("grab",m)},f=g=>{if(c){const[m,_]=l.elementToImage(g.offsetX,g.offsetY),b=[m-h[0],_-h[1]];t(3,o=a(u,c,b)),i("change",o)}},p=g=>{g.target.releasePointerCapture(g.pointerId),c=void 0,u=o,i("release",g)};return r.$$set=g=>{"shape"in g&&t(3,o=g.shape),"editor"in g&&t(4,a=g.editor),"transform"in g&&t(5,l=g.transform),"$$scope"in g&&t(6,s=g.$$scope)},[d,f,p,o,a,l,s,n]}class Ca extends st{constructor(e){super(),nt(this,e,Jp,Qp,Oe,{shape:3,editor:4,transform:5})}}const In=(r,e)=>{const t=typeof e=="function"?e(r):e;if(t){const{fill:n,fillOpacity:s}=t;let i="";return n&&(i+=`fill:${n};stroke:${n};`),i+=`fill-opacity:${s||"0.25"};`,i}};function em(r,e,t){let n;const s=mr();let{annotation:i}=e,{editor:o}=e,{style:a}=e,{target:l}=e,{transform:c}=e,{viewportScale:h}=e,u;return Xr(()=>(t(6,u=new o({target:l,props:{shape:i.target.selector,computedStyle:n,transform:c,viewportScale:h}})),u.$on("change",d=>{u.$$set({shape:d.detail}),s("change",d.detail)}),u.$on("grab",d=>s("grab",d.detail)),u.$on("release",d=>s("release",d.detail)),()=>{u.$destroy()})),r.$$set=d=>{"annotation"in d&&t(0,i=d.annotation),"editor"in d&&t(1,o=d.editor),"style"in d&&t(2,a=d.style),"target"in d&&t(3,l=d.target),"transform"in d&&t(4,c=d.transform),"viewportScale"in d&&t(5,h=d.viewportScale)},r.$$.update=()=>{r.$$.dirty&5&&(n=In(i,a)),r.$$.dirty&65&&i&&(u==null||u.$set({shape:i.target.selector})),r.$$.dirty&80&&u&&u.$set({transform:c}),r.$$.dirty&96&&u&&u.$set({viewportScale:h})},[i,o,a,l,c,h,u]}class tm extends st{constructor(e){super(),nt(this,e,em,null,Oe,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}function rm(r,e,t){const n=mr();let{drawingMode:s}=e,{target:i}=e,{tool:o}=e,{transform:a}=e,{viewportScale:l}=e,c;return Xr(()=>{const h=i.closest("svg"),u=[],d=(f,p,g)=>{h==null||h.addEventListener(f,p,g),u.push(()=>h==null?void 0:h.removeEventListener(f,p,g))};return t(5,c=new o({target:i,props:{addEventListener:d,drawingMode:s,transform:a,viewportScale:l}})),c.$on("create",f=>n("create",f.detail)),()=>{u.forEach(f=>f()),c.$destroy()}}),r.$$set=h=>{"drawingMode"in h&&t(0,s=h.drawingMode),"target"in h&&t(1,i=h.target),"tool"in h&&t(2,o=h.tool),"transform"in h&&t(3,a=h.transform),"viewportScale"in h&&t(4,l=h.viewportScale)},r.$$.update=()=>{r.$$.dirty&40&&c&&c.$set({transform:a}),r.$$.dirty&48&&c&&c.$set({viewportScale:l})},[s,i,o,a,l,c]}class nm extends st{constructor(e){super(),nt(this,e,rm,null,Oe,{drawingMode:0,target:1,tool:2,transform:3,viewportScale:4})}}function Ba(r){let e,t;return{c(){e=te("rect"),t=te("rect"),w(e,"class","a9s-outer"),w(e,"x",r[1]),w(e,"y",r[2]),w(e,"width",r[3]),w(e,"height",r[4]),w(t,"class","a9s-inner"),w(t,"x",r[1]),w(t,"y",r[2]),w(t,"width",r[3]),w(t,"height",r[4])},m(n,s){Y(n,e,s),Y(n,t,s)},p(n,s){s&2&&w(e,"x",n[1]),s&4&&w(e,"y",n[2]),s&8&&w(e,"width",n[3]),s&16&&w(e,"height",n[4]),s&2&&w(t,"x",n[1]),s&4&&w(t,"y",n[2]),s&8&&w(t,"width",n[3]),s&16&&w(t,"height",n[4])},d(n){n&&(X(e),X(t))}}}function sm(r){let e,t=r[0]&&Ba(r);return{c(){e=te("g"),t&&t.c(),w(e,"class","a9s-annotation a9s-rubberband")},m(n,s){Y(n,e,s),t&&t.m(e,null)},p(n,[s]){n[0]?t?t.p(n,s):(t=Ba(n),t.c(),t.m(e,null)):t&&(t.d(1),t=null)},i:ge,o:ge,d(n){n&&X(e),t&&t.d()}}}function im(r,e,t){const n=mr();let{addEventListener:s}=e,{drawingMode:i}=e,{transform:o}=e,a,l,c,h,u,d,f;const p=b=>{const y=b;a=performance.now(),i==="drag"&&(t(0,l=o.elementToImage(y.offsetX,y.offsetY)),c=l,t(1,h=l[0]),t(2,u=l[1]),t(3,d=1),t(4,f=1))},g=b=>{const y=b;l&&(c=o.elementToImage(y.offsetX,y.offsetY),t(1,h=Math.min(c[0],l[0])),t(2,u=Math.min(c[1],l[1])),t(3,d=Math.abs(c[0]-l[0])),t(4,f=Math.abs(c[1]-l[1])))},m=b=>{const y=b,x=performance.now()-a;if(i==="click"){if(x>300)return;y.stopPropagation(),l?_():(t(0,l=o.elementToImage(y.offsetX,y.offsetY)),c=l,t(1,h=l[0]),t(2,u=l[1]),t(3,d=1),t(4,f=1))}else l&&(x>300||d*f>100?(y.stopPropagation(),_()):(t(0,l=void 0),c=void 0))},_=()=>{if(d*f>15){const b={type:fe.RECTANGLE,geometry:{bounds:{minX:h,minY:u,maxX:h+d,maxY:u+f},x:h,y:u,w:d,h:f}};n("create",b)}t(0,l=void 0),c=void 0};return Xr(()=>{s("pointerdown",p),s("pointermove",g),s("pointerup",m,!0)}),r.$$set=b=>{"addEventListener"in b&&t(5,s=b.addEventListener),"drawingMode"in b&&t(6,i=b.drawingMode),"transform"in b&&t(7,o=b.transform)},[l,h,u,d,f,s,i,o]}class om extends st{constructor(e){super(),nt(this,e,im,sm,Oe,{addEventListener:5,drawingMode:6,transform:7})}}function Ls(r){const e=r.slice(),t=(e[2]?e[0]:[...e[0],e[1]]).map(n=>n.join(",")).join(" ");return e[16]=t,e}function Ra(r){let e,t,n,s,i,o=r[2]&&ka(r);return{c(){e=te("polygon"),n=te("polygon"),o&&o.c(),i=xt(),w(e,"class","a9s-outer"),w(e,"points",t=r[16]),w(n,"class","a9s-inner"),w(n,"points",s=r[16])},m(a,l){Y(a,e,l),Y(a,n,l),o&&o.m(a,l),Y(a,i,l)},p(a,l){l&7&&t!==(t=a[16])&&w(e,"points",t),l&7&&s!==(s=a[16])&&w(n,"points",s),a[2]?o?o.p(a,l):(o=ka(a),o.c(),o.m(i.parentNode,i)):o&&(o.d(1),o=null)},d(a){a&&(X(e),X(n),X(i)),o&&o.d(a)}}}function ka(r){let e,t,n;return{c(){e=te("rect"),w(e,"class","a9s-corner-handle"),w(e,"x",t=r[0][0][0]-r[3]/2),w(e,"y",n=r[0][0][1]-r[3]/2),w(e,"height",r[3]),w(e,"width",r[3])},m(s,i){Y(s,e,i)},p(s,i){i&9&&t!==(t=s[0][0][0]-s[3]/2)&&w(e,"x",t),i&9&&n!==(n=s[0][0][1]-s[3]/2)&&w(e,"y",n),i&8&&w(e,"height",s[3]),i&8&&w(e,"width",s[3])},d(s){s&&X(e)}}}function am(r){let e,t=r[1]&&Ra(Ls(r));return{c(){e=te("g"),t&&t.c(),w(e,"class","a9s-annotation a9s-rubberband")},m(n,s){Y(n,e,s),t&&t.m(e,null)},p(n,[s]){n[1]?t?t.p(Ls(n),s):(t=Ra(Ls(n)),t.c(),t.m(e,null)):t&&(t.d(1),t=null)},i:ge,o:ge,d(n){n&&X(e),t&&t.d()}}}const lm=20,cm=1500;function hm(r,e,t){let n;const s=mr();let{addEventListener:i}=e,{drawingMode:o}=e,{transform:a}=e,{viewportScale:l=1}=e,c,h=[],u,d,f=!1;const p=y=>{const x=y,{timeStamp:S,offsetX:k,offsetY:P}=x;if(c={timeStamp:S,offsetX:k,offsetY:P},o==="drag"&&h.length===0){const T=a.elementToImage(x.offsetX,x.offsetY);h.push(T),t(1,u=T)}},g=y=>{const x=y;if(d&&clearTimeout(d),h.length>0){if(t(1,u=a.elementToImage(x.offsetX,x.offsetY)),h.length>2){const S=Ds(u,h[0])*l;t(2,f=S<lm)}x.pointerType==="touch"&&(d=setTimeout(()=>{_()},cm))}},m=y=>{const x=y;if(d&&clearTimeout(d),o==="click"){const S=x.timeStamp-c.timeStamp,k=Ds([c.offsetX,c.offsetY],[x.offsetX,x.offsetY]);if(S>300||k>15)return;if(f)b();else if(h.length===0){const P=a.elementToImage(x.offsetX,x.offsetY);h.push(P),t(1,u=P)}else h.push(u)}else{if(h.length===1&&Ds(h[0],u)<=4){t(0,h=[]),t(1,u=void 0);return}x.stopImmediatePropagation(),f?b():h.push(u)}},_=()=>{if(!u)return;const y=[...h,u],x={type:fe.POLYGON,geometry:{bounds:Rn(y),points:y}};Gs(x)>4&&(t(0,h=[]),t(1,u=void 0),s("create",x))},b=()=>{const y={type:fe.POLYGON,geometry:{bounds:Rn(h),points:[...h]}};t(0,h=[]),t(1,u=void 0),s("create",y)};return Xr(()=>{i("pointerdown",p,!0),i("pointermove",g),i("pointerup",m,!0),i("dblclick",_,!0)}),r.$$set=y=>{"addEventListener"in y&&t(4,i=y.addEventListener),"drawingMode"in y&&t(5,o=y.drawingMode),"transform"in y&&t(6,a=y.transform),"viewportScale"in y&&t(7,l=y.viewportScale)},r.$$.update=()=>{r.$$.dirty&128&&t(3,n=10/l)},[h,u,f,n,i,o,a,l]}class um extends st{constructor(e){super(),nt(this,e,hm,am,Oe,{addEventListener:4,drawingMode:5,transform:6,viewportScale:7})}}const Ns=new Map([["rectangle",{tool:om}],["polygon",{tool:um}]]),Gn=()=>[...Ns.keys()],Un=r=>Ns.get(r),Ia=(r,e,t)=>Ns.set(r,{tool:e,opts:t});function dm(r){let e,t,n,s,i;return{c(){e=te("g"),t=te("ellipse"),s=te("ellipse"),w(t,"class","a9s-outer"),w(t,"style",n=r[1]?"display:none;":void 0),w(t,"cx",r[2]),w(t,"cy",r[3]),w(t,"rx",r[4]),w(t,"ry",r[5]),w(s,"class","a9s-inner"),w(s,"style",r[1]),w(s,"cx",r[2]),w(s,"cy",r[3]),w(s,"rx",r[4]),w(s,"ry",r[5]),w(e,"data-id",i=r[0].id)},m(o,a){Y(o,e,a),bt(e,t),bt(e,s)},p(o,[a]){a&2&&n!==(n=o[1]?"display:none;":void 0)&&w(t,"style",n),a&2&&w(s,"style",o[1]),a&1&&i!==(i=o[0].id)&&w(e,"data-id",i)},i:ge,o:ge,d(o){o&&X(e)}}}function fm(r,e,t){let n,{annotation:s}=e,{geom:i}=e,{style:o}=e;const{cx:a,cy:l,rx:c,ry:h}=i;return r.$$set=u=>{"annotation"in u&&t(0,s=u.annotation),"geom"in u&&t(6,i=u.geom),"style"in u&&t(7,o=u.style)},r.$$.update=()=>{r.$$.dirty&129&&t(1,n=In(s,o))},[s,n,a,l,c,h,i,o]}class pm extends st{constructor(e){super(),nt(this,e,fm,dm,Oe,{annotation:0,geom:6,style:7})}}function mm(r){let e,t,n,s,i;return{c(){e=te("g"),t=te("polygon"),s=te("polygon"),w(t,"class","a9s-outer"),w(t,"style",n=r[1]?"display:none;":void 0),w(t,"points",r[2].map(gm).join(" ")),w(s,"class","a9s-inner"),w(s,"style",r[1]),w(s,"points",r[2].map(_m).join(" ")),w(e,"data-id",i=r[0].id)},m(o,a){Y(o,e,a),bt(e,t),bt(e,s)},p(o,[a]){a&2&&n!==(n=o[1]?"display:none;":void 0)&&w(t,"style",n),a&2&&w(s,"style",o[1]),a&1&&i!==(i=o[0].id)&&w(e,"data-id",i)},i:ge,o:ge,d(o){o&&X(e)}}}const gm=r=>r.join(","),_m=r=>r.join(",");function ym(r,e,t){let n,{annotation:s}=e,{geom:i}=e,{style:o}=e;const{points:a}=i;return r.$$set=l=>{"annotation"in l&&t(0,s=l.annotation),"geom"in l&&t(3,i=l.geom),"style"in l&&t(4,o=l.style)},r.$$.update=()=>{r.$$.dirty&17&&t(1,n=In(s,o))},[s,n,a,i,o]}class bm extends st{constructor(e){super(),nt(this,e,ym,mm,Oe,{annotation:0,geom:3,style:4})}}function xm(r){let e,t,n,s,i;return{c(){e=te("g"),t=te("rect"),s=te("rect"),w(t,"class","a9s-outer"),w(t,"style",n=r[5]?"display:none;":void 0),w(t,"x",r[4]),w(t,"y",r[3]),w(t,"width",r[2]),w(t,"height",r[1]),w(s,"class","a9s-inner"),w(s,"style",r[5]),w(s,"x",r[4]),w(s,"y",r[3]),w(s,"width",r[2]),w(s,"height",r[1]),w(e,"data-id",i=r[0].id)},m(o,a){Y(o,e,a),bt(e,t),bt(e,s)},p(o,[a]){a&32&&n!==(n=o[5]?"display:none;":void 0)&&w(t,"style",n),a&16&&w(t,"x",o[4]),a&8&&w(t,"y",o[3]),a&4&&w(t,"width",o[2]),a&2&&w(t,"height",o[1]),a&32&&w(s,"style",o[5]),a&16&&w(s,"x",o[4]),a&8&&w(s,"y",o[3]),a&4&&w(s,"width",o[2]),a&2&&w(s,"height",o[1]),a&1&&i!==(i=o[0].id)&&w(e,"data-id",i)},i:ge,o:ge,d(o){o&&X(e)}}}function vm(r,e,t){let n,s,i,o,a,{annotation:l}=e,{geom:c}=e,{style:h}=e;return r.$$set=u=>{"annotation"in u&&t(0,l=u.annotation),"geom"in u&&t(6,c=u.geom),"style"in u&&t(7,h=u.style)},r.$$.update=()=>{r.$$.dirty&129&&t(5,n=In(l,h)),r.$$.dirty&64&&t(4,{x:s,y:i,w:o,h:a}=c,s,(t(3,i),t(6,c)),(t(2,o),t(6,c)),(t(1,a),t(6,c)))},[l,a,o,i,s,n,c,h]}class wm extends st{constructor(e){super(),nt(this,e,vm,xm,Oe,{annotation:0,geom:6,style:7})}}const Sm=r=>({elementToImage:(e,t)=>{const n=r.getBoundingClientRect(),s=r.createSVGPoint();s.x=e+n.x,s.y=t+n.y;const{x:i,y:o}=s.matrixTransform(r.getScreenCTM().inverse());return[i,o]}}),Tm=250,Em=(r,e)=>{const t=mr();let n;return{onPointerDown:()=>n=performance.now(),onPointerUp:s=>{if(performance.now()-n<Tm){const{x:i,y:o}=Pm(s,r),a=e.getAt(i,o);a?t("click",{originalEvent:s,annotation:a}):t("click",{originalEvent:s})}}}},Pm=(r,e)=>{const t=e.createSVGPoint(),n=e.getBoundingClientRect(),s=r.clientX-n.x,i=r.clientY-n.y,{left:o,top:a}=e.getBoundingClientRect();return t.x=s+o,t.y=i+a,t.matrixTransform(e.getScreenCTM().inverse())},{Boolean:Ga}=kf;function Ua(r,e,t){const n=r.slice();return n[31]=e[t],n}function Fa(r,e,t){const n=r.slice();return n[34]=e[t],n}function Hs(r){const e=r.slice(),t=e[34].target.selector;return e[37]=t,e}function Oa(r){let e=r[34].id,t,n,s=Da(r);return{c(){s.c(),t=xt()},m(i,o){s.m(i,o),Y(i,t,o),n=!0},p(i,o){o[0]&16384&&Oe(e,e=i[34].id)?(vt(),ee(s,1,1,ge),wt(),s=Da(i),s.c(),q(s,1),s.m(t.parentNode,t)):s.p(i,o)},i(i){n||(q(s),n=!0)},o(i){ee(s),n=!1},d(i){i&&X(t),s.d(i)}}}function Am(r){let e,t;return e=new bm({props:{annotation:r[34],geom:r[37].geometry,style:r[1]}}),{c(){rt(e.$$.fragment)},m(n,s){Ve(e,n,s),t=!0},p(n,s){const i={};s[0]&16384&&(i.annotation=n[34]),s[0]&16384&&(i.geom=n[37].geometry),s[0]&2&&(i.style=n[1]),e.$set(i)},i(n){t||(q(e.$$.fragment,n),t=!0)},o(n){ee(e.$$.fragment,n),t=!1},d(n){Xe(e,n)}}}function Mm(r){let e,t;return e=new wm({props:{annotation:r[34],geom:r[37].geometry,style:r[1]}}),{c(){rt(e.$$.fragment)},m(n,s){Ve(e,n,s),t=!0},p(n,s){const i={};s[0]&16384&&(i.annotation=n[34]),s[0]&16384&&(i.geom=n[37].geometry),s[0]&2&&(i.style=n[1]),e.$set(i)},i(n){t||(q(e.$$.fragment,n),t=!0)},o(n){ee(e.$$.fragment,n),t=!1},d(n){Xe(e,n)}}}function Cm(r){let e,t;return e=new pm({props:{annotation:r[34],geom:r[37].geometry,style:r[1]}}),{c(){rt(e.$$.fragment)},m(n,s){Ve(e,n,s),t=!0},p(n,s){const i={};s[0]&16384&&(i.annotation=n[34]),s[0]&16384&&(i.geom=n[37].geometry),s[0]&2&&(i.style=n[1]),e.$set(i)},i(n){t||(q(e.$$.fragment,n),t=!0)},o(n){ee(e.$$.fragment,n),t=!1},d(n){Xe(e,n)}}}function Da(r){let e,t,n,s;const i=[Cm,Mm,Am],o=[];function a(l,c){return l[37].type===fe.ELLIPSE?0:l[37].type===fe.RECTANGLE?1:l[37].type===fe.POLYGON?2:-1}return~(e=a(r))&&(t=o[e]=i[e](r)),{c(){t&&t.c(),n=xt()},m(l,c){~e&&o[e].m(l,c),Y(l,n,c),s=!0},p(l,c){let h=e;e=a(l),e===h?~e&&o[e].p(l,c):(t&&(vt(),ee(o[h],1,1,()=>{o[h]=null}),wt()),~e?(t=o[e],t?t.p(l,c):(t=o[e]=i[e](l),t.c()),q(t,1),t.m(n.parentNode,n)):t=null)},i(l){s||(q(t),s=!0)},o(l){ee(t),s=!1},d(l){l&&X(n),~e&&o[e].d(l)}}}function La(r){let e=!r[8](r[34]),t,n,s=e&&Oa(Hs(r));return{c(){s&&s.c(),t=xt()},m(i,o){s&&s.m(i,o),Y(i,t,o),n=!0},p(i,o){o[0]&16640&&(e=!i[8](i[34])),e?s?(s.p(Hs(i),o),o[0]&16640&&q(s,1)):(s=Oa(Hs(i)),s.c(),q(s,1),s.m(t.parentNode,t)):s&&(vt(),ee(s,1,1,()=>{s=null}),wt())},i(i){n||(q(s),n=!0)},o(i){ee(s),n=!1},d(i){i&&X(t),s&&s.d(i)}}}function Na(r){let e,t,n,s;const i=[Rm,Bm],o=[];function a(l,c){return l[7]?0:l[13]&&l[0]?1:-1}return~(e=a(r))&&(t=o[e]=i[e](r)),{c(){t&&t.c(),n=xt()},m(l,c){~e&&o[e].m(l,c),Y(l,n,c),s=!0},p(l,c){let h=e;e=a(l),e===h?~e&&o[e].p(l,c):(t&&(vt(),ee(o[h],1,1,()=>{o[h]=null}),wt()),~e?(t=o[e],t?t.p(l,c):(t=o[e]=i[e](l),t.c()),q(t,1),t.m(n.parentNode,n)):t=null)},i(l){s||(q(t),s=!0)},o(l){ee(t),s=!1},d(l){l&&X(n),~e&&o[e].d(l)}}}function Bm(r){let e=r[2],t,n,s=Ha(r);return{c(){s.c(),t=xt()},m(i,o){s.m(i,o),Y(i,t,o),n=!0},p(i,o){o[0]&4&&Oe(e,e=i[2])?(vt(),ee(s,1,1,ge),wt(),s=Ha(i),s.c(),q(s,1),s.m(t.parentNode,t)):s.p(i,o)},i(i){n||(q(s),n=!0)},o(i){ee(s),n=!1},d(i){i&&X(t),s.d(i)}}}function Rm(r){let e,t,n=br(r[7]),s=[];for(let o=0;o<n.length;o+=1)s[o]=$a(Ua(r,n,o));const i=o=>ee(s[o],1,1,()=>{s[o]=null});return{c(){for(let o=0;o<s.length;o+=1)s[o].c();e=xt()},m(o,a){for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(o,a);Y(o,e,a),t=!0},p(o,a){if(a[0]&1607842){n=br(o[7]);let l;for(l=0;l<n.length;l+=1){const c=Ua(o,n,l);s[l]?(s[l].p(c,a),q(s[l],1)):(s[l]=$a(c),s[l].c(),q(s[l],1),s[l].m(e.parentNode,e))}for(vt(),l=n.length;l<s.length;l+=1)i(l);wt()}},i(o){if(!t){for(let a=0;a<n.length;a+=1)q(s[a]);t=!0}},o(o){s=s.filter(Ga);for(let a=0;a<s.length;a+=1)ee(s[a]);t=!1},d(o){o&&X(e),Ms(s,o)}}}function Ha(r){let e,t;return e=new nm({props:{target:r[5],tool:r[13],drawingMode:r[12],transform:r[11],viewportScale:r[15]}}),e.$on("create",r[18]),{c(){rt(e.$$.fragment)},m(n,s){Ve(e,n,s),t=!0},p(n,s){const i={};s[0]&32&&(i.target=n[5]),s[0]&8192&&(i.tool=n[13]),s[0]&4096&&(i.drawingMode=n[12]),s[0]&2048&&(i.transform=n[11]),s[0]&32768&&(i.viewportScale=n[15]),e.$set(i)},i(n){t||(q(e.$$.fragment,n),t=!0)},o(n){ee(e.$$.fragment,n),t=!1},d(n){Xe(e,n)}}}function za(r){let e,t;return e=new tm({props:{target:r[5],editor:r[20](r[31].target.selector),annotation:r[31],style:r[1],transform:r[11],viewportScale:r[15]}}),e.$on("change",function(){Pe(r[19](r[31]))&&r[19](r[31]).apply(this,arguments)}),{c(){rt(e.$$.fragment)},m(n,s){Ve(e,n,s),t=!0},p(n,s){r=n;const i={};s[0]&32&&(i.target=r[5]),s[0]&128&&(i.editor=r[20](r[31].target.selector)),s[0]&128&&(i.annotation=r[31]),s[0]&2&&(i.style=r[1]),s[0]&2048&&(i.transform=r[11]),s[0]&32768&&(i.viewportScale=r[15]),e.$set(i)},i(n){t||(q(e.$$.fragment,n),t=!0)},o(n){ee(e.$$.fragment,n),t=!1},d(n){Xe(e,n)}}}function $a(r){let e=r[31].id,t,n,s=za(r);return{c(){s.c(),t=xt()},m(i,o){s.m(i,o),Y(i,t,o),n=!0},p(i,o){o[0]&128&&Oe(e,e=i[31].id)?(vt(),ee(s,1,1,ge),wt(),s=za(i),s.c(),q(s,1),s.m(t.parentNode,t)):s.p(i,o)},i(i){n||(q(s),n=!0)},o(i){ee(s),n=!1},d(i){i&&X(t),s.d(i)}}}function km(r){let e,t,n,s,i,o,a=br(r[14]),l=[];for(let u=0;u<a.length;u+=1)l[u]=La(Fa(r,a,u));const c=u=>ee(l[u],1,1,()=>{l[u]=null});let h=r[5]&&Na(r);return{c(){e=te("svg"),t=te("g");for(let u=0;u<l.length;u+=1)l[u].c();n=te("g"),h&&h.c(),w(n,"class","drawing"),w(e,"class","a9s-annotationlayer"),pr(e,"drawing",r[13]),pr(e,"hidden",!r[3])},m(u,d){Y(u,e,d),bt(e,t);for(let f=0;f<l.length;f+=1)l[f]&&l[f].m(t,null);bt(e,n),h&&h.m(n,null),r[27](n),r[28](e),s=!0,i||(o=[Ee(e,"pointerup",function(){Pe(r[9])&&r[9].apply(this,arguments)}),Ee(e,"pointerdown",function(){Pe(r[10])&&r[10].apply(this,arguments)})],i=!0)},p(u,d){if(r=u,d[0]&16642){a=br(r[14]);let f;for(f=0;f<a.length;f+=1){const p=Fa(r,a,f);l[f]?(l[f].p(p,d),q(l[f],1)):(l[f]=La(p),l[f].c(),q(l[f],1),l[f].m(t,null))}for(vt(),f=a.length;f<l.length;f+=1)c(f);wt()}r[5]?h?(h.p(r,d),d[0]&32&&q(h,1)):(h=Na(r),h.c(),q(h,1),h.m(n,null)):h&&(vt(),ee(h,1,1,()=>{h=null}),wt()),(!s||d[0]&8192)&&pr(e,"drawing",r[13]),(!s||d[0]&8)&&pr(e,"hidden",!r[3])},i(u){if(!s){for(let d=0;d<a.length;d+=1)q(l[d]);q(h),s=!0}},o(u){l=l.filter(Ga);for(let d=0;d<l.length;d+=1)ee(l[d]);ee(h),s=!1},d(u){u&&X(e),Ms(l,u),h&&h.d(),r[27](null),r[28](null),i=!1,yt(o)}}}function Im(r,e,t){let n,s,i,o,a,l,c,h,u,d,f=ge,p=()=>(f(),f=sa(E,U=>t(15,d=U)),E);r.$$.on_destroy.push(()=>f());let{drawingEnabled:g}=e,{image:m}=e,{preferredDrawingMode:_}=e,{state:b}=e,{style:y=void 0}=e,{toolName:x=Gn()[0]}=e,{user:S}=e,{visible:k=!0}=e,P,T,E;Xr(()=>p(t(6,E=zp(m,T))));const{selection:v,store:R}=b;ia(r,v,U=>t(26,h=U)),ia(r,R,U=>t(14,u=U));let I,C;const A=U=>{I&&R.unobserve(I);const we=U.filter(({editable:H})=>H).map(({id:H})=>H);we.length>0?(t(7,C=we.map(H=>R.getAnnotation(H)).filter(Boolean)),I=H=>{const{updated:pe}=H.changes;t(7,C=pe==null?void 0:pe.map(de=>de.newValue))},R.observe(I,{annotations:we})):t(7,C=void 0)},F=U=>{const we=ma(),H={id:we,bodies:[],target:{annotation:we,selector:U.detail,creator:S,created:new Date}};R.addAnnotation(H),v.setSelected(H.id)},D=U=>we=>{var H;const{target:pe}=U,de=10*60*1e3,L=((H=pe.creator)==null?void 0:H.id)!==S.id||!pe.created||new Date().getTime()-pe.created.getTime()>de;R.updateTarget({...pe,selector:we.detail,created:L?pe.created:new Date,updated:L?new Date:void 0,updatedBy:L?S:void 0})},V=U=>Pa(U);function K(U){Cn[U?"unshift":"push"](()=>{P=U,t(5,P)})}function N(U){Cn[U?"unshift":"push"](()=>{T=U,t(4,T)})}return r.$$set=U=>{"drawingEnabled"in U&&t(0,g=U.drawingEnabled),"image"in U&&t(21,m=U.image),"preferredDrawingMode"in U&&t(22,_=U.preferredDrawingMode),"state"in U&&t(23,b=U.state),"style"in U&&t(1,y=U.style),"toolName"in U&&t(2,x=U.toolName),"user"in U&&t(24,S=U.user),"visible"in U&&t(3,k=U.visible)},r.$$.update=()=>{r.$$.dirty[0]&4&&t(13,{tool:n,opts:s}=Un(x)||{tool:void 0,opts:void 0},n,(t(25,s),t(2,x))),r.$$.dirty[0]&37748736&&t(12,i=(s==null?void 0:s.drawingMode)||_),r.$$.dirty[0]&16&&t(11,o=Sm(T)),r.$$.dirty[0]&16&&t(10,{onPointerDown:a,onPointerUp:l}=Em(T,R),a,(t(9,l),t(4,T))),r.$$.dirty[0]&67108864&&t(8,c=U=>h.selected.find(we=>we.id===U.id&&we.editable)),r.$$.dirty[0]&67108864&&A(h.selected)},[g,y,x,k,T,P,E,C,c,l,a,o,i,n,u,d,v,R,F,D,V,m,_,b,S,s,h,K,N]}class Gm extends st{constructor(e){super(),nt(this,e,Im,km,Oe,{drawingEnabled:0,image:21,preferredDrawingMode:22,state:23,style:1,toolName:2,user:24,visible:3},null,[-1,-1])}}function Um(r,e,t,n,s){Wa(r,e,t||0,n||r.length-1,s||Fm)}function Wa(r,e,t,n,s){for(;n>t;){if(n-t>600){var i=n-t+1,o=e-t+1,a=Math.log(i),l=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*l*(i-l)/i)*(o-i/2<0?-1:1),h=Math.max(t,Math.floor(e-o*l/i+c)),u=Math.min(n,Math.floor(e+(i-o)*l/i+c));Wa(r,e,h,u,s)}var d=r[e],f=t,p=n;for(jr(r,t,e),s(r[n],d)>0&&jr(r,t,n);f<p;){for(jr(r,f,p),f++,p--;s(r[f],d)<0;)f++;for(;s(r[p],d)>0;)p--}s(r[t],d)===0?jr(r,t,p):(p++,jr(r,p,n)),p<=e&&(t=p+1),e<=p&&(n=p-1)}}function jr(r,e,t){var n=r[e];r[e]=r[t],r[t]=n}function Fm(r,e){return r<e?-1:r>e?1:0}class Om{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const n=[];if(!On(e,t))return n;const s=this.toBBox,i=[];for(;t;){for(let o=0;o<t.children.length;o++){const a=t.children[o],l=t.leaf?s(a):a;On(e,l)&&(t.leaf?n.push(a):$s(e,l)?this._all(a,n):i.push(a))}t=i.pop()}return n}collides(e){let t=this.data;if(!On(e,t))return!1;const n=[];for(;t;){for(let s=0;s<t.children.length;s++){const i=t.children[s],o=t.leaf?this.toBBox(i):i;if(On(e,o)){if(t.leaf||$s(e,o))return!0;n.push(i)}}t=n.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let n=0;n<e.length;n++)this.insert(e[n]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const n=this.data;this.data=t,t=n}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=Sr([]),this}remove(e,t){if(!e)return this;let n=this.data;const s=this.toBBox(e),i=[],o=[];let a,l,c;for(;n||i.length;){if(n||(n=i.pop(),l=i[i.length-1],a=o.pop(),c=!0),n.leaf){const h=Dm(e,n.children,t);if(h!==-1)return n.children.splice(h,1),i.push(n),this._condense(i),this}!c&&!n.leaf&&$s(n,s)?(i.push(n),o.push(a),a=0,l=n,n=n.children[0]):l?(a++,n=l.children[a],c=!1):n=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const n=[];for(;e;)e.leaf?t.push(...e.children):n.push(...e.children),e=n.pop();return t}_build(e,t,n,s){const i=n-t+1;let o=this._maxEntries,a;if(i<=o)return a=Sr(e.slice(t,n+1)),wr(a,this.toBBox),a;s||(s=Math.ceil(Math.log(i)/Math.log(o)),o=Math.ceil(i/Math.pow(o,s-1))),a=Sr([]),a.leaf=!1,a.height=s;const l=Math.ceil(i/o),c=l*Math.ceil(Math.sqrt(o));Va(e,t,n,c,this.compareMinX);for(let h=t;h<=n;h+=c){const u=Math.min(h+c-1,n);Va(e,h,u,l,this.compareMinY);for(let d=h;d<=u;d+=l){const f=Math.min(d+l-1,u);a.children.push(this._build(e,d,f,s-1))}}return wr(a,this.toBBox),a}_chooseSubtree(e,t,n,s){for(;s.push(t),!(t.leaf||s.length-1===n);){let i=1/0,o=1/0,a;for(let l=0;l<t.children.length;l++){const c=t.children[l],h=zs(c),u=Hm(e,c)-h;u<o?(o=u,i=h<i?h:i,a=c):u===o&&h<i&&(i=h,a=c)}t=a||t.children[0]}return t}_insert(e,t,n){const s=n?e:this.toBBox(e),i=[],o=this._chooseSubtree(s,this.data,t,i);for(o.children.push(e),Kr(o,s);t>=0&&i[t].children.length>this._maxEntries;)this._split(i,t),t--;this._adjustParentBBoxes(s,i,t)}_split(e,t){const n=e[t],s=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,s);const o=this._chooseSplitIndex(n,i,s),a=Sr(n.children.splice(o,n.children.length-o));a.height=n.height,a.leaf=n.leaf,wr(n,this.toBBox),wr(a,this.toBBox),t?e[t-1].children.push(a):this._splitRoot(n,a)}_splitRoot(e,t){this.data=Sr([e,t]),this.data.height=e.height+1,this.data.leaf=!1,wr(this.data,this.toBBox)}_chooseSplitIndex(e,t,n){let s,i=1/0,o=1/0;for(let a=t;a<=n-t;a++){const l=qr(e,0,a,this.toBBox),c=qr(e,a,n,this.toBBox),h=zm(l,c),u=zs(l)+zs(c);h<i?(i=h,s=a,o=u<o?u:o):h===i&&u<o&&(o=u,s=a)}return s||n-t}_chooseSplitAxis(e,t,n){const s=e.leaf?this.compareMinX:Lm,i=e.leaf?this.compareMinY:Nm,o=this._allDistMargin(e,t,n,s),a=this._allDistMargin(e,t,n,i);o<a&&e.children.sort(s)}_allDistMargin(e,t,n,s){e.children.sort(s);const i=this.toBBox,o=qr(e,0,t,i),a=qr(e,n-t,n,i);let l=Fn(o)+Fn(a);for(let c=t;c<n-t;c++){const h=e.children[c];Kr(o,e.leaf?i(h):h),l+=Fn(o)}for(let c=n-t-1;c>=t;c--){const h=e.children[c];Kr(a,e.leaf?i(h):h),l+=Fn(a)}return l}_adjustParentBBoxes(e,t,n){for(let s=n;s>=0;s--)Kr(t[s],e)}_condense(e){for(let t=e.length-1,n;t>=0;t--)e[t].children.length===0?t>0?(n=e[t-1].children,n.splice(n.indexOf(e[t]),1)):this.clear():wr(e[t],this.toBBox)}}function Dm(r,e,t){if(!t)return e.indexOf(r);for(let n=0;n<e.length;n++)if(t(r,e[n]))return n;return-1}function wr(r,e){qr(r,0,r.children.length,e,r)}function qr(r,e,t,n,s){s||(s=Sr(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let i=e;i<t;i++){const o=r.children[i];Kr(s,r.leaf?n(o):o)}return s}function Kr(r,e){return r.minX=Math.min(r.minX,e.minX),r.minY=Math.min(r.minY,e.minY),r.maxX=Math.max(r.maxX,e.maxX),r.maxY=Math.max(r.maxY,e.maxY),r}function Lm(r,e){return r.minX-e.minX}function Nm(r,e){return r.minY-e.minY}function zs(r){return(r.maxX-r.minX)*(r.maxY-r.minY)}function Fn(r){return r.maxX-r.minX+(r.maxY-r.minY)}function Hm(r,e){return(Math.max(e.maxX,r.maxX)-Math.min(e.minX,r.minX))*(Math.max(e.maxY,r.maxY)-Math.min(e.minY,r.minY))}function zm(r,e){const t=Math.max(r.minX,e.minX),n=Math.max(r.minY,e.minY),s=Math.min(r.maxX,e.maxX),i=Math.min(r.maxY,e.maxY);return Math.max(0,s-t)*Math.max(0,i-n)}function $s(r,e){return r.minX<=e.minX&&r.minY<=e.minY&&e.maxX<=r.maxX&&e.maxY<=r.maxY}function On(r,e){return e.minX<=r.maxX&&e.minY<=r.maxY&&e.maxX>=r.minX&&e.maxY>=r.minY}function Sr(r){return{children:r,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Va(r,e,t,n,s){const i=[e,t];for(;i.length;){if(t=i.pop(),e=i.pop(),t-e<=n)continue;const o=e+Math.ceil((t-e)/n/2)*n;Um(r,o,e,t,s),i.push(e,o,o,t)}}const $m=()=>{const r=new Om,e=new Map,t=()=>[...e.values()],n=()=>{r.clear(),e.clear()},s=o=>{const{minX:a,minY:l,maxX:c,maxY:h}=o.selector.geometry.bounds,u={minX:a,minY:l,maxX:c,maxY:h,target:o};r.insert(u),e.set(o.annotation,u)},i=o=>{const a=e.get(o.annotation);a&&r.remove(a),e.delete(o.annotation)};return{all:t,clear:n,getAt:(o,a)=>{const l=r.search({minX:o,minY:a,maxX:o,maxY:a}).map(c=>c.target).filter(c=>c.selector.type===fe.RECTANGLE||Hf(c.selector,o,a));if(l.length>0)return l.sort((c,h)=>Gs(c.selector)-Gs(h.selector)),l[0]},getIntersecting:(o,a,l,c)=>r.search({minX:o,minY:a,maxX:o+l,maxY:a+c}).map(h=>h.target),insert:s,remove:i,set:(o,a=!0)=>{a&&n();const l=o.map(c=>{const{minX:h,minY:u,maxX:d,maxY:f}=c.selector.geometry.bounds;return{minX:h,minY:u,maxX:d,maxY:f,target:c}});l.forEach(c=>e.set(c.target.annotation,c)),r.load(l)},size:()=>r.all().length,update:(o,a)=>{i(o),s(a)}}},Xa=r=>{const e=mp(),t=$m(),n=ip(e,r.pointerSelectAction),s=sp(e),i=xp();return e.observe(({changes:o})=>{t.set((o.created||[]).map(a=>a.target),!1),(o.deleted||[]).forEach(a=>t.remove(a.target)),(o.updated||[]).forEach(({oldValue:a,newValue:l})=>t.update(a.target,l.target))}),{store:{...e,getAt:(o,a)=>{const l=t.getAt(o,a);return l?e.getAnnotation(l.annotation):void 0},getIntersecting:(o,a,l,c)=>t.getIntersecting(o,a,l,c).map(h=>e.getAnnotation(h.annotation))},selection:n,hover:s,viewport:i}},Wm=r=>{const e=Xa(r);return{...e,store:gp(e.store)}},Vm=r=>{let e,t;if(r.nodeName==="CANVAS")e=r,t=e.getContext("2d",{willReadFrequently:!0});else{const s=r;e=document.createElement("canvas"),e.width=s.width,e.height=s.height,t=e.getContext("2d",{willReadFrequently:!0}),t.drawImage(s,0,0,s.width,s.height)}let n=0;for(let s=1;s<10;s++)for(let i=1;i<10;i++){const o=Math.round(i*e.width/10),a=Math.round(s*e.height/10),l=t.getImageData(o,a,1,1).data,c=(.299*l[0]+.587*l[1]+.114*l[2])/255;n+=c}return n/81},Ya=r=>{const e=Vm(r),t=e>.6?"dark":"light";return console.log(`[Annotorious] Image brightness: ${e.toFixed(1)}. Setting ${t} theme.`),t},ja=(r,e,t)=>e.setAttribute("data-theme",t==="auto"?Ya(r):t),qa=(r,e)=>({...r,drawingEnabled:r.drawingEnabled===void 0?e.drawingEnabled:r.drawingEnabled,drawingMode:r.drawingMode||e.drawingMode,pointerSelectAction:r.pointerSelectAction||e.pointerSelectAction,theme:r.theme||e.theme}),Ka=navigator.userAgent.indexOf("Mac OS X")!==-1,Za=(r,e)=>{const t=e||document,n=o=>{const a=o;a.key==="z"&&a.ctrlKey?r.undo():a.key==="y"&&a.ctrlKey&&r.redo()},s=o=>{const a=o;a.key==="z"&&a.metaKey&&(a.shiftKey?r.redo():r.undo())},i=()=>{Ka?t.removeEventListener("keydown",s):t.removeEventListener("keydown",n)};return Ka?t.addEventListener("keydown",s):t.addEventListener("keydown",n),{destroy:i}},Xm=(r,e={})=>{if(!r)throw"Missing argument: image";const t=typeof r=="string"?document.getElementById(r):r,n=qa(e,{drawingEnabled:!0,drawingMode:"drag",pointerSelectAction:_a.EDIT,theme:"light"}),s=Wm(n),{selection:i,store:o}=s,a=bp(o),l=vp(s,a,n.adapter,n.autoSave),c=document.createElement("DIV");c.style.position="relative",c.style.display="inline-block",t.style.display="block",t.parentNode.insertBefore(c,t),c.appendChild(t);const h=Za(a);let u=Cp();ja(t,c,n.theme);const d=new Gm({target:c,props:{drawingEnabled:!!n.drawingEnabled,image:t,preferredDrawingMode:n.drawingMode,state:s,style:n.style,user:u}});d.$on("click",E=>{const{originalEvent:v,annotation:R}=E.detail;R?i.clickSelect(R.id,v):i.isEmpty()||i.clear()});const f=Sp(s,a,n.adapter),p=()=>{d.$destroy(),c.parentNode.insertBefore(t,c),c.parentNode.removeChild(c),h.destroy(),a.destroy()},g=()=>u,m=(E,v,R)=>Ia(E,v,R),_=(E,v)=>Aa(E,v),b=E=>{if(!Un(E))throw`No drawing tool named ${E}`;d.$set({toolName:E})},y=E=>d.$set({drawingEnabled:E}),x=E=>{console.warn("Filter not implemented yet")},S=E=>d.$set({style:E}),k=E=>ja(t,c,E),P=E=>{u=E,d.$set({user:E})},T=E=>d.$set({visible:E});return{...f,destroy:p,getUser:g,listDrawingTools:Gn,on:l.on,off:l.off,registerDrawingTool:m,registerShapeEditor:_,setDrawingEnabled:y,setDrawingTool:b,setFilter:x,setStyle:S,setTheme:k,setUser:P,setVisible:T,state:s}};function St(){}function Ws(r,e){for(const t in e)r[t]=e[t];return r}function Qa(r){return r()}function Ja(){return Object.create(null)}function Mt(r){r.forEach(Qa)}function De(r){return typeof r=="function"}function He(r,e){return r!=r?e==e:r!==e||r&&typeof r=="object"||typeof r=="function"}function Ym(r){return Object.keys(r).length===0}function jm(r,...e){if(r==null){for(const n of e)n(void 0);return St}const t=r.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function Vs(r,e,t){r.$$.on_destroy.push(jm(e,t))}function el(r,e,t,n){if(r){const s=tl(r,e,t,n);return r[0](s)}}function tl(r,e,t,n){return r[1]&&n?Ws(t.ctx.slice(),r[1](n(e))):t.ctx}function rl(r,e,t,n){if(r[2]&&n){const s=r[2](n(t));if(e.dirty===void 0)return s;if(typeof s=="object"){const i=[],o=Math.max(e.dirty.length,s.length);for(let a=0;a<o;a+=1)i[a]=e.dirty[a]|s[a];return i}return e.dirty|s}return e.dirty}function nl(r,e,t,n,s,i){if(s){const o=tl(e,t,n,i);r.p(o,s)}}function sl(r){if(r.ctx.length>32){const e=[],t=r.ctx.length/32;for(let n=0;n<t;n++)e[n]=-1;return e}return-1}function il(r){const e={};for(const t in r)t[0]!=="$"&&(e[t]=r[t]);return e}function Dn(r){return r??""}const qm=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function Ct(r,e){r.appendChild(e)}function Q(r,e,t){r.insertBefore(e,t||null)}function Z(r){r.parentNode&&r.parentNode.removeChild(r)}function Xs(r,e){for(let t=0;t<r.length;t+=1)r[t]&&r[t].d(e)}function me(r){return document.createElementNS("http://www.w3.org/2000/svg",r)}function Ys(r){return document.createTextNode(r)}function dt(){return Ys(" ")}function $t(){return Ys("")}function ke(r,e,t,n){return r.addEventListener(e,t,n),()=>r.removeEventListener(e,t,n)}function B(r,e,t){t==null?r.removeAttribute(e):r.getAttribute(e)!==t&&r.setAttribute(e,t)}function Km(r){return Array.from(r.childNodes)}function Zm(r,e){e=""+e,r.data!==e&&(r.data=e)}function Ln(r,e,t){r.classList.toggle(e,!!t)}function Qm(r,e,{bubbles:t=!1,cancelable:n=!1}={}){return new CustomEvent(r,{detail:e,bubbles:t,cancelable:n})}let Zr;function Qr(r){Zr=r}function js(){if(!Zr)throw new Error("Function called outside component initialization");return Zr}function Nn(r){js().$$.on_mount.push(r)}function Jm(r){js().$$.on_destroy.push(r)}function Hn(){const r=js();return(e,t,{cancelable:n=!1}={})=>{const s=r.$$.callbacks[e];if(s){const i=Qm(e,t,{cancelable:n});return s.slice().forEach(o=>{o.call(r,i)}),!i.defaultPrevented}return!0}}function Bt(r,e){const t=r.$$.callbacks[e.type];t&&t.slice().forEach(n=>n.call(this,e))}const Tr=[],zn=[];let Er=[];const ol=[],eg=Promise.resolve();let qs=!1;function tg(){qs||(qs=!0,eg.then(al))}function Ks(r){Er.push(r)}const Zs=new Set;let Pr=0;function al(){if(Pr!==0)return;const r=Zr;do{try{for(;Pr<Tr.length;){const e=Tr[Pr];Pr++,Qr(e),rg(e.$$)}}catch(e){throw Tr.length=0,Pr=0,e}for(Qr(null),Tr.length=0,Pr=0;zn.length;)zn.pop()();for(let e=0;e<Er.length;e+=1){const t=Er[e];Zs.has(t)||(Zs.add(t),t())}Er.length=0}while(Tr.length);for(;ol.length;)ol.pop()();qs=!1,Zs.clear(),Qr(r)}function rg(r){if(r.fragment!==null){r.update(),Mt(r.before_update);const e=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,e),r.after_update.forEach(Ks)}}function ng(r){const e=[],t=[];Er.forEach(n=>r.indexOf(n)===-1?e.push(n):t.push(n)),t.forEach(n=>n()),Er=e}const $n=new Set;let er;function Rt(){er={r:0,c:[],p:er}}function kt(){er.r||Mt(er.c),er=er.p}function j(r,e){r&&r.i&&($n.delete(r),r.i(e))}function J(r,e,t,n){if(r&&r.o){if($n.has(r))return;$n.add(r),er.c.push(()=>{$n.delete(r),n&&(t&&r.d(1),n())}),r.o(e)}else n&&n()}function Ar(r){return(r==null?void 0:r.length)!==void 0?r:Array.from(r)}function ze(r){r&&r.c()}function Le(r,e,t){const{fragment:n,after_update:s}=r.$$;n&&n.m(e,t),Ks(()=>{const i=r.$$.on_mount.map(Qa).filter(De);r.$$.on_destroy?r.$$.on_destroy.push(...i):Mt(i),r.$$.on_mount=[]}),s.forEach(Ks)}function Ne(r,e){const t=r.$$;t.fragment!==null&&(ng(t.after_update),Mt(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function sg(r,e){r.$$.dirty[0]===-1&&(Tr.push(r),tg(),r.$$.dirty.fill(0)),r.$$.dirty[e/31|0]|=1<<e%31}function Ye(r,e,t,n,s,i,o=null,a=[-1]){const l=Zr;Qr(r);const c=r.$$={fragment:null,ctx:[],props:i,update:St,not_equal:s,bound:Ja(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:Ja(),dirty:a,skip_bound:!1,root:e.target||l.$$.root};o&&o(c.root);let h=!1;if(c.ctx=t?t(r,e.props||{},(u,d,...f)=>{const p=f.length?f[0]:d;return c.ctx&&s(c.ctx[u],c.ctx[u]=p)&&(!c.skip_bound&&c.bound[u]&&c.bound[u](p),h&&sg(r,u)),d}):[],c.update(),h=!0,Mt(c.before_update),c.fragment=n?n(c.ctx):!1,e.target){if(e.hydrate){const u=Km(e.target);c.fragment&&c.fragment.l(u),u.forEach(Z)}else c.fragment&&c.fragment.c();e.intro&&j(r.$$.fragment),Le(r,e.target,e.anchor),al()}Qr(l)}class je{constructor(){Yo(this,"$$");Yo(this,"$$set")}$destroy(){Ne(this,1),this.$destroy=St}$on(e,t){if(!De(t))return St;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const s=n.indexOf(t);s!==-1&&n.splice(s,1)}}$set(e){this.$$set&&!Ym(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const ig="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(ig);var M=(r=>(r.Application="application",r.WebGLPipes="webgl-pipes",r.WebGLPipesAdaptor="webgl-pipes-adaptor",r.WebGLSystem="webgl-system",r.WebGPUPipes="webgpu-pipes",r.WebGPUPipesAdaptor="webgpu-pipes-adaptor",r.WebGPUSystem="webgpu-system",r.CanvasSystem="canvas-system",r.CanvasPipesAdaptor="canvas-pipes-adaptor",r.CanvasPipes="canvas-pipes",r.Asset="asset",r.LoadParser="load-parser",r.ResolveParser="resolve-parser",r.CacheParser="cache-parser",r.DetectionParser="detection-parser",r.MaskEffect="mask-effect",r.BlendMode="blend-mode",r.TextureSource="texture-source",r.Environment="environment",r))(M||{});const Qs=r=>{if(typeof r=="function"||typeof r=="object"&&r.extension){if(!r.extension)throw new Error("Extension class must have an extension object");r={...typeof r.extension!="object"?{type:r.extension}:r.extension,ref:r}}if(typeof r=="object")r={...r};else throw new Error("Invalid extension type");return typeof r.type=="string"&&(r.type=[r.type]),r},Wn=(r,e)=>Qs(r).priority??e,re={_addHandlers:{},_removeHandlers:{},_queue:{},remove(...r){return r.map(Qs).forEach(e=>{e.type.forEach(t=>{var n,s;return(s=(n=this._removeHandlers)[t])==null?void 0:s.call(n,e)})}),this},add(...r){return r.map(Qs).forEach(e=>{e.type.forEach(t=>{var i,o;const n=this._addHandlers,s=this._queue;n[t]?(o=n[t])==null||o.call(n,e):(s[t]=s[t]||[],(i=s[t])==null||i.push(e))})}),this},handle(r,e,t){var o;const n=this._addHandlers,s=this._removeHandlers;if(n[r]||s[r])throw new Error(`Extension type ${r} already has a handler`);n[r]=e,s[r]=t;const i=this._queue;return i[r]&&((o=i[r])==null||o.forEach(a=>e(a)),delete i[r]),this},handleByMap(r,e){return this.handle(r,t=>{t.name&&(e[t.name]=t.ref)},t=>{t.name&&delete e[t.name]})},handleByNamedList(r,e,t=-1){return this.handle(r,n=>{e.findIndex(i=>i.name===n.name)>=0||(e.push({name:n.name,value:n.ref}),e.sort((i,o)=>Wn(o.value,t)-Wn(i.value,t)))},n=>{const s=e.findIndex(i=>i.name===n.name);s!==-1&&e.splice(s,1)})},handleByList(r,e,t=-1){return this.handle(r,n=>{e.includes(n.ref)||(e.push(n.ref),e.sort((s,i)=>Wn(i,t)-Wn(s,t)))},n=>{const s=e.indexOf(n.ref);s!==-1&&e.splice(s,1)})}},og={extension:{type:M.Environment,name:"browser",priority:-1},test:()=>!0,load:async()=>{await Promise.resolve().then(()=>n1)}},ag={extension:{type:M.Environment,name:"webworker",priority:0},test:()=>typeof self<"u"&&self.WorkerGlobalScope!==void 0,load:async()=>{await Promise.resolve().then(()=>s1)}};class qe{constructor(e,t,n){this._x=t||0,this._y=n||0,this._observer=e}clone(e){return new qe(e??this._observer,this._x,this._y)}set(e=0,t=e){return(this._x!==e||this._y!==t)&&(this._x=e,this._y=t,this._observer._onUpdate(this)),this}copyFrom(e){return(this._x!==e.x||this._y!==e.y)&&(this._x=e.x,this._y=e.y,this._observer._onUpdate(this)),this}copyTo(e){return e.set(this._x,this._y),e}equals(e){return e.x===this._x&&e.y===this._y}toString(){return`[pixi.js/math:ObservablePoint x=0 y=0 scope=${this._observer}]`}get x(){return this._x}set x(e){this._x!==e&&(this._x=e,this._observer._onUpdate(this))}get y(){return this._y}set y(e){this._y!==e&&(this._y=e,this._observer._onUpdate(this))}}function Js(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var ll={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(t=!1));function s(l,c,h){this.fn=l,this.context=c,this.once=h||!1}function i(l,c,h,u,d){if(typeof h!="function")throw new TypeError("The listener must be a function");var f=new s(h,u||l,d),p=t?t+c:c;return l._events[p]?l._events[p].fn?l._events[p]=[l._events[p],f]:l._events[p].push(f):(l._events[p]=f,l._eventsCount++),l}function o(l,c){--l._eventsCount===0?l._events=new n:delete l._events[c]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var c=[],h,u;if(this._eventsCount===0)return c;for(u in h=this._events)e.call(h,u)&&c.push(t?u.slice(1):u);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(h)):c},a.prototype.listeners=function(c){var h=t?t+c:c,u=this._events[h];if(!u)return[];if(u.fn)return[u.fn];for(var d=0,f=u.length,p=new Array(f);d<f;d++)p[d]=u[d].fn;return p},a.prototype.listenerCount=function(c){var h=t?t+c:c,u=this._events[h];return u?u.fn?1:u.length:0},a.prototype.emit=function(c,h,u,d,f,p){var g=t?t+c:c;if(!this._events[g])return!1;var m=this._events[g],_=arguments.length,b,y;if(m.fn){switch(m.once&&this.removeListener(c,m.fn,void 0,!0),_){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,h),!0;case 3:return m.fn.call(m.context,h,u),!0;case 4:return m.fn.call(m.context,h,u,d),!0;case 5:return m.fn.call(m.context,h,u,d,f),!0;case 6:return m.fn.call(m.context,h,u,d,f,p),!0}for(y=1,b=new Array(_-1);y<_;y++)b[y-1]=arguments[y];m.fn.apply(m.context,b)}else{var x=m.length,S;for(y=0;y<x;y++)switch(m[y].once&&this.removeListener(c,m[y].fn,void 0,!0),_){case 1:m[y].fn.call(m[y].context);break;case 2:m[y].fn.call(m[y].context,h);break;case 3:m[y].fn.call(m[y].context,h,u);break;case 4:m[y].fn.call(m[y].context,h,u,d);break;default:if(!b)for(S=1,b=new Array(_-1);S<_;S++)b[S-1]=arguments[S];m[y].fn.apply(m[y].context,b)}}return!0},a.prototype.on=function(c,h,u){return i(this,c,h,u,!1)},a.prototype.once=function(c,h,u){return i(this,c,h,u,!0)},a.prototype.removeListener=function(c,h,u,d){var f=t?t+c:c;if(!this._events[f])return this;if(!h)return o(this,f),this;var p=this._events[f];if(p.fn)p.fn===h&&(!d||p.once)&&(!u||p.context===u)&&o(this,f);else{for(var g=0,m=[],_=p.length;g<_;g++)(p[g].fn!==h||d&&!p[g].once||u&&p[g].context!==u)&&m.push(p[g]);m.length?this._events[f]=m.length===1?m[0]:m:o(this,f)}return this},a.prototype.removeAllListeners=function(c){var h;return c?(h=t?t+c:c,this._events[h]&&o(this,h)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(ll);var lg=ll.exports;const Ke=Js(lg),cg=Math.PI*2,hg=180/Math.PI,ug=Math.PI/180;class ce{constructor(e=0,t=0){this.x=0,this.y=0,this.x=e,this.y=t}clone(){return new ce(this.x,this.y)}copyFrom(e){return this.set(e.x,e.y),this}copyTo(e){return e.set(this.x,this.y),e}equals(e){return e.x===this.x&&e.y===this.y}set(e=0,t=e){return this.x=e,this.y=t,this}toString(){return`[pixi.js/math:Point x=${this.x} y=${this.y}]`}static get shared(){return ei.x=0,ei.y=0,ei}}const ei=new ce;class W{constructor(e=1,t=0,n=0,s=1,i=0,o=0){this.array=null,this.a=e,this.b=t,this.c=n,this.d=s,this.tx=i,this.ty=o}fromArray(e){this.a=e[0],this.b=e[1],this.c=e[3],this.d=e[4],this.tx=e[2],this.ty=e[5]}set(e,t,n,s,i,o){return this.a=e,this.b=t,this.c=n,this.d=s,this.tx=i,this.ty=o,this}toArray(e,t){this.array||(this.array=new Float32Array(9));const n=t||this.array;return e?(n[0]=this.a,n[1]=this.b,n[2]=0,n[3]=this.c,n[4]=this.d,n[5]=0,n[6]=this.tx,n[7]=this.ty,n[8]=1):(n[0]=this.a,n[1]=this.c,n[2]=this.tx,n[3]=this.b,n[4]=this.d,n[5]=this.ty,n[6]=0,n[7]=0,n[8]=1),n}apply(e,t){t=t||new ce;const n=e.x,s=e.y;return t.x=this.a*n+this.c*s+this.tx,t.y=this.b*n+this.d*s+this.ty,t}applyInverse(e,t){t=t||new ce;const n=this.a,s=this.b,i=this.c,o=this.d,a=this.tx,l=this.ty,c=1/(n*o+i*-s),h=e.x,u=e.y;return t.x=o*c*h+-i*c*u+(l*i-a*o)*c,t.y=n*c*u+-s*c*h+(-l*n+a*s)*c,t}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this}rotate(e){const t=Math.cos(e),n=Math.sin(e),s=this.a,i=this.c,o=this.tx;return this.a=s*t-this.b*n,this.b=s*n+this.b*t,this.c=i*t-this.d*n,this.d=i*n+this.d*t,this.tx=o*t-this.ty*n,this.ty=o*n+this.ty*t,this}append(e){const t=this.a,n=this.b,s=this.c,i=this.d;return this.a=e.a*t+e.b*s,this.b=e.a*n+e.b*i,this.c=e.c*t+e.d*s,this.d=e.c*n+e.d*i,this.tx=e.tx*t+e.ty*s+this.tx,this.ty=e.tx*n+e.ty*i+this.ty,this}appendFrom(e,t){const n=e.a,s=e.b,i=e.c,o=e.d,a=e.tx,l=e.ty,c=t.a,h=t.b,u=t.c,d=t.d;return this.a=n*c+s*u,this.b=n*h+s*d,this.c=i*c+o*u,this.d=i*h+o*d,this.tx=a*c+l*u+t.tx,this.ty=a*h+l*d+t.ty,this}setTransform(e,t,n,s,i,o,a,l,c){return this.a=Math.cos(a+c)*i,this.b=Math.sin(a+c)*i,this.c=-Math.sin(a-l)*o,this.d=Math.cos(a-l)*o,this.tx=e-(n*this.a+s*this.c),this.ty=t-(n*this.b+s*this.d),this}prepend(e){const t=this.tx;if(e.a!==1||e.b!==0||e.c!==0||e.d!==1){const n=this.a,s=this.c;this.a=n*e.a+this.b*e.c,this.b=n*e.b+this.b*e.d,this.c=s*e.a+this.d*e.c,this.d=s*e.b+this.d*e.d}return this.tx=t*e.a+this.ty*e.c+e.tx,this.ty=t*e.b+this.ty*e.d+e.ty,this}decompose(e){const t=this.a,n=this.b,s=this.c,i=this.d,o=e.pivot,a=-Math.atan2(-s,i),l=Math.atan2(n,t),c=Math.abs(a+l);return c<1e-5||Math.abs(cg-c)<1e-5?(e.rotation=l,e.skew.x=e.skew.y=0):(e.rotation=0,e.skew.x=a,e.skew.y=l),e.scale.x=Math.sqrt(t*t+n*n),e.scale.y=Math.sqrt(s*s+i*i),e.position.x=this.tx+(o.x*t+o.y*s),e.position.y=this.ty+(o.x*n+o.y*i),e}invert(){const e=this.a,t=this.b,n=this.c,s=this.d,i=this.tx,o=e*s-t*n;return this.a=s/o,this.b=-t/o,this.c=-n/o,this.d=e/o,this.tx=(n*this.ty-s*i)/o,this.ty=-(e*this.ty-t*i)/o,this}isIdentity(){return this.a===1&&this.b===0&&this.c===0&&this.d===1&&this.tx===0&&this.ty===0}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}clone(){const e=new W;return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e}copyFrom(e){return this.a=e.a,this.b=e.b,this.c=e.c,this.d=e.d,this.tx=e.tx,this.ty=e.ty,this}equals(e){return e.a===this.a&&e.b===this.b&&e.c===this.c&&e.d===this.d&&e.tx===this.tx&&e.ty===this.ty}toString(){return`[pixi.js:Matrix a=${this.a} b=${this.b} c=${this.c} d=${this.d} tx=${this.tx} ty=${this.ty}]`}static get IDENTITY(){return fg.identity()}static get shared(){return dg.identity()}}const dg=new W,fg=new W,tr=[1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1,0,1],rr=[0,1,1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1],nr=[0,-1,-1,-1,0,1,1,1,0,1,1,1,0,-1,-1,-1],sr=[1,1,0,-1,-1,-1,0,1,-1,-1,0,1,1,1,0,-1],ti=[],cl=[],Vn=Math.sign;function pg(){for(let r=0;r<16;r++){const e=[];ti.push(e);for(let t=0;t<16;t++){const n=Vn(tr[r]*tr[t]+nr[r]*rr[t]),s=Vn(rr[r]*tr[t]+sr[r]*rr[t]),i=Vn(tr[r]*nr[t]+nr[r]*sr[t]),o=Vn(rr[r]*nr[t]+sr[r]*sr[t]);for(let a=0;a<16;a++)if(tr[a]===n&&rr[a]===s&&nr[a]===i&&sr[a]===o){e.push(a);break}}}for(let r=0;r<16;r++){const e=new W;e.set(tr[r],rr[r],nr[r],sr[r],0,0),cl.push(e)}}pg();const ye={E:0,SE:1,S:2,SW:3,W:4,NW:5,N:6,NE:7,MIRROR_VERTICAL:8,MAIN_DIAGONAL:10,MIRROR_HORIZONTAL:12,REVERSE_DIAGONAL:14,uX:r=>tr[r],uY:r=>rr[r],vX:r=>nr[r],vY:r=>sr[r],inv:r=>r&8?r&15:-r&7,add:(r,e)=>ti[r][e],sub:(r,e)=>ti[r][ye.inv(e)],rotate180:r=>r^4,isVertical:r=>(r&3)===2,byDirection:(r,e)=>Math.abs(r)*2<=Math.abs(e)?e>=0?ye.S:ye.N:Math.abs(e)*2<=Math.abs(r)?r>0?ye.E:ye.W:e>0?r>0?ye.SE:ye.SW:r>0?ye.NE:ye.NW,matrixAppendRotationInv:(r,e,t=0,n=0)=>{const s=cl[ye.inv(e)];s.tx=t,s.ty=n,r.append(s)}},Xn=[new ce,new ce,new ce,new ce];class he{constructor(e=0,t=0,n=0,s=0){this.type="rectangle",this.x=Number(e),this.y=Number(t),this.width=Number(n),this.height=Number(s)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}isEmpty(){return this.left===this.right||this.top===this.bottom}static get EMPTY(){return new he(0,0,0,0)}clone(){return new he(this.x,this.y,this.width,this.height)}copyFromBounds(e){return this.x=e.minX,this.y=e.minY,this.width=e.maxX-e.minX,this.height=e.maxY-e.minY,this}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}copyTo(e){return e.copyFrom(this),e}contains(e,t){return this.width<=0||this.height<=0?!1:e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height}strokeContains(e,t,n){const{width:s,height:i}=this;if(s<=0||i<=0)return!1;const o=this.x,a=this.y,l=o-n/2,c=o+s+n/2,h=a-n/2,u=a+i+n/2,d=o+n/2,f=o+s-n/2,p=a+n/2,g=a+i-n/2;return e>=l&&e<=c&&t>=h&&t<=u&&!(e>d&&e<f&&t>p&&t<g)}intersects(e,t){if(!t){const T=this.x<e.x?e.x:this.x;if((this.right>e.right?e.right:this.right)<=T)return!1;const v=this.y<e.y?e.y:this.y;return(this.bottom>e.bottom?e.bottom:this.bottom)>v}const n=this.left,s=this.right,i=this.top,o=this.bottom;if(s<=n||o<=i)return!1;const a=Xn[0].set(e.left,e.top),l=Xn[1].set(e.left,e.bottom),c=Xn[2].set(e.right,e.top),h=Xn[3].set(e.right,e.bottom);if(c.x<=a.x||l.y<=a.y)return!1;const u=Math.sign(t.a*t.d-t.b*t.c);if(u===0||(t.apply(a,a),t.apply(l,l),t.apply(c,c),t.apply(h,h),Math.max(a.x,l.x,c.x,h.x)<=n||Math.min(a.x,l.x,c.x,h.x)>=s||Math.max(a.y,l.y,c.y,h.y)<=i||Math.min(a.y,l.y,c.y,h.y)>=o))return!1;const d=u*(l.y-a.y),f=u*(a.x-l.x),p=d*n+f*i,g=d*s+f*i,m=d*n+f*o,_=d*s+f*o;if(Math.max(p,g,m,_)<=d*a.x+f*a.y||Math.min(p,g,m,_)>=d*h.x+f*h.y)return!1;const b=u*(a.y-c.y),y=u*(c.x-a.x),x=b*n+y*i,S=b*s+y*i,k=b*n+y*o,P=b*s+y*o;return!(Math.max(x,S,k,P)<=b*a.x+y*a.y||Math.min(x,S,k,P)>=b*h.x+y*h.y)}pad(e=0,t=e){return this.x-=e,this.y-=t,this.width+=e*2,this.height+=t*2,this}fit(e){const t=Math.max(this.x,e.x),n=Math.min(this.x+this.width,e.x+e.width),s=Math.max(this.y,e.y),i=Math.min(this.y+this.height,e.y+e.height);return this.x=t,this.width=Math.max(n-t,0),this.y=s,this.height=Math.max(i-s,0),this}ceil(e=1,t=.001){const n=Math.ceil((this.x+this.width-t)*e)/e,s=Math.ceil((this.y+this.height-t)*e)/e;return this.x=Math.floor((this.x+t)*e)/e,this.y=Math.floor((this.y+t)*e)/e,this.width=n-this.x,this.height=s-this.y,this}enlarge(e){const t=Math.min(this.x,e.x),n=Math.max(this.x+this.width,e.x+e.width),s=Math.min(this.y,e.y),i=Math.max(this.y+this.height,e.y+e.height);return this.x=t,this.width=n-t,this.y=s,this.height=i-s,this}getBounds(e){return e=e||new he,e.copyFrom(this),e}toString(){return`[pixi.js/math:Rectangle x=${this.x} y=${this.y} width=${this.width} height=${this.height}]`}}const ri={default:-1};function be(r="default"){return ri[r]===void 0&&(ri[r]=-1),++ri[r]}const hl={},le="8.0.0";function ie(r,e,t=3){if(hl[e])return;let n=new Error().stack;typeof n>"u"?console.warn("PixiJS Deprecation Warning: ",`${e}
Deprecated since v${r}`):(n=n.split(`
`).splice(t).join(`
`),console.groupCollapsed?(console.groupCollapsed("%cPixiJS Deprecation Warning: %c%s","color:#614108;background:#fffbe6","font-weight:normal;color:#614108;background:#fffbe6",`${e}
Deprecated since v${r}`),console.warn(n),console.groupEnd()):(console.warn("PixiJS Deprecation Warning: ",`${e}
Deprecated since v${r}`),console.warn(n))),hl[e]=!0}const ul=()=>{};function Mr(r){return r+=r===0?1:0,--r,r|=r>>>1,r|=r>>>2,r|=r>>>4,r|=r>>>8,r|=r>>>16,r+1}function dl(r){return!(r&r-1)&&!!r}function mg(r){const e={};for(const t in r)r[t]!==void 0&&(e[t]=r[t]);return e}const fl=Object.create(null);function gg(r){const e=fl[r];return e===void 0&&(fl[r]=be("resource")),e}const pl=class Ud extends Ke{constructor(e={}){super(),this._resourceType="textureSampler",this._touched=0,this._maxAnisotropy=1,this.destroyed=!1,e={...Ud.defaultOptions,...e},this.addressMode=e.addressMode,this.addressModeU=e.addressModeU??this.addressModeU,this.addressModeV=e.addressModeV??this.addressModeV,this.addressModeW=e.addressModeW??this.addressModeW,this.scaleMode=e.scaleMode,this.magFilter=e.magFilter??this.magFilter,this.minFilter=e.minFilter??this.minFilter,this.mipmapFilter=e.mipmapFilter??this.mipmapFilter,this.lodMinClamp=e.lodMinClamp,this.lodMaxClamp=e.lodMaxClamp,this.compare=e.compare,this.maxAnisotropy=e.maxAnisotropy??1}set addressMode(e){this.addressModeU=e,this.addressModeV=e,this.addressModeW=e}get addressMode(){return this.addressModeU}set wrapMode(e){ie(le,"TextureStyle.wrapMode is now TextureStyle.addressMode"),this.addressMode=e}get wrapMode(){return this.addressMode}set scaleMode(e){this.magFilter=e,this.minFilter=e,this.mipmapFilter=e}get scaleMode(){return this.magFilter}set maxAnisotropy(e){this._maxAnisotropy=Math.min(e,16),this._maxAnisotropy>1&&(this.scaleMode="linear")}get maxAnisotropy(){return this._maxAnisotropy}get _resourceId(){return this._sharedResourceId||this._generateResourceId()}update(){this.emit("change",this),this._sharedResourceId=null}_generateResourceId(){const e=`${this.addressModeU}-${this.addressModeV}-${this.addressModeW}-${this.magFilter}-${this.minFilter}-${this.mipmapFilter}-${this.lodMinClamp}-${this.lodMaxClamp}-${this.compare}-${this._maxAnisotropy}`;return this._sharedResourceId=gg(e),this._resourceId}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this.removeAllListeners()}};pl.defaultOptions={addressMode:"clamp-to-edge",scaleMode:"linear"};let _g=pl;const ml=class Fd extends Ke{constructor(e={}){super(),this.options=e,this.uid=be("textureSource"),this._resourceType="textureSource",this._resourceId=be("resource"),this.uploadMethodId="unknown",this._resolution=1,this.pixelWidth=1,this.pixelHeight=1,this.width=1,this.height=1,this.sampleCount=1,this.mipLevelCount=1,this.autoGenerateMipmaps=!1,this.format="rgba8unorm",this.dimension="2d",this.antialias=!1,this._touched=0,this._batchTick=-1,this._textureBindLocation=-1,e={...Fd.defaultOptions,...e},this.label=e.label??"",this.resource=e.resource,this.autoGarbageCollect=e.autoGarbageCollect,this._resolution=e.resolution,e.width?this.pixelWidth=e.width*this._resolution:this.pixelWidth=this.resource?this.resourceWidth??1:1,e.height?this.pixelHeight=e.height*this._resolution:this.pixelHeight=this.resource?this.resourceHeight??1:1,this.width=this.pixelWidth/this._resolution,this.height=this.pixelHeight/this._resolution,this.format=e.format,this.dimension=e.dimensions,this.mipLevelCount=e.mipLevelCount,this.autoGenerateMipmaps=e.autoGenerateMipmaps,this.sampleCount=e.sampleCount,this.antialias=e.antialias,this.alphaMode=e.alphaMode,this.style=new _g(mg(e)),this.destroyed=!1,this._refreshPOT()}get source(){return this}get style(){return this._style}set style(e){var t,n;this.style!==e&&((t=this._style)==null||t.off("change",this._onStyleChange,this),this._style=e,(n=this._style)==null||n.on("change",this._onStyleChange,this),this._onStyleChange())}get addressMode(){return this._style.addressMode}set addressMode(e){this._style.addressMode=e}get repeatMode(){return this._style.addressMode}set repeatMode(e){this._style.addressMode=e}get magFilter(){return this._style.magFilter}set magFilter(e){this._style.magFilter=e}get minFilter(){return this._style.minFilter}set minFilter(e){this._style.minFilter=e}get mipmapFilter(){return this._style.mipmapFilter}set mipmapFilter(e){this._style.mipmapFilter=e}get lodMinClamp(){return this._style.lodMinClamp}set lodMinClamp(e){this._style.lodMinClamp=e}get lodMaxClamp(){return this._style.lodMaxClamp}set lodMaxClamp(e){this._style.lodMaxClamp=e}_onStyleChange(){this.emit("styleChange",this)}update(){if(this.resource){const e=this._resolution;if(this.resize(this.resourceWidth/e,this.resourceHeight/e))return}this.emit("update",this)}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this._style&&(this._style.destroy(),this._style=null),this.uploadMethodId=null,this.resource=null,this.removeAllListeners()}unload(){this._resourceId=be("resource"),this.emit("change",this),this.emit("unload",this)}get resourceWidth(){const{resource:e}=this;return e.naturalWidth||e.videoWidth||e.displayWidth||e.width}get resourceHeight(){const{resource:e}=this;return e.naturalHeight||e.videoHeight||e.displayHeight||e.height}get resolution(){return this._resolution}set resolution(e){this._resolution!==e&&(this._resolution=e,this.width=this.pixelWidth/e,this.height=this.pixelHeight/e)}resize(e,t,n){n=n||this._resolution,e=e||this.width,t=t||this.height;const s=Math.round(e*n),i=Math.round(t*n);return this.width=s/n,this.height=i/n,this._resolution=n,this.pixelWidth===s&&this.pixelHeight===i?!1:(this._refreshPOT(),this.pixelWidth=s,this.pixelHeight=i,this.emit("resize",this),this._resourceId=be("resource"),this.emit("change",this),!0)}updateMipmaps(){this.autoGenerateMipmaps&&this.mipLevelCount>1&&this.emit("updateMipmaps",this)}set wrapMode(e){this._style.wrapMode=e}get wrapMode(){return this._style.wrapMode}set scaleMode(e){this._style.scaleMode=e}get scaleMode(){return this._style.scaleMode}_refreshPOT(){this.isPowerOfTwo=dl(this.pixelWidth)&&dl(this.pixelHeight)}static test(e){throw new Error("Unimplemented")}};ml.defaultOptions={resolution:1,format:"bgra8unorm",alphaMode:"premultiply-alpha-on-upload",dimensions:"2d",mipLevelCount:1,autoGenerateMipmaps:!1,sampleCount:1,antialias:!1,autoGarbageCollect:!1};let Ie=ml;class ni extends Ie{constructor(e){const t=e.resource||new Float32Array(e.width*e.height*4);let n=e.format;n||(t instanceof Float32Array?n="rgba32float":t instanceof Int32Array||t instanceof Uint32Array?n="rgba32uint":t instanceof Int16Array||t instanceof Uint16Array?n="rgba16uint":(t instanceof Int8Array,n="bgra8unorm")),super({...e,resource:t,format:n}),this.uploadMethodId="buffer"}static test(e){return e instanceof Int8Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array}}ni.extension=M.TextureSource;const gl=new W;class _l{constructor(e,t){this.mapCoord=new W,this.uClampFrame=new Float32Array(4),this.uClampOffset=new Float32Array(2),this._textureID=-1,this._updateID=0,this.clampOffset=0,typeof t>"u"?this.clampMargin=e.width<10?0:.5:this.clampMargin=t,this.isSimple=!1,this.texture=e}get texture(){return this._texture}set texture(e){var t;this.texture!==e&&((t=this._texture)==null||t.removeListener("update",this.update,this),this._texture=e,this._texture.addListener("update",this.update,this),this.update())}multiplyUvs(e,t){t===void 0&&(t=e);const n=this.mapCoord;for(let s=0;s<e.length;s+=2){const i=e[s],o=e[s+1];t[s]=i*n.a+o*n.c+n.tx,t[s+1]=i*n.b+o*n.d+n.ty}return t}update(){const e=this._texture;this._updateID++;const t=e.uvs;this.mapCoord.set(t.x1-t.x0,t.y1-t.y0,t.x3-t.x0,t.y3-t.y0,t.x0,t.y0);const n=e.orig,s=e.trim;s&&(gl.set(n.width/s.width,0,0,n.height/s.height,-s.x/s.width,-s.y/s.height),this.mapCoord.append(gl));const i=e.source,o=this.uClampFrame,a=this.clampMargin/i._resolution,l=this.clampOffset;return o[0]=(e.frame.x+a+l)/i.width,o[1]=(e.frame.y+a+l)/i.height,o[2]=(e.frame.x+e.frame.width-a+l)/i.width,o[3]=(e.frame.y+e.frame.height-a+l)/i.height,this.uClampOffset[0]=l/i.pixelWidth,this.uClampOffset[1]=l/i.pixelHeight,this.isSimple=e.frame.width===i.width&&e.frame.height===i.height&&e.rotate===0,!0}}class $ extends Ke{constructor({source:e,label:t,frame:n,orig:s,trim:i,defaultAnchor:o,defaultBorders:a,rotate:l,dynamic:c}={}){if(super(),this.uid=be("texture"),this.uvs={x0:0,y0:0,x1:0,y1:0,x2:0,y2:0,x3:0,y3:0},this.frame=new he,this.noFrame=!1,this.dynamic=!1,this.isTexture=!0,this.label=t,this.source=(e==null?void 0:e.source)??new Ie,this.noFrame=!n,n)this.frame.copyFrom(n);else{const{width:h,height:u}=this._source;this.frame.width=h,this.frame.height=u}this.orig=s||this.frame,this.trim=i,this.rotate=l??0,this.defaultAnchor=o,this.defaultBorders=a,this.destroyed=!1,this.dynamic=c||!1,this.updateUvs()}set source(e){this._source&&this._source.off("resize",this.update,this),this._source=e,e.on("resize",this.update,this),this.emit("update",this)}get source(){return this._source}get textureMatrix(){return this._textureMatrix||(this._textureMatrix=new _l(this)),this._textureMatrix}get width(){return this.orig.width}get height(){return this.orig.height}updateUvs(){const{uvs:e,frame:t}=this,{width:n,height:s}=this._source,i=t.x/n,o=t.y/s,a=t.width/n,l=t.height/s;let c=this.rotate;if(c){const h=a/2,u=l/2,d=i+h,f=o+u;c=ye.add(c,ye.NW),e.x0=d+h*ye.uX(c),e.y0=f+u*ye.uY(c),c=ye.add(c,2),e.x1=d+h*ye.uX(c),e.y1=f+u*ye.uY(c),c=ye.add(c,2),e.x2=d+h*ye.uX(c),e.y2=f+u*ye.uY(c),c=ye.add(c,2),e.x3=d+h*ye.uX(c),e.y3=f+u*ye.uY(c)}else e.x0=i,e.y0=o,e.x1=i+a,e.y1=o,e.x2=i+a,e.y2=o+l,e.x3=i,e.y3=o+l}destroy(e=!1){this._source&&e&&(this._source.destroy(),this._source=null),this._textureMatrix=null,this.destroyed=!0,this.emit("destroy",this),this.removeAllListeners()}update(){this.noFrame&&(this.frame.width=this._source.width,this.frame.height=this._source.height),this.updateUvs(),this.emit("update",this)}get baseTexture(){return ie(le,"Texture.baseTexture is now Texture.source"),this._source}}$.EMPTY=new $({label:"EMPTY",source:new Ie({label:"EMPTY"})}),$.EMPTY.destroy=ul,$.WHITE=new $({source:new ni({resource:new Uint8Array([255,255,255,255]),width:1,height:1,alphaMode:"premultiply-alpha-on-upload",label:"WHITE"}),label:"WHITE"}),$.WHITE.destroy=ul;function Yn(r,e,t,n){const{width:s,height:i}=t.orig,o=t.trim;if(o){const a=o.width,l=o.height;r.minX=o.x-e._x*s-n,r.maxX=r.minX+a,r.minY=o.y-e._y*i-n,r.maxY=r.minY+l}else r.minX=-e._x*s-n,r.maxX=r.minX+s,r.minY=-e._y*i-n,r.maxY=r.minY+i}var yg={grad:.9,turn:360,rad:360/(2*Math.PI)},It=function(r){return typeof r=="string"?r.length>0:typeof r=="number"},Ae=function(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=Math.pow(10,e)),Math.round(t*r)/t+0},it=function(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=1),r>t?t:r>e?r:e},yl=function(r){return(r=isFinite(r)?r%360:0)>0?r:r+360},bl=function(r){return{r:it(r.r,0,255),g:it(r.g,0,255),b:it(r.b,0,255),a:it(r.a)}},si=function(r){return{r:Ae(r.r),g:Ae(r.g),b:Ae(r.b),a:Ae(r.a,3)}},bg=/^#([0-9a-f]{3,8})$/i,jn=function(r){var e=r.toString(16);return e.length<2?"0"+e:e},xl=function(r){var e=r.r,t=r.g,n=r.b,s=r.a,i=Math.max(e,t,n),o=i-Math.min(e,t,n),a=o?i===e?(t-n)/o:i===t?2+(n-e)/o:4+(e-t)/o:0;return{h:60*(a<0?a+6:a),s:i?o/i*100:0,v:i/255*100,a:s}},vl=function(r){var e=r.h,t=r.s,n=r.v,s=r.a;e=e/360*6,t/=100,n/=100;var i=Math.floor(e),o=n*(1-t),a=n*(1-(e-i)*t),l=n*(1-(1-e+i)*t),c=i%6;return{r:255*[n,a,o,o,l,n][c],g:255*[l,n,n,a,o,o][c],b:255*[o,o,l,n,n,a][c],a:s}},wl=function(r){return{h:yl(r.h),s:it(r.s,0,100),l:it(r.l,0,100),a:it(r.a)}},Sl=function(r){return{h:Ae(r.h),s:Ae(r.s),l:Ae(r.l),a:Ae(r.a,3)}},Tl=function(r){return vl((t=(e=r).s,{h:e.h,s:(t*=((n=e.l)<50?n:100-n)/100)>0?2*t/(n+t)*100:0,v:n+t,a:e.a}));var e,t,n},Jr=function(r){return{h:(e=xl(r)).h,s:(s=(200-(t=e.s))*(n=e.v)/100)>0&&s<200?t*n/100/(s<=100?s:200-s)*100:0,l:s/2,a:e.a};var e,t,n,s},xg=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,vg=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,wg=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Sg=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,ii={string:[[function(r){var e=bg.exec(r);return e?(r=e[1]).length<=4?{r:parseInt(r[0]+r[0],16),g:parseInt(r[1]+r[1],16),b:parseInt(r[2]+r[2],16),a:r.length===4?Ae(parseInt(r[3]+r[3],16)/255,2):1}:r.length===6||r.length===8?{r:parseInt(r.substr(0,2),16),g:parseInt(r.substr(2,2),16),b:parseInt(r.substr(4,2),16),a:r.length===8?Ae(parseInt(r.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(r){var e=wg.exec(r)||Sg.exec(r);return e?e[2]!==e[4]||e[4]!==e[6]?null:bl({r:Number(e[1])/(e[2]?100/255:1),g:Number(e[3])/(e[4]?100/255:1),b:Number(e[5])/(e[6]?100/255:1),a:e[7]===void 0?1:Number(e[7])/(e[8]?100:1)}):null},"rgb"],[function(r){var e=xg.exec(r)||vg.exec(r);if(!e)return null;var t,n,s=wl({h:(t=e[1],n=e[2],n===void 0&&(n="deg"),Number(t)*(yg[n]||1)),s:Number(e[3]),l:Number(e[4]),a:e[5]===void 0?1:Number(e[5])/(e[6]?100:1)});return Tl(s)},"hsl"]],object:[[function(r){var e=r.r,t=r.g,n=r.b,s=r.a,i=s===void 0?1:s;return It(e)&&It(t)&&It(n)?bl({r:Number(e),g:Number(t),b:Number(n),a:Number(i)}):null},"rgb"],[function(r){var e=r.h,t=r.s,n=r.l,s=r.a,i=s===void 0?1:s;if(!It(e)||!It(t)||!It(n))return null;var o=wl({h:Number(e),s:Number(t),l:Number(n),a:Number(i)});return Tl(o)},"hsl"],[function(r){var e=r.h,t=r.s,n=r.v,s=r.a,i=s===void 0?1:s;if(!It(e)||!It(t)||!It(n))return null;var o=function(a){return{h:yl(a.h),s:it(a.s,0,100),v:it(a.v,0,100),a:it(a.a)}}({h:Number(e),s:Number(t),v:Number(n),a:Number(i)});return vl(o)},"hsv"]]},El=function(r,e){for(var t=0;t<e.length;t++){var n=e[t][0](r);if(n)return[n,e[t][1]]}return[null,void 0]},Tg=function(r){return typeof r=="string"?El(r.trim(),ii.string):typeof r=="object"&&r!==null?El(r,ii.object):[null,void 0]},oi=function(r,e){var t=Jr(r);return{h:t.h,s:it(t.s+100*e,0,100),l:t.l,a:t.a}},ai=function(r){return(299*r.r+587*r.g+114*r.b)/1e3/255},Pl=function(r,e){var t=Jr(r);return{h:t.h,s:t.s,l:it(t.l+100*e,0,100),a:t.a}},li=function(){function r(e){this.parsed=Tg(e)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return r.prototype.isValid=function(){return this.parsed!==null},r.prototype.brightness=function(){return Ae(ai(this.rgba),2)},r.prototype.isDark=function(){return ai(this.rgba)<.5},r.prototype.isLight=function(){return ai(this.rgba)>=.5},r.prototype.toHex=function(){return e=si(this.rgba),t=e.r,n=e.g,s=e.b,o=(i=e.a)<1?jn(Ae(255*i)):"","#"+jn(t)+jn(n)+jn(s)+o;var e,t,n,s,i,o},r.prototype.toRgb=function(){return si(this.rgba)},r.prototype.toRgbString=function(){return e=si(this.rgba),t=e.r,n=e.g,s=e.b,(i=e.a)<1?"rgba("+t+", "+n+", "+s+", "+i+")":"rgb("+t+", "+n+", "+s+")";var e,t,n,s,i},r.prototype.toHsl=function(){return Sl(Jr(this.rgba))},r.prototype.toHslString=function(){return e=Sl(Jr(this.rgba)),t=e.h,n=e.s,s=e.l,(i=e.a)<1?"hsla("+t+", "+n+"%, "+s+"%, "+i+")":"hsl("+t+", "+n+"%, "+s+"%)";var e,t,n,s,i},r.prototype.toHsv=function(){return e=xl(this.rgba),{h:Ae(e.h),s:Ae(e.s),v:Ae(e.v),a:Ae(e.a,3)};var e},r.prototype.invert=function(){return Tt({r:255-(e=this.rgba).r,g:255-e.g,b:255-e.b,a:e.a});var e},r.prototype.saturate=function(e){return e===void 0&&(e=.1),Tt(oi(this.rgba,e))},r.prototype.desaturate=function(e){return e===void 0&&(e=.1),Tt(oi(this.rgba,-e))},r.prototype.grayscale=function(){return Tt(oi(this.rgba,-1))},r.prototype.lighten=function(e){return e===void 0&&(e=.1),Tt(Pl(this.rgba,e))},r.prototype.darken=function(e){return e===void 0&&(e=.1),Tt(Pl(this.rgba,-e))},r.prototype.rotate=function(e){return e===void 0&&(e=15),this.hue(this.hue()+e)},r.prototype.alpha=function(e){return typeof e=="number"?Tt({r:(t=this.rgba).r,g:t.g,b:t.b,a:e}):Ae(this.rgba.a,3);var t},r.prototype.hue=function(e){var t=Jr(this.rgba);return typeof e=="number"?Tt({h:e,s:t.s,l:t.l,a:t.a}):Ae(t.h)},r.prototype.isEqual=function(e){return this.toHex()===Tt(e).toHex()},r}(),Tt=function(r){return r instanceof li?r:new li(r)},Al=[],Eg=function(r){r.forEach(function(e){Al.indexOf(e)<0&&(e(li,ii),Al.push(e))})};function Pg(r,e){var t={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},n={};for(var s in t)n[t[s]]=s;var i={};r.prototype.toName=function(o){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var a,l,c=n[this.toHex()];if(c)return c;if(o!=null&&o.closest){var h=this.toRgb(),u=1/0,d="black";if(!i.length)for(var f in t)i[f]=new r(t[f]).toRgb();for(var p in t){var g=(a=h,l=i[p],Math.pow(a.r-l.r,2)+Math.pow(a.g-l.g,2)+Math.pow(a.b-l.b,2));g<u&&(u=g,d=p)}return d}},e.string.push([function(o){var a=o.toLowerCase(),l=a==="transparent"?"#0000":t[a];return l?new r(l).toRgb():null},"name"])}Eg([Pg]);const Cr=class En{constructor(e=16777215){this._value=null,this._components=new Float32Array(4),this._components.fill(1),this._int=16777215,this.value=e}get red(){return this._components[0]}get green(){return this._components[1]}get blue(){return this._components[2]}get alpha(){return this._components[3]}setValue(e){return this.value=e,this}set value(e){if(e instanceof En)this._value=this._cloneSource(e._value),this._int=e._int,this._components.set(e._components);else{if(e===null)throw new Error("Cannot set Color#value to null");(this._value===null||!this._isSourceEqual(this._value,e))&&(this._normalize(e),this._value=this._cloneSource(e))}}get value(){return this._value}_cloneSource(e){return typeof e=="string"||typeof e=="number"||e instanceof Number||e===null?e:Array.isArray(e)||ArrayBuffer.isView(e)?e.slice(0):typeof e=="object"&&e!==null?{...e}:e}_isSourceEqual(e,t){const n=typeof e;if(n!==typeof t)return!1;if(n==="number"||n==="string"||e instanceof Number)return e===t;if(Array.isArray(e)&&Array.isArray(t)||ArrayBuffer.isView(e)&&ArrayBuffer.isView(t))return e.length!==t.length?!1:e.every((i,o)=>i===t[o]);if(e!==null&&t!==null){const i=Object.keys(e),o=Object.keys(t);return i.length!==o.length?!1:i.every(a=>e[a]===t[a])}return e===t}toRgba(){const[e,t,n,s]=this._components;return{r:e,g:t,b:n,a:s}}toRgb(){const[e,t,n]=this._components;return{r:e,g:t,b:n}}toRgbaString(){const[e,t,n]=this.toUint8RgbArray();return`rgba(${e},${t},${n},${this.alpha})`}toUint8RgbArray(e){const[t,n,s]=this._components;return this._arrayRgb||(this._arrayRgb=[]),e=e||this._arrayRgb,e[0]=Math.round(t*255),e[1]=Math.round(n*255),e[2]=Math.round(s*255),e}toArray(e){this._arrayRgba||(this._arrayRgba=[]),e=e||this._arrayRgba;const[t,n,s,i]=this._components;return e[0]=t,e[1]=n,e[2]=s,e[3]=i,e}toRgbArray(e){this._arrayRgb||(this._arrayRgb=[]),e=e||this._arrayRgb;const[t,n,s]=this._components;return e[0]=t,e[1]=n,e[2]=s,e}toNumber(){return this._int}toBgrNumber(){const[e,t,n]=this.toUint8RgbArray();return(n<<16)+(t<<8)+e}toLittleEndianNumber(){const e=this._int;return(e>>16)+(e&65280)+((e&255)<<16)}multiply(e){const[t,n,s,i]=En._temp.setValue(e)._components;return this._components[0]*=t,this._components[1]*=n,this._components[2]*=s,this._components[3]*=i,this._refreshInt(),this._value=null,this}premultiply(e,t=!0){return t&&(this._components[0]*=e,this._components[1]*=e,this._components[2]*=e),this._components[3]=e,this._refreshInt(),this._value=null,this}toPremultiplied(e,t=!0){if(e===1)return(255<<24)+this._int;if(e===0)return t?0:this._int;let n=this._int>>16&255,s=this._int>>8&255,i=this._int&255;return t&&(n=n*e+.5|0,s=s*e+.5|0,i=i*e+.5|0),(e*255<<24)+(n<<16)+(s<<8)+i}toHex(){const e=this._int.toString(16);return`#${"000000".substring(0,6-e.length)+e}`}toHexa(){const t=Math.round(this._components[3]*255).toString(16);return this.toHex()+"00".substring(0,2-t.length)+t}setAlpha(e){return this._components[3]=this._clamp(e),this}_normalize(e){let t,n,s,i;if((typeof e=="number"||e instanceof Number)&&e>=0&&e<=16777215){const o=e;t=(o>>16&255)/255,n=(o>>8&255)/255,s=(o&255)/255,i=1}else if((Array.isArray(e)||e instanceof Float32Array)&&e.length>=3&&e.length<=4)e=this._clamp(e),[t,n,s,i=1]=e;else if((e instanceof Uint8Array||e instanceof Uint8ClampedArray)&&e.length>=3&&e.length<=4)e=this._clamp(e,0,255),[t,n,s,i=255]=e,t/=255,n/=255,s/=255,i/=255;else if(typeof e=="string"||typeof e=="object"){if(typeof e=="string"){const a=En.HEX_PATTERN.exec(e);a&&(e=`#${a[2]}`)}const o=Tt(e);o.isValid()&&({r:t,g:n,b:s,a:i}=o.rgba,t/=255,n/=255,s/=255)}if(t!==void 0)this._components[0]=t,this._components[1]=n,this._components[2]=s,this._components[3]=i,this._refreshInt();else throw new Error(`Unable to convert color ${e}`)}_refreshInt(){this._clamp(this._components);const[e,t,n]=this._components;this._int=(e*255<<16)+(t*255<<8)+(n*255|0)}_clamp(e,t=0,n=1){return typeof e=="number"?Math.min(Math.max(e,t),n):(e.forEach((s,i)=>{e[i]=Math.min(Math.max(s,t),n)}),e)}static isColorLike(e){return typeof e=="number"||typeof e=="string"||e instanceof Number||e instanceof En||Array.isArray(e)||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Float32Array||e.r!==void 0&&e.g!==void 0&&e.b!==void 0||e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0||e.h!==void 0&&e.s!==void 0&&e.l!==void 0||e.h!==void 0&&e.s!==void 0&&e.l!==void 0&&e.a!==void 0||e.h!==void 0&&e.s!==void 0&&e.v!==void 0||e.h!==void 0&&e.s!==void 0&&e.v!==void 0&&e.a!==void 0}};Cr.shared=new Cr,Cr._temp=new Cr,Cr.HEX_PATTERN=/^(#|0x)?(([a-f0-9]{3}){1,2}([a-f0-9]{2})?)$/i;let ue=Cr;const Ag={cullArea:null,cullable:!1,cullableChildren:!0};function Ml(r,e,t){const n=r.length;let s;if(e>=n||t===0)return;t=e+t>n?n-e:t;const i=n-t;for(s=e;s<i;++s)r[s]=r[s+t];r.length=i}const Mg={allowChildren:!0,removeChildren(r=0,e){const t=e??this.children.length,n=t-r,s=[];if(n>0&&n<=t){for(let i=t-1;i>=r;i--){const o=this.children[i];o&&(this.renderGroup&&this.renderGroup.removeChild(o),s.push(o),o.parent=null)}Ml(this.children,r,t);for(let i=0;i<s.length;++i)this.emit("childRemoved",s[i],this,i),s[i].emit("removed",this);return s}else if(n===0&&this.children.length===0)return s;throw new RangeError("removeChildren: numeric values are outside the acceptable range.")},removeChildAt(r){const e=this.getChildAt(r);return this.removeChild(e)},getChildAt(r){if(r<0||r>=this.children.length)throw new Error(`getChildAt: Index (${r}) does not exist.`);return this.children[r]},setChildIndex(r,e){if(e<0||e>=this.children.length)throw new Error(`The index ${e} supplied is out of bounds ${this.children.length}`);this.getChildIndex(r),this.addChildAt(r,e)},getChildIndex(r){const e=this.children.indexOf(r);if(e===-1)throw new Error("The supplied Container must be a child of the caller");return e},addChildAt(r,e){this.allowChildren||ie(le,"addChildAt: Only Containers will be allowed to add children in v8.0.0");const{children:t}=this;if(e<0||e>t.length)throw new Error(`${r}addChildAt: The index ${e} supplied is out of bounds ${t.length}`);if(r.parent){const n=r.parent.children.indexOf(r);if(r.parent===this&&n===e)return r;n!==-1&&r.parent.children.splice(n,1)}return e===t.length?t.push(r):t.splice(e,0,r),r.parent=this,r.didChange=!0,r.didViewUpdate=!1,r._updateFlags=15,this.renderGroup&&this.renderGroup.addChild(r),this.sortableChildren&&(this.sortDirty=!0),this.emit("childAdded",r,this,e),r.emit("added",this),r},swapChildren(r,e){if(r===e)return;const t=this.getChildIndex(r),n=this.getChildIndex(e);this.children[t]=e,this.children[n]=r},removeFromParent(){var r;(r=this.parent)==null||r.removeChild(this)}};class ci{constructor(e){this.pipe="filter",this.priority=1,this.filters=e==null?void 0:e.filters,this.filterArea=e==null?void 0:e.filterArea}destroy(){for(let e=0;e<this.filters.length;e++)this.filters[e].destroy();this.filters=null,this.filterArea=null}}class hi{constructor(e,t){this._pool=[],this._count=0,this._index=0,this._classType=e,t&&this.prepopulate(t)}prepopulate(e){for(let t=0;t<e;t++)this._pool[this._index++]=new this._classType;this._count+=e}get(e){var n;let t;return this._index>0?t=this._pool[--this._index]:t=new this._classType,(n=t.init)==null||n.call(t,e),t}return(e){var t;(t=e.reset)==null||t.call(e),this._pool[this._index++]=e}get totalSize(){return this._count}get totalFree(){return this._index}get totalUsed(){return this._count-this._index}}class Cg{constructor(){this._poolsByClass=new Map}prepopulate(e,t){this.getPool(e).prepopulate(t)}get(e,t){return this.getPool(e).get(t)}return(e){this.getPool(e.constructor).return(e)}getPool(e){return this._poolsByClass.has(e)||this._poolsByClass.set(e,new hi(e)),this._poolsByClass.get(e)}stats(){const e={};return this._poolsByClass.forEach(t=>{const n=e[t._classType.name]?t._classType.name+t._classType.ID:t._classType.name;e[n]={free:t.totalFree,used:t.totalUsed,size:t.totalSize}}),e}}const oe=new Cg;class Bg{constructor(){this._effectClasses=[],this._tests=[],this._initialized=!1}init(){this._initialized||(this._initialized=!0,this._effectClasses.forEach(e=>{this.add({test:e.test,maskClass:e})}))}add(e){this._tests.push(e)}getMaskEffect(e){this._initialized||this.init();for(let t=0;t<this._tests.length;t++){const n=this._tests[t];if(n.test(e))return oe.get(n.maskClass,e)}return e}returnMaskEffect(e){oe.return(e)}}const ui=new Bg;re.handleByList(M.MaskEffect,ui._effectClasses);const Rg={_mask:null,_filters:null,effects:[],addEffect(r){this.effects.indexOf(r)===-1&&(this.effects.push(r),this.effects.sort((t,n)=>t.priority-n.priority),this.renderGroup&&(this.renderGroup.structureDidChange=!0),this._updateIsSimple())},removeEffect(r){const e=this.effects.indexOf(r);e!==-1&&(this.effects.splice(e,1),!this.isRenderGroupRoot&&this.renderGroup&&(this.renderGroup.structureDidChange=!0),this._updateIsSimple())},set mask(r){if(this._mask||(this._mask={mask:null,effect:null}),this._mask.mask===r||(this._mask.effect&&(this.removeEffect(this._mask.effect),ui.returnMaskEffect(this._mask.effect),this._mask.effect=null),this._mask.mask=r,r==null))return;const e=ui.getMaskEffect(r);this._mask.effect=e,this.addEffect(e)},get mask(){var r;return(r=this._mask)==null?void 0:r.mask},set filters(r){!Array.isArray(r)&&r&&(r=[r]),r=r,this._filters||(this._filters={filters:null,effect:null,filterArea:null});const e=(r==null?void 0:r.length)>0,t=this._filters.effect&&!e||!this._filters.effect&&e;if(r=Array.isArray(r)?r.slice(0):r,this._filters.filters=Object.freeze(r),t)if(e){const n=oe.get(ci);this._filters.effect=n,this.addEffect(n)}else{const n=this._filters.effect;this.removeEffect(n),n.filterArea=null,n.filters=null,this._filters.effect=null,oe.return(n)}e&&(this._filters.effect.filters=r,this._filters.effect.filterArea=this.filterArea)},get filters(){var r;return(r=this._filters)==null?void 0:r.filters},set filterArea(r){this._filters||(this._filters={filters:null,effect:null,filterArea:null}),this._filters.filterArea=r},get filterArea(){var r;return(r=this._filters)==null?void 0:r.filterArea}},kg={label:null,get name(){return ie(le,"Container.name property has been removed, use Container.label instead"),this.label},set name(r){ie(le,"Container.name property has been removed, use Container.label instead"),this.label=r},getChildByName(r,e=!1){return this.getChildByLabel(r,e)},getChildByLabel(r,e=!1){const t=this.children;for(let n=0;n<t.length;n++){const s=t[n];if(s.label===r||r instanceof RegExp&&r.test(s.label))return s}if(e)for(let n=0;n<t.length;n++){const i=t[n].getChildByLabel(r,!0);if(i)return i}return null},getChildrenByLabel(r,e=!1,t=[]){const n=this.children;for(let s=0;s<n.length;s++){const i=n[s];(i.label===r||r instanceof RegExp&&r.test(i.label))&&t.push(i)}if(e)for(let s=0;s<n.length;s++)n[s].getChildrenByLabel(r,!0,t);return t}},Cl=new W;class Ze{constructor(e=1/0,t=1/0,n=-1/0,s=-1/0){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.matrix=Cl,this.minX=e,this.minY=t,this.maxX=n,this.maxY=s}isEmpty(){return this.minX>this.maxX||this.minY>this.maxY}get rectangle(){this._rectangle||(this._rectangle=new he);const e=this._rectangle;return this.minX>this.maxX||this.minY>this.maxY?(e.x=0,e.y=0,e.width=0,e.height=0):e.copyFromBounds(this),e}clear(){return this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.matrix=Cl,this}set(e,t,n,s){this.minX=e,this.minY=t,this.maxX=n,this.maxY=s}addFrame(e,t,n,s,i){i||(i=this.matrix);const o=i.a,a=i.b,l=i.c,c=i.d,h=i.tx,u=i.ty;let d=this.minX,f=this.minY,p=this.maxX,g=this.maxY,m=o*e+l*t+h,_=a*e+c*t+u;m<d&&(d=m),_<f&&(f=_),m>p&&(p=m),_>g&&(g=_),m=o*n+l*t+h,_=a*n+c*t+u,m<d&&(d=m),_<f&&(f=_),m>p&&(p=m),_>g&&(g=_),m=o*e+l*s+h,_=a*e+c*s+u,m<d&&(d=m),_<f&&(f=_),m>p&&(p=m),_>g&&(g=_),m=o*n+l*s+h,_=a*n+c*s+u,m<d&&(d=m),_<f&&(f=_),m>p&&(p=m),_>g&&(g=_),this.minX=d,this.minY=f,this.maxX=p,this.maxY=g}addRect(e,t){this.addFrame(e.x,e.y,e.x+e.width,e.y+e.height,t)}addBounds(e,t){this.addFrame(e.minX,e.minY,e.maxX,e.maxY,t)}addBoundsMask(e){this.minX=this.minX>e.minX?this.minX:e.minX,this.minY=this.minY>e.minY?this.minY:e.minY,this.maxX=this.maxX<e.maxX?this.maxX:e.maxX,this.maxY=this.maxY<e.maxY?this.maxY:e.maxY}applyMatrix(e){const t=this.minX,n=this.minY,s=this.maxX,i=this.maxY,{a:o,b:a,c:l,d:c,tx:h,ty:u}=e;let d=o*t+l*n+h,f=a*t+c*n+u;this.minX=d,this.minY=f,this.maxX=d,this.maxY=f,d=o*s+l*n+h,f=a*s+c*n+u,this.minX=d<this.minX?d:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=d>this.maxX?d:this.maxX,this.maxY=f>this.maxY?f:this.maxY,d=o*t+l*i+h,f=a*t+c*i+u,this.minX=d<this.minX?d:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=d>this.maxX?d:this.maxX,this.maxY=f>this.maxY?f:this.maxY,d=o*s+l*i+h,f=a*s+c*i+u,this.minX=d<this.minX?d:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=d>this.maxX?d:this.maxX,this.maxY=f>this.maxY?f:this.maxY}fit(e){return this.minX<e.left&&(this.minX=e.left),this.maxX>e.right&&(this.maxX=e.right),this.minY<e.top&&(this.minY=e.top),this.maxY>e.bottom&&(this.maxY=e.bottom),this}fitBounds(e,t,n,s){return this.minX<e&&(this.minX=e),this.maxX>t&&(this.maxX=t),this.minY<n&&(this.minY=n),this.maxY>s&&(this.maxY=s),this}pad(e,t=e){return this.minX-=e,this.maxX+=e,this.minY-=t,this.maxY+=t,this}ceil(){return this.minX=Math.floor(this.minX),this.minY=Math.floor(this.minY),this.maxX=Math.ceil(this.maxX),this.maxY=Math.ceil(this.maxY),this}clone(){return new Ze(this.minX,this.minY,this.maxX,this.maxY)}scale(e,t=e){return this.minX*=e,this.minY*=t,this.maxX*=e,this.maxY*=t,this}get x(){return this.minX}set x(e){const t=this.maxX-this.minX;this.minX=e,this.maxX=e+t}get y(){return this.minY}set y(e){const t=this.maxY-this.minY;this.minY=e,this.maxY=e+t}get width(){return this.maxX-this.minX}set width(e){this.maxX=this.minX+e}get height(){return this.maxY-this.minY}set height(e){this.maxY=this.minY+e}get left(){return this.minX}get right(){return this.maxX}get top(){return this.minY}get bottom(){return this.maxY}get isPositive(){return this.maxX-this.minX>0&&this.maxY-this.minY>0}get isValid(){return this.minX+this.minY!==1/0}addVertexData(e,t,n,s){let i=this.minX,o=this.minY,a=this.maxX,l=this.maxY;s||(s=this.matrix);const c=s.a,h=s.b,u=s.c,d=s.d,f=s.tx,p=s.ty;for(let g=t;g<n;g+=2){const m=e[g],_=e[g+1],b=c*m+u*_+f,y=h*m+d*_+p;i=b<i?b:i,o=y<o?y:o,a=b>a?b:a,l=y>l?y:l}this.minX=i,this.minY=o,this.maxX=a,this.maxY=l}containsPoint(e,t){return this.minX<=e&&this.minY<=t&&this.maxX>=e&&this.maxY>=t}toString(){return`[pixi.js:Bounds minX=${this.minX} minY=${this.minY} maxX=${this.maxX} maxY=${this.maxY} width=${this.width} height=${this.height}]`}}const Gt=new hi(W),Ut=new hi(Ze);function di(r,e,t){t.clear();let n,s;return r.parent?e?n=r.parent.worldTransform:(s=Gt.get().identity(),n=qn(r,s)):n=W.IDENTITY,Bl(r,t,n,e),s&&Gt.return(s),t.isValid||t.set(0,0,0,0),t}function Bl(r,e,t,n){var a,l;if(!r.visible||!r.measurable)return;let s;n?s=r.worldTransform:(r.updateLocalTransform(),s=Gt.get(),s.appendFrom(r.localTransform,t));const i=e,o=!!r.effects.length;if(o&&(e=Ut.get().clear()),r.boundsArea)e.addRect(r.boundsArea,s);else{r.addBounds&&(e.matrix=s,r.addBounds(e));for(let c=0;c<r.children.length;c++)Bl(r.children[c],e,s,n)}if(o){for(let c=0;c<r.effects.length;c++)(l=(a=r.effects[c]).addBounds)==null||l.call(a,e);i.addBounds(e,W.IDENTITY),Ut.return(e)}n||Gt.return(s)}function qn(r,e){const t=r.parent;return t&&(qn(t,e),t.updateLocalTransform(),e.append(t.localTransform)),e}let fi=0;const Rl=500;function ne(...r){fi!==Rl&&(fi++,fi===Rl?console.warn("PixiJS Warning: too many warnings, no more warnings will be reported to the console by PixiJS."):console.warn("PixiJS Warning: ",...r))}function pi(r,e,t){return e.clear(),t||(t=W.IDENTITY),kl(r,e,t,r,!0),e.isValid||e.set(0,0,0,0),e}function kl(r,e,t,n,s){var l,c;let i;if(s)i=Gt.get(),i=t.copyTo(i);else{if(!r.visible||!r.measurable)return;r.updateLocalTransform();const h=r.localTransform;i=Gt.get(),i.appendFrom(h,t)}const o=e,a=!!r.effects.length;if(a&&(e=Ut.get().clear()),r.boundsArea)e.addRect(r.boundsArea,i);else{r.renderPipeId&&(e.matrix=i,r.addBounds(e));const h=r.children;for(let u=0;u<h.length;u++)kl(h[u],e,i,n,!1)}if(a){for(let h=0;h<r.effects.length;h++)(c=(l=r.effects[h]).addLocalBounds)==null||c.call(l,e,n);o.addBounds(e,W.IDENTITY),Ut.return(e)}Gt.return(i)}function Il(r,e){const t=r.children;for(let n=0;n<t.length;n++){const s=t[n],i=(s.uid&255)<<24|s._didChangeId&16777215;e.data[e.index]!==i&&(e.data[e.index]=i,e.didChange=!0),e.index++,s.children.length&&Il(s,e)}return e.didChange}const Ig=new W,Gg={_localBoundsCacheId:-1,_localBoundsCacheData:null,_setWidth(r,e){const t=Math.sign(this.scale.x)||1;e!==0?this.scale.x=r/e*t:this.scale.x=t},_setHeight(r,e){const t=Math.sign(this.scale.y)||1;e!==0?this.scale.y=r/e*t:this.scale.y=t},getLocalBounds(){this._localBoundsCacheData||(this._localBoundsCacheData={data:[],index:1,didChange:!1,localBounds:new Ze});const r=this._localBoundsCacheData;return r.index=1,r.didChange=!1,r.data[0]!==this._didChangeId>>12&&(r.didChange=!0,r.data[0]=this._didChangeId>>12),Il(this,r),r.didChange&&pi(this,r.localBounds,Ig),r.localBounds},getBounds(r,e){return di(this,r,e||new Ze)}},Ug={_onRender:null,set onRender(r){const e=this.renderGroup;if(!r){this._onRender&&(e==null||e.removeOnRender(this)),this._onRender=null;return}this._onRender||e==null||e.addOnRender(this),this._onRender=r},get onRender(){return this._onRender}},Fg={_zIndex:0,sortDirty:!1,sortableChildren:!1,get zIndex(){return this._zIndex},set zIndex(r){this._zIndex!==r&&(this._zIndex=r,this.depthOfChildModified())},depthOfChildModified(){this.parent&&(this.parent.sortableChildren=!0,this.parent.sortDirty=!0),this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0)},sortChildren(){this.sortDirty&&(this.sortDirty=!1,this.children.sort(Og))}};function Og(r,e){return r._zIndex-e._zIndex}const Dg={getGlobalPosition(r=new ce,e=!1){return this.parent?this.parent.toGlobal(this._position,r,e):(r.x=this._position.x,r.y=this._position.y),r},toGlobal(r,e,t=!1){if(!t){this.updateLocalTransform();const n=qn(this,new W);return n.append(this.localTransform),n.apply(r,e)}return this.worldTransform.apply(r,e)},toLocal(r,e,t,n){if(e&&(r=e.toGlobal(r,t,n)),!n){this.updateLocalTransform();const s=qn(this,new W);return s.append(this.localTransform),s.applyInverse(r,t)}return this.worldTransform.applyInverse(r,t)}};class Gl{constructor(){this.uid=be("instructionSet"),this.instructions=[],this.instructionSize=0}reset(){this.instructionSize=0}add(e){this.instructions[this.instructionSize++]=e}log(){this.instructions.length=this.instructionSize,console.table(this.instructions,["type","action"])}}class Lg{constructor(e){this.renderPipeId="renderGroup",this.root=null,this.canBundle=!1,this.renderGroupParent=null,this.renderGroupChildren=[],this._children=[],this.worldTransform=new W,this.worldColorAlpha=4294967295,this.worldColor=16777215,this.worldAlpha=1,this.childrenToUpdate=Object.create(null),this.updateTick=0,this.childrenRenderablesToUpdate={list:[],index:0},this.structureDidChange=!0,this.instructionSet=new Gl,this._onRenderContainers=[],this.root=e,this.addChild(e)}get localTransform(){return this.root.localTransform}addRenderGroupChild(e){e.renderGroupParent&&e.renderGroupParent._removeRenderGroupChild(e),e.renderGroupParent=this,this.onChildUpdate(e.root),this.renderGroupChildren.push(e)}_removeRenderGroupChild(e){e.root.didChange&&this._removeChildFromUpdate(e.root);const t=this.renderGroupChildren.indexOf(e);t>-1&&this.renderGroupChildren.splice(t,1),e.renderGroupParent=null}addChild(e){if(this.structureDidChange=!0,e!==this.root&&(this._children.push(e),e.updateTick=-1,e.parent===this.root?e.relativeRenderGroupDepth=1:e.relativeRenderGroupDepth=e.parent.relativeRenderGroupDepth+1),e.renderGroup){if(e.renderGroup.root===e){this.addRenderGroupChild(e.renderGroup);return}}else e.renderGroup=this,e.didChange=!0;e._onRender&&(e.isRenderGroupRoot?e.renderGroup.root===e&&this.addOnRender(e):this.addOnRender(e));const t=e.children;e.isRenderGroupRoot||this.onChildUpdate(e);for(let n=0;n<t.length;n++)this.addChild(t[n])}removeChild(e){if(this.structureDidChange=!0,e._onRender&&(e.isRenderGroupRoot?e.renderGroup.root===e&&this.removeOnRender(e):this.removeOnRender(e)),e.renderGroup.root!==e){const n=e.children;for(let s=0;s<n.length;s++)this.removeChild(n[s]);e.didChange&&e.renderGroup._removeChildFromUpdate(e),e.renderGroup=null}else this._removeRenderGroupChild(e.renderGroup);const t=this._children.indexOf(e);t>-1&&this._children.splice(t,1)}onChildUpdate(e){let t=this.childrenToUpdate[e.relativeRenderGroupDepth];t||(t=this.childrenToUpdate[e.relativeRenderGroupDepth]={index:0,list:[]}),t.list[t.index++]=e}updateRenderable(e){e.globalDisplayStatus<7||(e.didViewUpdate=!1,this.instructionSet.renderPipes[e.renderPipeId].updateRenderable(e))}onChildViewUpdate(e){this.childrenRenderablesToUpdate.list[this.childrenRenderablesToUpdate.index++]=e}_removeChildFromUpdate(e){const t=this.childrenToUpdate[e.relativeRenderGroupDepth];if(!t)return;const n=t.list.indexOf(e);n>-1&&t.list.splice(n,1),t.index--}get isRenderable(){return this.root.localDisplayStatus===7&&this.worldAlpha>0}addOnRender(e){this._onRenderContainers.push(e)}removeOnRender(e){this._onRenderContainers.splice(this._onRenderContainers.indexOf(e),1)}runOnRender(){for(let e=0;e<this._onRenderContainers.length;e++)this._onRenderContainers[e]._onRender()}}function Ng(r,e,t={}){for(const n in e)!t[n]&&e[n]!==void 0&&(r[n]=e[n])}const mi=new qe(null),gi=new qe(null),_i=new qe(null,1,1),yi=1,Ul=2,Kn=4;class Se extends Ke{constructor(e={}){var t,n;super(),this.uid=be("renderable"),this._updateFlags=15,this.isRenderGroupRoot=!1,this.renderGroup=null,this.didChange=!1,this.didViewUpdate=!1,this.relativeRenderGroupDepth=0,this.children=[],this.parent=null,this.includeInBuild=!0,this.measurable=!0,this.isSimple=!0,this.updateTick=-1,this.localTransform=new W,this.relativeGroupTransform=new W,this.groupTransform=this.relativeGroupTransform,this.destroyed=!1,this._position=new qe(this,0,0),this._scale=_i,this._pivot=gi,this._skew=mi,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._rotation=0,this.localColor=16777215,this.localAlpha=1,this.groupAlpha=1,this.groupColor=16777215,this.groupColorAlpha=4294967295,this.localBlendMode="inherit",this.groupBlendMode="normal",this.localDisplayStatus=7,this.globalDisplayStatus=7,this._didChangeId=0,this._didLocalTransformChangeId=-1,Ng(this,e,{children:!0,parent:!0,effects:!0}),(t=e.children)==null||t.forEach(s=>this.addChild(s)),this.effects=[],(n=e.parent)==null||n.addChild(this)}static mixin(e){Object.defineProperties(Se.prototype,Object.getOwnPropertyDescriptors(e))}addChild(...e){if(this.allowChildren||ie(le,"addChild: Only Containers will be allowed to add children in v8.0.0"),e.length>1){for(let n=0;n<e.length;n++)this.addChild(e[n]);return e[0]}const t=e[0];return t.parent===this?(this.children.splice(this.children.indexOf(t),1),this.children.push(t),this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),t):(t.parent&&t.parent.removeChild(t),this.children.push(t),this.sortableChildren&&(this.sortDirty=!0),t.parent=this,t.didChange=!0,t.didViewUpdate=!1,t._updateFlags=15,this.renderGroup&&this.renderGroup.addChild(t),this.emit("childAdded",t,this,this.children.length-1),t.emit("added",this),this._didChangeId+=4096,t._zIndex!==0&&t.depthOfChildModified(),t)}removeChild(...e){if(e.length>1){for(let s=0;s<e.length;s++)this.removeChild(e[s]);return e[0]}const t=e[0],n=this.children.indexOf(t);return n>-1&&(this._didChangeId+=4096,this.children.splice(n,1),this.renderGroup&&this.renderGroup.removeChild(t),t.parent=null,this.emit("childRemoved",t,this,n),t.emit("removed",this)),t}_onUpdate(e){if(e&&e===this._skew&&this._updateSkew(),this._didChangeId++,!this.didChange)if(this.didChange=!0,this.isRenderGroupRoot){const t=this.renderGroup.renderGroupParent;t&&t.onChildUpdate(this)}else this.renderGroup&&this.renderGroup.onChildUpdate(this)}set isRenderGroup(e){if(this.isRenderGroupRoot&&e===!1)throw new Error("[Pixi] cannot undo a render group just yet");e&&this.enableRenderGroup()}get isRenderGroup(){return this.isRenderGroupRoot}enableRenderGroup(){if(this.renderGroup&&this.renderGroup.root===this)return;this.isRenderGroupRoot=!0;const e=this.renderGroup;if(e&&e.removeChild(this),this.renderGroup=new Lg(this),e){for(let t=0;t<e.renderGroupChildren.length;t++){const n=e.renderGroupChildren[t];let s=n.root;for(;s;){if(s===this){this.renderGroup.addRenderGroupChild(n);break}s=s.parent}}e.addRenderGroupChild(this.renderGroup)}this._updateIsSimple(),this.groupTransform=W.IDENTITY}_updateIsSimple(){this.isSimple=!this.isRenderGroupRoot&&this.effects.length===0}get worldTransform(){return this._worldTransform||(this._worldTransform=new W),this.renderGroup&&(this.isRenderGroupRoot?this._worldTransform.copyFrom(this.renderGroup.worldTransform):this._worldTransform.appendFrom(this.relativeGroupTransform,this.renderGroup.worldTransform)),this._worldTransform}get x(){return this._position.x}set x(e){this._position.x=e}get y(){return this._position.y}set y(e){this._position.y=e}get position(){return this._position}set position(e){this._position.copyFrom(e)}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._onUpdate(this._skew))}get angle(){return this.rotation*hg}set angle(e){this.rotation=e*ug}get pivot(){return this._pivot===gi&&(this._pivot=new qe(this,0,0)),this._pivot}set pivot(e){this._pivot===gi&&(this._pivot=new qe(this,0,0)),typeof e=="number"?this._pivot.set(e):this._pivot.copyFrom(e)}get skew(){return this._skew===mi&&(this._skew=new qe(this,0,0)),this._skew}set skew(e){this._skew===mi&&(this._skew=new qe(this,0,0)),this._skew.copyFrom(e)}get scale(){return this._scale===_i&&(this._scale=new qe(this,1,1)),this._scale}set scale(e){this._scale===_i&&(this._scale=new qe(this,0,0)),typeof e=="number"?this._scale.set(e):this._scale.copyFrom(e)}get width(){return Math.abs(this.scale.x*this.getLocalBounds().width)}set width(e){const t=this.getLocalBounds().width;this._setWidth(e,t)}get height(){return Math.abs(this.scale.y*this.getLocalBounds().height)}set height(e){const t=this.getLocalBounds().height;this._setHeight(e,t)}getSize(e){e||(e={});const t=this.getLocalBounds();return e.width=Math.abs(this.scale.x*t.width),e.height=Math.abs(this.scale.y*t.height),e}setSize(e,t){const n=this.getLocalBounds();let s,i;typeof e!="object"?(s=e,i=t??e):(s=e.width,i=e.height??e.width),s!==void 0&&this._setWidth(s,n.width),i!==void 0&&this._setHeight(i,n.height)}_updateSkew(){const e=this._rotation,t=this._skew;this._cx=Math.cos(e+t._y),this._sx=Math.sin(e+t._y),this._cy=-Math.sin(e-t._x),this._sy=Math.cos(e-t._x)}updateTransform(e){return this.position.set(typeof e.x=="number"?e.x:this.position.x,typeof e.y=="number"?e.y:this.position.y),this.scale.set(typeof e.scaleX=="number"?e.scaleX||1:this.scale.x,typeof e.scaleY=="number"?e.scaleY||1:this.scale.y),this.rotation=typeof e.rotation=="number"?e.rotation:this.rotation,this.skew.set(typeof e.skewX=="number"?e.skewX:this.skew.x,typeof e.skewY=="number"?e.skewY:this.skew.y),this.pivot.set(typeof e.pivotX=="number"?e.pivotX:this.pivot.x,typeof e.pivotY=="number"?e.pivotY:this.pivot.y),this}setFromMatrix(e){e.decompose(this)}updateLocalTransform(){if((this._didLocalTransformChangeId&15)===this._didChangeId)return;this._didLocalTransformChangeId=this._didChangeId;const e=this.localTransform,t=this._scale,n=this._pivot,s=this._position,i=t._x,o=t._y,a=n._x,l=n._y;e.a=this._cx*i,e.b=this._sx*i,e.c=this._cy*o,e.d=this._sy*o,e.tx=s._x-(a*e.a+l*e.c),e.ty=s._y-(a*e.b+l*e.d)}set alpha(e){e!==this.localAlpha&&(this.localAlpha=e,this._updateFlags|=yi,this._onUpdate())}get alpha(){return this.localAlpha}set tint(e){const n=ue.shared.setValue(e??16777215).toBgrNumber();n!==this.localColor&&(this.localColor=n,this._updateFlags|=yi,this._onUpdate())}get tint(){const e=this.localColor;return((e&255)<<16)+(e&65280)+(e>>16&255)}set blendMode(e){this.localBlendMode!==e&&(this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),this._updateFlags|=Ul,this.localBlendMode=e,this._onUpdate())}get blendMode(){return this.localBlendMode}get visible(){return!!(this.localDisplayStatus&2)}set visible(e){const t=e?1:0;(this.localDisplayStatus&2)>>1!==t&&(this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),this._updateFlags|=Kn,this.localDisplayStatus^=2,this._onUpdate())}get culled(){return!(this.localDisplayStatus&4)}set culled(e){const t=e?1:0;(this.localDisplayStatus&4)>>2!==t&&(this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),this._updateFlags|=Kn,this.localDisplayStatus^=4,this._onUpdate())}get renderable(){return!!(this.localDisplayStatus&1)}set renderable(e){const t=e?1:0;(this.localDisplayStatus&1)!==t&&(this._updateFlags|=Kn,this.localDisplayStatus^=1,this.renderGroup&&!this.isRenderGroupRoot&&(this.renderGroup.structureDidChange=!0),this._onUpdate())}get isRenderable(){return this.localDisplayStatus===7&&this.groupAlpha>0}destroy(e=!1){if(this.destroyed)return;this.destroyed=!0,this.removeFromParent(),this.parent=null,this._mask=null,this._filters=null,this.effects=null,this._position=null,this._scale=null,this._pivot=null,this._skew=null,this.emit("destroyed",this),this.removeAllListeners();const t=typeof e=="boolean"?e:e==null?void 0:e.children,n=this.removeChildren(0,this.children.length);if(t)for(let s=0;s<n.length;++s)n[s].destroy(e)}}Se.mixin(Mg),Se.mixin(Dg),Se.mixin(Ug),Se.mixin(Gg),Se.mixin(Rg),Se.mixin(kg),Se.mixin(Fg),Se.mixin(Ag);class Br extends Se{constructor(e=$.EMPTY){e instanceof $&&(e={texture:e});const{texture:t,anchor:n,roundPixels:s,width:i,height:o,...a}=e;super({label:"Sprite",...a}),this.renderPipeId="sprite",this.batched=!0,this._didSpriteUpdate=!1,this._bounds={minX:0,maxX:1,minY:0,maxY:0},this._sourceBounds={minX:0,maxX:1,minY:0,maxY:0},this._boundsDirty=!0,this._sourceBoundsDirty=!0,this._roundPixels=0,this._anchor=new qe({_onUpdate:()=>{this.onViewUpdate()}}),n?this.anchor=n:t.defaultAnchor&&(this.anchor=t.defaultAnchor),this.texture=t,this.allowChildren=!1,this.roundPixels=s??!1,i&&(this.width=i),o&&(this.height=o)}static from(e,t=!1){return e instanceof $?new Br(e):new Br($.from(e,t))}set texture(e){e||(e=$.EMPTY);const t=this._texture;t!==e&&(t&&t.dynamic&&t.off("update",this.onViewUpdate,this),e.dynamic&&e.on("update",this.onViewUpdate,this),this._texture=e,this.onViewUpdate())}get texture(){return this._texture}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}get sourceBounds(){return this._sourceBoundsDirty&&(this._updateSourceBounds(),this._sourceBoundsDirty=!1),this._sourceBounds}containsPoint(e){const t=this.sourceBounds;return e.x>=t.maxX&&e.x<=t.minX&&e.y>=t.maxY&&e.y<=t.minY}addBounds(e){const t=this._texture.trim?this.sourceBounds:this.bounds;e.addFrame(t.minX,t.minY,t.maxX,t.maxY)}onViewUpdate(){this._didChangeId+=4096,this._didSpriteUpdate=!0,this._sourceBoundsDirty=this._boundsDirty=!0,!this.didViewUpdate&&(this.didViewUpdate=!0,this.renderGroup&&this.renderGroup.onChildViewUpdate(this))}_updateBounds(){Yn(this._bounds,this._anchor,this._texture,0)}_updateSourceBounds(){const e=this._anchor,t=this._texture,n=this._sourceBounds,{width:s,height:i}=t.orig;n.maxX=-e._x*s,n.minX=n.maxX+s,n.maxY=-e._y*i,n.minY=n.maxY+i}destroy(e=!1){if(super.destroy(e),typeof e=="boolean"?e:e==null?void 0:e.texture){const n=typeof e=="boolean"?e:e==null?void 0:e.textureSource;this._texture.destroy(n)}this._texture=null,this._bounds=null,this._sourceBounds=null,this._anchor=null}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}get roundPixels(){return!!this._roundPixels}set roundPixels(e){this._roundPixels=e?1:0}get width(){return Math.abs(this.scale.x)*this._texture.orig.width}set width(e){this._setWidth(e,this._texture.orig.width)}get height(){return Math.abs(this.scale.y)*this._texture.orig.height}set height(e){this._setHeight(e,this._texture.orig.height)}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this._texture.orig.width,e.height=Math.abs(this.scale.y)*this._texture.orig.height,e}setSize(e,t){let n,s;typeof e!="object"?(n=e,s=t??e):(n=e.width,s=e.height??e.width),n!==void 0&&this._setWidth(n,this._texture.orig.width),s!==void 0&&this._setHeight(s,this._texture.orig.height)}}const Hg=new Ze;function Fl(r,e,t){const n=Hg;r.measurable=!0,di(r,t,n),e.addBoundsMask(n),r.measurable=!1}function Ol(r,e,t){const n=Ut.get();r.measurable=!0;const s=Gt.get().identity(),i=Dl(r,t,s);pi(r,n,i),r.measurable=!1,e.addBoundsMask(n),Gt.return(s),Ut.return(n)}function Dl(r,e,t){return r?(r!==e&&(Dl(r.parent,e,t),r.updateLocalTransform(),t.append(r.localTransform)),t):(ne("Mask bounds, renderable is not inside the root container"),t)}class Ll{constructor(e){this.priority=0,this.pipe="alphaMask",e!=null&&e.mask&&this.init(e.mask)}init(e){this.mask=e,this.renderMaskToTexture=!(e instanceof Br),this.mask.renderable=this.renderMaskToTexture,this.mask.includeInBuild=!this.renderMaskToTexture,this.mask.measurable=!1}reset(){this.mask.measurable=!0,this.mask=null}addBounds(e,t){Fl(this.mask,e,t)}addLocalBounds(e,t){Ol(this.mask,e,t)}containsPoint(e,t){const n=this.mask;return t(n,e)}destroy(){this.reset()}static test(e){return e instanceof Br}}Ll.extension=M.MaskEffect;class Nl{constructor(e){this.priority=0,this.pipe="colorMask",e!=null&&e.mask&&this.init(e.mask)}init(e){this.mask=e}destroy(){}static test(e){return typeof e=="number"}}Nl.extension=M.MaskEffect;class Hl{constructor(e){this.priority=0,this.pipe="stencilMask",e!=null&&e.mask&&this.init(e.mask)}init(e){this.mask=e,this.mask.includeInBuild=!1,this.mask.measurable=!1}reset(){this.mask.measurable=!0,this.mask.includeInBuild=!0,this.mask=null}addBounds(e,t){Fl(this.mask,e,t)}addLocalBounds(e,t){Ol(this.mask,e,t)}containsPoint(e,t){const n=this.mask;return t(n,e)}destroy(){this.reset()}static test(e){return e instanceof Se}}Hl.extension=M.MaskEffect;let zl={createCanvas:(r,e)=>{const t=document.createElement("canvas");return t.width=r,t.height=e,t},getCanvasRenderingContext2D:()=>CanvasRenderingContext2D,getWebGLRenderingContext:()=>WebGLRenderingContext,getNavigator:()=>navigator,getBaseUrl:()=>document.baseURI??window.location.href,getFontFaceSet:()=>document.fonts,fetch:(r,e)=>fetch(r,e),parseXML:r=>new DOMParser().parseFromString(r,"text/xml")};const xe={get(){return zl},set(r){zl=r}};class Rr extends Ie{constructor(e){e.resource||(e.resource=xe.get().createCanvas()),e.width||(e.width=e.resource.width,e.autoDensity||(e.width/=e.resolution)),e.height||(e.height=e.resource.height,e.autoDensity||(e.height/=e.resolution)),super(e),this.uploadMethodId="image",this.autoDensity=e.autoDensity;const t=e.resource;(this.pixelWidth!==t.width||this.pixelWidth!==t.height)&&this.resizeCanvas(),this.transparent=!!e.transparent}resizeCanvas(){this.autoDensity&&(this.resource.style.width=`${this.width}px`,this.resource.style.height=`${this.height}px`),(this.resource.width!==this.pixelWidth||this.resource.height!==this.pixelHeight)&&(this.resource.width=this.pixelWidth,this.resource.height=this.pixelHeight)}resize(e=this.width,t=this.height,n=this._resolution){const s=super.resize(e,t,n);return s&&this.resizeCanvas(),s}static test(e){return globalThis.HTMLCanvasElement&&e instanceof HTMLCanvasElement||globalThis.OffscreenCanvas&&e instanceof OffscreenCanvas}}Rr.extension=M.TextureSource;class Zn extends Ie{constructor(e){if(e.resource&&globalThis.HTMLImageElement&&e.resource instanceof HTMLImageElement){const t=xe.get().createCanvas(e.resource.width,e.resource.height);t.getContext("2d").drawImage(e.resource,0,0),e.resource=t,ne("ImageSource: Image element passed, converting to canvas. Use CanvasSource instead.")}super(e),this.uploadMethodId="image",this.autoGarbageCollect=!0}static test(e){return globalThis.HTMLImageElement&&e instanceof HTMLImageElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap}}Zn.extension=M.TextureSource;var en=(r=>(r[r.INTERACTION=50]="INTERACTION",r[r.HIGH=25]="HIGH",r[r.NORMAL=0]="NORMAL",r[r.LOW=-25]="LOW",r[r.UTILITY=-50]="UTILITY",r))(en||{});class bi{constructor(e,t=null,n=0,s=!1){this.next=null,this.previous=null,this._destroyed=!1,this._fn=e,this._context=t,this.priority=n,this._once=s}match(e,t=null){return this._fn===e&&this._context===t}emit(e){this._fn&&(this._context?this._fn.call(this._context,e):this._fn(e));const t=this.next;return this._once&&this.destroy(!0),this._destroyed&&(this.next=null),t}connect(e){this.previous=e,e.next&&(e.next.previous=this),this.next=e.next,e.next=this}destroy(e=!1){this._destroyed=!0,this._fn=null,this._context=null,this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous);const t=this.next;return this.next=e?null:t,this.previous=null,t}}const $l=class tt{constructor(){this.autoStart=!1,this.deltaTime=1,this.lastTime=-1,this.speed=1,this.started=!1,this._requestId=null,this._maxElapsedMS=100,this._minElapsedMS=0,this._protected=!1,this._lastFrame=-1,this._head=new bi(null,null,1/0),this.deltaMS=1/tt.targetFPMS,this.elapsedMS=1/tt.targetFPMS,this._tick=e=>{this._requestId=null,this.started&&(this.update(e),this.started&&this._requestId===null&&this._head.next&&(this._requestId=requestAnimationFrame(this._tick)))}}_requestIfNeeded(){this._requestId===null&&this._head.next&&(this.lastTime=performance.now(),this._lastFrame=this.lastTime,this._requestId=requestAnimationFrame(this._tick))}_cancelIfNeeded(){this._requestId!==null&&(cancelAnimationFrame(this._requestId),this._requestId=null)}_startIfPossible(){this.started?this._requestIfNeeded():this.autoStart&&this.start()}add(e,t,n=en.NORMAL){return this._addListener(new bi(e,t,n))}addOnce(e,t,n=en.NORMAL){return this._addListener(new bi(e,t,n,!0))}_addListener(e){let t=this._head.next,n=this._head;if(!t)e.connect(n);else{for(;t;){if(e.priority>t.priority){e.connect(n);break}n=t,t=t.next}e.previous||e.connect(n)}return this._startIfPossible(),this}remove(e,t){let n=this._head.next;for(;n;)n.match(e,t)?n=n.destroy():n=n.next;return this._head.next||this._cancelIfNeeded(),this}get count(){if(!this._head)return 0;let e=0,t=this._head;for(;t=t.next;)e++;return e}start(){this.started||(this.started=!0,this._requestIfNeeded())}stop(){this.started&&(this.started=!1,this._cancelIfNeeded())}destroy(){if(!this._protected){this.stop();let e=this._head.next;for(;e;)e=e.destroy(!0);this._head.destroy(),this._head=null}}update(e=performance.now()){let t;if(e>this.lastTime){if(t=this.elapsedMS=e-this.lastTime,t>this._maxElapsedMS&&(t=this._maxElapsedMS),t*=this.speed,this._minElapsedMS){const i=e-this._lastFrame|0;if(i<this._minElapsedMS)return;this._lastFrame=e-i%this._minElapsedMS}this.deltaMS=t,this.deltaTime=this.deltaMS*tt.targetFPMS;const n=this._head;let s=n.next;for(;s;)s=s.emit(this);n.next||this._cancelIfNeeded()}else this.deltaTime=this.deltaMS=this.elapsedMS=0;this.lastTime=e}get FPS(){return 1e3/this.elapsedMS}get minFPS(){return 1e3/this._maxElapsedMS}set minFPS(e){const t=Math.min(this.maxFPS,e),n=Math.min(Math.max(0,t)/1e3,tt.targetFPMS);this._maxElapsedMS=1/n}get maxFPS(){return this._minElapsedMS?Math.round(1e3/this._minElapsedMS):0}set maxFPS(e){if(e===0)this._minElapsedMS=0;else{const t=Math.max(this.minFPS,e);this._minElapsedMS=1/(t/1e3)}}static get shared(){if(!tt._shared){const e=tt._shared=new tt;e.autoStart=!0,e._protected=!0}return tt._shared}static get system(){if(!tt._system){const e=tt._system=new tt;e.autoStart=!0,e._protected=!0}return tt._system}};$l.targetFPMS=.06;let Wt=$l,xi;async function zg(){return xi??(xi=(async()=>{var o;const e=document.createElement("canvas").getContext("webgl");if(!e)return"premultiply-alpha-on-upload";const t=await new Promise(a=>{const l=document.createElement("video");l.onloadeddata=()=>a(l),l.onerror=()=>a(null),l.autoplay=!1,l.crossOrigin="anonymous",l.preload="auto",l.src="data:video/webm;base64,GkXfo59ChoEBQveBAULygQRC84EIQoKEd2VibUKHgQJChYECGFOAZwEAAAAAAAHTEU2bdLpNu4tTq4QVSalmU6yBoU27i1OrhBZUrmtTrIHGTbuMU6uEElTDZ1OsggEXTbuMU6uEHFO7a1OsggG97AEAAAAAAABZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVSalmoCrXsYMPQkBNgIRMYXZmV0GETGF2ZkSJiEBEAAAAAAAAFlSua8yuAQAAAAAAAEPXgQFzxYgAAAAAAAAAAZyBACK1nIN1bmSIgQCGhVZfVlA5g4EBI+ODhAJiWgDglLCBArqBApqBAlPAgQFVsIRVuYEBElTDZ9Vzc9JjwItjxYgAAAAAAAAAAWfInEWjh0VOQ09ERVJEh49MYXZjIGxpYnZweC12cDlnyKJFo4hEVVJBVElPTkSHlDAwOjAwOjAwLjA0MDAwMDAwMAAAH0O2dcfngQCgwqGggQAAAIJJg0IAABAAFgA4JBwYSgAAICAAEb///4r+AAB1oZ2mm+6BAaWWgkmDQgAAEAAWADgkHBhKAAAgIABIQBxTu2uRu4+zgQC3iveBAfGCAXHwgQM=",l.load()});if(!t)return"premultiply-alpha-on-upload";const n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n);const s=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,s),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n,0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t);const i=new Uint8Array(4);return e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,i),e.deleteFramebuffer(s),e.deleteTexture(n),(o=e.getExtension("WEBGL_lose_context"))==null||o.loseContext(),i[0]<=i[3]?"premultiplied-alpha":"premultiply-alpha-on-upload"})()),xi}const Qn=class Od extends Ie{constructor(e){super(e),this.isReady=!1,this.uploadMethodId="video",e={...Od.defaultOptions,...e},this._autoUpdate=!0,this._isConnectedToTicker=!1,this._updateFPS=e.updateFPS||0,this._msToNextUpdate=0,this.autoPlay=e.autoPlay!==!1,this.alphaMode=e.alphaMode??"premultiply-alpha-on-upload",this._videoFrameRequestCallback=this._videoFrameRequestCallback.bind(this),this._videoFrameRequestCallbackHandle=null,this._load=null,this._resolve=null,this._reject=null,this._onCanPlay=this._onCanPlay.bind(this),this._onCanPlayThrough=this._onCanPlayThrough.bind(this),this._onError=this._onError.bind(this),this._onPlayStart=this._onPlayStart.bind(this),this._onPlayStop=this._onPlayStop.bind(this),this._onSeeked=this._onSeeked.bind(this),e.autoLoad!==!1&&this.load()}updateFrame(){if(!this.destroyed){if(this._updateFPS){const e=Wt.shared.elapsedMS*this.resource.playbackRate;this._msToNextUpdate=Math.floor(this._msToNextUpdate-e)}(!this._updateFPS||this._msToNextUpdate<=0)&&(this._msToNextUpdate=this._updateFPS?Math.floor(1e3/this._updateFPS):0),this.isValid&&this.update()}}_videoFrameRequestCallback(){this.updateFrame(),this.destroyed?this._videoFrameRequestCallbackHandle=null:this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback)}get isValid(){return!!this.resource.videoWidth&&!!this.resource.videoHeight}async load(){if(this._load)return this._load;const e=this.resource,t=this.options;return(e.readyState===e.HAVE_ENOUGH_DATA||e.readyState===e.HAVE_FUTURE_DATA)&&e.width&&e.height&&(e.complete=!0),e.addEventListener("play",this._onPlayStart),e.addEventListener("pause",this._onPlayStop),e.addEventListener("seeked",this._onSeeked),this._isSourceReady()?this._mediaReady():(t.preload||e.addEventListener("canplay",this._onCanPlay),e.addEventListener("canplaythrough",this._onCanPlayThrough),e.addEventListener("error",this._onError,!0)),this.alphaMode=await zg(),this._load=new Promise((n,s)=>{this.isValid?n(this):(this._resolve=n,this._reject=s,t.preloadTimeoutMs!==void 0&&(this._preloadTimeout=setTimeout(()=>{this._onError(new ErrorEvent(`Preload exceeded timeout of ${t.preloadTimeoutMs}ms`))})),e.load())}),this._load}_onError(e){this.resource.removeEventListener("error",this._onError,!0),this.emit("error",e),this._reject&&(this._reject(e),this._reject=null,this._resolve=null)}_isSourcePlaying(){const e=this.resource;return!e.paused&&!e.ended}_isSourceReady(){return this.resource.readyState>2}_onPlayStart(){this.isValid||this._mediaReady(),this._configureAutoUpdate()}_onPlayStop(){this._configureAutoUpdate()}_onSeeked(){this._autoUpdate&&!this._isSourcePlaying()&&(this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0)}_onCanPlay(){this.resource.removeEventListener("canplay",this._onCanPlay),this._mediaReady()}_onCanPlayThrough(){this.resource.removeEventListener("canplaythrough",this._onCanPlay),this._preloadTimeout&&(clearTimeout(this._preloadTimeout),this._preloadTimeout=void 0),this._mediaReady()}_mediaReady(){const e=this.resource;this.isValid&&(this.isReady=!0,this.resize(e.videoWidth,e.videoHeight)),this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0,this._resolve&&(this._resolve(this),this._resolve=null,this._reject=null),this._isSourcePlaying()?this._onPlayStart():this.autoPlay&&this.resource.play()}destroy(){this._configureAutoUpdate();const e=this.resource;e&&(e.removeEventListener("play",this._onPlayStart),e.removeEventListener("pause",this._onPlayStop),e.removeEventListener("seeked",this._onSeeked),e.removeEventListener("canplay",this._onCanPlay),e.removeEventListener("canplaythrough",this._onCanPlayThrough),e.removeEventListener("error",this._onError,!0),e.pause(),e.src="",e.load()),super.destroy()}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,this._configureAutoUpdate())}get updateFPS(){return this._updateFPS}set updateFPS(e){e!==this._updateFPS&&(this._updateFPS=e,this._configureAutoUpdate())}_configureAutoUpdate(){this._autoUpdate&&this._isSourcePlaying()?!this._updateFPS&&this.resource.requestVideoFrameCallback?(this._isConnectedToTicker&&(Wt.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0),this._videoFrameRequestCallbackHandle===null&&(this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback))):(this._videoFrameRequestCallbackHandle!==null&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker||(Wt.shared.add(this.updateFrame,this),this._isConnectedToTicker=!0,this._msToNextUpdate=0)):(this._videoFrameRequestCallbackHandle!==null&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker&&(Wt.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0))}static test(e){return globalThis.HTMLVideoElement&&e instanceof HTMLVideoElement||globalThis.VideoFrame&&e instanceof VideoFrame}};Qn.extension=M.TextureSource,Qn.defaultOptions={...Ie.defaultOptions,autoLoad:!0,autoPlay:!0,updateFPS:0,crossorigin:!0,loop:!1,muted:!0,playsinline:!0,preload:!1},Qn.MIME_TYPES={ogv:"video/ogg",mov:"video/quicktime",m4v:"video/mp4"};let $g=Qn;const kr=(r,e,t=!1)=>(Array.isArray(r)||(r=[r]),e?r.map(n=>typeof n=="string"||t?e(n):n):r);class Wg{constructor(){this._parsers=[],this._cache=new Map,this._cacheMap=new Map}reset(){this._cacheMap.clear(),this._cache.clear()}has(e){return this._cache.has(e)}get(e){const t=this._cache.get(e);return t||ne(`[Assets] Asset id ${e} was not found in the Cache`),t}set(e,t){const n=kr(e);let s;for(let l=0;l<this.parsers.length;l++){const c=this.parsers[l];if(c.test(t)){s=c.getCacheableAssets(n,t);break}}const i=new Map(Object.entries(s||{}));s||n.forEach(l=>{i.set(l,t)});const o=[...i.keys()],a={cacheKeys:o,keys:n};n.forEach(l=>{this._cacheMap.set(l,a)}),o.forEach(l=>{const c=s?s[l]:t;this._cache.has(l)&&this._cache.get(l)!==c&&ne("[Cache] already has key:",l),this._cache.set(l,i.get(l))})}remove(e){if(!this._cacheMap.has(e)){ne(`[Assets] Asset id ${e} was not found in the Cache`);return}const t=this._cacheMap.get(e);t.cacheKeys.forEach(s=>{this._cache.delete(s)}),t.keys.forEach(s=>{this._cacheMap.delete(s)})}get parsers(){return this._parsers}}const Ge=new Wg,vi=[];re.handleByList(M.TextureSource,vi);function Vg(r={}){const e=r&&r.resource,t=e?r.resource:r,n=e?r:{resource:r};for(let s=0;s<vi.length;s++){const i=vi[s];if(i.test(t))return new i(n)}throw new Error(`Could not find a source type for resource: ${n.resource}`)}function Xg(r={},e=!1){const t=r&&r.resource,n=t?r.resource:r,s=t?r:{resource:r};if(!e&&Ge.has(n))return Ge.get(n);const i=new $({source:Vg(s)});return i.on("destroy",()=>{Ge.has(n)&&Ge.remove(n)}),e||Ge.set(n,i),i}function Yg(r,e=!1){return typeof r=="string"?Ge.get(r):r instanceof Ie?new $({source:r}):Xg(r,e)}$.from=Yg,re.add(Ll,Nl,Hl,$g,Zn,Rr,ni);var wi=(r=>(r[r.Low=0]="Low",r[r.Normal=1]="Normal",r[r.High=2]="High",r))(wi||{});function ft(r){if(typeof r!="string")throw new TypeError(`Path must be a string. Received ${JSON.stringify(r)}`)}function tn(r){return r.split("?")[0].split("#")[0]}function jg(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function qg(r,e,t){return r.replace(new RegExp(jg(e),"g"),t)}function Kg(r,e){let t="",n=0,s=-1,i=0,o=-1;for(let a=0;a<=r.length;++a){if(a<r.length)o=r.charCodeAt(a);else{if(o===47)break;o=47}if(o===47){if(!(s===a-1||i===1))if(s!==a-1&&i===2){if(t.length<2||n!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){const l=t.lastIndexOf("/");if(l!==t.length-1){l===-1?(t="",n=0):(t=t.slice(0,l),n=t.length-1-t.lastIndexOf("/")),s=a,i=0;continue}}else if(t.length===2||t.length===1){t="",n=0,s=a,i=0;continue}}}else t.length>0?t+=`/${r.slice(s+1,a)}`:t=r.slice(s+1,a),n=a-s-1;s=a,i=0}else o===46&&i!==-1?++i:i=-1}return t}const Vt={toPosix(r){return qg(r,"\\","/")},isUrl(r){return/^https?:/.test(this.toPosix(r))},isDataUrl(r){return/^data:([a-z]+\/[a-z0-9-+.]+(;[a-z0-9-.!#$%*+.{}|~`]+=[a-z0-9-.!#$%*+.{}()_|~`]+)*)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s<>]*?)$/i.test(r)},isBlobUrl(r){return r.startsWith("blob:")},hasProtocol(r){return/^[^/:]+:/.test(this.toPosix(r))},getProtocol(r){ft(r),r=this.toPosix(r);const e=/^file:\/\/\//.exec(r);if(e)return e[0];const t=/^[^/:]+:\/{0,2}/.exec(r);return t?t[0]:""},toAbsolute(r,e,t){if(ft(r),this.isDataUrl(r)||this.isBlobUrl(r))return r;const n=tn(this.toPosix(e??xe.get().getBaseUrl())),s=tn(this.toPosix(t??this.rootname(n)));return r=this.toPosix(r),r.startsWith("/")?Vt.join(s,r.slice(1)):this.isAbsolute(r)?r:this.join(n,r)},normalize(r){if(ft(r),r.length===0)return".";if(this.isDataUrl(r)||this.isBlobUrl(r))return r;r=this.toPosix(r);let e="";const t=r.startsWith("/");this.hasProtocol(r)&&(e=this.rootname(r),r=r.slice(e.length));const n=r.endsWith("/");return r=Kg(r),r.length>0&&n&&(r+="/"),t?`/${r}`:e+r},isAbsolute(r){return ft(r),r=this.toPosix(r),this.hasProtocol(r)?!0:r.startsWith("/")},join(...r){if(r.length===0)return".";let e;for(let t=0;t<r.length;++t){const n=r[t];if(ft(n),n.length>0)if(e===void 0)e=n;else{const s=r[t-1]??"";this.joinExtensions.includes(this.extname(s).toLowerCase())?e+=`/../${n}`:e+=`/${n}`}}return e===void 0?".":this.normalize(e)},dirname(r){if(ft(r),r.length===0)return".";r=this.toPosix(r);let e=r.charCodeAt(0);const t=e===47;let n=-1,s=!0;const i=this.getProtocol(r),o=r;r=r.slice(i.length);for(let a=r.length-1;a>=1;--a)if(e=r.charCodeAt(a),e===47){if(!s){n=a;break}}else s=!1;return n===-1?t?"/":this.isUrl(o)?i+r:i:t&&n===1?"//":i+r.slice(0,n)},rootname(r){ft(r),r=this.toPosix(r);let e="";if(r.startsWith("/")?e="/":e=this.getProtocol(r),this.isUrl(r)){const t=r.indexOf("/",e.length);t!==-1?e=r.slice(0,t):e=r,e.endsWith("/")||(e+="/")}return e},basename(r,e){ft(r),e&&ft(e),r=tn(this.toPosix(r));let t=0,n=-1,s=!0,i;if(e!==void 0&&e.length>0&&e.length<=r.length){if(e.length===r.length&&e===r)return"";let o=e.length-1,a=-1;for(i=r.length-1;i>=0;--i){const l=r.charCodeAt(i);if(l===47){if(!s){t=i+1;break}}else a===-1&&(s=!1,a=i+1),o>=0&&(l===e.charCodeAt(o)?--o===-1&&(n=i):(o=-1,n=a))}return t===n?n=a:n===-1&&(n=r.length),r.slice(t,n)}for(i=r.length-1;i>=0;--i)if(r.charCodeAt(i)===47){if(!s){t=i+1;break}}else n===-1&&(s=!1,n=i+1);return n===-1?"":r.slice(t,n)},extname(r){ft(r),r=tn(this.toPosix(r));let e=-1,t=0,n=-1,s=!0,i=0;for(let o=r.length-1;o>=0;--o){const a=r.charCodeAt(o);if(a===47){if(!s){t=o+1;break}continue}n===-1&&(s=!1,n=o+1),a===46?e===-1?e=o:i!==1&&(i=1):e!==-1&&(i=-1)}return e===-1||n===-1||i===0||i===1&&e===n-1&&e===t+1?"":r.slice(e,n)},parse(r){ft(r);const e={root:"",dir:"",base:"",ext:"",name:""};if(r.length===0)return e;r=tn(this.toPosix(r));let t=r.charCodeAt(0);const n=this.isAbsolute(r);let s;e.root=this.rootname(r),n||this.hasProtocol(r)?s=1:s=0;let i=-1,o=0,a=-1,l=!0,c=r.length-1,h=0;for(;c>=s;--c){if(t=r.charCodeAt(c),t===47){if(!l){o=c+1;break}continue}a===-1&&(l=!1,a=c+1),t===46?i===-1?i=c:h!==1&&(h=1):i!==-1&&(h=-1)}return i===-1||a===-1||h===0||h===1&&i===a-1&&i===o+1?a!==-1&&(o===0&&n?e.base=e.name=r.slice(1,a):e.base=e.name=r.slice(o,a)):(o===0&&n?(e.name=r.slice(1,i),e.base=r.slice(1,a)):(e.name=r.slice(o,i),e.base=r.slice(o,a)),e.ext=r.slice(i,a)),e.dir=this.dirname(r),e},sep:"/",delimiter:":",joinExtensions:[".html"]};function Wl(r,e,t,n,s){const i=e[t];for(let o=0;o<i.length;o++){const a=i[o];t<e.length-1?Wl(r.replace(n[t],a),e,t+1,n,s):s.push(r.replace(n[t],a))}}function Zg(r){const e=/\{(.*?)\}/g,t=r.match(e),n=[];if(t){const s=[];t.forEach(i=>{const o=i.substring(1,i.length-1).split(",");s.push(o)}),Wl(r,s,0,t,n)}else n.push(r);return n}const Vl=r=>!Array.isArray(r);class Xl{constructor(){this._defaultBundleIdentifierOptions={connector:"-",createBundleAssetId:(e,t)=>`${e}${this._bundleIdConnector}${t}`,extractAssetIdFromBundle:(e,t)=>t.replace(`${e}${this._bundleIdConnector}`,"")},this._bundleIdConnector=this._defaultBundleIdentifierOptions.connector,this._createBundleAssetId=this._defaultBundleIdentifierOptions.createBundleAssetId,this._extractAssetIdFromBundle=this._defaultBundleIdentifierOptions.extractAssetIdFromBundle,this._assetMap={},this._preferredOrder=[],this._parsers=[],this._resolverHash={},this._bundles={}}setBundleIdentifier(e){if(this._bundleIdConnector=e.connector??this._bundleIdConnector,this._createBundleAssetId=e.createBundleAssetId??this._createBundleAssetId,this._extractAssetIdFromBundle=e.extractAssetIdFromBundle??this._extractAssetIdFromBundle,this._extractAssetIdFromBundle("foo",this._createBundleAssetId("foo","bar"))!=="bar")throw new Error("[Resolver] GenerateBundleAssetId are not working correctly")}prefer(...e){e.forEach(t=>{this._preferredOrder.push(t),t.priority||(t.priority=Object.keys(t.params))}),this._resolverHash={}}set basePath(e){this._basePath=e}get basePath(){return this._basePath}set rootPath(e){this._rootPath=e}get rootPath(){return this._rootPath}get parsers(){return this._parsers}reset(){this.setBundleIdentifier(this._defaultBundleIdentifierOptions),this._assetMap={},this._preferredOrder=[],this._resolverHash={},this._rootPath=null,this._basePath=null,this._manifest=null,this._bundles={},this._defaultSearchParams=null}setDefaultSearchParams(e){if(typeof e=="string")this._defaultSearchParams=e;else{const t=e;this._defaultSearchParams=Object.keys(t).map(n=>`${encodeURIComponent(n)}=${encodeURIComponent(t[n])}`).join("&")}}getAlias(e){const{alias:t,src:n}=e;return kr(t||n,i=>typeof i=="string"?i:Array.isArray(i)?i.map(o=>(o==null?void 0:o.src)??o):i!=null&&i.src?i.src:i,!0)}addManifest(e){this._manifest&&ne("[Resolver] Manifest already exists, this will be overwritten"),this._manifest=e,e.bundles.forEach(t=>{this.addBundle(t.name,t.assets)})}addBundle(e,t){const n=[];let s=t;Array.isArray(t)||(s=Object.entries(t).map(([i,o])=>typeof o=="string"||Array.isArray(o)?{alias:i,src:o}:{alias:i,...o})),s.forEach(i=>{const o=i.src,a=i.alias;let l;if(typeof a=="string"){const c=this._createBundleAssetId(e,a);n.push(c),l=[a,c]}else{const c=a.map(h=>this._createBundleAssetId(e,h));n.push(...c),l=[...a,...c]}this.add({...i,alias:l,src:o})}),this._bundles[e]=n}add(e){const t=[];Array.isArray(e)?t.push(...e):t.push(e);let n;n=i=>{this.hasKey(i)&&ne(`[Resolver] already has key: ${i} overwriting`)},kr(t).forEach(i=>{const{src:o}=i;let{data:a,format:l,loadParser:c}=i;const h=kr(o).map(f=>typeof f=="string"?Zg(f):Array.isArray(f)?f:[f]),u=this.getAlias(i);Array.isArray(u)?u.forEach(n):n(u);const d=[];h.forEach(f=>{f.forEach(p=>{let g={};if(typeof p!="object"){g.src=p;for(let m=0;m<this._parsers.length;m++){const _=this._parsers[m];if(_.test(p)){g=_.parse(p);break}}}else a=p.data??a,l=p.format??l,c=p.loadParser??c,g={...g,...p};if(!u)throw new Error(`[Resolver] alias is undefined for this asset: ${g.src}`);g=this._buildResolvedAsset(g,{aliases:u,data:a,format:l,loadParser:c}),d.push(g)})}),u.forEach(f=>{this._assetMap[f]=d})})}resolveBundle(e){const t=Vl(e);e=kr(e);const n={};return e.forEach(s=>{const i=this._bundles[s];if(i){const o=this.resolve(i),a={};for(const l in o){const c=o[l];a[this._extractAssetIdFromBundle(s,l)]=c}n[s]=a}}),t?n[e[0]]:n}resolveUrl(e){const t=this.resolve(e);if(typeof e!="string"){const n={};for(const s in t)n[s]=t[s].src;return n}return t.src}resolve(e){const t=Vl(e);e=kr(e);const n={};return e.forEach(s=>{if(!this._resolverHash[s])if(this._assetMap[s]){let i=this._assetMap[s];const o=this._getPreferredOrder(i);o==null||o.priority.forEach(a=>{o.params[a].forEach(l=>{const c=i.filter(h=>h[a]?h[a]===l:!1);c.length&&(i=c)})}),this._resolverHash[s]=i[0]}else this._resolverHash[s]=this._buildResolvedAsset({alias:[s],src:s},{});n[s]=this._resolverHash[s]}),t?n[e[0]]:n}hasKey(e){return!!this._assetMap[e]}hasBundle(e){return!!this._bundles[e]}_getPreferredOrder(e){for(let t=0;t<e.length;t++){const n=e[0],s=this._preferredOrder.find(i=>i.params.format.includes(n.format));if(s)return s}return this._preferredOrder[0]}_appendDefaultSearchParams(e){if(!this._defaultSearchParams)return e;const t=/\?/.test(e)?"&":"?";return`${e}${t}${this._defaultSearchParams}`}_buildResolvedAsset(e,t){const{aliases:n,data:s,loadParser:i,format:o}=t;return(this._basePath||this._rootPath)&&(e.src=Vt.toAbsolute(e.src,this._basePath,this._rootPath)),e.alias=n??e.alias??[e.src],e.src=this._appendDefaultSearchParams(e.src),e.data={...s||{},...e.data},e.loadParser=i??e.loadParser,e.format=o??e.format??Qg(e.src),e}}Xl.RETINA_PREFIX=/@([0-9\.]+)x/;function Qg(r){return r.split(".").pop().split("?").shift().split("#").shift()}const Si=(r,e)=>{const t=e.split("?")[1];return t&&(r+=`?${t}`),r},Yl=class Pn{constructor(e,t){this.linkedSheets=[],this._texture=e instanceof $?e:null,this.textureSource=e.source,this.textures={},this.animations={},this.data=t;const n=parseFloat(t.meta.scale);n?(this.resolution=n,e.source.resolution=this.resolution):this.resolution=e.source._resolution,this._frames=this.data.frames,this._frameKeys=Object.keys(this._frames),this._batchIndex=0,this._callback=null}parse(){return new Promise(e=>{this._callback=e,this._batchIndex=0,this._frameKeys.length<=Pn.BATCH_SIZE?(this._processFrames(0),this._processAnimations(),this._parseComplete()):this._nextBatch()})}_processFrames(e){let t=e;const n=Pn.BATCH_SIZE;for(;t-e<n&&t<this._frameKeys.length;){const s=this._frameKeys[t],i=this._frames[s],o=i.frame;if(o){let a=null,l=null;const c=i.trimmed!==!1&&i.sourceSize?i.sourceSize:i.frame,h=new he(0,0,Math.floor(c.w)/this.resolution,Math.floor(c.h)/this.resolution);i.rotated?a=new he(Math.floor(o.x)/this.resolution,Math.floor(o.y)/this.resolution,Math.floor(o.h)/this.resolution,Math.floor(o.w)/this.resolution):a=new he(Math.floor(o.x)/this.resolution,Math.floor(o.y)/this.resolution,Math.floor(o.w)/this.resolution,Math.floor(o.h)/this.resolution),i.trimmed!==!1&&i.spriteSourceSize&&(l=new he(Math.floor(i.spriteSourceSize.x)/this.resolution,Math.floor(i.spriteSourceSize.y)/this.resolution,Math.floor(o.w)/this.resolution,Math.floor(o.h)/this.resolution)),this.textures[s]=new $({source:this.textureSource,frame:a,orig:h,trim:l,rotate:i.rotated?2:0,defaultAnchor:i.anchor,defaultBorders:i.borders,label:s.toString()})}t++}}_processAnimations(){const e=this.data.animations||{};for(const t in e){this.animations[t]=[];for(let n=0;n<e[t].length;n++){const s=e[t][n];this.animations[t].push(this.textures[s])}}}_parseComplete(){const e=this._callback;this._callback=null,this._batchIndex=0,e.call(this,this.textures)}_nextBatch(){this._processFrames(this._batchIndex*Pn.BATCH_SIZE),this._batchIndex++,setTimeout(()=>{this._batchIndex*Pn.BATCH_SIZE<this._frameKeys.length?this._nextBatch():(this._processAnimations(),this._parseComplete())},0)}destroy(e=!1){var t;for(const n in this.textures)this.textures[n].destroy();this._frames=null,this._frameKeys=null,this.data=null,this.textures=null,e&&((t=this._texture)==null||t.destroy(),this.textureSource.destroy()),this._texture=null,this.textureSource=null,this.linkedSheets=[]}};Yl.BATCH_SIZE=1e3;let jl=Yl;const Jg=["jpg","png","jpeg","avif","webp","basis","etc2","bc7","bc6h","bc5","bc4","bc3","bc2","bc1","eac","astc"];function ql(r,e,t){const n={};if(r.forEach(s=>{n[s]=e}),Object.keys(e.textures).forEach(s=>{n[s]=e.textures[s]}),!t){const s=Vt.dirname(r[0]);e.linkedSheets.forEach((i,o)=>{const a=ql([`${s}/${e.data.meta.related_multi_packs[o]}`],i,!0);Object.assign(n,a)})}return n}const e_={extension:M.Asset,cache:{test:r=>r instanceof jl,getCacheableAssets:(r,e)=>ql(r,e,!1)},resolver:{test:r=>{const t=r.split("?")[0].split("."),n=t.pop(),s=t.pop();return n==="json"&&Jg.includes(s)},parse:r=>{var t;const e=r.split(".");return{resolution:parseFloat(((t=Xl.RETINA_PREFIX.exec(r))==null?void 0:t[1])??"1"),format:e[e.length-2],src:r}}},loader:{name:"spritesheetLoader",extension:{type:M.LoadParser,priority:wi.Normal},async testParse(r,e){return Vt.extname(e.src).toLowerCase()===".json"&&!!r.frames},async parse(r,e,t){var c,h;const{texture:n,imageFilename:s}=(e==null?void 0:e.data)??{};let i=Vt.dirname(e.src);i&&i.lastIndexOf("/")!==i.length-1&&(i+="/");let o;if(n instanceof $)o=n;else{const u=Si(i+(s??r.meta.image),e.src);o=(await t.load([u]))[u]}const a=new jl(o.source,r);await a.parse();const l=(c=r==null?void 0:r.meta)==null?void 0:c.related_multi_packs;if(Array.isArray(l)){const u=[];for(const f of l){if(typeof f!="string")continue;let p=i+f;(h=e.data)!=null&&h.ignoreMultiPack||(p=Si(p,e.src),u.push(t.load({src:p,data:{ignoreMultiPack:!0}})))}const d=await Promise.all(u);a.linkedSheets=d,d.forEach(f=>{f.linkedSheets=[a].concat(a.linkedSheets.filter(p=>p!==f))})}return a},async unload(r,e,t){await t.unload(r.textureSource._sourceOrigin),r.destroy(!1)}}};re.add(e_);class rn{constructor(e){this.bubbles=!0,this.cancelBubble=!0,this.cancelable=!1,this.composed=!1,this.defaultPrevented=!1,this.eventPhase=rn.prototype.NONE,this.propagationStopped=!1,this.propagationImmediatelyStopped=!1,this.layer=new ce,this.page=new ce,this.NONE=0,this.CAPTURING_PHASE=1,this.AT_TARGET=2,this.BUBBLING_PHASE=3,this.manager=e}get layerX(){return this.layer.x}get layerY(){return this.layer.y}get pageX(){return this.page.x}get pageY(){return this.page.y}get data(){return this}composedPath(){return this.manager&&(!this.path||this.path[this.path.length-1]!==this.target)&&(this.path=this.target?this.manager.propagationPath(this.target):[]),this.path}initEvent(e,t,n){throw new Error("initEvent() is a legacy DOM API. It is not implemented in the Federated Events API.")}initUIEvent(e,t,n,s,i){throw new Error("initUIEvent() is a legacy DOM API. It is not implemented in the Federated Events API.")}preventDefault(){this.nativeEvent instanceof Event&&this.nativeEvent.cancelable&&this.nativeEvent.preventDefault(),this.defaultPrevented=!0}stopImmediatePropagation(){this.propagationImmediatelyStopped=!0}stopPropagation(){this.propagationStopped=!0}}var Ti=/iPhone/i,Kl=/iPod/i,Zl=/iPad/i,Ql=/\biOS-universal(?:.+)Mac\b/i,Ei=/\bAndroid(?:.+)Mobile\b/i,Jl=/Android/i,Ir=/(?:SD4930UR|\bSilk(?:.+)Mobile\b)/i,Jn=/Silk/i,Ft=/Windows Phone/i,ec=/\bWindows(?:.+)ARM\b/i,tc=/BlackBerry/i,rc=/BB10/i,nc=/Opera Mini/i,sc=/\b(CriOS|Chrome)(?:.+)Mobile/i,ic=/Mobile(?:.+)Firefox\b/i,oc=function(r){return typeof r<"u"&&r.platform==="MacIntel"&&typeof r.maxTouchPoints=="number"&&r.maxTouchPoints>1&&typeof MSStream>"u"};function t_(r){return function(e){return e.test(r)}}function ac(r){var e={userAgent:"",platform:"",maxTouchPoints:0};!r&&typeof navigator<"u"?e={userAgent:navigator.userAgent,platform:navigator.platform,maxTouchPoints:navigator.maxTouchPoints||0}:typeof r=="string"?e.userAgent=r:r&&r.userAgent&&(e={userAgent:r.userAgent,platform:r.platform,maxTouchPoints:r.maxTouchPoints||0});var t=e.userAgent,n=t.split("[FBAN");typeof n[1]<"u"&&(t=n[0]),n=t.split("Twitter"),typeof n[1]<"u"&&(t=n[0]);var s=t_(t),i={apple:{phone:s(Ti)&&!s(Ft),ipod:s(Kl),tablet:!s(Ti)&&(s(Zl)||oc(e))&&!s(Ft),universal:s(Ql),device:(s(Ti)||s(Kl)||s(Zl)||s(Ql)||oc(e))&&!s(Ft)},amazon:{phone:s(Ir),tablet:!s(Ir)&&s(Jn),device:s(Ir)||s(Jn)},android:{phone:!s(Ft)&&s(Ir)||!s(Ft)&&s(Ei),tablet:!s(Ft)&&!s(Ir)&&!s(Ei)&&(s(Jn)||s(Jl)),device:!s(Ft)&&(s(Ir)||s(Jn)||s(Ei)||s(Jl))||s(/\bokhttp\b/i)},windows:{phone:s(Ft),tablet:s(ec),device:s(Ft)||s(ec)},other:{blackberry:s(tc),blackberry10:s(rc),opera:s(nc),firefox:s(ic),chrome:s(sc),device:s(tc)||s(rc)||s(nc)||s(ic)||s(sc)},any:!1,phone:!1,tablet:!1};return i.any=i.apple.device||i.android.device||i.windows.device||i.other.device,i.phone=i.apple.phone||i.android.phone||i.windows.phone,i.tablet=i.apple.tablet||i.android.tablet||i.windows.tablet,i}const r_=(ac.default??ac)(globalThis.navigator),n_=9,es=100,s_=0,i_=0,lc=2,cc=1,o_=-1e3,a_=-1e3,l_=2;class hc{constructor(e,t=r_){this._mobileInfo=t,this.debug=!1,this._isActive=!1,this._isMobileAccessibility=!1,this._pool=[],this._renderId=0,this._children=[],this._androidUpdateCount=0,this._androidUpdateFrequency=500,this._hookDiv=null,(t.tablet||t.phone)&&this._createTouchHook();const n=document.createElement("div");n.style.width=`${es}px`,n.style.height=`${es}px`,n.style.position="absolute",n.style.top=`${s_}px`,n.style.left=`${i_}px`,n.style.zIndex=lc.toString(),this._div=n,this._renderer=e,this._onKeyDown=this._onKeyDown.bind(this),this._onMouseMove=this._onMouseMove.bind(this),globalThis.addEventListener("keydown",this._onKeyDown,!1)}get isActive(){return this._isActive}get isMobileAccessibility(){return this._isMobileAccessibility}get hookDiv(){return this._hookDiv}_createTouchHook(){const e=document.createElement("button");e.style.width=`${cc}px`,e.style.height=`${cc}px`,e.style.position="absolute",e.style.top=`${o_}px`,e.style.left=`${a_}px`,e.style.zIndex=l_.toString(),e.style.backgroundColor="#FF0000",e.title="select to enable accessibility for this content",e.addEventListener("focus",()=>{this._isMobileAccessibility=!0,this._activate(),this._destroyTouchHook()}),document.body.appendChild(e),this._hookDiv=e}_destroyTouchHook(){this._hookDiv&&(document.body.removeChild(this._hookDiv),this._hookDiv=null)}_activate(){var e;this._isActive||(this._isActive=!0,globalThis.document.addEventListener("mousemove",this._onMouseMove,!0),globalThis.removeEventListener("keydown",this._onKeyDown,!1),this._renderer.runners.postrender.add(this),(e=this._renderer.view.canvas.parentNode)==null||e.appendChild(this._div))}_deactivate(){var e;!this._isActive||this._isMobileAccessibility||(this._isActive=!1,globalThis.document.removeEventListener("mousemove",this._onMouseMove,!0),globalThis.addEventListener("keydown",this._onKeyDown,!1),this._renderer.runners.postrender.remove(this),(e=this._div.parentNode)==null||e.removeChild(this._div))}_updateAccessibleObjects(e){if(!e.visible||!e.accessibleChildren)return;e.accessible&&e.isInteractive()&&(e._accessibleActive||this._addChild(e),e._renderId=this._renderId);const t=e.children;if(t)for(let n=0;n<t.length;n++)this._updateAccessibleObjects(t[n])}init(e){this.debug=(e==null?void 0:e.debug)??this.debug,this._renderer.runners.postrender.remove(this)}postrender(){const e=performance.now();if(this._mobileInfo.android.device&&e<this._androidUpdateCount||(this._androidUpdateCount=e+this._androidUpdateFrequency,!this._renderer.renderingToScreen||!this._renderer.view.canvas))return;this._renderer.lastObjectRendered&&this._updateAccessibleObjects(this._renderer.lastObjectRendered);const{x:t,y:n,width:s,height:i}=this._renderer.view.canvas.getBoundingClientRect(),{width:o,height:a,resolution:l}=this._renderer,c=s/o*l,h=i/a*l;let u=this._div;u.style.left=`${t}px`,u.style.top=`${n}px`,u.style.width=`${o}px`,u.style.height=`${a}px`;for(let d=0;d<this._children.length;d++){const f=this._children[d];if(f._renderId!==this._renderId)f._accessibleActive=!1,Ml(this._children,d,1),this._div.removeChild(f._accessibleDiv),this._pool.push(f._accessibleDiv),f._accessibleDiv=null,d--;else{u=f._accessibleDiv;let p=f.hitArea;const g=f.worldTransform;f.hitArea?(u.style.left=`${(g.tx+p.x*g.a)*c}px`,u.style.top=`${(g.ty+p.y*g.d)*h}px`,u.style.width=`${p.width*g.a*c}px`,u.style.height=`${p.height*g.d*h}px`):(p=f.getBounds().rectangle,this._capHitArea(p),u.style.left=`${p.x*c}px`,u.style.top=`${p.y*h}px`,u.style.width=`${p.width*c}px`,u.style.height=`${p.height*h}px`,u.title!==f.accessibleTitle&&f.accessibleTitle!==null&&(u.title=f.accessibleTitle||""),u.getAttribute("aria-label")!==f.accessibleHint&&f.accessibleHint!==null&&u.setAttribute("aria-label",f.accessibleHint||"")),(f.accessibleTitle!==u.title||f.tabIndex!==u.tabIndex)&&(u.title=f.accessibleTitle||"",u.tabIndex=f.tabIndex,this.debug&&this._updateDebugHTML(u))}}this._renderId++}_updateDebugHTML(e){e.innerHTML=`type: ${e.type}</br> title : ${e.title}</br> tabIndex: ${e.tabIndex}`}_capHitArea(e){e.x<0&&(e.width+=e.x,e.x=0),e.y<0&&(e.height+=e.y,e.y=0);const{width:t,height:n}=this._renderer;e.x+e.width>t&&(e.width=t-e.x),e.y+e.height>n&&(e.height=n-e.y)}_addChild(e){let t=this._pool.pop();t||(t=document.createElement("button"),t.style.width=`${es}px`,t.style.height=`${es}px`,t.style.backgroundColor=this.debug?"rgba(255,255,255,0.5)":"transparent",t.style.position="absolute",t.style.zIndex=lc.toString(),t.style.borderStyle="none",navigator.userAgent.toLowerCase().includes("chrome")?t.setAttribute("aria-live","off"):t.setAttribute("aria-live","polite"),navigator.userAgent.match(/rv:.*Gecko\//)?t.setAttribute("aria-relevant","additions"):t.setAttribute("aria-relevant","text"),t.addEventListener("click",this._onClick.bind(this)),t.addEventListener("focus",this._onFocus.bind(this)),t.addEventListener("focusout",this._onFocusOut.bind(this))),t.style.pointerEvents=e.accessiblePointerEvents,t.type=e.accessibleType,e.accessibleTitle&&e.accessibleTitle!==null?t.title=e.accessibleTitle:(!e.accessibleHint||e.accessibleHint===null)&&(t.title=`container ${e.tabIndex}`),e.accessibleHint&&e.accessibleHint!==null&&t.setAttribute("aria-label",e.accessibleHint),this.debug&&this._updateDebugHTML(t),e._accessibleActive=!0,e._accessibleDiv=t,t.container=e,this._children.push(e),this._div.appendChild(e._accessibleDiv),e._accessibleDiv.tabIndex=e.tabIndex}_dispatchEvent(e,t){const{container:n}=e.target,s=this._renderer.events.rootBoundary,i=Object.assign(new rn(s),{target:n});s.rootTarget=this._renderer.lastObjectRendered,t.forEach(o=>s.dispatchEvent(i,o))}_onClick(e){this._dispatchEvent(e,["click","pointertap","tap"])}_onFocus(e){e.target.getAttribute("aria-live")||e.target.setAttribute("aria-live","assertive"),this._dispatchEvent(e,["mouseover"])}_onFocusOut(e){e.target.getAttribute("aria-live")||e.target.setAttribute("aria-live","polite"),this._dispatchEvent(e,["mouseout"])}_onKeyDown(e){e.keyCode===n_&&this._activate()}_onMouseMove(e){e.movementX===0&&e.movementY===0||this._deactivate()}destroy(){this._destroyTouchHook(),this._div=null,globalThis.document.removeEventListener("mousemove",this._onMouseMove,!0),globalThis.removeEventListener("keydown",this._onKeyDown),this._pool=null,this._children=null,this._renderer=null}}hc.extension={type:[M.WebGLSystem,M.WebGPUSystem],name:"accessibility"};const c_={accessible:!1,accessibleTitle:null,accessibleHint:null,tabIndex:0,_accessibleActive:!1,_accessibleDiv:null,accessibleType:"button",accessiblePointerEvents:"auto",accessibleChildren:!0,_renderId:-1},Pi=Object.create(null),uc=Object.create(null);function ts(r,e){let t=uc[r];return t===void 0&&(Pi[e]===void 0&&(Pi[e]=1),uc[r]=t=Pi[e]++),t}let Gr;function h_(){return(!Gr||Gr!=null&&Gr.isContextLost())&&(Gr=xe.get().createCanvas().getContext("webgl",{})),Gr}let rs;function u_(){if(!rs){rs="mediump";const r=h_();r&&r.getShaderPrecisionFormat&&(rs=r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.HIGH_FLOAT).precision?"highp":"mediump")}return rs}function d_(r,e,t){return e?r:t?(r=r.replace("out vec4 finalColor;",""),`
        
        #ifdef GL_ES // This checks if it is WebGL1
        #define in varying
        #define finalColor gl_FragColor
        #define texture texture2D
        #endif
        ${r}
        `):`
        
        #ifdef GL_ES // This checks if it is WebGL1
        #define in attribute
        #define out varying
        #endif
        ${r}
        `}function f_(r,e,t){const n=t?e.maxSupportedFragmentPrecision:e.maxSupportedVertexPrecision;if(r.substring(0,9)!=="precision"){let s=t?e.requestedFragmentPrecision:e.requestedVertexPrecision;return s==="highp"&&n!=="highp"&&(s="mediump"),`precision ${s} float;
${r}`}else if(n!=="highp"&&r.substring(0,15)==="precision highp")return r.replace("precision highp","precision mediump");return r}function p_(r,e){return e?`#version 300 es
${r}`:r}const m_={},g_={};function __(r,{name:e="pixi-program"},t=!0){e=e.replace(/\s+/g,"-"),e+=t?"-fragment":"-vertex";const n=t?m_:g_;return n[e]?(n[e]++,e+=`-${n[e]}`):n[e]=1,r.indexOf("#define SHADER_NAME")!==-1?r:`${`#define SHADER_NAME ${e}`}
${r}`}function y_(r,e){return e?r.replace("#version 300 es",""):r}const Ai={stripVersion:y_,ensurePrecision:f_,addProgramDefines:d_,setProgramName:__,insertVersion:p_},Mi=Object.create(null),dc=class jo{constructor(e){e={...jo.defaultOptions,...e};const t=e.fragment.indexOf("#version 300 es")!==-1,n={stripVersion:t,ensurePrecision:{requestedFragmentPrecision:e.preferredFragmentPrecision,requestedVertexPrecision:e.preferredVertexPrecision,maxSupportedVertexPrecision:"highp",maxSupportedFragmentPrecision:u_()},setProgramName:{name:e.name},addProgramDefines:t,insertVersion:t};let s=e.fragment,i=e.vertex;Object.keys(Ai).forEach(o=>{const a=n[o];s=Ai[o](s,a,!0),i=Ai[o](i,a,!1)}),this.fragment=s,this.vertex=i,this._key=ts(`${this.vertex}:${this.fragment}`,"gl-program")}destroy(){this.fragment=null,this.vertex=null,this._attributeData=null,this._uniformData=null,this._uniformBlockData=null,this.transformFeedbackVaryings=null}static from(e){const t=`${e.vertex}:${e.fragment}`;return Mi[t]||(Mi[t]=new jo(e)),Mi[t]}};dc.defaultOptions={preferredVertexPrecision:"highp",preferredFragmentPrecision:"mediump"};let nn=dc;const fc={uint8x2:{size:2,stride:2,normalised:!1},uint8x4:{size:4,stride:4,normalised:!1},sint8x2:{size:2,stride:2,normalised:!1},sint8x4:{size:4,stride:4,normalised:!1},unorm8x2:{size:2,stride:2,normalised:!0},unorm8x4:{size:4,stride:4,normalised:!0},snorm8x2:{size:2,stride:2,normalised:!0},snorm8x4:{size:4,stride:4,normalised:!0},uint16x2:{size:2,stride:4,normalised:!1},uint16x4:{size:4,stride:8,normalised:!1},sint16x2:{size:2,stride:4,normalised:!1},sint16x4:{size:4,stride:8,normalised:!1},unorm16x2:{size:2,stride:4,normalised:!0},unorm16x4:{size:4,stride:8,normalised:!0},snorm16x2:{size:2,stride:4,normalised:!0},snorm16x4:{size:4,stride:8,normalised:!0},float16x2:{size:2,stride:4,normalised:!1},float16x4:{size:4,stride:8,normalised:!1},float32:{size:1,stride:4,normalised:!1},float32x2:{size:2,stride:8,normalised:!1},float32x3:{size:3,stride:12,normalised:!1},float32x4:{size:4,stride:16,normalised:!1},uint32:{size:1,stride:4,normalised:!1},uint32x2:{size:2,stride:8,normalised:!1},uint32x3:{size:3,stride:12,normalised:!1},uint32x4:{size:4,stride:16,normalised:!1},sint32:{size:1,stride:4,normalised:!1},sint32x2:{size:2,stride:8,normalised:!1},sint32x3:{size:3,stride:12,normalised:!1},sint32x4:{size:4,stride:16,normalised:!1}};function sn(r){return fc[r]??fc.float32}const b_={f32:"float32","vec2<f32>":"float32x2","vec3<f32>":"float32x3","vec4<f32>":"float32x4",vec2f:"float32x2",vec3f:"float32x3",vec4f:"float32x4",i32:"sint32","vec2<i32>":"sint32x2","vec3<i32>":"sint32x3","vec4<i32>":"sint32x4",u32:"uint32","vec2<u32>":"uint32x2","vec3<u32>":"uint32x3","vec4<u32>":"uint32x4",bool:"uint32","vec2<bool>":"uint32x2","vec3<bool>":"uint32x3","vec4<bool>":"uint32x4"};function x_({source:r,entryPoint:e}){const t={},n=r.indexOf(`fn ${e}`);if(n!==-1){const s=r.indexOf("->",n);if(s!==-1){const i=r.substring(n,s),o=/@location\((\d+)\)\s+([a-zA-Z0-9_]+)\s*:\s*([a-zA-Z0-9_<>]+)(?:,|\s|$)/g;let a;for(;(a=o.exec(i))!==null;){const l=b_[a[3]]??"float32";t[a[2]]={location:parseInt(a[1],10),format:l,stride:sn(l).stride,offset:0,instance:!1,start:0}}}}return t}function Ci(r){var u,d;const e=/(^|[^/])@(group|binding)\(\d+\)[^;]+;/g,t=/@group\((\d+)\)/,n=/@binding\((\d+)\)/,s=/var(<[^>]+>)? (\w+)/,i=/:\s*(\w+)/,o=/struct\s+(\w+)\s*{([^}]+)}/g,a=/(\w+)\s*:\s*([\w\<\>]+)/g,l=/struct\s+(\w+)/,c=(u=r.match(e))==null?void 0:u.map(f=>({group:parseInt(f.match(t)[1],10),binding:parseInt(f.match(n)[1],10),name:f.match(s)[2],isUniform:f.match(s)[1]==="<uniform>",type:f.match(i)[1]}));if(!c)return{groups:[],structs:[]};const h=((d=r.match(o))==null?void 0:d.map(f=>{const p=f.match(l)[1],g=f.match(a).reduce((m,_)=>{const[b,y]=_.split(":");return m[b.trim()]=y.trim(),m},{});return g?{name:p,members:g}:null}).filter(({name:f})=>c.some(p=>p.type===f)))??[];return{groups:c,structs:h}}var on=(r=>(r[r.VERTEX=1]="VERTEX",r[r.FRAGMENT=2]="FRAGMENT",r[r.COMPUTE=4]="COMPUTE",r))(on||{});function v_({groups:r}){const e=[];for(let t=0;t<r.length;t++){const n=r[t];e[n.group]||(e[n.group]=[]),n.isUniform?e[n.group].push({binding:n.binding,visibility:on.VERTEX|on.FRAGMENT,buffer:{type:"uniform"}}):n.type==="sampler"?e[n.group].push({binding:n.binding,visibility:on.FRAGMENT,sampler:{type:"filtering"}}):n.type==="texture_2d"&&e[n.group].push({binding:n.binding,visibility:on.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}})}return e}function w_({groups:r}){const e=[];for(let t=0;t<r.length;t++){const n=r[t];e[n.group]||(e[n.group]={}),e[n.group][n.name]=n.binding}return e}function S_(r,e){const t=new Set,n=new Set,s=[...r.structs,...e.structs].filter(o=>t.has(o.name)?!1:(t.add(o.name),!0)),i=[...r.groups,...e.groups].filter(o=>{const a=`${o.name}-${o.binding}`;return n.has(a)?!1:(n.add(a),!0)});return{structs:s,groups:i}}const Bi=Object.create(null);class Ur{constructor(e){var a,l;this._layoutKey=0;const{fragment:t,vertex:n,layout:s,gpuLayout:i,name:o}=e;if(this.name=o,this.fragment=t,this.vertex=n,t.source===n.source){const c=Ci(t.source);this.structsAndGroups=c}else{const c=Ci(n.source),h=Ci(t.source);this.structsAndGroups=S_(c,h)}this.layout=s??w_(this.structsAndGroups),this.gpuLayout=i??v_(this.structsAndGroups),this.autoAssignGlobalUniforms=((a=this.layout[0])==null?void 0:a.globalUniforms)!==void 0,this.autoAssignLocalUniforms=((l=this.layout[1])==null?void 0:l.localUniforms)!==void 0,this._generateProgramKey()}_generateProgramKey(){const{vertex:e,fragment:t}=this,n=e.source+t.source+e.entryPoint+t.entryPoint;this._layoutKey=ts(n,"program")}get attributeData(){return this._attributeData??(this._attributeData=x_(this.vertex)),this._attributeData}destroy(){this.gpuLayout=null,this.layout=null,this.structsAndGroups=null,this.fragment=null,this.vertex=null}static from(e){const t=`${e.vertex.source}:${e.fragment.source}:${e.fragment.entryPoint}:${e.vertex.entryPoint}`;return Bi[t]||(Bi[t]=new Ur(e)),Bi[t]}}function T_(r,e){switch(r){case"f32":return 0;case"vec2<f32>":return new Float32Array(2*e);case"vec3<f32>":return new Float32Array(3*e);case"vec4<f32>":return new Float32Array(4*e);case"mat2x2<f32>":return new Float32Array([1,0,0,1]);case"mat3x3<f32>":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4x4<f32>":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}const pc=class Dd{constructor(e,t){this._touched=0,this.uid=be("uniform"),this._resourceType="uniformGroup",this._resourceId=be("resource"),this.isUniformGroup=!0,this._dirtyId=0,this.destroyed=!1,t={...Dd.defaultOptions,...t},this.uniformStructures=e;const n={};for(const s in e){const i=e[s];i.name=s,i.size=i.size??1,i.value??(i.value=T_(i.type,i.size)),n[s]=i.value}this.uniforms=n,this._dirtyId=1,this.ubo=t.ubo,this.isStatic=t.isStatic,this._signature=ts(Object.keys(n).map(s=>`${s}-${e[s].type}`).join("-"),"uniform-group")}update(){this._dirtyId++}};pc.defaultOptions={ubo:!1,isStatic:!1};let Qe=pc;class Ot{constructor(e){this.resources=Object.create(null),this._dirty=!0;let t=0;for(const n in e){const s=e[n];this.setResource(s,t++)}this._updateKey()}_updateKey(){if(!this._dirty)return;this._dirty=!1;const e=[];let t=0;for(const n in this.resources)e[t++]=this.resources[n]._resourceId;this._key=e.join("|")}setResource(e,t){var s,i;const n=this.resources[t];e!==n&&(n&&((s=e.off)==null||s.call(e,"change",this.onResourceChange,this)),(i=e.on)==null||i.call(e,"change",this.onResourceChange,this),this.resources[t]=e,this._dirty=!0)}getResource(e){return this.resources[e]}_touch(e){const t=this.resources;for(const n in t)t[n]._touched=e}destroy(){var t;const e=this.resources;for(const n in e){const s=e[n];(t=s.off)==null||t.call(s,"change",this.onResourceChange,this)}this.resources=null}onResourceChange(e){if(this._dirty=!0,e.destroyed){const t=this.resources;for(const n in t)t[n]===e&&(t[n]=null)}else this._updateKey()}}var Et=(r=>(r[r.WEBGL=1]="WEBGL",r[r.WEBGPU=2]="WEBGPU",r[r.BOTH=3]="BOTH",r))(Et||{});class ot extends Ke{constructor(e){super(),this._uniformBindMap=Object.create(null),this._ownedBindGroups=[];let{gpuProgram:t,glProgram:n,groups:s,resources:i,compatibleRenderers:o,groupMap:a}=e;this.gpuProgram=t,this.glProgram=n,o===void 0&&(o=0,t&&(o|=Et.WEBGPU),n&&(o|=Et.WEBGL)),this.compatibleRenderers=o;const l={};if(!i&&!s&&(i={}),i&&s)throw new Error("[Shader] Cannot have both resources and groups");if(!t&&s&&!a)throw new Error("[Shader] No group map or WebGPU shader provided - consider using resources instead.");if(!t&&s&&a)for(const c in a)for(const h in a[c]){const u=a[c][h];l[u]={group:c,binding:h,name:u}}else if(t&&s&&!a){const c=t.structsAndGroups.groups;a={},c.forEach(h=>{a[h.group]=a[h.group]||{},a[h.group][h.binding]=h.name,l[h.name]=h})}else if(i){if(t){const c=t.structsAndGroups.groups;a={},c.forEach(h=>{a[h.group]=a[h.group]||{},a[h.group][h.binding]=h.name,l[h.name]=h})}else{a={},s={99:new Ot},this._ownedBindGroups.push(s[99]);let c=0;for(const h in i)l[h]={group:99,binding:c,name:h},a[99]=a[99]||{},a[99][c]=h,c++}s={};for(const c in i){const h=c;let u=i[c];!u.source&&!u._resourceType&&(u=new Qe(u));const d=l[h];d&&(s[d.group]||(s[d.group]=new Ot,this._ownedBindGroups.push(s[d.group])),s[d.group].setResource(u,d.binding))}}this.groups=s,this._uniformBindMap=a,this.resources=this._buildResourceAccessor(s,l)}addResource(e,t,n){var s,i;(s=this._uniformBindMap)[t]||(s[t]={}),(i=this._uniformBindMap[t])[n]||(i[n]=e),this.groups[t]||(this.groups[t]=new Ot,this._ownedBindGroups.push(this.groups[t]))}_buildResourceAccessor(e,t){const n={};for(const s in t){const i=t[s];Object.defineProperty(n,i.name,{get(){return e[i.group].getResource(i.binding)},set(o){e[i.group].setResource(o,i.binding)}})}return n}destroy(e=!1){var t,n;this.emit("destroy",this),e&&((t=this.gpuProgram)==null||t.destroy(),(n=this.glProgram)==null||n.destroy()),this.gpuProgram=null,this.glProgram=null,this.removeAllListeners(),this._uniformBindMap=null,this._ownedBindGroups.forEach(s=>{s.destroy()}),this._ownedBindGroups=null,this.resources=null,this.groups=null}static from(e){const{gpu:t,gl:n,...s}=e;let i,o;return t&&(i=Ur.from(t)),n&&(o=nn.from(n)),new ot({gpuProgram:i,glProgram:o,...s})}}const E_={normal:0,add:1,multiply:2,screen:3,overlay:4,erase:5,"normal-npm":6,"add-npm":7,"screen-npm":8},Ri=0,ki=1,Ii=2,Gi=3,Ui=4,Fi=5,Oi=class Ld{constructor(){this.data=0,this.blendMode="normal",this.polygonOffset=0,this.blend=!0,this.depthMask=!0}get blend(){return!!(this.data&1<<Ri)}set blend(e){!!(this.data&1<<Ri)!==e&&(this.data^=1<<Ri)}get offsets(){return!!(this.data&1<<ki)}set offsets(e){!!(this.data&1<<ki)!==e&&(this.data^=1<<ki)}set cullMode(e){if(e==="none"){this.culling=!1;return}this.culling=!0,this.clockwiseFrontFace=e==="front"}get cullMode(){return this.culling?this.clockwiseFrontFace?"front":"back":"none"}get culling(){return!!(this.data&1<<Ii)}set culling(e){!!(this.data&1<<Ii)!==e&&(this.data^=1<<Ii)}get depthTest(){return!!(this.data&1<<Gi)}set depthTest(e){!!(this.data&1<<Gi)!==e&&(this.data^=1<<Gi)}get depthMask(){return!!(this.data&1<<Fi)}set depthMask(e){!!(this.data&1<<Fi)!==e&&(this.data^=1<<Fi)}get clockwiseFrontFace(){return!!(this.data&1<<Ui)}set clockwiseFrontFace(e){!!(this.data&1<<Ui)!==e&&(this.data^=1<<Ui)}get blendMode(){return this._blendMode}set blendMode(e){this.blend=e!=="none",this._blendMode=e,this._blendModeId=E_[e]||0}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){this.offsets=!!e,this._polygonOffset=e}toString(){return`[pixi.js/core:State blendMode=${this.blendMode} clockwiseFrontFace=${this.clockwiseFrontFace} culling=${this.culling} depthMask=${this.depthMask} polygonOffset=${this.polygonOffset}]`}static for2d(){const e=new Ld;return e.depthTest=!1,e.blend=!0,e}};Oi.default2d=Oi.for2d();let Dt=Oi;const mc=class qo extends ot{constructor(e){e={...qo.defaultOptions,...e},super(e),this.enabled=!0,this._state=Dt.for2d(),this.padding=e.padding,typeof e.antialias=="boolean"?this.antialias=e.antialias?"on":"off":this.antialias=e.antialias,this.resolution=e.resolution,this.blendRequired=e.blendRequired,this.addResource("uTexture",0,1)}apply(e,t,n,s){e.applyFilter(this,t,n,s)}get blendMode(){return this._state.blendMode}set blendMode(e){this._state.blendMode=e}static from(e){const{gpu:t,gl:n,...s}=e;let i,o;return t&&(i=Ur.from(t)),n&&(o=nn.from(n)),new qo({gpuProgram:i,glProgram:o,...s})}};mc.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1};let P_=mc;const Di=[];re.handleByNamedList(M.Environment,Di);async function A_(r){if(r)for(let e=0;e<Di.length;e++){const t=Di[e];if(t.value.test()){await t.value.load();return}}}let an;function gc(){if(typeof an=="boolean")return an;try{an=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{an=!1}return an}var Li={exports:{}};Li.exports=ns,Li.exports.default=ns;function ns(r,e,t){t=t||2;var n=e&&e.length,s=n?e[0]*t:r.length,i=_c(r,0,s,t,!0),o=[];if(!i||i.next===i.prev)return o;var a,l,c,h,u,d,f;if(n&&(i=k_(r,e,i,t)),r.length>80*t){a=c=r[0],l=h=r[1];for(var p=t;p<s;p+=t)u=r[p],d=r[p+1],u<a&&(a=u),d<l&&(l=d),u>c&&(c=u),d>h&&(h=d);f=Math.max(c-a,h-l),f=f!==0?32767/f:0}return ln(i,o,t,a,l,f,0),o}function _c(r,e,t,n,s){var i,o;if(s===zi(r,e,t,n)>0)for(i=e;i<t;i+=n)o=xc(i,r[i],r[i+1],o);else for(i=t-n;i>=e;i-=n)o=xc(i,r[i],r[i+1],o);return o&&ss(o,o.next)&&(hn(o),o=o.next),o}function ir(r,e){if(!r)return r;e||(e=r);var t=r,n;do if(n=!1,!t.steiner&&(ss(t,t.next)||ve(t.prev,t,t.next)===0)){if(hn(t),t=e=t.prev,t===t.next)break;n=!0}else t=t.next;while(n||t!==e);return e}function ln(r,e,t,n,s,i,o){if(r){!o&&i&&O_(r,n,s,i);for(var a=r,l,c;r.prev!==r.next;){if(l=r.prev,c=r.next,i?C_(r,n,s,i):M_(r)){e.push(l.i/t|0),e.push(r.i/t|0),e.push(c.i/t|0),hn(r),r=c.next,a=c.next;continue}if(r=c,r===a){o?o===1?(r=B_(ir(r),e,t),ln(r,e,t,n,s,i,2)):o===2&&R_(r,e,t,n,s,i):ln(ir(r),e,t,n,s,i,1);break}}}}function M_(r){var e=r.prev,t=r,n=r.next;if(ve(e,t,n)>=0)return!1;for(var s=e.x,i=t.x,o=n.x,a=e.y,l=t.y,c=n.y,h=s<i?s<o?s:o:i<o?i:o,u=a<l?a<c?a:c:l<c?l:c,d=s>i?s>o?s:o:i>o?i:o,f=a>l?a>c?a:c:l>c?l:c,p=n.next;p!==e;){if(p.x>=h&&p.x<=d&&p.y>=u&&p.y<=f&&Fr(s,a,i,l,o,c,p.x,p.y)&&ve(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function C_(r,e,t,n){var s=r.prev,i=r,o=r.next;if(ve(s,i,o)>=0)return!1;for(var a=s.x,l=i.x,c=o.x,h=s.y,u=i.y,d=o.y,f=a<l?a<c?a:c:l<c?l:c,p=h<u?h<d?h:d:u<d?u:d,g=a>l?a>c?a:c:l>c?l:c,m=h>u?h>d?h:d:u>d?u:d,_=Ni(f,p,e,t,n),b=Ni(g,m,e,t,n),y=r.prevZ,x=r.nextZ;y&&y.z>=_&&x&&x.z<=b;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==s&&y!==o&&Fr(a,h,l,u,c,d,y.x,y.y)&&ve(y.prev,y,y.next)>=0||(y=y.prevZ,x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==s&&x!==o&&Fr(a,h,l,u,c,d,x.x,x.y)&&ve(x.prev,x,x.next)>=0))return!1;x=x.nextZ}for(;y&&y.z>=_;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==s&&y!==o&&Fr(a,h,l,u,c,d,y.x,y.y)&&ve(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;x&&x.z<=b;){if(x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==s&&x!==o&&Fr(a,h,l,u,c,d,x.x,x.y)&&ve(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function B_(r,e,t){var n=r;do{var s=n.prev,i=n.next.next;!ss(s,i)&&yc(s,n,n.next,i)&&cn(s,i)&&cn(i,s)&&(e.push(s.i/t|0),e.push(n.i/t|0),e.push(i.i/t|0),hn(n),hn(n.next),n=r=i),n=n.next}while(n!==r);return ir(n)}function R_(r,e,t,n,s,i){var o=r;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&N_(o,a)){var l=bc(o,a);o=ir(o,o.next),l=ir(l,l.next),ln(o,e,t,n,s,i,0),ln(l,e,t,n,s,i,0);return}a=a.next}o=o.next}while(o!==r)}function k_(r,e,t,n){var s=[],i,o,a,l,c;for(i=0,o=e.length;i<o;i++)a=e[i]*n,l=i<o-1?e[i+1]*n:r.length,c=_c(r,a,l,n,!1),c===c.next&&(c.steiner=!0),s.push(L_(c));for(s.sort(I_),i=0;i<s.length;i++)t=G_(s[i],t);return t}function I_(r,e){return r.x-e.x}function G_(r,e){var t=U_(r,e);if(!t)return e;var n=bc(t,r);return ir(n,n.next),ir(t,t.next)}function U_(r,e){var t=e,n=r.x,s=r.y,i=-1/0,o;do{if(s<=t.y&&s>=t.next.y&&t.next.y!==t.y){var a=t.x+(s-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(a<=n&&a>i&&(i=a,o=t.x<t.next.x?t:t.next,a===n))return o}t=t.next}while(t!==e);if(!o)return null;var l=o,c=o.x,h=o.y,u=1/0,d;t=o;do n>=t.x&&t.x>=c&&n!==t.x&&Fr(s<h?n:i,s,c,h,s<h?i:n,s,t.x,t.y)&&(d=Math.abs(s-t.y)/(n-t.x),cn(t,r)&&(d<u||d===u&&(t.x>o.x||t.x===o.x&&F_(o,t)))&&(o=t,u=d)),t=t.next;while(t!==l);return o}function F_(r,e){return ve(r.prev,r,e.prev)<0&&ve(e.next,r,r.next)<0}function O_(r,e,t,n){var s=r;do s.z===0&&(s.z=Ni(s.x,s.y,e,t,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==r);s.prevZ.nextZ=null,s.prevZ=null,D_(s)}function D_(r){var e,t,n,s,i,o,a,l,c=1;do{for(t=r,r=null,i=null,o=0;t;){for(o++,n=t,a=0,e=0;e<c&&(a++,n=n.nextZ,!!n);e++);for(l=c;a>0||l>0&&n;)a!==0&&(l===0||!n||t.z<=n.z)?(s=t,t=t.nextZ,a--):(s=n,n=n.nextZ,l--),i?i.nextZ=s:r=s,s.prevZ=i,i=s;t=n}i.nextZ=null,c*=2}while(o>1);return r}function Ni(r,e,t,n,s){return r=(r-t)*s|0,e=(e-n)*s|0,r=(r|r<<8)&16711935,r=(r|r<<4)&252645135,r=(r|r<<2)&858993459,r=(r|r<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,r|e<<1}function L_(r){var e=r,t=r;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==r);return t}function Fr(r,e,t,n,s,i,o,a){return(s-o)*(e-a)>=(r-o)*(i-a)&&(r-o)*(n-a)>=(t-o)*(e-a)&&(t-o)*(i-a)>=(s-o)*(n-a)}function N_(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!H_(r,e)&&(cn(r,e)&&cn(e,r)&&z_(r,e)&&(ve(r.prev,r,e.prev)||ve(r,e.prev,e))||ss(r,e)&&ve(r.prev,r,r.next)>0&&ve(e.prev,e,e.next)>0)}function ve(r,e,t){return(e.y-r.y)*(t.x-e.x)-(e.x-r.x)*(t.y-e.y)}function ss(r,e){return r.x===e.x&&r.y===e.y}function yc(r,e,t,n){var s=os(ve(r,e,t)),i=os(ve(r,e,n)),o=os(ve(t,n,r)),a=os(ve(t,n,e));return!!(s!==i&&o!==a||s===0&&is(r,t,e)||i===0&&is(r,n,e)||o===0&&is(t,r,n)||a===0&&is(t,e,n))}function is(r,e,t){return e.x<=Math.max(r.x,t.x)&&e.x>=Math.min(r.x,t.x)&&e.y<=Math.max(r.y,t.y)&&e.y>=Math.min(r.y,t.y)}function os(r){return r>0?1:r<0?-1:0}function H_(r,e){var t=r;do{if(t.i!==r.i&&t.next.i!==r.i&&t.i!==e.i&&t.next.i!==e.i&&yc(t,t.next,r,e))return!0;t=t.next}while(t!==r);return!1}function cn(r,e){return ve(r.prev,r,r.next)<0?ve(r,e,r.next)>=0&&ve(r,r.prev,e)>=0:ve(r,e,r.prev)<0||ve(r,r.next,e)<0}function z_(r,e){var t=r,n=!1,s=(r.x+e.x)/2,i=(r.y+e.y)/2;do t.y>i!=t.next.y>i&&t.next.y!==t.y&&s<(t.next.x-t.x)*(i-t.y)/(t.next.y-t.y)+t.x&&(n=!n),t=t.next;while(t!==r);return n}function bc(r,e){var t=new Hi(r.i,r.x,r.y),n=new Hi(e.i,e.x,e.y),s=r.next,i=e.prev;return r.next=e,e.prev=r,t.next=s,s.prev=t,n.next=t,t.prev=n,i.next=n,n.prev=i,n}function xc(r,e,t,n){var s=new Hi(r,e,t);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function hn(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Hi(r,e,t){this.i=r,this.x=e,this.y=t,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}ns.deviation=function(r,e,t,n){var s=e&&e.length,i=s?e[0]*t:r.length,o=Math.abs(zi(r,0,i,t));if(s)for(var a=0,l=e.length;a<l;a++){var c=e[a]*t,h=a<l-1?e[a+1]*t:r.length;o-=Math.abs(zi(r,c,h,t))}var u=0;for(a=0;a<n.length;a+=3){var d=n[a]*t,f=n[a+1]*t,p=n[a+2]*t;u+=Math.abs((r[d]-r[p])*(r[f+1]-r[d+1])-(r[d]-r[f])*(r[p+1]-r[d+1]))}return o===0&&u===0?0:Math.abs((u-o)/o)};function zi(r,e,t,n){for(var s=0,i=e,o=t-n;i<t;i+=n)s+=(r[o]-r[i])*(r[i+1]+r[o+1]),o=i;return s}ns.flatten=function(r){for(var e=r[0][0].length,t={vertices:[],holes:[],dimensions:e},n=0,s=0;s<r.length;s++){for(var i=0;i<r[s].length;i++)for(var o=0;o<e;o++)t.vertices.push(r[s][i][o]);s>0&&(n+=r[s-1].length,t.holes.push(n))}return t};var $_=Li.exports;const W_=Js($_);var Je=(r=>(r[r.NONE=0]="NONE",r[r.COLOR=16384]="COLOR",r[r.STENCIL=1024]="STENCIL",r[r.DEPTH=256]="DEPTH",r[r.COLOR_DEPTH=16640]="COLOR_DEPTH",r[r.COLOR_STENCIL=17408]="COLOR_STENCIL",r[r.DEPTH_STENCIL=1280]="DEPTH_STENCIL",r[r.ALL=17664]="ALL",r))(Je||{});class vc{constructor(e){this.items=[],this._name=e}emit(e,t,n,s,i,o,a,l){const{name:c,items:h}=this;for(let u=0,d=h.length;u<d;u++)h[u][c](e,t,n,s,i,o,a,l);return this}add(e){return e[this._name]&&(this.remove(e),this.items.push(e)),this}remove(e){const t=this.items.indexOf(e);return t!==-1&&this.items.splice(t,1),this}contains(e){return this.items.indexOf(e)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const V_=["init","destroy","contextChange","resolutionChange","reset","renderEnd","renderStart","render","update","postrender","prerender"],wc=class Nd extends Ke{constructor(e){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=e.type,this.name=e.name;const t=[...V_,...e.runners??[]];this._addRunners(...t),this._addSystems(e.systems),this._addPipes(e.renderPipes,e.renderPipeAdaptors),this._unsafeEvalCheck()}async init(e={}){for(const t in this._systemsHash)e={...this._systemsHash[t].constructor.defaultOptions,...e};e={...Nd.defaultOptions,...e},this._roundPixels=e.roundPixels?1:0;for(let t=0;t<this.runners.init.items.length;t++)await this.runners.init.items[t].init(e);this._initOptions=e}render(e,t){let n=e;if(n instanceof Se&&(n={container:n},t&&(ie(le,"passing a second argument is deprecated, please use render options instead"),n.target=t.renderTexture)),n.target||(n.target=this.view.renderTarget),n.target===this.view.renderTarget&&(this._lastObjectRendered=n.container,n.clearColor=this.background.colorRgba),n.clearColor){const s=Array.isArray(n.clearColor)&&n.clearColor.length===4;n.clearColor=s?n.clearColor:ue.shared.setValue(n.clearColor).toArray()}n.transform||(n.container.updateLocalTransform(),n.transform=n.container.localTransform),this.runners.prerender.emit(n),this.runners.renderStart.emit(n),this.runners.render.emit(n),this.runners.renderEnd.emit(n),this.runners.postrender.emit(n)}resize(e,t,n){this.view.resize(e,t,n),this.emit("resize",this.view.screen.width,this.view.screen.height)}clear(e={}){const t=this;e.target||(e.target=t.renderTarget.renderTarget),e.clearColor||(e.clearColor=this.background.colorRgba),e.clear??(e.clear=Je.ALL);const{clear:n,clearColor:s,target:i}=e;ue.shared.setValue(s??this.background.colorRgba),t.renderTarget.clear(i,n,ue.shared.toArray())}get resolution(){return this.view.resolution}set resolution(e){this.view.resolution=e,this.runners.resolutionChange.emit(e)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...e){e.forEach(t=>{this.runners[t]=new vc(t)})}_addSystems(e){let t;for(t in e){const n=e[t];this._addSystem(n.value,n.name)}}_addSystem(e,t){const n=new e(this);if(this[t])throw new Error(`Whoops! The name "${t}" is already in use`);this[t]=n,this._systemsHash[t]=n;for(const s in this.runners)this.runners[s].add(n);return this}_addPipes(e,t){const n=t.reduce((s,i)=>(s[i.name]=i.value,s),{});e.forEach(s=>{const i=s.value,o=s.name,a=n[o];this.renderPipes[o]=new i(this,a?new a:null)})}destroy(e=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(e),Object.values(this.runners).forEach(t=>{t.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(e){return this.textureGenerator.generateTexture(e)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!gc())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}};wc.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let as=wc,ls;function X_(r){return ls!==void 0||(ls=(()=>{var t;const e={stencil:!0,failIfMajorPerformanceCaveat:r??as.defaultOptions.failIfMajorPerformanceCaveat};try{if(!xe.get().getWebGLRenderingContext())return!1;let s=xe.get().createCanvas().getContext("webgl",e);const i=!!((t=s==null?void 0:s.getContextAttributes())!=null&&t.stencil);if(s){const o=s.getExtension("WEBGL_lose_context");o&&o.loseContext()}return s=null,i}catch{return!1}})()),ls}let cs;async function Y_(r={}){return cs!==void 0||(cs=await(async()=>{if(!xe.get().getNavigator().gpu)return!1;try{return await(await navigator.gpu.requestAdapter(r)).requestDevice(),!0}catch{return!1}})()),cs}const Sc=["webgl","webgpu","canvas"];async function j_(r){let e=[];r.preference?(e.push(r.preference),Sc.forEach(i=>{i!==r.preference&&e.push(i)})):e=Sc.slice();let t;await A_(r.manageImports??!0);let n={};for(let i=0;i<e.length;i++){const o=e[i];if(o==="webgpu"&&await Y_()){const{WebGPURenderer:a}=await Promise.resolve().then(()=>d0);t=a,n={...r,...r.webgpu};break}else if(o==="webgl"&&X_(r.failIfMajorPerformanceCaveat??as.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await Promise.resolve().then(()=>Yx);t=a,n={...r,...r.webgl};break}else if(o==="canvas")throw n={...r},new Error("CanvasRenderer is not yet implemented")}if(delete n.webgpu,delete n.webgl,!t)throw new Error("No available renderer for the current environment");const s=new t;return await s.init(n),s}class Tc{static init(e){Object.defineProperty(this,"resizeTo",{set(t){globalThis.removeEventListener("resize",this.queueResize),this._resizeTo=t,t&&(globalThis.addEventListener("resize",this.queueResize),this.resize())},get(){return this._resizeTo}}),this.queueResize=()=>{this._resizeTo&&(this._cancelResize(),this._resizeId=requestAnimationFrame(()=>this.resize()))},this._cancelResize=()=>{this._resizeId&&(cancelAnimationFrame(this._resizeId),this._resizeId=null)},this.resize=()=>{if(!this._resizeTo)return;this._cancelResize();let t,n;if(this._resizeTo===globalThis.window)t=globalThis.innerWidth,n=globalThis.innerHeight;else{const{clientWidth:s,clientHeight:i}=this._resizeTo;t=s,n=i}this.renderer.resize(t,n),this.render()},this._resizeId=null,this._resizeTo=null,this.resizeTo=e.resizeTo||null}static destroy(){globalThis.removeEventListener("resize",this.queueResize),this._cancelResize(),this._cancelResize=null,this.queueResize=null,this.resizeTo=null,this.resize=null}}Tc.extension=M.Application;class Ec{static init(e){e=Object.assign({autoStart:!0,sharedTicker:!1},e),Object.defineProperty(this,"ticker",{set(t){this._ticker&&this._ticker.remove(this.render,this),this._ticker=t,t&&t.add(this.render,this,en.LOW)},get(){return this._ticker}}),this.stop=()=>{this._ticker.stop()},this.start=()=>{this._ticker.start()},this._ticker=null,this.ticker=e.sharedTicker?Wt.shared:new Wt,e.autoStart&&this.start()}static destroy(){if(this._ticker){const e=this._ticker;this.ticker=null,e.destroy()}}}Ec.extension=M.Application;var q_=Z_,$i={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},K_=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function Z_(r){var e=[];return r.replace(K_,function(t,n,s){var i=n.toLowerCase();for(s=J_(s),i=="m"&&s.length>2&&(e.push([n].concat(s.splice(0,2))),i="l",n=n=="m"?"l":"L");;){if(s.length==$i[i])return s.unshift(n),e.push(s);if(s.length<$i[i])throw new Error("malformed path data");e.push([n].concat(s.splice(0,$i[i])))}}),e}var Q_=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function J_(r){var e=r.match(Q_);return e?e.map(Number):[]}const ey=Js(q_);function ty(r,e){const t=ey(r),n=[];let s=null,i=0,o=0;for(let a=0;a<t.length;a++){const l=t[a],c=l[0],h=l;switch(c){case"M":i=h[1],o=h[2],e.moveTo(i,o);break;case"m":i+=h[1],o+=h[2],e.moveTo(i,o);break;case"H":i=h[1],e.lineTo(i,o);break;case"h":i+=h[1],e.lineTo(i,o);break;case"V":o=h[1],e.lineTo(i,o);break;case"v":o+=h[1],e.lineTo(i,o);break;case"L":i=h[1],o=h[2],e.lineTo(i,o);break;case"l":i+=h[1],o+=h[2],e.lineTo(i,o);break;case"C":i=h[5],o=h[6],e.bezierCurveTo(h[1],h[2],h[3],h[4],i,o);break;case"c":e.bezierCurveTo(i+h[1],o+h[2],i+h[3],o+h[4],i+h[5],o+h[6]),i+=h[5],o+=h[6];break;case"S":i=h[3],o=h[4],e.bezierCurveToShort(h[1],h[2],i,o);break;case"s":e.bezierCurveToShort(i+h[1],o+h[2],i+h[3],o+h[4]),i+=h[3],o+=h[4];break;case"Q":i=h[3],o=h[4],e.quadraticCurveTo(h[1],h[2],i,o);break;case"q":e.quadraticCurveTo(i+h[1],o+h[2],i+h[3],o+h[4]),i+=h[3],o+=h[4];break;case"T":i=h[1],o=h[2],e.quadraticCurveToShort(i,o);break;case"t":i+=h[1],o+=h[2],e.quadraticCurveToShort(i,o);break;case"A":i=h[6],o=h[7],e.arcToSvg(h[1],h[2],h[3],h[4],h[5],i,o);break;case"a":i+=h[6],o+=h[7],e.arcToSvg(h[1],h[2],h[3],h[4],h[5],i,o);break;case"Z":case"z":e.closePath(),n.length>0&&(s=n.pop(),s?(i=s.startX,o=s.startY):(i=0,o=0)),s=null;break;default:ne(`Unknown SVG path command: ${c}`)}c!=="Z"&&c!=="z"&&s===null&&(s={startX:i,startY:o},n.push(s))}return e}class Wi{constructor(e=0,t=0,n=0){this.type="circle",this.x=e,this.y=t,this.radius=n}clone(){return new Wi(this.x,this.y,this.radius)}contains(e,t){if(this.radius<=0)return!1;const n=this.radius*this.radius;let s=this.x-e,i=this.y-t;return s*=s,i*=i,s+i<=n}strokeContains(e,t,n){if(this.radius===0)return!1;const s=this.x-e,i=this.y-t,o=this.radius,a=n/2,l=Math.sqrt(s*s+i*i);return l<o+a&&l>o-a}getBounds(e){return e=e||new he,e.x=this.x-this.radius,e.y=this.y-this.radius,e.width=this.radius*2,e.height=this.radius*2,e}copyFrom(e){return this.x=e.x,this.y=e.y,this.radius=e.radius,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:Circle x=${this.x} y=${this.y} radius=${this.radius}]`}}class Vi{constructor(e=0,t=0,n=0,s=0){this.type="ellipse",this.x=e,this.y=t,this.halfWidth=n,this.halfHeight=s}clone(){return new Vi(this.x,this.y,this.halfWidth,this.halfHeight)}contains(e,t){if(this.halfWidth<=0||this.halfHeight<=0)return!1;let n=(e-this.x)/this.halfWidth,s=(t-this.y)/this.halfHeight;return n*=n,s*=s,n+s<=1}strokeContains(e,t,n){const{halfWidth:s,halfHeight:i}=this;if(s<=0||i<=0)return!1;const o=n/2,a=s-o,l=i-o,c=s+o,h=i+o,u=e-this.x,d=t-this.y,f=u*u/(a*a)+d*d/(l*l),p=u*u/(c*c)+d*d/(h*h);return f>1&&p<=1}getBounds(){return new he(this.x-this.halfWidth,this.y-this.halfHeight,this.halfWidth*2,this.halfHeight*2)}copyFrom(e){return this.x=e.x,this.y=e.y,this.halfWidth=e.halfWidth,this.halfHeight=e.halfHeight,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:Ellipse x=${this.x} y=${this.y} halfWidth=${this.halfWidth} halfHeight=${this.halfHeight}]`}}function ry(r,e,t,n,s,i){const o=r-t,a=e-n,l=s-t,c=i-n,h=o*l+a*c,u=l*l+c*c;let d=-1;u!==0&&(d=h/u);let f,p;d<0?(f=t,p=n):d>1?(f=s,p=i):(f=t+d*l,p=n+d*c);const g=r-f,m=e-p;return g*g+m*m}class un{constructor(...e){this.type="polygon";let t=Array.isArray(e[0])?e[0]:e;if(typeof t[0]!="number"){const n=[];for(let s=0,i=t.length;s<i;s++)n.push(t[s].x,t[s].y);t=n}this.points=t,this.closePath=!0}clone(){const e=this.points.slice(),t=new un(e);return t.closePath=this.closePath,t}contains(e,t){let n=!1;const s=this.points.length/2;for(let i=0,o=s-1;i<s;o=i++){const a=this.points[i*2],l=this.points[i*2+1],c=this.points[o*2],h=this.points[o*2+1];l>t!=h>t&&e<(c-a)*((t-l)/(h-l))+a&&(n=!n)}return n}strokeContains(e,t,n){const s=n/2,i=s*s,{points:o}=this,a=o.length-(this.closePath?0:2);for(let l=0;l<a;l+=2){const c=o[l],h=o[l+1],u=o[(l+2)%o.length],d=o[(l+3)%o.length];if(ry(e,t,c,h,u,d)<=i)return!0}return!1}getBounds(e){e=e||new he;const t=this.points;let n=1/0,s=-1/0,i=1/0,o=-1/0;for(let a=0,l=t.length;a<l;a+=2){const c=t[a],h=t[a+1];n=c<n?c:n,s=c>s?c:s,i=h<i?h:i,o=h>o?h:o}return e.x=n,e.width=s-n,e.y=i,e.height=o-i,e}copyFrom(e){return this.points=e.points.slice(),this.closePath=e.closePath,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:PolygoncloseStroke=${this.closePath}points=${this.points.reduce((e,t)=>`${e}, ${t}`,"")}]`}get lastX(){return this.points[this.points.length-2]}get lastY(){return this.points[this.points.length-1]}get x(){return this.points[this.points.length-2]}get y(){return this.points[this.points.length-1]}}const hs=(r,e,t,n,s,i)=>{const o=r-t,a=e-n,l=Math.sqrt(o*o+a*a);return l>=s-i&&l<=s+i};class Xi{constructor(e=0,t=0,n=0,s=0,i=20){this.type="roundedRectangle",this.x=e,this.y=t,this.width=n,this.height=s,this.radius=i}getBounds(e){return e=e||new he,e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e}clone(){return new Xi(this.x,this.y,this.width,this.height,this.radius)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}copyTo(e){return e.copyFrom(this),e}contains(e,t){if(this.width<=0||this.height<=0)return!1;if(e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height){const n=Math.max(0,Math.min(this.radius,Math.min(this.width,this.height)/2));if(t>=this.y+n&&t<=this.y+this.height-n||e>=this.x+n&&e<=this.x+this.width-n)return!0;let s=e-(this.x+n),i=t-(this.y+n);const o=n*n;if(s*s+i*i<=o||(s=e-(this.x+this.width-n),s*s+i*i<=o)||(i=t-(this.y+this.height-n),s*s+i*i<=o)||(s=e-(this.x+n),s*s+i*i<=o))return!0}return!1}strokeContains(e,t,n){const{x:s,y:i,width:o,height:a,radius:l}=this,c=n/2,h=s+l,u=i+l,d=o-l*2,f=a-l*2,p=s+o,g=i+a;return(e>=s-c&&e<=s+c||e>=p-c&&e<=p+c)&&t>=u&&t<=u+f||(t>=i-c&&t<=i+c||t>=g-c&&t<=g+c)&&e>=h&&e<=h+d?!0:e<h&&t<u&&hs(e,t,h,u,l,c)||e>p-l&&t<u&&hs(e,t,p-l,u,l,c)||e>p-l&&t>g-l&&hs(e,t,p-l,g-l,l,c)||e<h&&t>g-l&&hs(e,t,h,g-l,l,c)}toString(){return`[pixi.js/math:RoundedRectangle x=${this.x} y=${this.y}width=${this.width} height=${this.height} radius=${this.radius}]`}}var ae=(r=>(r[r.MAP_READ=1]="MAP_READ",r[r.MAP_WRITE=2]="MAP_WRITE",r[r.COPY_SRC=4]="COPY_SRC",r[r.COPY_DST=8]="COPY_DST",r[r.INDEX=16]="INDEX",r[r.VERTEX=32]="VERTEX",r[r.UNIFORM=64]="UNIFORM",r[r.STORAGE=128]="STORAGE",r[r.INDIRECT=256]="INDIRECT",r[r.QUERY_RESOLVE=512]="QUERY_RESOLVE",r[r.STATIC=1024]="STATIC",r))(ae||{});class pt extends Ke{constructor(e){let{data:t,size:n}=e;const{usage:s,label:i,shrinkToFit:o}=e;super(),this.uid=be("buffer"),this._resourceType="buffer",this._resourceId=be("resource"),this._touched=0,this._updateID=1,this.shrinkToFit=!0,this.destroyed=!1,t instanceof Array&&(t=new Float32Array(t)),this._data=t,n=n??(t==null?void 0:t.byteLength);const a=!!t;this.descriptor={size:n,usage:s,mappedAtCreation:a,label:i},this.shrinkToFit=o??!0}get data(){return this._data}set data(e){this.setDataWithSize(e,e.length,!0)}get static(){return!!(this.descriptor.usage&ae.STATIC)}set static(e){e?this.descriptor.usage|=ae.STATIC:this.descriptor.usage&=~ae.STATIC}setDataWithSize(e,t,n){if(this._updateID++,this._updateSize=t*e.BYTES_PER_ELEMENT,this._data===e){n&&this.emit("update",this);return}const s=this._data;if(this._data=e,s.length!==e.length){!this.shrinkToFit&&e.byteLength<s.byteLength?n&&this.emit("update",this):(this.descriptor.size=e.byteLength,this._resourceId=be("resource"),this.emit("change",this));return}n&&this.emit("update",this)}update(e){this._updateSize=e??this._updateSize,this._updateID++,this.emit("update",this)}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this._data=null,this.descriptor=null,this.removeAllListeners()}}function Pc(r,e){if(!(r instanceof pt)){let t=e?ae.INDEX:ae.VERTEX;r instanceof Array&&(e?(r=new Uint32Array(r),t=ae.INDEX|ae.COPY_DST):(r=new Float32Array(r),t=ae.VERTEX|ae.COPY_DST)),r=new pt({data:r,label:e?"index-mesh-buffer":"vertex-mesh-buffer",usage:t})}return r}function ny(r,e,t){const n=r.getAttribute(e);if(!n)return t.minX=0,t.minY=0,t.maxX=0,t.maxY=0,t;const s=n.buffer.data;let i=1/0,o=1/0,a=-1/0,l=-1/0;const c=s.BYTES_PER_ELEMENT,h=(n.offset||0)/c,u=(n.stride||2*4)/c;for(let d=h;d<s.length;d+=u){const f=s[d],p=s[d+1];f>a&&(a=f),p>l&&(l=p),f<i&&(i=f),p<o&&(o=p)}return t.minX=i,t.minY=o,t.maxX=a,t.maxY=l,t}function sy(r){return(r instanceof pt||Array.isArray(r)||r.BYTES_PER_ELEMENT)&&(r={buffer:r}),r.buffer=Pc(r.buffer,!1),r}class us extends Ke{constructor(e){const{attributes:t,indexBuffer:n,topology:s}=e;super(),this.uid=be("geometry"),this._layoutKey=0,this.instanceCount=1,this._bounds=new Ze,this._boundsDirty=!0,this.attributes=t,this.buffers=[],this.instanceCount=e.instanceCount||1;for(const i in t){const o=t[i]=sy(t[i]);this.buffers.indexOf(o.buffer)===-1&&(this.buffers.push(o.buffer),o.buffer.on("update",this.onBufferUpdate,this),o.buffer.on("change",this.onBufferUpdate,this))}n&&(this.indexBuffer=Pc(n,!0),this.buffers.push(this.indexBuffer)),this.topology=s||"triangle-list"}onBufferUpdate(){this._boundsDirty=!0,this.emit("update",this)}getAttribute(e){return this.attributes[e]}getIndex(){return this.indexBuffer}getBuffer(e){return this.getAttribute(e).buffer}getSize(){for(const e in this.attributes){const t=this.attributes[e];return t.buffer.data.length/(t.stride/4||t.size)}return 0}get bounds(){return this._boundsDirty?(this._boundsDirty=!1,ny(this,"aPosition",this._bounds)):this._bounds}destroy(e=!1){this.emit("destroy",this),this.removeAllListeners(),e&&this.buffers.forEach(t=>t.destroy()),this.attributes=null,this.buffers=null,this.indexBuffer=null,this._bounds=null}}const iy=new Float32Array(1),oy=new Uint32Array(1);class Ac extends us{constructor(){const t=new pt({data:iy,label:"attribute-batch-buffer",usage:ae.VERTEX|ae.COPY_DST,shrinkToFit:!1}),n=new pt({data:oy,label:"index-batch-buffer",usage:ae.INDEX|ae.COPY_DST,shrinkToFit:!1}),s=6*4;super({attributes:{aPosition:{buffer:t,format:"float32x2",stride:s,offset:0,location:1},aUV:{buffer:t,format:"float32x2",stride:s,offset:2*4,location:3},aColor:{buffer:t,format:"unorm8x4",stride:s,offset:4*4,location:0},aTextureIdAndRound:{buffer:t,format:"uint16x2",stride:s,offset:5*4,location:2}},indexBuffer:n})}}const mt=16,Mc={};function Yi(r,e){let t=0;for(let n=0;n<e;n++)t=t*31+r[n].uid>>>0;return Mc[t]||ay(r,t)}function ay(r,e){const t={};let n=0;for(let i=0;i<mt;i++){const o=i<r.length?r[i]:$.EMPTY.source;t[n++]=o.source,t[n++]=o.style}const s=new Ot(t);return Mc[e]=s,s}class Cc{constructor(e){typeof e=="number"?this.rawBinaryData=new ArrayBuffer(e):e instanceof Uint8Array?this.rawBinaryData=e.buffer:this.rawBinaryData=e,this.uint32View=new Uint32Array(this.rawBinaryData),this.float32View=new Float32Array(this.rawBinaryData),this.size=this.rawBinaryData.byteLength}get int8View(){return this._int8View||(this._int8View=new Int8Array(this.rawBinaryData)),this._int8View}get uint8View(){return this._uint8View||(this._uint8View=new Uint8Array(this.rawBinaryData)),this._uint8View}get int16View(){return this._int16View||(this._int16View=new Int16Array(this.rawBinaryData)),this._int16View}get int32View(){return this._int32View||(this._int32View=new Int32Array(this.rawBinaryData)),this._int32View}get float64View(){return this._float64Array||(this._float64Array=new Float64Array(this.rawBinaryData)),this._float64Array}get bigUint64View(){return this._bigUint64Array||(this._bigUint64Array=new BigUint64Array(this.rawBinaryData)),this._bigUint64Array}view(e){return this[`${e}View`]}destroy(){this.rawBinaryData=null,this._int8View=null,this._uint8View=null,this._int16View=null,this.uint16View=null,this._int32View=null,this.uint32View=null,this.float32View=null}static sizeOf(e){switch(e){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float32":return 4;default:throw new Error(`${e} isn't a valid view type`)}}}function ji(r,e){const t=r.byteLength/8|0,n=new Float64Array(r,0,t);new Float64Array(e,0,t).set(n);const i=r.byteLength-t*8;if(i>0){const o=new Uint8Array(r,t*8,i);new Uint8Array(e,t*8,i).set(o)}}const ly={normal:"normal-npm",add:"add-npm",screen:"screen-npm"};var Me=(r=>(r[r.DISABLED=0]="DISABLED",r[r.RENDERING_MASK_ADD=1]="RENDERING_MASK_ADD",r[r.MASK_ACTIVE=2]="MASK_ACTIVE",r[r.RENDERING_MASK_REMOVE=3]="RENDERING_MASK_REMOVE",r[r.NONE=4]="NONE",r))(Me||{});function Bc(r,e){return e.alphaMode==="no-premultiply-alpha"&&ly[r]||r}class Rc{constructor(){this.ids=Object.create(null),this.textures=[],this.count=0}clear(){for(let e=0;e<this.count;e++){const t=this.textures[e];this.textures[e]=null,this.ids[t.uid]=null}this.count=0}}class kc{constructor(){this.renderPipeId="batch",this.action="startBatch",this.start=0,this.size=0,this.blendMode="normal",this.canBundle=!0}destroy(){this.textures=null,this.gpuBindGroup=null,this.bindGroup=null,this.batcher=null}}let dn=0;const Ic=class Hd{constructor(e={}){this.uid=be("batcher"),this.dirty=!0,this.batchIndex=0,this.batches=[],this._vertexSize=6,this._elements=[],this._batchPool=[],this._batchPoolIndex=0,this._textureBatchPool=[],this._textureBatchPoolIndex=0,e={...Hd.defaultOptions,...e};const{vertexSize:t,indexSize:n}=e;this.attributeBuffer=new Cc(t*this._vertexSize*4),this.indexBuffer=new Uint16Array(n)}begin(){this.batchIndex=0,this.elementSize=0,this.elementStart=0,this.indexSize=0,this.attributeSize=0,this._batchPoolIndex=0,this._textureBatchPoolIndex=0,this._batchIndexStart=0,this._batchIndexSize=0,this.dirty=!0}add(e){this._elements[this.elementSize++]=e,e.indexStart=this.indexSize,e.location=this.attributeSize,e.batcher=this,this.indexSize+=e.indexSize,this.attributeSize+=e.vertexSize*this._vertexSize}checkAndUpdateTexture(e,t){const n=e.batch.textures.ids[t._source.uid];return!n&&n!==0?!1:(e.textureId=n,e.texture=t,!0)}updateElement(e){this.dirty=!0,e.packAttributes(this.attributeBuffer.float32View,this.attributeBuffer.uint32View,e.location,e.textureId)}break(e){const t=this._elements;let n=this._textureBatchPool[this._textureBatchPoolIndex++]||new Rc;if(n.clear(),!t[this.elementStart])return;const s=t[this.elementStart];let i=Bc(s.blendMode,s.texture._source);this.attributeSize*4>this.attributeBuffer.size&&this._resizeAttributeBuffer(this.attributeSize*4),this.indexSize>this.indexBuffer.length&&this._resizeIndexBuffer(this.indexSize);const o=this.attributeBuffer.float32View,a=this.attributeBuffer.uint32View,l=this.indexBuffer;let c=this._batchIndexSize,h=this._batchIndexStart,u="startBatch",d=this._batchPool[this._batchPoolIndex++]||new kc;for(let f=this.elementStart;f<this.elementSize;++f){const p=t[f];t[f]=null;const m=p.texture._source,_=Bc(p.blendMode,m),b=i!==_;if(m._batchTick===dn&&!b){p.textureId=m._textureBindLocation,c+=p.indexSize,p.packAttributes(o,a,p.location,p.textureId),p.packIndex(l,p.indexStart,p.location/this._vertexSize),p.batch=d;continue}m._batchTick=dn,(n.count>=mt||b)&&(this._finishBatch(d,h,c-h,n,i,e,u),u="renderBatch",h=c,i=_,n=this._textureBatchPool[this._textureBatchPoolIndex++]||new Rc,n.clear(),d=this._batchPool[this._batchPoolIndex++]||new kc,++dn),p.textureId=m._textureBindLocation=n.count,n.ids[m.uid]=n.count,n.textures[n.count++]=m,p.batch=d,c+=p.indexSize,p.packAttributes(o,a,p.location,p.textureId),p.packIndex(l,p.indexStart,p.location/this._vertexSize)}n.count>0&&(this._finishBatch(d,h,c-h,n,i,e,u),h=c,++dn),this.elementStart=this.elementSize,this._batchIndexStart=h,this._batchIndexSize=c}_finishBatch(e,t,n,s,i,o,a){e.gpuBindGroup=null,e.action=a,e.batcher=this,e.textures=s,e.blendMode=i,e.start=t,e.size=n,++dn,o.add(e)}finish(e){this.break(e)}ensureAttributeBuffer(e){e*4<=this.attributeBuffer.size||this._resizeAttributeBuffer(e*4)}ensureIndexBuffer(e){e<=this.indexBuffer.length||this._resizeIndexBuffer(e)}_resizeAttributeBuffer(e){const t=Math.max(e,this.attributeBuffer.size*2),n=new Cc(t);ji(this.attributeBuffer.rawBinaryData,n.rawBinaryData),this.attributeBuffer=n}_resizeIndexBuffer(e){const t=this.indexBuffer;let n=Math.max(e,t.length*1.5);n+=n%2;const s=n>65535?new Uint32Array(n):new Uint16Array(n);if(s.BYTES_PER_ELEMENT!==t.BYTES_PER_ELEMENT)for(let i=0;i<t.length;i++)s[i]=t[i];else ji(t.buffer,s.buffer);this.indexBuffer=s}destroy(){for(let e=0;e<this.batches.length;e++)this.batches[e].destroy();this.batches=null;for(let e=0;e<this._elements.length;e++)this._elements[e].batch=null;this._elements=null,this.indexBuffer=null,this.attributeBuffer.destroy(),this.attributeBuffer=null}};Ic.defaultOptions={vertexSize:4,indexSize:6};let Gc=Ic;function cy(r,e,t,n,s,i,o,a=null){let l=0;t*=e,s*=i;const c=a.a,h=a.b,u=a.c,d=a.d,f=a.tx,p=a.ty;for(;l<o;){const g=r[t],m=r[t+1];n[s]=c*g+u*m+f,n[s+1]=h*g+d*m+p,s+=i,t+=e,l++}}function hy(r,e,t,n){let s=0;for(e*=t;s<n;)r[e]=0,r[e+1]=0,e+=t,s++}function Uc(r,e,t,n,s){const i=e.a,o=e.b,a=e.c,l=e.d,c=e.tx,h=e.ty;t=t||0,n=n||2,s=s||r.length/n-t;let u=t*n;for(let d=0;d<s;d++){const f=r[u],p=r[u+1];r[u]=i*f+a*p+c,r[u+1]=o*f+l*p+h,u+=n}}function uy(r,e){if(r===16777215||!e)return e;if(e===16777215||!r)return r;const t=r>>16&255,n=r>>8&255,s=r&255,i=e>>16&255,o=e>>8&255,a=e&255,l=t*i/255,c=n*o/255,h=s*a/255;return(l<<16)+(c<<8)+h}class qi{constructor(){this.batcher=null,this.batch=null,this.applyTransform=!0,this.roundPixels=0}get blendMode(){return this.applyTransform?this.renderable.groupBlendMode:"normal"}packIndex(e,t,n){const s=this.geometryData.indices;for(let i=0;i<this.indexSize;i++)e[t++]=s[i+this.indexOffset]+n-this.vertexOffset}packAttributes(e,t,n,s){const i=this.geometryData,o=this.renderable,a=i.vertices,l=i.uvs,c=this.vertexOffset*2,h=(this.vertexOffset+this.vertexSize)*2,u=this.color,d=u>>16|u&65280|(u&255)<<16;if(this.applyTransform){const f=uy(d,o.groupColor)+(this.alpha*o.groupAlpha*255<<24),p=o.groupTransform,g=s<<16|this.roundPixels&65535,m=p.a,_=p.b,b=p.c,y=p.d,x=p.tx,S=p.ty;for(let k=c;k<h;k+=2){const P=a[k],T=a[k+1];e[n]=m*P+b*T+x,e[n+1]=_*P+y*T+S,e[n+2]=l[k],e[n+3]=l[k+1],t[n+4]=f,t[n+5]=g,n+=6}}else{const f=d+(this.alpha*255<<24);for(let p=c;p<h;p+=2)e[n]=a[p],e[n+1]=a[p+1],e[n+2]=l[p],e[n+3]=l[p+1],t[n+4]=f,t[n+5]=s<<16,n+=6}}get vertSize(){return this.vertexSize}copyTo(e){e.indexOffset=this.indexOffset,e.indexSize=this.indexSize,e.vertexOffset=this.vertexOffset,e.vertexSize=this.vertexSize,e.color=this.color,e.alpha=this.alpha,e.texture=this.texture,e.geometryData=this.geometryData}reset(){this.applyTransform=!0}}const Ki={build(r,e){let t,n,s,i,o,a;if(r.type==="circle"){const x=r;t=x.x,n=x.y,o=a=x.radius,s=i=0}else if(r.type==="ellipse"){const x=r;t=x.x,n=x.y,o=x.halfWidth,a=x.halfHeight,s=i=0}else{const x=r,S=x.width/2,k=x.height/2;t=x.x+S,n=x.y+k,o=a=Math.max(0,Math.min(x.radius,Math.min(S,k))),s=S-o,i=k-a}if(!(o>=0&&a>=0&&s>=0&&i>=0))return e;const l=Math.ceil(2.3*Math.sqrt(o+a)),c=l*8+(s?4:0)+(i?4:0);if(c===0)return e;if(l===0)return e[0]=e[6]=t+s,e[1]=e[3]=n+i,e[2]=e[4]=t-s,e[5]=e[7]=n-i,e;let h=0,u=l*4+(s?2:0)+2,d=u,f=c,p=s+o,g=i,m=t+p,_=t-p,b=n+g;if(e[h++]=m,e[h++]=b,e[--u]=b,e[--u]=_,i){const x=n-g;e[d++]=_,e[d++]=x,e[--f]=x,e[--f]=m}for(let x=1;x<l;x++){const S=Math.PI/2*(x/l),k=s+Math.cos(S)*o,P=i+Math.sin(S)*a,T=t+k,E=t-k,v=n+P,R=n-P;e[h++]=T,e[h++]=v,e[--u]=v,e[--u]=E,e[d++]=E,e[d++]=R,e[--f]=R,e[--f]=T}p=s,g=i+a,m=t+p,_=t-p,b=n+g;const y=n-g;return e[h++]=m,e[h++]=b,e[--f]=y,e[--f]=m,s&&(e[h++]=_,e[h++]=b,e[--f]=y,e[--f]=_),e},triangulate(r,e,t,n,s,i){if(r.length===0)return;let o=0,a=0;for(let h=0;h<r.length;h+=2)o+=r[h],a+=r[h+1];o/=r.length/2,a/=r.length/2;let l=n;e[l*t]=o,e[l*t+1]=a;const c=l++;for(let h=0;h<r.length;h+=2)e[l*t]=r[h],e[l*t+1]=r[h+1],h>0&&(s[i++]=l,s[i++]=c,s[i++]=l-1),l++;s[i++]=c+1,s[i++]=c,s[i++]=l-1}},dy=1e-4,Fc=1e-4;function fy(r){const e=r.length;if(e<6)return 1;let t=0;for(let n=0,s=r[e-2],i=r[e-1];n<e;n+=2){const o=r[n],a=r[n+1];t+=(o-s)*(a+i),s=o,i=a}return t<0?-1:1}function Oc(r,e,t,n,s,i,o,a){const l=r-t*s,c=e-n*s,h=r+t*i,u=e+n*i;let d,f;o?(d=n,f=-t):(d=-n,f=t);const p=l+d,g=c+f,m=h+d,_=u+f;return a.push(p,g),a.push(m,_),2}function or(r,e,t,n,s,i,o,a){const l=t-r,c=n-e;let h=Math.atan2(l,c),u=Math.atan2(s-r,i-e);a&&h<u?h+=Math.PI*2:!a&&h>u&&(u+=Math.PI*2);let d=h;const f=u-h,p=Math.abs(f),g=Math.sqrt(l*l+c*c),m=(15*p*Math.sqrt(g)/Math.PI>>0)+1,_=f/m;if(d+=_,a){o.push(r,e),o.push(t,n);for(let b=1,y=d;b<m;b++,y+=_)o.push(r,e),o.push(r+Math.sin(y)*g,e+Math.cos(y)*g);o.push(r,e),o.push(s,i)}else{o.push(t,n),o.push(r,e);for(let b=1,y=d;b<m;b++,y+=_)o.push(r+Math.sin(y)*g,e+Math.cos(y)*g),o.push(r,e);o.push(s,i),o.push(r,e)}return m*2}function py(r,e,t,n,s,i,o,a,l){const c=dy;if(r.length===0)return;const h=e;let u=h.alignment;if(e.alignment!==.5){let H=fy(r);u=(u-.5)*H+.5}const d=new ce(r[0],r[1]),f=new ce(r[r.length-2],r[r.length-1]),p=n,g=Math.abs(d.x-f.x)<c&&Math.abs(d.y-f.y)<c;if(p){r=r.slice(),g&&(r.pop(),r.pop(),f.set(r[r.length-2],r[r.length-1]));const H=(d.x+f.x)*.5,pe=(f.y+d.y)*.5;r.unshift(H,pe),r.push(H,pe)}const m=s,_=r.length/2;let b=r.length;const y=m.length/2,x=h.width/2,S=x*x,k=h.miterLimit*h.miterLimit;let P=r[0],T=r[1],E=r[2],v=r[3],R=0,I=0,C=-(T-v),A=P-E,F=0,D=0,V=Math.sqrt(C*C+A*A);C/=V,A/=V,C*=x,A*=x;const K=u,N=(1-K)*2,U=K*2;p||(h.cap==="round"?b+=or(P-C*(N-U)*.5,T-A*(N-U)*.5,P-C*N,T-A*N,P+C*U,T+A*U,m,!0)+2:h.cap==="square"&&(b+=Oc(P,T,C,A,N,U,!0,m))),m.push(P-C*N,T-A*N),m.push(P+C*U,T+A*U);for(let H=1;H<_-1;++H){P=r[(H-1)*2],T=r[(H-1)*2+1],E=r[H*2],v=r[H*2+1],R=r[(H+1)*2],I=r[(H+1)*2+1],C=-(T-v),A=P-E,V=Math.sqrt(C*C+A*A),C/=V,A/=V,C*=x,A*=x,F=-(v-I),D=E-R,V=Math.sqrt(F*F+D*D),F/=V,D/=V,F*=x,D*=x;const pe=E-P,de=T-v,L=E-R,et=I-v,Kt=pe*L+de*et,O=de*L-et*pe,G=O<0;if(Math.abs(O)<.001*Math.abs(Kt)){m.push(E-C*N,v-A*N),m.push(E+C*U,v+A*U),Kt>=0&&(h.join==="round"?b+=or(E,v,E-C*N,v-A*N,E-F*N,v-D*N,m,!1)+4:b+=2,m.push(E-F*U,v-D*U),m.push(E+F*N,v+D*N));continue}const ct=(-C+P)*(-A+v)-(-C+E)*(-A+T),ht=(-F+R)*(-D+v)-(-F+E)*(-D+I),$e=(pe*ht-L*ct)/O,We=(et*ct-de*ht)/O,Xo=($e-E)*($e-E)+(We-v)*(We-v),hr=E+($e-E)*N,ur=v+(We-v)*N,dr=E-($e-E)*U,fr=v-(We-v)*U,i1=Math.min(pe*pe+de*de,L*L+et*et),Gd=G?N:U,o1=i1+Gd*Gd*S;Xo<=o1?h.join==="bevel"||Xo/S>k?(G?(m.push(hr,ur),m.push(E+C*U,v+A*U),m.push(hr,ur),m.push(E+F*U,v+D*U)):(m.push(E-C*N,v-A*N),m.push(dr,fr),m.push(E-F*N,v-D*N),m.push(dr,fr)),b+=2):h.join==="round"?G?(m.push(hr,ur),m.push(E+C*U,v+A*U),b+=or(E,v,E+C*U,v+A*U,E+F*U,v+D*U,m,!0)+4,m.push(hr,ur),m.push(E+F*U,v+D*U)):(m.push(E-C*N,v-A*N),m.push(dr,fr),b+=or(E,v,E-C*N,v-A*N,E-F*N,v-D*N,m,!1)+4,m.push(E-F*N,v-D*N),m.push(dr,fr)):(m.push(hr,ur),m.push(dr,fr)):(m.push(E-C*N,v-A*N),m.push(E+C*U,v+A*U),h.join==="round"?G?b+=or(E,v,E+C*U,v+A*U,E+F*U,v+D*U,m,!0)+2:b+=or(E,v,E-C*N,v-A*N,E-F*N,v-D*N,m,!1)+2:h.join==="miter"&&Xo/S<=k&&(G?(m.push(dr,fr),m.push(dr,fr)):(m.push(hr,ur),m.push(hr,ur)),b+=2),m.push(E-F*N,v-D*N),m.push(E+F*U,v+D*U),b+=2)}P=r[(_-2)*2],T=r[(_-2)*2+1],E=r[(_-1)*2],v=r[(_-1)*2+1],C=-(T-v),A=P-E,V=Math.sqrt(C*C+A*A),C/=V,A/=V,C*=x,A*=x,m.push(E-C*N,v-A*N),m.push(E+C*U,v+A*U),p||(h.cap==="round"?b+=or(E-C*(N-U)*.5,v-A*(N-U)*.5,E-C*N,v-A*N,E+C*U,v+A*U,m,!1)+2:h.cap==="square"&&(b+=Oc(E,v,C,A,N,U,!1,m)));const we=Fc*Fc;for(let H=y;H<b+y-2;++H)P=m[H*2],T=m[H*2+1],E=m[(H+1)*2],v=m[(H+1)*2+1],R=m[(H+2)*2],I=m[(H+2)*2+1],!(Math.abs(P*(v-I)+E*(I-T)+R*(T-v))<we)&&a.push(H,H+1,H+2)}function Dc(r,e,t,n,s,i,o){const a=W_(r,e,2);if(!a)return;for(let c=0;c<a.length;c+=3)i[o++]=a[c]+s,i[o++]=a[c+1]+s,i[o++]=a[c+2]+s;let l=s*n;for(let c=0;c<r.length;c+=2)t[l]=r[c],t[l+1]=r[c+1],l+=n}const my=[],Zi={rectangle:{build(r,e){const t=r,n=t.x,s=t.y,i=t.width,o=t.height;return i>=0&&o>=0&&(e[0]=n,e[1]=s,e[2]=n+i,e[3]=s,e[4]=n+i,e[5]=s+o,e[6]=n,e[7]=s+o),e},triangulate(r,e,t,n,s,i){let o=0;n*=t,e[n+o]=r[0],e[n+o+1]=r[1],o+=t,e[n+o]=r[2],e[n+o+1]=r[3],o+=t,e[n+o]=r[6],e[n+o+1]=r[7],o+=t,e[n+o]=r[4],e[n+o+1]=r[5],o+=t;const a=n/t;s[i++]=a,s[i++]=a+1,s[i++]=a+2,s[i++]=a+1,s[i++]=a+3,s[i++]=a+2}},polygon:{build(r,e){for(let t=0;t<r.points.length;t++)e[t]=r.points[t];return e},triangulate(r,e,t,n,s,i){Dc(r,my,e,t,n,s,i)}},triangle:{build(r,e){return e[0]=r.x,e[1]=r.y,e[2]=r.x2,e[3]=r.y2,e[4]=r.x3,e[5]=r.y3,e},triangulate(r,e,t,n,s,i){let o=0;n*=t,e[n+o]=r[0],e[n+o+1]=r[1],o+=t,e[n+o]=r[2],e[n+o+1]=r[3],o+=t,e[n+o]=r[4],e[n+o+1]=r[5];const a=n/t;s[i++]=a,s[i++]=a+1,s[i++]=a+2}},circle:Ki,ellipse:Ki,roundedRectangle:Ki},gy=new he;function _y(r,e){const{geometryData:t,batches:n}=e;n.length=0,t.indices.length=0,t.vertices.length=0,t.uvs.length=0;for(let s=0;s<r.instructions.length;s++){const i=r.instructions[s];if(i.action==="texture")yy(i.data,n,t);else if(i.action==="fill"||i.action==="stroke"){const o=i.action==="stroke",a=i.data.path.shapePath,l=i.data.style,c=i.data.hole;o&&c&&Lc(c.shapePath,l,null,!0,n,t),Lc(a,l,c,o,n,t)}}}function yy(r,e,t){const{vertices:n,uvs:s,indices:i}=t,o=i.length,a=n.length/2,l=[],c=Zi.rectangle,h=gy,u=r.image;h.x=r.dx,h.y=r.dy,h.width=r.dw,h.height=r.dh;const d=r.transform;c.build(h,l),d&&Uc(l,d),c.triangulate(l,n,2,a,i,o);const f=u.uvs;s.push(f.x0,f.y0,f.x1,f.y1,f.x3,f.y3,f.x2,f.y2);const p=oe.get(qi);p.indexOffset=o,p.indexSize=i.length-o,p.vertexOffset=a,p.vertexSize=n.length/2-a,p.color=r.style,p.alpha=r.alpha,p.texture=u,p.geometryData=t,e.push(p)}function Lc(r,e,t,n,s,i){const{vertices:o,uvs:a,indices:l}=i,c=r.shapePrimitives.length-1;r.shapePrimitives.forEach(({shape:h,transform:u},d)=>{const f=l.length,p=o.length/2,g=[],m=Zi[h.type];if(m.build(h,g),u&&Uc(g,u),n){const x=h.closePath??!0;py(g,e,!1,x,o,2,p,l)}else if(t&&c===d){c!==0&&console.warn("[Pixi Graphics] only the last shape have be cut out");const x=[],S=g.slice();by(t.shapePath).forEach(P=>{x.push(S.length/2),S.push(...P)}),Dc(S,x,o,2,p,l,f)}else m.triangulate(g,o,2,p,l,f);const _=a.length/2,b=e.texture;if(b!==$.WHITE){const x=e.matrix;u&&x.append(u.clone().invert()),cy(o,2,p,a,_,2,o.length/2-p,x)}else hy(a,_,2,o.length/2-p);const y=oe.get(qi);y.indexOffset=f,y.indexSize=l.length-f,y.vertexOffset=p,y.vertexSize=o.length/2-p,y.color=e.color,y.alpha=e.alpha,y.texture=b,y.geometryData=i,s.push(y)})}function by(r){if(!r)return[];const e=r.shapePrimitives,t=[];for(let n=0;n<e.length;n++){const s=e[n].shape,i=[];Zi[s.type].build(s,i),t.push(i)}return t}class xy{constructor(){this.batches=[],this.geometryData={vertices:[],uvs:[],indices:[]}}}class vy{constructor(){this.geometry=new Ac,this.instructions=new Gl}init(){this.instructions.reset()}}const Qi=class Ko{constructor(){this._activeBatchers=[],this._gpuContextHash={},this._graphicsDataContextHash=Object.create(null),this._needsContextNeedsRebuild=[]}init(e){Ko.defaultOptions.bezierSmoothness=(e==null?void 0:e.bezierSmoothness)??Ko.defaultOptions.bezierSmoothness}prerender(){this._returnActiveBatchers()}getContextRenderData(e){return this._graphicsDataContextHash[e.uid]||this._initContextRenderData(e)}updateGpuContext(e){let t=this._gpuContextHash[e.uid]||this._initContext(e);if(e.dirty){t?this._cleanGraphicsContextData(e):t=this._initContext(e),_y(e,t);const n=e.batchMode;e.customShader||n==="no-batch"?t.isBatchable=!1:n==="auto"&&(t.isBatchable=t.geometryData.vertices.length<400),e.dirty=!1}return t}getGpuContext(e){return this._gpuContextHash[e.uid]||this._initContext(e)}_returnActiveBatchers(){for(let e=0;e<this._activeBatchers.length;e++)oe.return(this._activeBatchers[e]);this._activeBatchers.length=0}_initContextRenderData(e){const t=oe.get(vy),{batches:n,geometryData:s}=this._gpuContextHash[e.uid],i=s.vertices.length,o=s.indices.length;for(let h=0;h<n.length;h++)n[h].applyTransform=!1;const a=oe.get(Gc);this._activeBatchers.push(a),a.ensureAttributeBuffer(i),a.ensureIndexBuffer(o),a.begin();for(let h=0;h<n.length;h++){const u=n[h];a.add(u)}a.finish(t.instructions);const l=t.geometry;l.indexBuffer.setDataWithSize(a.indexBuffer,a.indexSize,!0),l.buffers[0].setDataWithSize(a.attributeBuffer.float32View,a.attributeSize,!0);const c=a.batches;for(let h=0;h<c.length;h++){const u=c[h];u.bindGroup=Yi(u.textures.textures,u.textures.count)}return this._graphicsDataContextHash[e.uid]=t,t}_initContext(e){const t=new xy;return this._gpuContextHash[e.uid]=t,e.on("update",this.onGraphicsContextUpdate,this),e.on("destroy",this.onGraphicsContextDestroy,this),this._gpuContextHash[e.uid]}onGraphicsContextUpdate(e){this._needsContextNeedsRebuild.push(e)}onGraphicsContextDestroy(e){this._cleanGraphicsContextData(e),e.off("update",this.onGraphicsContextUpdate,this),e.off("destroy",this.onGraphicsContextDestroy,this),this._gpuContextHash[e.uid]=null}_cleanGraphicsContextData(e){const t=this._gpuContextHash[e.uid];t.isBatchable||this._graphicsDataContextHash[e.uid]&&(oe.return(this.getContextRenderData(e)),this._graphicsDataContextHash[e.uid]=null),t.batches&&t.batches.forEach(n=>{oe.return(n)})}destroy(){for(const e of this._needsContextNeedsRebuild)this._gpuContextHash[e.uid]&&this.onGraphicsContextDestroy(e);this._needsContextNeedsRebuild.length=0}};Qi.extension={type:[M.WebGLSystem,M.WebGPUSystem,M.CanvasSystem],name:"graphicsContext"},Qi.defaultOptions={bezierSmoothness:.5};let Ji=Qi;const wy=8,ds=11920929e-14,Sy=1;function Nc(r,e,t,n,s,i,o,a,l,c){const u=Math.min(.99,Math.max(0,c??Ji.defaultOptions.bezierSmoothness));let d=(Sy-u)/1;return d*=d,Ty(e,t,n,s,i,o,a,l,r,d),r}function Ty(r,e,t,n,s,i,o,a,l,c){eo(r,e,t,n,s,i,o,a,l,c,0),l.push(o,a)}function eo(r,e,t,n,s,i,o,a,l,c,h){if(h>wy)return;const u=(r+t)/2,d=(e+n)/2,f=(t+s)/2,p=(n+i)/2,g=(s+o)/2,m=(i+a)/2,_=(u+f)/2,b=(d+p)/2,y=(f+g)/2,x=(p+m)/2,S=(_+y)/2,k=(b+x)/2;if(h>0){let P=o-r,T=a-e;const E=Math.abs((t-o)*T-(n-a)*P),v=Math.abs((s-o)*T-(i-a)*P);if(E>ds&&v>ds){if((E+v)*(E+v)<=c*(P*P+T*T)){l.push(S,k);return}}else if(E>ds){if(E*E<=c*(P*P+T*T)){l.push(S,k);return}}else if(v>ds){if(v*v<=c*(P*P+T*T)){l.push(S,k);return}}else if(P=S-(r+o)/2,T=k-(e+a)/2,P*P+T*T<=c){l.push(S,k);return}}eo(r,e,u,d,_,b,S,k,l,c,h+1),eo(S,k,y,x,g,m,o,a,l,c,h+1)}const Ey=8,Py=11920929e-14,Ay=1;function My(r,e,t,n,s,i,o,a){const c=Math.min(.99,Math.max(0,a??Ji.defaultOptions.bezierSmoothness));let h=(Ay-c)/1;return h*=h,Cy(e,t,n,s,i,o,r,h),r}function Cy(r,e,t,n,s,i,o,a){to(o,r,e,t,n,s,i,a,0),o.push(s,i)}function to(r,e,t,n,s,i,o,a,l){if(l>Ey)return;const c=(e+n)/2,h=(t+s)/2,u=(n+i)/2,d=(s+o)/2,f=(c+u)/2,p=(h+d)/2;let g=i-e,m=o-t;const _=Math.abs((n-i)*m-(s-o)*g);if(_>Py){if(_*_<=a*(g*g+m*m)){r.push(f,p);return}}else if(g=f-(e+i)/2,m=p-(t+o)/2,g*g+m*m<=a){r.push(f,p);return}to(r,e,t,c,h,f,p,a,l+1),to(r,f,p,u,d,i,o,a,l+1)}function Hc(r,e,t,n,s,i,o,a){let l=Math.abs(s-i);(!o&&s>i||o&&i>s)&&(l=2*Math.PI-l),a=a||Math.max(6,Math.floor(6*Math.pow(n,1/3)*(l/Math.PI))),a=Math.max(a,3);let c=l/a,h=s;c*=o?-1:1;for(let u=0;u<a+1;u++){const d=Math.cos(h),f=Math.sin(h),p=e+d*n,g=t+f*n;r.push(p,g),h+=c}}function By(r,e,t,n,s,i){const o=r[r.length-2],l=r[r.length-1]-t,c=o-e,h=s-t,u=n-e,d=Math.abs(l*u-c*h);if(d<1e-8||i===0){(r[r.length-2]!==e||r[r.length-1]!==t)&&r.push(e,t);return}const f=l*l+c*c,p=h*h+u*u,g=l*h+c*u,m=i*Math.sqrt(f)/d,_=i*Math.sqrt(p)/d,b=m*g/f,y=_*g/p,x=m*u+_*c,S=m*h+_*l,k=c*(_+b),P=l*(_+b),T=u*(m+y),E=h*(m+y),v=Math.atan2(P-S,k-x),R=Math.atan2(E-S,T-x);Hc(r,x+e,S+t,i,v,R,c*h>u*l)}const fn=Math.PI*2,ro={centerX:0,centerY:0,ang1:0,ang2:0},no=({x:r,y:e},t,n,s,i,o,a,l)=>{r*=t,e*=n;const c=s*r-i*e,h=i*r+s*e;return l.x=c+o,l.y=h+a,l};function Ry(r,e){const t=e===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(e/4),n=e===1.5707963267948966?.551915024494:t,s=Math.cos(r),i=Math.sin(r),o=Math.cos(r+e),a=Math.sin(r+e);return[{x:s-i*n,y:i+s*n},{x:o+a*n,y:a-o*n},{x:o,y:a}]}const zc=(r,e,t,n)=>{const s=r*n-e*t<0?-1:1;let i=r*t+e*n;return i>1&&(i=1),i<-1&&(i=-1),s*Math.acos(i)},ky=(r,e,t,n,s,i,o,a,l,c,h,u,d)=>{const f=Math.pow(s,2),p=Math.pow(i,2),g=Math.pow(h,2),m=Math.pow(u,2);let _=f*p-f*m-p*g;_<0&&(_=0),_/=f*m+p*g,_=Math.sqrt(_)*(o===a?-1:1);const b=_*s/i*u,y=_*-i/s*h,x=c*b-l*y+(r+t)/2,S=l*b+c*y+(e+n)/2,k=(h-b)/s,P=(u-y)/i,T=(-h-b)/s,E=(-u-y)/i,v=zc(1,0,k,P);let R=zc(k,P,T,E);a===0&&R>0&&(R-=fn),a===1&&R<0&&(R+=fn),d.centerX=x,d.centerY=S,d.ang1=v,d.ang2=R};function Iy(r,e,t,n,s,i,o,a=0,l=0,c=0){if(i===0||o===0)return;const h=Math.sin(a*fn/360),u=Math.cos(a*fn/360),d=u*(e-n)/2+h*(t-s)/2,f=-h*(e-n)/2+u*(t-s)/2;if(d===0&&f===0)return;i=Math.abs(i),o=Math.abs(o);const p=Math.pow(d,2)/Math.pow(i,2)+Math.pow(f,2)/Math.pow(o,2);p>1&&(i*=Math.sqrt(p),o*=Math.sqrt(p)),ky(e,t,n,s,i,o,l,c,h,u,d,f,ro);let{ang1:g,ang2:m}=ro;const{centerX:_,centerY:b}=ro;let y=Math.abs(m)/(fn/4);Math.abs(1-y)<1e-7&&(y=1);const x=Math.max(Math.ceil(y),1);m/=x;let S=r[r.length-2],k=r[r.length-1];const P={x:0,y:0};for(let T=0;T<x;T++){const E=Ry(g,m),{x:v,y:R}=no(E[0],i,o,u,h,_,b,P),{x:I,y:C}=no(E[1],i,o,u,h,_,b,P),{x:A,y:F}=no(E[2],i,o,u,h,_,b,P);Nc(r,S,k,v,R,I,C,A,F),S=A,k=F,g+=m}}function Gy(r,e,t){const n=(o,a)=>{const l=a.x-o.x,c=a.y-o.y,h=Math.sqrt(l*l+c*c),u=l/h,d=c/h;return{len:h,nx:u,ny:d}},s=(o,a)=>{o===0?r.moveTo(a.x,a.y):r.lineTo(a.x,a.y)};let i=e[e.length-1];for(let o=0;o<e.length;o++){const a=e[o%e.length],l=a.radius??t;if(l<=0){s(o,a),i=a;continue}const c=e[(o+1)%e.length],h=n(a,i),u=n(a,c);if(h.len<1e-4||u.len<1e-4){s(o,a),i=a;continue}let d=Math.asin(h.nx*u.ny-h.ny*u.nx),f=1,p=!1;h.nx*u.nx-h.ny*-u.ny<0?d<0?d=Math.PI+d:(d=Math.PI-d,f=-1,p=!0):d>0&&(f=-1,p=!0);const g=d/2;let m,_=Math.abs(Math.cos(g)*l/Math.sin(g));_>Math.min(h.len/2,u.len/2)?(_=Math.min(h.len/2,u.len/2),m=Math.abs(_*Math.sin(g)/Math.cos(g))):m=l;const b=a.x+u.nx*_+-u.ny*m*f,y=a.y+u.ny*_+u.nx*m*f,x=Math.atan2(h.ny,h.nx)+Math.PI/2*f,S=Math.atan2(u.ny,u.nx)-Math.PI/2*f;o===0&&r.moveTo(b+Math.cos(x)*m,y+Math.sin(x)*m),r.arc(b,y,m,x,S,p),i=a}}function Uy(r,e,t,n){const s=(a,l)=>Math.sqrt((a.x-l.x)**2+(a.y-l.y)**2),i=(a,l,c)=>({x:a.x+(l.x-a.x)*c,y:a.y+(l.y-a.y)*c}),o=e.length;for(let a=0;a<o;a++){const l=e[(a+1)%o],c=l.radius??t;if(c<=0){a===0?r.moveTo(l.x,l.y):r.lineTo(l.x,l.y);continue}const h=e[a],u=e[(a+2)%o],d=s(h,l);let f;if(d<1e-4)f=l;else{const m=Math.min(d/2,c);f=i(l,h,m/d)}const p=s(u,l);let g;if(p<1e-4)g=l;else{const m=Math.min(p/2,c);g=i(l,u,m/p)}a===0?r.moveTo(f.x,f.y):r.lineTo(f.x,f.y),r.quadraticCurveTo(l.x,l.y,g.x,g.y,n)}}const Fy=new he;class Oy{constructor(e){this.shapePrimitives=[],this._currentPoly=null,this._bounds=new Ze,this._graphicsPath2D=e}moveTo(e,t){return this.startPoly(e,t),this}lineTo(e,t){this._ensurePoly();const n=this._currentPoly.points,s=n[n.length-2],i=n[n.length-1];return(s!==e||i!==t)&&n.push(e,t),this}arc(e,t,n,s,i,o){this._ensurePoly(!1);const a=this._currentPoly.points;return Hc(a,e,t,n,s,i,o),this}arcTo(e,t,n,s,i){this._ensurePoly();const o=this._currentPoly.points;return By(o,e,t,n,s,i),this}arcToSvg(e,t,n,s,i,o,a){const l=this._currentPoly.points;return Iy(l,this._currentPoly.lastX,this._currentPoly.lastY,o,a,e,t,n,s,i),this}bezierCurveTo(e,t,n,s,i,o,a){this._ensurePoly();const l=this._currentPoly;return Nc(this._currentPoly.points,l.lastX,l.lastY,e,t,n,s,i,o,a),this}quadraticCurveTo(e,t,n,s,i){this._ensurePoly();const o=this._currentPoly;return My(this._currentPoly.points,o.lastX,o.lastY,e,t,n,s,i),this}closePath(){return this.endPoly(!0),this}addPath(e,t){this.endPoly(),t&&!t.isIdentity()&&(e=e.clone(!0),e.transform(t));for(let n=0;n<e.instructions.length;n++){const s=e.instructions[n];this[s.action](...s.data)}return this}finish(e=!1){this.endPoly(e)}rect(e,t,n,s,i){return this.drawShape(new he(e,t,n,s),i),this}circle(e,t,n,s){return this.drawShape(new Wi(e,t,n),s),this}poly(e,t,n){const s=new un(e);return s.closePath=t,this.drawShape(s,n),this}regularPoly(e,t,n,s,i=0,o){s=Math.max(s|0,3);const a=-1*Math.PI/2+i,l=Math.PI*2/s,c=[];for(let h=0;h<s;h++){const u=h*l+a;c.push(e+n*Math.cos(u),t+n*Math.sin(u))}return this.poly(c,!0,o),this}roundPoly(e,t,n,s,i,o=0,a){if(s=Math.max(s|0,3),i<=0)return this.regularPoly(e,t,n,s,o);const l=n*Math.sin(Math.PI/s)-.001;i=Math.min(i,l);const c=-1*Math.PI/2+o,h=Math.PI*2/s,u=(s-2)*Math.PI/s/2;for(let d=0;d<s;d++){const f=d*h+c,p=e+n*Math.cos(f),g=t+n*Math.sin(f),m=f+Math.PI+u,_=f-Math.PI-u,b=p+i*Math.cos(m),y=g+i*Math.sin(m),x=p+i*Math.cos(_),S=g+i*Math.sin(_);d===0?this.moveTo(b,y):this.lineTo(b,y),this.quadraticCurveTo(p,g,x,S,a)}return this.closePath()}roundShape(e,t,n=!1,s){return e.length<3?this:(n?Uy(this,e,t,s):Gy(this,e,t),this.closePath())}filletRect(e,t,n,s,i){if(i===0)return this.rect(e,t,n,s);const o=Math.min(n,s)/2,a=Math.min(o,Math.max(-o,i)),l=e+n,c=t+s,h=a<0?-a:0,u=Math.abs(a);return this.moveTo(e,t+u).arcTo(e+h,t+h,e+u,t,u).lineTo(l-u,t).arcTo(l-h,t+h,l,t+u,u).lineTo(l,c-u).arcTo(l-h,c-h,e+n-u,c,u).lineTo(e+u,c).arcTo(e+h,c-h,e,c-u,u).closePath()}chamferRect(e,t,n,s,i,o){if(i<=0)return this.rect(e,t,n,s);const a=Math.min(i,Math.min(n,s)/2),l=e+n,c=t+s,h=[e+a,t,l-a,t,l,t+a,l,c-a,l-a,c,e+a,c,e,c-a,e,t+a];for(let u=h.length-1;u>=2;u-=2)h[u]===h[u-2]&&h[u-1]===h[u-3]&&h.splice(u-1,2);return this.poly(h,!0,o)}ellipse(e,t,n,s,i){return this.drawShape(new Vi(e,t,n,s),i),this}roundRect(e,t,n,s,i,o){return this.drawShape(new Xi(e,t,n,s,i),o),this}drawShape(e,t){return this.endPoly(),this.shapePrimitives.push({shape:e,transform:t}),this}startPoly(e,t){let n=this._currentPoly;return n&&this.endPoly(),n=new un,n.points.push(e,t),this._currentPoly=n,this}endPoly(e=!1){const t=this._currentPoly;return t&&t.points.length>2&&(t.closePath=e,this.shapePrimitives.push({shape:t})),this._currentPoly=null,this}_ensurePoly(e=!0){if(!this._currentPoly&&(this._currentPoly=new un,e)){const t=this.shapePrimitives[this.shapePrimitives.length-1];if(t){let n=t.shape.x,s=t.shape.y;if(!t.transform.isIdentity()){const i=t.transform,o=n;n=i.a*n+i.c*s+i.tx,s=i.b*o+i.d*s+i.ty}this._currentPoly.points.push(n,s)}else this._currentPoly.points.push(0,0)}}buildPath(){const e=this._graphicsPath2D;this.shapePrimitives.length=0,this._currentPoly=null;for(let t=0;t<e.instructions.length;t++){const n=e.instructions[t];this[n.action](...n.data)}this.finish()}get bounds(){const e=this._bounds;e.clear();const t=this.shapePrimitives;for(let n=0;n<t.length;n++){const s=t[n],i=s.shape.getBounds(Fy);s.transform?e.addRect(i,s.transform):e.addRect(i)}return e}}class Or{constructor(e){this.instructions=[],this.uid=be("graphicsPath"),this._dirty=!0,typeof e=="string"?ty(e,this):this.instructions=(e==null?void 0:e.slice())??[]}get shapePath(){return this._shapePath||(this._shapePath=new Oy(this)),this._dirty&&(this._dirty=!1,this._shapePath.buildPath()),this._shapePath}addPath(e,t){return e=e.clone(),this.instructions.push({action:"addPath",data:[e,t]}),this._dirty=!0,this}arc(...e){return this.instructions.push({action:"arc",data:e}),this._dirty=!0,this}arcTo(...e){return this.instructions.push({action:"arcTo",data:e}),this._dirty=!0,this}arcToSvg(...e){return this.instructions.push({action:"arcToSvg",data:e}),this._dirty=!0,this}bezierCurveTo(...e){return this.instructions.push({action:"bezierCurveTo",data:e}),this._dirty=!0,this}bezierCurveToShort(e,t,n,s,i){const o=this.instructions[this.instructions.length-1],a=this.getLastPoint(ce.shared);let l=0,c=0;if(!o||o.action!=="bezierCurveTo")l=a.x,c=a.y;else{l=o.data[2],c=o.data[3];const h=a.x,u=a.y;l=h+(h-l),c=u+(u-c)}return this.instructions.push({action:"bezierCurveTo",data:[l,c,e,t,n,s,i]}),this._dirty=!0,this}closePath(){return this.instructions.push({action:"closePath",data:[]}),this._dirty=!0,this}ellipse(...e){return this.instructions.push({action:"ellipse",data:e}),this._dirty=!0,this}lineTo(...e){return this.instructions.push({action:"lineTo",data:e}),this._dirty=!0,this}moveTo(...e){return this.instructions.push({action:"moveTo",data:e}),this}quadraticCurveTo(...e){return this.instructions.push({action:"quadraticCurveTo",data:e}),this._dirty=!0,this}quadraticCurveToShort(e,t,n){const s=this.instructions[this.instructions.length-1],i=this.getLastPoint(ce.shared);let o=0,a=0;if(!s||s.action!=="quadraticCurveTo")o=i.x,a=i.y;else{o=s.data[0],a=s.data[1];const l=i.x,c=i.y;o=l+(l-o),a=c+(c-a)}return this.instructions.push({action:"quadraticCurveTo",data:[o,a,e,t,n]}),this._dirty=!0,this}rect(e,t,n,s,i){return this.instructions.push({action:"rect",data:[e,t,n,s,i]}),this._dirty=!0,this}circle(e,t,n,s){return this.instructions.push({action:"circle",data:[e,t,n,s]}),this._dirty=!0,this}roundRect(...e){return this.instructions.push({action:"roundRect",data:e}),this._dirty=!0,this}poly(...e){return this.instructions.push({action:"poly",data:e}),this._dirty=!0,this}regularPoly(...e){return this.instructions.push({action:"regularPoly",data:e}),this._dirty=!0,this}roundPoly(...e){return this.instructions.push({action:"roundPoly",data:e}),this._dirty=!0,this}roundShape(...e){return this.instructions.push({action:"roundShape",data:e}),this._dirty=!0,this}filletRect(...e){return this.instructions.push({action:"filletRect",data:e}),this._dirty=!0,this}chamferRect(...e){return this.instructions.push({action:"chamferRect",data:e}),this._dirty=!0,this}star(e,t,n,s,i,o,a){i=i||s/2;const l=-1*Math.PI/2+o,c=n*2,h=Math.PI*2/c,u=[];for(let d=0;d<c;d++){const f=d%2?i:s,p=d*h+l;u.push(e+f*Math.cos(p),t+f*Math.sin(p))}return this.poly(u,!0,a),this}clone(e=!1){const t=new Or;if(!e)t.instructions=this.instructions.slice();else for(let n=0;n<this.instructions.length;n++){const s=this.instructions[n];t.instructions.push({action:s.action,data:s.data.slice()})}return t}clear(){return this.instructions.length=0,this._dirty=!0,this}transform(e){if(e.isIdentity())return this;const t=e.a,n=e.b,s=e.c,i=e.d,o=e.tx,a=e.ty;let l=0,c=0,h=0,u=0,d=0,f=0,p=0,g=0;for(let m=0;m<this.instructions.length;m++){const _=this.instructions[m],b=_.data;switch(_.action){case"moveTo":case"lineTo":l=b[0],c=b[1],b[0]=t*l+s*c+o,b[1]=n*l+i*c+a;break;case"bezierCurveTo":h=b[0],u=b[1],d=b[2],f=b[3],l=b[4],c=b[5],b[0]=t*h+s*u+o,b[1]=n*h+i*u+a,b[2]=t*d+s*f+o,b[3]=n*d+i*f+a,b[4]=t*l+s*c+o,b[5]=n*l+i*c+a;break;case"quadraticCurveTo":h=b[0],u=b[1],l=b[2],c=b[3],b[0]=t*h+s*u+o,b[1]=n*h+i*u+a,b[2]=t*l+s*c+o,b[3]=n*l+i*c+a;break;case"arcToSvg":l=b[5],c=b[6],p=b[0],g=b[1],b[0]=t*p+s*g,b[1]=n*p+i*g,b[5]=t*l+s*c+o,b[6]=n*l+i*c+a;break;case"circle":b[4]=pn(b[3],e);break;case"rect":b[4]=pn(b[4],e);break;case"ellipse":b[8]=pn(b[8],e);break;case"roundRect":b[5]=pn(b[5],e);break;case"addPath":b[0].transform(e);break;case"poly":b[2]=pn(b[2],e);break;default:ne("unknown transform action",_.action);break}}return this._dirty=!0,this}get bounds(){return this.shapePath.bounds}getLastPoint(e){let t=this.instructions.length-1,n=this.instructions[t];if(!n)return e.x=0,e.y=0,e;for(;n.action==="closePath";){if(t--,t<0)return e.x=0,e.y=0,e;n=this.instructions[t]}switch(n.action){case"moveTo":case"lineTo":e.x=n.data[0],e.y=n.data[1];break;case"quadraticCurveTo":e.x=n.data[2],e.y=n.data[3];break;case"bezierCurveTo":e.x=n.data[4],e.y=n.data[5];break;case"arc":case"arcToSvg":e.x=n.data[5],e.y=n.data[6];break;case"addPath":n.data[0].getLastPoint(e);break}return e}}function pn(r,e){return r?r.prepend(e):e.clone()}function Dy(r,e){if(typeof r=="string"){const n=document.createElement("div");n.innerHTML=r.trim(),r=n.querySelector("svg")}const t={context:e,path:new Or};return $c(r,t,null,null),e}function $c(r,e,t,n){const s=r.children,{fillStyle:i,strokeStyle:o}=Ly(r);i&&t?t={...t,...i}:i&&(t=i),o&&n?n={...n,...o}:o&&(n=o),e.context.fillStyle=t,e.context.strokeStyle=n;let a,l,c,h,u,d,f,p,g,m,_,b,y,x,S,k,P;switch(r.nodeName.toLowerCase()){case"path":x=r.getAttribute("d"),S=new Or(x),e.context.path(S),t&&e.context.fill(),n&&e.context.stroke();break;case"circle":f=Ce(r,"cx",0),p=Ce(r,"cy",0),g=Ce(r,"r",0),e.context.ellipse(f,p,g,g),t&&e.context.fill(),n&&e.context.stroke();break;case"rect":a=Ce(r,"x",0),l=Ce(r,"y",0),k=Ce(r,"width",0),P=Ce(r,"height",0),m=Ce(r,"rx",0),_=Ce(r,"ry",0),m||_?e.context.roundRect(a,l,k,P,m||_):e.context.rect(a,l,k,P),t&&e.context.fill(),n&&e.context.stroke();break;case"ellipse":f=Ce(r,"cx",0),p=Ce(r,"cy",0),m=Ce(r,"rx",0),_=Ce(r,"ry",0),e.context.beginPath(),e.context.ellipse(f,p,m,_),t&&e.context.fill(),n&&e.context.stroke();break;case"line":c=Ce(r,"x1",0),h=Ce(r,"y1",0),u=Ce(r,"x2",0),d=Ce(r,"y2",0),e.context.beginPath(),e.context.moveTo(c,h),e.context.lineTo(u,d),n&&e.context.stroke();break;case"polygon":y=r.getAttribute("points"),b=y.match(/\d+/g).map(T=>parseInt(T,10)),e.context.poly(b,!0),t&&e.context.fill(),n&&e.context.stroke();break;case"polyline":y=r.getAttribute("points"),b=y.match(/\d+/g).map(T=>parseInt(T,10)),e.context.poly(b,!1),n&&e.context.stroke();break;case"g":case"svg":break;default:{console.info(`[SVG parser] <${r.nodeName}> elements unsupported`);break}}for(let T=0;T<s.length;T++)$c(s[T],e,t,n)}function Ce(r,e,t){const n=r.getAttribute(e);return n?Number(n):t}function Ly(r){const e=r.getAttribute("style"),t={},n={};let s=!1,i=!1;if(e){const o=e.split(";");for(let a=0;a<o.length;a++){const l=o[a],[c,h]=l.split(":");switch(c){case"stroke":h!=="none"&&(t.color=ue.shared.setValue(h).toNumber(),i=!0);break;case"stroke-width":t.width=Number(h);break;case"fill":h!=="none"&&(s=!0,n.color=ue.shared.setValue(h).toNumber());break;case"fill-opacity":n.alpha=Number(h);break;case"stroke-opacity":t.alpha=Number(h);break;case"opacity":n.alpha=Number(h),t.alpha=Number(h);break}}}else{const o=r.getAttribute("stroke");o&&o!=="none"&&(i=!0,t.color=ue.shared.setValue(o).toNumber(),t.width=Ce(r,"stroke-width",1));const a=r.getAttribute("fill");a&&a!=="none"&&(s=!0,n.color=ue.shared.setValue(a).toNumber())}return{strokeStyle:i?t:null,fillStyle:s?n:null}}const Wc=class Zo{constructor(e,t,n,s){this.uid=be("fillGradient"),this.type="linear",this.gradientStops=[],this.x0=e,this.y0=t,this.x1=n,this.y1=s}addColorStop(e,t){return this.gradientStops.push({offset:e,color:ue.shared.setValue(t).toHex()}),this}buildLinearGradient(){const e=Zo.defaultTextureSize,{gradientStops:t}=this,n=xe.get().createCanvas();n.width=e,n.height=e;const s=n.getContext("2d"),i=s.createLinearGradient(0,0,Zo.defaultTextureSize,1);for(let g=0;g<t.length;g++){const m=t[g];i.addColorStop(m.offset,m.color)}s.fillStyle=i,s.fillRect(0,0,e,e),this.texture=new $({source:new Zn({resource:n,addressModeU:"clamp-to-edge",addressModeV:"repeat"})});const{x0:o,y0:a,x1:l,y1:c}=this,h=new W,u=l-o,d=c-a,f=Math.sqrt(u*u+d*d),p=Math.atan2(d,u);h.translate(-o,-a),h.scale(1/e,1/e),h.rotate(-p),h.scale(256/f,1),this.transform=h}};Wc.defaultTextureSize=256;let so=Wc;const Vc={repeat:{addressModeU:"repeat",addressModeV:"repeat"},"repeat-x":{addressModeU:"repeat",addressModeV:"clamp-to-edge"},"repeat-y":{addressModeU:"clamp-to-edge",addressModeV:"repeat"},"no-repeat":{addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}};class Xc{constructor(e,t){this.uid=be("fillPattern"),this.transform=new W,this.texture=e,this.transform.scale(1/e.frame.width,1/e.frame.height),t&&(e.source.style.addressModeU=Vc[t].addressModeU,e.source.style.addressModeV=Vc[t].addressModeV)}setTransform(e){const t=this.texture;this.transform.copyFrom(e),this.transform.invert(),this.transform.scale(1/t.frame.width,1/t.frame.height)}}function Xt(r,e){var o;if(r==null)return null;let t,n;if(r!=null&&r.fill?(n=r.fill,t={...e,...r}):(n=r,t=e),ue.isColorLike(n)){const a=ue.shared.setValue(n??0);return{...t,color:a.toNumber(),alpha:a.alpha===1?t.alpha:a.alpha,texture:$.WHITE}}else if(n instanceof Xc){const a=n;return{...t,color:16777215,texture:a.texture,matrix:a.transform,fill:t.fill??null}}else if(n instanceof so){const a=n;return a.buildLinearGradient(),{...t,color:16777215,texture:a.texture,matrix:a.transform}}const s={...e,...r};if(s.texture){if(s.texture!==$.WHITE){const l=((o=s.matrix)==null?void 0:o.invert())||new W;l.scale(1/s.texture.frame.width,1/s.texture.frame.height),s.matrix=l}const a=s.texture.source.style;a.addressMode==="clamp-to-edge"&&(a.addressMode="repeat")}const i=ue.shared.setValue(s.color);return s.alpha*=i.alpha,s.color=i.toNumber(),s.matrix=s.matrix?s.matrix.clone():null,s}const Ny=new ce,Yc=new W,io=class Pt extends Ke{constructor(){super(...arguments),this.uid=be("graphicsContext"),this.dirty=!0,this.batchMode="auto",this.instructions=[],this._activePath=new Or,this._transform=new W,this._fillStyle={...Pt.defaultFillStyle},this._strokeStyle={...Pt.defaultStrokeStyle},this._stateStack=[],this._tick=0,this._bounds=new Ze,this._boundsDirty=!0}clone(){const e=new Pt;return e.batchMode=this.batchMode,e.instructions=this.instructions.slice(),e._activePath=this._activePath.clone(),e._transform=this._transform.clone(),e._fillStyle={...this._fillStyle},e._strokeStyle={...this._strokeStyle},e._stateStack=this._stateStack.slice(),e._bounds=this._bounds.clone(),e._boundsDirty=!0,e}get fillStyle(){return this._fillStyle}set fillStyle(e){this._fillStyle=Xt(e,Pt.defaultFillStyle)}get strokeStyle(){return this._strokeStyle}set strokeStyle(e){this._strokeStyle=Xt(e,Pt.defaultStrokeStyle)}setFillStyle(e){return this._fillStyle=Xt(e,Pt.defaultFillStyle),this}setStrokeStyle(e){return this._strokeStyle=Xt(e,Pt.defaultStrokeStyle),this}texture(e,t,n,s,i,o){return this.instructions.push({action:"texture",data:{image:e,dx:n||0,dy:s||0,dw:i||e.frame.width,dh:o||e.frame.height,transform:this._transform.clone(),alpha:this._fillStyle.alpha,style:t?ue.shared.setValue(t).toNumber():16777215}}),this.onUpdate(),this}beginPath(){return this._activePath=new Or,this}fill(e,t){let n;const s=this.instructions[this.instructions.length-1];return this._tick===0&&s&&s.action==="stroke"?n=s.data.path:n=this._activePath.clone(),n?(e!=null&&(t!==void 0&&typeof e=="number"&&(ie(le,"GraphicsContext.fill(color, alpha) is deprecated, use GraphicsContext.fill({ color, alpha }) instead"),e={color:e,alpha:t}),this._fillStyle=Xt(e,Pt.defaultFillStyle)),this.instructions.push({action:"fill",data:{style:this.fillStyle,path:n}}),this.onUpdate(),this._initNextPathLocation(),this._tick=0,this):this}_initNextPathLocation(){const{x:e,y:t}=this._activePath.getLastPoint(ce.shared);this._activePath.clear(),this._activePath.moveTo(e,t)}stroke(e){let t;const n=this.instructions[this.instructions.length-1];return this._tick===0&&n&&n.action==="fill"?t=n.data.path:t=this._activePath.clone(),t?(e!=null&&(this._strokeStyle=Xt(e,Pt.defaultStrokeStyle)),this.instructions.push({action:"stroke",data:{style:this.strokeStyle,path:t}}),this.onUpdate(),this._initNextPathLocation(),this._tick=0,this):this}cut(){for(let e=0;e<2;e++){const t=this.instructions[this.instructions.length-1-e],n=this._activePath.clone();if(t&&(t.action==="stroke"||t.action==="fill"))if(t.data.hole)t.data.hole.addPath(n);else{t.data.hole=n;break}}return this._initNextPathLocation(),this}arc(e,t,n,s,i,o){this._tick++;const a=this._transform;return this._activePath.arc(a.a*e+a.c*t+a.tx,a.b*e+a.d*t+a.ty,n,s,i,o),this}arcTo(e,t,n,s,i){this._tick++;const o=this._transform;return this._activePath.arcTo(o.a*e+o.c*t+o.tx,o.b*e+o.d*t+o.ty,o.a*n+o.c*s+o.tx,o.b*n+o.d*s+o.ty,i),this}arcToSvg(e,t,n,s,i,o,a){this._tick++;const l=this._transform;return this._activePath.arcToSvg(e,t,n,s,i,l.a*o+l.c*a+l.tx,l.b*o+l.d*a+l.ty),this}bezierCurveTo(e,t,n,s,i,o,a){this._tick++;const l=this._transform;return this._activePath.bezierCurveTo(l.a*e+l.c*t+l.tx,l.b*e+l.d*t+l.ty,l.a*n+l.c*s+l.tx,l.b*n+l.d*s+l.ty,l.a*i+l.c*o+l.tx,l.b*i+l.d*o+l.ty,a),this}closePath(){var e;return this._tick++,(e=this._activePath)==null||e.closePath(),this}ellipse(e,t,n,s){return this._tick++,this._activePath.ellipse(e,t,n,s,this._transform.clone()),this}circle(e,t,n){return this._tick++,this._activePath.circle(e,t,n,this._transform.clone()),this}path(e){return this._tick++,this._activePath.addPath(e,this._transform.clone()),this}lineTo(e,t){this._tick++;const n=this._transform;return this._activePath.lineTo(n.a*e+n.c*t+n.tx,n.b*e+n.d*t+n.ty),this}moveTo(e,t){this._tick++;const n=this._transform,s=this._activePath.instructions,i=n.a*e+n.c*t+n.tx,o=n.b*e+n.d*t+n.ty;return s.length===1&&s[0].action==="moveTo"?(s[0].data[0]=i,s[0].data[1]=o,this):(this._activePath.moveTo(i,o),this)}quadraticCurveTo(e,t,n,s,i){this._tick++;const o=this._transform;return this._activePath.quadraticCurveTo(o.a*e+o.c*t+o.tx,o.b*e+o.d*t+o.ty,o.a*n+o.c*s+o.tx,o.b*n+o.d*s+o.ty,i),this}rect(e,t,n,s){return this._tick++,this._activePath.rect(e,t,n,s,this._transform.clone()),this}roundRect(e,t,n,s,i){return this._tick++,this._activePath.roundRect(e,t,n,s,i,this._transform.clone()),this}poly(e,t){return this._tick++,this._activePath.poly(e,t,this._transform.clone()),this}regularPoly(e,t,n,s,i=0,o){return this._tick++,this._activePath.regularPoly(e,t,n,s,i,o),this}roundPoly(e,t,n,s,i,o){return this._tick++,this._activePath.roundPoly(e,t,n,s,i,o),this}roundShape(e,t,n,s){return this._tick++,this._activePath.roundShape(e,t,n,s),this}filletRect(e,t,n,s,i){return this._tick++,this._activePath.filletRect(e,t,n,s,i),this}chamferRect(e,t,n,s,i,o){return this._tick++,this._activePath.chamferRect(e,t,n,s,i,o),this}star(e,t,n,s,i=0,o=0){return this._tick++,this._activePath.star(e,t,n,s,i,o,this._transform.clone()),this}svg(e){return this._tick++,Dy(e,this),this}restore(){const e=this._stateStack.pop();return e&&(this._transform=e.transform,this._fillStyle=e.fillStyle,this._strokeStyle=e.strokeStyle),this}save(){return this._stateStack.push({transform:this._transform.clone(),fillStyle:{...this._fillStyle},strokeStyle:{...this._strokeStyle}}),this}getTransform(){return this._transform}resetTransform(){return this._transform.identity(),this}rotate(e){return this._transform.rotate(e),this}scale(e,t=e){return this._transform.scale(e,t),this}setTransform(e,t,n,s,i,o){return e instanceof W?(this._transform.set(e.a,e.b,e.c,e.d,e.tx,e.ty),this):(this._transform.set(e,t,n,s,i,o),this)}transform(e,t,n,s,i,o){return e instanceof W?(this._transform.append(e),this):(Yc.set(e,t,n,s,i,o),this._transform.append(Yc),this)}translate(e,t=e){return this._transform.translate(e,t),this}clear(){return this.instructions.length=0,this.resetTransform(),this.onUpdate(),this}onUpdate(){this.dirty||(this.emit("update",this,16),this.dirty=!0,this._boundsDirty=!0)}get bounds(){if(!this._boundsDirty)return this._bounds;const e=this._bounds;e.clear();for(let t=0;t<this.instructions.length;t++){const n=this.instructions[t],s=n.action;if(s==="fill"){const i=n.data;e.addBounds(i.path.bounds)}else if(s==="texture"){const i=n.data;e.addFrame(i.dx,i.dy,i.dx+i.dw,i.dy+i.dh,i.transform)}if(s==="stroke"){const i=n.data,o=i.style.width/2,a=i.path.bounds;e.addFrame(a.minX-o,a.minY-o,a.maxX+o,a.maxY+o)}}return e}containsPoint(e){var s;if(!this.bounds.containsPoint(e.x,e.y))return!1;const t=this.instructions;let n=!1;for(let i=0;i<t.length;i++){const o=t[i],a=o.data,l=a.path;if(!o.action||!l)continue;const c=a.style,h=l.shapePath.shapePrimitives;for(let u=0;u<h.length;u++){const d=h[u].shape;if(!c||!d)continue;const f=h[u].transform,p=f?f.applyInverse(e,Ny):e;o.action==="fill"?n=d.contains(p.x,p.y):n=d.strokeContains(p.x,p.y,c.width);const g=a.hole;if(g){const m=(s=g.shapePath)==null?void 0:s.shapePrimitives;if(m)for(let _=0;_<m.length;_++)m[_].shape.contains(p.x,p.y)&&(n=!1)}if(n)return!0}}return n}destroy(e=!1){if(this._stateStack.length=0,this._transform=null,this.emit("destroy",this),this.removeAllListeners(),typeof e=="boolean"?e:e==null?void 0:e.texture){const n=typeof e=="boolean"?e:e==null?void 0:e.textureSource;this._fillStyle.texture&&this._fillStyle.texture.destroy(n),this._strokeStyle.texture&&this._strokeStyle.texture.destroy(n)}this._fillStyle=null,this._strokeStyle=null,this.instructions=null,this._activePath=null,this._bounds=null,this._stateStack=null,this.customShader=null,this._transform=null}};io.defaultFillStyle={color:16777215,alpha:1,texture:$.WHITE,matrix:null,fill:null},io.defaultStrokeStyle={width:1,color:16777215,alpha:1,alignment:.5,miterLimit:10,cap:"butt",join:"miter",texture:$.WHITE,matrix:null,fill:null};let ar=io;class Hy{constructor(){this.interactionFrequency=10,this._deltaTime=0,this._didMove=!1,this._tickerAdded=!1,this._pauseUpdate=!0}init(e){this.removeTickerListener(),this.events=e,this.interactionFrequency=10,this._deltaTime=0,this._didMove=!1,this._tickerAdded=!1,this._pauseUpdate=!0}get pauseUpdate(){return this._pauseUpdate}set pauseUpdate(e){this._pauseUpdate=e}addTickerListener(){this._tickerAdded||!this.domElement||(Wt.system.add(this._tickerUpdate,this,en.INTERACTION),this._tickerAdded=!0)}removeTickerListener(){this._tickerAdded&&(Wt.system.remove(this._tickerUpdate,this),this._tickerAdded=!1)}pointerMoved(){this._didMove=!0}_update(){if(!this.domElement||this._pauseUpdate)return;if(this._didMove){this._didMove=!1;return}const e=this.events._rootPointerEvent;this.events.supportsTouchEvents&&e.pointerType==="touch"||globalThis.document.dispatchEvent(new PointerEvent("pointermove",{clientX:e.clientX,clientY:e.clientY}))}_tickerUpdate(e){this._deltaTime+=e.deltaTime,!(this._deltaTime<this.interactionFrequency)&&(this._deltaTime=0,this._update())}}const Yt=new Hy;class fs extends rn{constructor(){super(...arguments),this.client=new ce,this.movement=new ce,this.offset=new ce,this.global=new ce,this.screen=new ce}get clientX(){return this.client.x}get clientY(){return this.client.y}get x(){return this.clientX}get y(){return this.clientY}get movementX(){return this.movement.x}get movementY(){return this.movement.y}get offsetX(){return this.offset.x}get offsetY(){return this.offset.y}get globalX(){return this.global.x}get globalY(){return this.global.y}get screenX(){return this.screen.x}get screenY(){return this.screen.y}getLocalPosition(e,t,n){return e.worldTransform.applyInverse(n||this.global,t)}getModifierState(e){return"getModifierState"in this.nativeEvent&&this.nativeEvent.getModifierState(e)}initMouseEvent(e,t,n,s,i,o,a,l,c,h,u,d,f,p,g){throw new Error("Method not implemented.")}}class gt extends fs{constructor(){super(...arguments),this.width=0,this.height=0,this.isPrimary=!1}getCoalescedEvents(){return this.type==="pointermove"||this.type==="mousemove"||this.type==="touchmove"?[this]:[]}getPredictedEvents(){throw new Error("getPredictedEvents is not supported!")}}class Dr extends fs{constructor(){super(...arguments),this.DOM_DELTA_PIXEL=0,this.DOM_DELTA_LINE=1,this.DOM_DELTA_PAGE=2}}Dr.DOM_DELTA_PIXEL=0,Dr.DOM_DELTA_LINE=1,Dr.DOM_DELTA_PAGE=2;const zy=2048,$y=new ce,mn=new ce;class Wy{constructor(e){this.dispatch=new Ke,this.moveOnAll=!1,this.enableGlobalMoveEvents=!0,this.mappingState={trackingData:{}},this.eventPool=new Map,this._allInteractiveElements=[],this._hitElements=[],this._isPointerMoveEvent=!1,this.rootTarget=e,this.hitPruneFn=this.hitPruneFn.bind(this),this.hitTestFn=this.hitTestFn.bind(this),this.mapPointerDown=this.mapPointerDown.bind(this),this.mapPointerMove=this.mapPointerMove.bind(this),this.mapPointerOut=this.mapPointerOut.bind(this),this.mapPointerOver=this.mapPointerOver.bind(this),this.mapPointerUp=this.mapPointerUp.bind(this),this.mapPointerUpOutside=this.mapPointerUpOutside.bind(this),this.mapWheel=this.mapWheel.bind(this),this.mappingTable={},this.addEventMapping("pointerdown",this.mapPointerDown),this.addEventMapping("pointermove",this.mapPointerMove),this.addEventMapping("pointerout",this.mapPointerOut),this.addEventMapping("pointerleave",this.mapPointerOut),this.addEventMapping("pointerover",this.mapPointerOver),this.addEventMapping("pointerup",this.mapPointerUp),this.addEventMapping("pointerupoutside",this.mapPointerUpOutside),this.addEventMapping("wheel",this.mapWheel)}addEventMapping(e,t){this.mappingTable[e]||(this.mappingTable[e]=[]),this.mappingTable[e].push({fn:t,priority:0}),this.mappingTable[e].sort((n,s)=>n.priority-s.priority)}dispatchEvent(e,t){e.propagationStopped=!1,e.propagationImmediatelyStopped=!1,this.propagate(e,t),this.dispatch.emit(t||e.type,e)}mapEvent(e){if(!this.rootTarget)return;const t=this.mappingTable[e.type];if(t)for(let n=0,s=t.length;n<s;n++)t[n].fn(e);else ne(`[EventBoundary]: Event mapping not defined for ${e.type}`)}hitTest(e,t){Yt.pauseUpdate=!0;const s=this._isPointerMoveEvent&&this.enableGlobalMoveEvents?"hitTestMoveRecursive":"hitTestRecursive",i=this[s](this.rootTarget,this.rootTarget.eventMode,$y.set(e,t),this.hitTestFn,this.hitPruneFn);return i&&i[0]}propagate(e,t){if(!e.target)return;const n=e.composedPath();e.eventPhase=e.CAPTURING_PHASE;for(let s=0,i=n.length-1;s<i;s++)if(e.currentTarget=n[s],this.notifyTarget(e,t),e.propagationStopped||e.propagationImmediatelyStopped)return;if(e.eventPhase=e.AT_TARGET,e.currentTarget=e.target,this.notifyTarget(e,t),!(e.propagationStopped||e.propagationImmediatelyStopped)){e.eventPhase=e.BUBBLING_PHASE;for(let s=n.length-2;s>=0;s--)if(e.currentTarget=n[s],this.notifyTarget(e,t),e.propagationStopped||e.propagationImmediatelyStopped)return}}all(e,t,n=this._allInteractiveElements){if(n.length===0)return;e.eventPhase=e.BUBBLING_PHASE;const s=Array.isArray(t)?t:[t];for(let i=n.length-1;i>=0;i--)s.forEach(o=>{e.currentTarget=n[i],this.notifyTarget(e,o)})}propagationPath(e){const t=[e];for(let n=0;n<zy&&e!==this.rootTarget&&e.parent;n++){if(!e.parent)throw new Error("Cannot find propagation path to disconnected target");t.push(e.parent),e=e.parent}return t.reverse(),t}hitTestMoveRecursive(e,t,n,s,i,o=!1){let a=!1;if(this._interactivePrune(e))return null;if((e.eventMode==="dynamic"||t==="dynamic")&&(Yt.pauseUpdate=!1),e.interactiveChildren&&e.children){const h=e.children;for(let u=h.length-1;u>=0;u--){const d=h[u],f=this.hitTestMoveRecursive(d,this._isInteractive(t)?t:d.eventMode,n,s,i,o||i(e,n));if(f){if(f.length>0&&!f[f.length-1].parent)continue;const p=e.isInteractive();(f.length>0||p)&&(p&&this._allInteractiveElements.push(e),f.push(e)),this._hitElements.length===0&&(this._hitElements=f),a=!0}}}const l=this._isInteractive(t),c=e.isInteractive();return c&&c&&this._allInteractiveElements.push(e),o||this._hitElements.length>0?null:a?this._hitElements:l&&!i(e,n)&&s(e,n)?c?[e]:[]:null}hitTestRecursive(e,t,n,s,i){if(this._interactivePrune(e)||i(e,n))return null;if((e.eventMode==="dynamic"||t==="dynamic")&&(Yt.pauseUpdate=!1),e.interactiveChildren&&e.children){const l=e.children,c=n;for(let h=l.length-1;h>=0;h--){const u=l[h],d=this.hitTestRecursive(u,this._isInteractive(t)?t:u.eventMode,c,s,i);if(d){if(d.length>0&&!d[d.length-1].parent)continue;const f=e.isInteractive();return(d.length>0||f)&&d.push(e),d}}}const o=this._isInteractive(t),a=e.isInteractive();return o&&s(e,n)?a?[e]:[]:null}_isInteractive(e){return e==="static"||e==="dynamic"}_interactivePrune(e){return!e||!e.visible||!e.renderable||e.eventMode==="none"||e.eventMode==="passive"&&!e.interactiveChildren}hitPruneFn(e,t){if(e.hitArea&&(e.worldTransform.applyInverse(t,mn),!e.hitArea.contains(mn.x,mn.y)))return!0;if(e.effects&&e.effects.length)for(let n=0;n<e.effects.length;n++){const s=e.effects[n];if(s.containsPoint&&!s.containsPoint(t,this.hitTestFn))return!0}return!1}hitTestFn(e,t){return e.hitArea?!0:e!=null&&e.containsPoint?(e.worldTransform.applyInverse(t,mn),e.containsPoint(mn)):!1}notifyTarget(e,t){var i,o;t=t??e.type;const n=`on${t}`;(o=(i=e.currentTarget)[n])==null||o.call(i,e);const s=e.eventPhase===e.CAPTURING_PHASE||e.eventPhase===e.AT_TARGET?`${t}capture`:t;this._notifyListeners(e,s),e.eventPhase===e.AT_TARGET&&this._notifyListeners(e,t)}mapPointerDown(e){if(!(e instanceof gt)){ne("EventBoundary cannot map a non-pointer event as a pointer event");return}const t=this.createPointerEvent(e);if(this.dispatchEvent(t,"pointerdown"),t.pointerType==="touch")this.dispatchEvent(t,"touchstart");else if(t.pointerType==="mouse"||t.pointerType==="pen"){const s=t.button===2;this.dispatchEvent(t,s?"rightdown":"mousedown")}const n=this.trackingData(e.pointerId);n.pressTargetsByButton[e.button]=t.composedPath(),this.freeEvent(t)}mapPointerMove(e){var l,c;if(!(e instanceof gt)){ne("EventBoundary cannot map a non-pointer event as a pointer event");return}this._allInteractiveElements.length=0,this._hitElements.length=0,this._isPointerMoveEvent=!0;const t=this.createPointerEvent(e);this._isPointerMoveEvent=!1;const n=t.pointerType==="mouse"||t.pointerType==="pen",s=this.trackingData(e.pointerId),i=this.findMountedTarget(s.overTargets);if(((l=s.overTargets)==null?void 0:l.length)>0&&i!==t.target){const h=e.type==="mousemove"?"mouseout":"pointerout",u=this.createPointerEvent(e,h,i);if(this.dispatchEvent(u,"pointerout"),n&&this.dispatchEvent(u,"mouseout"),!t.composedPath().includes(i)){const d=this.createPointerEvent(e,"pointerleave",i);for(d.eventPhase=d.AT_TARGET;d.target&&!t.composedPath().includes(d.target);)d.currentTarget=d.target,this.notifyTarget(d),n&&this.notifyTarget(d,"mouseleave"),d.target=d.target.parent;this.freeEvent(d)}this.freeEvent(u)}if(i!==t.target){const h=e.type==="mousemove"?"mouseover":"pointerover",u=this.clonePointerEvent(t,h);this.dispatchEvent(u,"pointerover"),n&&this.dispatchEvent(u,"mouseover");let d=i==null?void 0:i.parent;for(;d&&d!==this.rootTarget.parent&&d!==t.target;)d=d.parent;if(!d||d===this.rootTarget.parent){const p=this.clonePointerEvent(t,"pointerenter");for(p.eventPhase=p.AT_TARGET;p.target&&p.target!==i&&p.target!==this.rootTarget.parent;)p.currentTarget=p.target,this.notifyTarget(p),n&&this.notifyTarget(p,"mouseenter"),p.target=p.target.parent;this.freeEvent(p)}this.freeEvent(u)}const o=[],a=this.enableGlobalMoveEvents??!0;this.moveOnAll?o.push("pointermove"):this.dispatchEvent(t,"pointermove"),a&&o.push("globalpointermove"),t.pointerType==="touch"&&(this.moveOnAll?o.splice(1,0,"touchmove"):this.dispatchEvent(t,"touchmove"),a&&o.push("globaltouchmove")),n&&(this.moveOnAll?o.splice(1,0,"mousemove"):this.dispatchEvent(t,"mousemove"),a&&o.push("globalmousemove"),this.cursor=(c=t.target)==null?void 0:c.cursor),o.length>0&&this.all(t,o),this._allInteractiveElements.length=0,this._hitElements.length=0,s.overTargets=t.composedPath(),this.freeEvent(t)}mapPointerOver(e){var o;if(!(e instanceof gt)){ne("EventBoundary cannot map a non-pointer event as a pointer event");return}const t=this.trackingData(e.pointerId),n=this.createPointerEvent(e),s=n.pointerType==="mouse"||n.pointerType==="pen";this.dispatchEvent(n,"pointerover"),s&&this.dispatchEvent(n,"mouseover"),n.pointerType==="mouse"&&(this.cursor=(o=n.target)==null?void 0:o.cursor);const i=this.clonePointerEvent(n,"pointerenter");for(i.eventPhase=i.AT_TARGET;i.target&&i.target!==this.rootTarget.parent;)i.currentTarget=i.target,this.notifyTarget(i),s&&this.notifyTarget(i,"mouseenter"),i.target=i.target.parent;t.overTargets=n.composedPath(),this.freeEvent(n),this.freeEvent(i)}mapPointerOut(e){if(!(e instanceof gt)){ne("EventBoundary cannot map a non-pointer event as a pointer event");return}const t=this.trackingData(e.pointerId);if(t.overTargets){const n=e.pointerType==="mouse"||e.pointerType==="pen",s=this.findMountedTarget(t.overTargets),i=this.createPointerEvent(e,"pointerout",s);this.dispatchEvent(i),n&&this.dispatchEvent(i,"mouseout");const o=this.createPointerEvent(e,"pointerleave",s);for(o.eventPhase=o.AT_TARGET;o.target&&o.target!==this.rootTarget.parent;)o.currentTarget=o.target,this.notifyTarget(o),n&&this.notifyTarget(o,"mouseleave"),o.target=o.target.parent;t.overTargets=null,this.freeEvent(i),this.freeEvent(o)}this.cursor=null}mapPointerUp(e){if(!(e instanceof gt)){ne("EventBoundary cannot map a non-pointer event as a pointer event");return}const t=performance.now(),n=this.createPointerEvent(e);if(this.dispatchEvent(n,"pointerup"),n.pointerType==="touch")this.dispatchEvent(n,"touchend");else if(n.pointerType==="mouse"||n.pointerType==="pen"){const a=n.button===2;this.dispatchEvent(n,a?"rightup":"mouseup")}const s=this.trackingData(e.pointerId),i=this.findMountedTarget(s.pressTargetsByButton[e.button]);let o=i;if(i&&!n.composedPath().includes(i)){let a=i;for(;a&&!n.composedPath().includes(a);){if(n.currentTarget=a,this.notifyTarget(n,"pointerupoutside"),n.pointerType==="touch")this.notifyTarget(n,"touchendoutside");else if(n.pointerType==="mouse"||n.pointerType==="pen"){const l=n.button===2;this.notifyTarget(n,l?"rightupoutside":"mouseupoutside")}a=a.parent}delete s.pressTargetsByButton[e.button],o=a}if(o){const a=this.clonePointerEvent(n,"click");a.target=o,a.path=null,s.clicksByButton[e.button]||(s.clicksByButton[e.button]={clickCount:0,target:a.target,timeStamp:t});const l=s.clicksByButton[e.button];if(l.target===a.target&&t-l.timeStamp<200?++l.clickCount:l.clickCount=1,l.target=a.target,l.timeStamp=t,a.detail=l.clickCount,a.pointerType==="mouse"){const c=a.button===2;this.dispatchEvent(a,c?"rightclick":"click")}else a.pointerType==="touch"&&this.dispatchEvent(a,"tap");this.dispatchEvent(a,"pointertap"),this.freeEvent(a)}this.freeEvent(n)}mapPointerUpOutside(e){if(!(e instanceof gt)){ne("EventBoundary cannot map a non-pointer event as a pointer event");return}const t=this.trackingData(e.pointerId),n=this.findMountedTarget(t.pressTargetsByButton[e.button]),s=this.createPointerEvent(e);if(n){let i=n;for(;i;)s.currentTarget=i,this.notifyTarget(s,"pointerupoutside"),s.pointerType==="touch"?this.notifyTarget(s,"touchendoutside"):(s.pointerType==="mouse"||s.pointerType==="pen")&&this.notifyTarget(s,s.button===2?"rightupoutside":"mouseupoutside"),i=i.parent;delete t.pressTargetsByButton[e.button]}this.freeEvent(s)}mapWheel(e){if(!(e instanceof Dr)){ne("EventBoundary cannot map a non-wheel event as a wheel event");return}const t=this.createWheelEvent(e);this.dispatchEvent(t),this.freeEvent(t)}findMountedTarget(e){if(!e)return null;let t=e[0];for(let n=1;n<e.length&&e[n].parent===t;n++)t=e[n];return t}createPointerEvent(e,t,n){const s=this.allocateEvent(gt);return this.copyPointerData(e,s),this.copyMouseData(e,s),this.copyData(e,s),s.nativeEvent=e.nativeEvent,s.originalEvent=e,s.target=n??this.hitTest(s.global.x,s.global.y)??this._hitElements[0],typeof t=="string"&&(s.type=t),s}createWheelEvent(e){const t=this.allocateEvent(Dr);return this.copyWheelData(e,t),this.copyMouseData(e,t),this.copyData(e,t),t.nativeEvent=e.nativeEvent,t.originalEvent=e,t.target=this.hitTest(t.global.x,t.global.y),t}clonePointerEvent(e,t){const n=this.allocateEvent(gt);return n.nativeEvent=e.nativeEvent,n.originalEvent=e.originalEvent,this.copyPointerData(e,n),this.copyMouseData(e,n),this.copyData(e,n),n.target=e.target,n.path=e.composedPath().slice(),n.type=t??n.type,n}copyWheelData(e,t){t.deltaMode=e.deltaMode,t.deltaX=e.deltaX,t.deltaY=e.deltaY,t.deltaZ=e.deltaZ}copyPointerData(e,t){e instanceof gt&&t instanceof gt&&(t.pointerId=e.pointerId,t.width=e.width,t.height=e.height,t.isPrimary=e.isPrimary,t.pointerType=e.pointerType,t.pressure=e.pressure,t.tangentialPressure=e.tangentialPressure,t.tiltX=e.tiltX,t.tiltY=e.tiltY,t.twist=e.twist)}copyMouseData(e,t){e instanceof fs&&t instanceof fs&&(t.altKey=e.altKey,t.button=e.button,t.buttons=e.buttons,t.client.copyFrom(e.client),t.ctrlKey=e.ctrlKey,t.metaKey=e.metaKey,t.movement.copyFrom(e.movement),t.screen.copyFrom(e.screen),t.shiftKey=e.shiftKey,t.global.copyFrom(e.global))}copyData(e,t){t.isTrusted=e.isTrusted,t.srcElement=e.srcElement,t.timeStamp=performance.now(),t.type=e.type,t.detail=e.detail,t.view=e.view,t.which=e.which,t.layer.copyFrom(e.layer),t.page.copyFrom(e.page)}trackingData(e){return this.mappingState.trackingData[e]||(this.mappingState.trackingData[e]={pressTargetsByButton:{},clicksByButton:{},overTarget:null}),this.mappingState.trackingData[e]}allocateEvent(e){this.eventPool.has(e)||this.eventPool.set(e,[]);const t=this.eventPool.get(e).pop()||new e(this);return t.eventPhase=t.NONE,t.currentTarget=null,t.path=null,t.target=null,t}freeEvent(e){if(e.manager!==this)throw new Error("It is illegal to free an event not managed by this EventBoundary!");const t=e.constructor;this.eventPool.has(t)||this.eventPool.set(t,[]),this.eventPool.get(t).push(e)}_notifyListeners(e,t){const n=e.currentTarget._events[t];if(n&&e.currentTarget.isInteractive())if("fn"in n)n.once&&e.currentTarget.removeListener(t,n.fn,void 0,!0),n.fn.call(n.context,e);else for(let s=0,i=n.length;s<i&&!e.propagationImmediatelyStopped;s++)n[s].once&&e.currentTarget.removeListener(t,n[s].fn,void 0,!0),n[s].fn.call(n[s].context,e)}}const Vy=1,Xy={touchstart:"pointerdown",touchend:"pointerup",touchendoutside:"pointerupoutside",touchmove:"pointermove",touchcancel:"pointercancel"},oo=class Qo{constructor(e){this.supportsTouchEvents="ontouchstart"in globalThis,this.supportsPointerEvents=!!globalThis.PointerEvent,this.domElement=null,this.resolution=1,this.renderer=e,this.rootBoundary=new Wy(null),Yt.init(this),this.autoPreventDefault=!0,this._eventsAdded=!1,this._rootPointerEvent=new gt(null),this._rootWheelEvent=new Dr(null),this.cursorStyles={default:"inherit",pointer:"pointer"},this.features=new Proxy({...Qo.defaultEventFeatures},{set:(t,n,s)=>(n==="globalMove"&&(this.rootBoundary.enableGlobalMoveEvents=s),t[n]=s,!0)}),this._onPointerDown=this._onPointerDown.bind(this),this._onPointerMove=this._onPointerMove.bind(this),this._onPointerUp=this._onPointerUp.bind(this),this._onPointerOverOut=this._onPointerOverOut.bind(this),this.onWheel=this.onWheel.bind(this)}static get defaultEventMode(){return this._defaultEventMode}init(e){const{canvas:t,resolution:n}=this.renderer;this.setTargetElement(t),this.resolution=n,Qo._defaultEventMode=e.eventMode??"passive",Object.assign(this.features,e.eventFeatures??{}),this.rootBoundary.enableGlobalMoveEvents=this.features.globalMove}resolutionChange(e){this.resolution=e}destroy(){this.setTargetElement(null),this.renderer=null,this._currentCursor=null}setCursor(e){e=e||"default";let t=!0;if(globalThis.OffscreenCanvas&&this.domElement instanceof OffscreenCanvas&&(t=!1),this._currentCursor===e)return;this._currentCursor=e;const n=this.cursorStyles[e];if(n)switch(typeof n){case"string":t&&(this.domElement.style.cursor=n);break;case"function":n(e);break;case"object":t&&Object.assign(this.domElement.style,n);break}else t&&typeof e=="string"&&!Object.prototype.hasOwnProperty.call(this.cursorStyles,e)&&(this.domElement.style.cursor=e)}get pointer(){return this._rootPointerEvent}_onPointerDown(e){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;const t=this._normalizeToPointerData(e);this.autoPreventDefault&&t[0].isNormalized&&(e.cancelable||!("cancelable"in e))&&e.preventDefault();for(let n=0,s=t.length;n<s;n++){const i=t[n],o=this._bootstrapEvent(this._rootPointerEvent,i);this.rootBoundary.mapEvent(o)}this.setCursor(this.rootBoundary.cursor)}_onPointerMove(e){if(!this.features.move)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered,Yt.pointerMoved();const t=this._normalizeToPointerData(e);for(let n=0,s=t.length;n<s;n++){const i=this._bootstrapEvent(this._rootPointerEvent,t[n]);this.rootBoundary.mapEvent(i)}this.setCursor(this.rootBoundary.cursor)}_onPointerUp(e){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;let t=e.target;e.composedPath&&e.composedPath().length>0&&(t=e.composedPath()[0]);const n=t!==this.domElement?"outside":"",s=this._normalizeToPointerData(e);for(let i=0,o=s.length;i<o;i++){const a=this._bootstrapEvent(this._rootPointerEvent,s[i]);a.type+=n,this.rootBoundary.mapEvent(a)}this.setCursor(this.rootBoundary.cursor)}_onPointerOverOut(e){if(!this.features.click)return;this.rootBoundary.rootTarget=this.renderer.lastObjectRendered;const t=this._normalizeToPointerData(e);for(let n=0,s=t.length;n<s;n++){const i=this._bootstrapEvent(this._rootPointerEvent,t[n]);this.rootBoundary.mapEvent(i)}this.setCursor(this.rootBoundary.cursor)}onWheel(e){if(!this.features.wheel)return;const t=this.normalizeWheelEvent(e);this.rootBoundary.rootTarget=this.renderer.lastObjectRendered,this.rootBoundary.mapEvent(t)}setTargetElement(e){this._removeEvents(),this.domElement=e,Yt.domElement=e,this._addEvents()}_addEvents(){if(this._eventsAdded||!this.domElement)return;Yt.addTickerListener();const e=this.domElement.style;e&&(globalThis.navigator.msPointerEnabled?(e.msContentZooming="none",e.msTouchAction="none"):this.supportsPointerEvents&&(e.touchAction="none")),this.supportsPointerEvents?(globalThis.document.addEventListener("pointermove",this._onPointerMove,!0),this.domElement.addEventListener("pointerdown",this._onPointerDown,!0),this.domElement.addEventListener("pointerleave",this._onPointerOverOut,!0),this.domElement.addEventListener("pointerover",this._onPointerOverOut,!0),globalThis.addEventListener("pointerup",this._onPointerUp,!0)):(globalThis.document.addEventListener("mousemove",this._onPointerMove,!0),this.domElement.addEventListener("mousedown",this._onPointerDown,!0),this.domElement.addEventListener("mouseout",this._onPointerOverOut,!0),this.domElement.addEventListener("mouseover",this._onPointerOverOut,!0),globalThis.addEventListener("mouseup",this._onPointerUp,!0),this.supportsTouchEvents&&(this.domElement.addEventListener("touchstart",this._onPointerDown,!0),this.domElement.addEventListener("touchend",this._onPointerUp,!0),this.domElement.addEventListener("touchmove",this._onPointerMove,!0))),this.domElement.addEventListener("wheel",this.onWheel,{passive:!0,capture:!0}),this._eventsAdded=!0}_removeEvents(){if(!this._eventsAdded||!this.domElement)return;Yt.removeTickerListener();const e=this.domElement.style;e&&(globalThis.navigator.msPointerEnabled?(e.msContentZooming="",e.msTouchAction=""):this.supportsPointerEvents&&(e.touchAction="")),this.supportsPointerEvents?(globalThis.document.removeEventListener("pointermove",this._onPointerMove,!0),this.domElement.removeEventListener("pointerdown",this._onPointerDown,!0),this.domElement.removeEventListener("pointerleave",this._onPointerOverOut,!0),this.domElement.removeEventListener("pointerover",this._onPointerOverOut,!0),globalThis.removeEventListener("pointerup",this._onPointerUp,!0)):(globalThis.document.removeEventListener("mousemove",this._onPointerMove,!0),this.domElement.removeEventListener("mousedown",this._onPointerDown,!0),this.domElement.removeEventListener("mouseout",this._onPointerOverOut,!0),this.domElement.removeEventListener("mouseover",this._onPointerOverOut,!0),globalThis.removeEventListener("mouseup",this._onPointerUp,!0),this.supportsTouchEvents&&(this.domElement.removeEventListener("touchstart",this._onPointerDown,!0),this.domElement.removeEventListener("touchend",this._onPointerUp,!0),this.domElement.removeEventListener("touchmove",this._onPointerMove,!0))),this.domElement.removeEventListener("wheel",this.onWheel,!0),this.domElement=null,this._eventsAdded=!1}mapPositionToPoint(e,t,n){const s=this.domElement.isConnected?this.domElement.getBoundingClientRect():{x:0,y:0,width:this.domElement.width,height:this.domElement.height,left:0,top:0},i=1/this.resolution;e.x=(t-s.left)*(this.domElement.width/s.width)*i,e.y=(n-s.top)*(this.domElement.height/s.height)*i}_normalizeToPointerData(e){const t=[];if(this.supportsTouchEvents&&e instanceof TouchEvent)for(let n=0,s=e.changedTouches.length;n<s;n++){const i=e.changedTouches[n];typeof i.button>"u"&&(i.button=0),typeof i.buttons>"u"&&(i.buttons=1),typeof i.isPrimary>"u"&&(i.isPrimary=e.touches.length===1&&e.type==="touchstart"),typeof i.width>"u"&&(i.width=i.radiusX||1),typeof i.height>"u"&&(i.height=i.radiusY||1),typeof i.tiltX>"u"&&(i.tiltX=0),typeof i.tiltY>"u"&&(i.tiltY=0),typeof i.pointerType>"u"&&(i.pointerType="touch"),typeof i.pointerId>"u"&&(i.pointerId=i.identifier||0),typeof i.pressure>"u"&&(i.pressure=i.force||.5),typeof i.twist>"u"&&(i.twist=0),typeof i.tangentialPressure>"u"&&(i.tangentialPressure=0),typeof i.layerX>"u"&&(i.layerX=i.offsetX=i.clientX),typeof i.layerY>"u"&&(i.layerY=i.offsetY=i.clientY),i.isNormalized=!0,i.type=e.type,t.push(i)}else if(!globalThis.MouseEvent||e instanceof MouseEvent&&(!this.supportsPointerEvents||!(e instanceof globalThis.PointerEvent))){const n=e;typeof n.isPrimary>"u"&&(n.isPrimary=!0),typeof n.width>"u"&&(n.width=1),typeof n.height>"u"&&(n.height=1),typeof n.tiltX>"u"&&(n.tiltX=0),typeof n.tiltY>"u"&&(n.tiltY=0),typeof n.pointerType>"u"&&(n.pointerType="mouse"),typeof n.pointerId>"u"&&(n.pointerId=Vy),typeof n.pressure>"u"&&(n.pressure=.5),typeof n.twist>"u"&&(n.twist=0),typeof n.tangentialPressure>"u"&&(n.tangentialPressure=0),n.isNormalized=!0,t.push(n)}else t.push(e);return t}normalizeWheelEvent(e){const t=this._rootWheelEvent;return this._transferMouseData(t,e),t.deltaX=e.deltaX,t.deltaY=e.deltaY,t.deltaZ=e.deltaZ,t.deltaMode=e.deltaMode,this.mapPositionToPoint(t.screen,e.clientX,e.clientY),t.global.copyFrom(t.screen),t.offset.copyFrom(t.screen),t.nativeEvent=e,t.type=e.type,t}_bootstrapEvent(e,t){return e.originalEvent=null,e.nativeEvent=t,e.pointerId=t.pointerId,e.width=t.width,e.height=t.height,e.isPrimary=t.isPrimary,e.pointerType=t.pointerType,e.pressure=t.pressure,e.tangentialPressure=t.tangentialPressure,e.tiltX=t.tiltX,e.tiltY=t.tiltY,e.twist=t.twist,this._transferMouseData(e,t),this.mapPositionToPoint(e.screen,t.clientX,t.clientY),e.global.copyFrom(e.screen),e.offset.copyFrom(e.screen),e.isTrusted=t.isTrusted,e.type==="pointerleave"&&(e.type="pointerout"),e.type.startsWith("mouse")&&(e.type=e.type.replace("mouse","pointer")),e.type.startsWith("touch")&&(e.type=Xy[e.type]||e.type),e}_transferMouseData(e,t){e.isTrusted=t.isTrusted,e.srcElement=t.srcElement,e.timeStamp=performance.now(),e.type=t.type,e.altKey=t.altKey,e.button=t.button,e.buttons=t.buttons,e.client.x=t.clientX,e.client.y=t.clientY,e.ctrlKey=t.ctrlKey,e.metaKey=t.metaKey,e.movement.x=t.movementX,e.movement.y=t.movementY,e.page.x=t.pageX,e.page.y=t.pageY,e.relatedTarget=null,e.shiftKey=t.shiftKey}};oo.extension={name:"events",type:[M.WebGLSystem,M.CanvasSystem,M.WebGPUSystem],priority:-1},oo.defaultEventFeatures={move:!0,globalMove:!0,click:!0,wheel:!0};let jc=oo;const Yy={onclick:null,onmousedown:null,onmouseenter:null,onmouseleave:null,onmousemove:null,onglobalmousemove:null,onmouseout:null,onmouseover:null,onmouseup:null,onmouseupoutside:null,onpointercancel:null,onpointerdown:null,onpointerenter:null,onpointerleave:null,onpointermove:null,onglobalpointermove:null,onpointerout:null,onpointerover:null,onpointertap:null,onpointerup:null,onpointerupoutside:null,onrightclick:null,onrightdown:null,onrightup:null,onrightupoutside:null,ontap:null,ontouchcancel:null,ontouchend:null,ontouchendoutside:null,ontouchmove:null,onglobaltouchmove:null,ontouchstart:null,onwheel:null,get interactive(){return this.eventMode==="dynamic"||this.eventMode==="static"},set interactive(r){this.eventMode=r?"static":"passive"},_internalEventMode:void 0,get eventMode(){return this._internalEventMode??jc.defaultEventMode},set eventMode(r){this._internalEventMode=r},isInteractive(){return this.eventMode==="static"||this.eventMode==="dynamic"},interactiveChildren:!0,hitArea:null,addEventListener(r,e,t){const n=typeof t=="boolean"&&t||typeof t=="object"&&t.capture,s=typeof t=="object"?t.signal:void 0,i=typeof t=="object"?t.once===!0:!1,o=typeof e=="function"?void 0:e;r=n?`${r}capture`:r;const a=typeof e=="function"?e:e.handleEvent,l=this;s&&s.addEventListener("abort",()=>{l.off(r,a,o)}),i?l.once(r,a,o):l.on(r,a,o)},removeEventListener(r,e,t){const n=typeof t=="boolean"&&t||typeof t=="object"&&t.capture,s=typeof e=="function"?void 0:e;r=n?`${r}capture`:r,e=typeof e=="function"?e:e.handleEvent,this.off(r,e,s)},dispatchEvent(r){if(!(r instanceof rn))throw new Error("Container cannot propagate events outside of the Federated Events API");return r.defaultPrevented=!1,r.path=null,r.target=this,r.manager.dispatchEvent(r),!r.defaultPrevented}};let jy=0;class qy{constructor(e){this._poolKeyHash=Object.create(null),this._texturePool={},this.textureOptions=e||{},this.enableFullScreen=!1}createTexture(e,t,n){const s=new Ie({...this.textureOptions,width:e,height:t,resolution:1,antialias:n,autoGarbageCollect:!0});return new $({source:s,label:`texturePool_${jy++}`})}getOptimalTexture(e,t,n=1,s){let i=Math.ceil(e*n-1e-6),o=Math.ceil(t*n-1e-6);i=Mr(i),o=Mr(o);const a=(i<<17)+(o<<1)+(s?1:0);this._texturePool[a]||(this._texturePool[a]=[]);let l=this._texturePool[a].pop();return l||(l=this.createTexture(i,o,s)),l.source._resolution=n,l.source.width=i/n,l.source.height=o/n,l.source.pixelWidth=i,l.source.pixelHeight=o,l.frame.x=0,l.frame.y=0,l.frame.width=e,l.frame.height=t,l.updateUvs(),this._poolKeyHash[l.uid]=a,l}getSameSizeTexture(e,t=!1){const n=e.source;return this.getOptimalTexture(e.width,e.height,n._resolution,t)}returnTexture(e){const t=this._poolKeyHash[e.uid];this._texturePool[t].push(e)}clear(e){if(e=e!==!1,e)for(const t in this._texturePool){const n=this._texturePool[t];if(n)for(let s=0;s<n.length;s++)n[s].destroy(!0)}this._texturePool={}}}const at=new qy;class qc{constructor(e){this._renderer=e}push(e,t,n){this._renderer.renderPipes.batch.break(n),n.add({renderPipeId:"filter",canBundle:!1,action:"pushFilter",container:t,filterEffect:e})}pop(e,t,n){this._renderer.renderPipes.batch.break(n),n.add({renderPipeId:"filter",action:"popFilter",canBundle:!1})}execute(e){e.action==="pushFilter"?this._renderer.filter.push(e):e.action==="popFilter"&&this._renderer.filter.pop()}destroy(){this._renderer=null}}qc.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"filter"};const Ky=new W;function Zy(r,e){return e.clear(),Kc(r,e),e.isValid||e.set(0,0,0,0),r.isRenderGroupRoot?e.applyMatrix(r.renderGroup.localTransform):e.applyMatrix(r.renderGroup.worldTransform),e}function Kc(r,e){if(r.localDisplayStatus!==7||!r.measurable)return;const t=!!r.effects.length;let n=e;if((r.isRenderGroupRoot||t)&&(n=Ut.get().clear()),r.boundsArea)e.addRect(r.boundsArea,r.worldTransform);else{if(r.renderPipeId){const i=r.bounds;n.addFrame(i.minX,i.minY,i.maxX,i.maxY,r.groupTransform)}const s=r.children;for(let i=0;i<s.length;i++)Kc(s[i],n)}if(t){let s=!1;for(let i=0;i<r.effects.length;i++)r.effects[i].addBounds&&(s||(s=!0,n.applyMatrix(r.renderGroup.worldTransform)),r.effects[i].addBounds(n,!0));s&&(n.applyMatrix(r.renderGroup.worldTransform.copyTo(Ky).invert()),e.addBounds(n,r.relativeGroupTransform)),e.addBounds(n),Ut.return(n)}else r.isRenderGroupRoot&&(e.addBounds(n,r.relativeGroupTransform),Ut.return(n))}function Qy(r,e){e.clear();const t=e.matrix;for(let n=0;n<r.length;n++){const s=r[n];s.globalDisplayStatus<7||(e.matrix=s.worldTransform,s.addBounds(e))}return e.matrix=t,e}const Jy=new us({attributes:{aPosition:{buffer:new Float32Array([0,0,1,0,1,1,0,1]),location:0,format:"float32x2",stride:2*4,offset:0}},indexBuffer:new Uint32Array([0,1,2,0,2,3])});class Zc{constructor(e){this._filterStackIndex=0,this._filterStack=[],this._filterGlobalUniforms=new Qe({uInputSize:{value:new Float32Array(4),type:"vec4<f32>"},uInputPixel:{value:new Float32Array(4),type:"vec4<f32>"},uInputClamp:{value:new Float32Array(4),type:"vec4<f32>"},uOutputFrame:{value:new Float32Array(4),type:"vec4<f32>"},uGlobalFrame:{value:new Float32Array(4),type:"vec4<f32>"},uOutputTexture:{value:new Float32Array(4),type:"vec4<f32>"}}),this._globalFilterBindGroup=new Ot({}),this.renderer=e}get activeBackTexture(){var e;return(e=this._activeFilterData)==null?void 0:e.backTexture}push(e){var f;const t=this.renderer,n=e.filterEffect.filters;this._filterStack[this._filterStackIndex]||(this._filterStack[this._filterStackIndex]=this._getFilterData());const s=this._filterStack[this._filterStackIndex];if(this._filterStackIndex++,n.length===0){s.skip=!0;return}const i=s.bounds;e.renderables?Qy(e.renderables,i):e.filterEffect.filterArea?(i.clear(),i.addRect(e.filterEffect.filterArea),i.applyMatrix(e.container.worldTransform)):Zy(e.container,i);const o=t.renderTarget.rootRenderTarget.colorTexture.source;let a=o._resolution,l=0,c=o.antialias,h=!1,u=!1;for(let p=0;p<n.length;p++){const g=n[p];if(a=Math.min(a,g.resolution),l+=g.padding,g.antialias!=="inherit"&&(g.antialias==="on"?c=!0:c=!1),!!!(g.compatibleRenderers&t.type)){u=!1;break}if(g.blendRequired&&!(((f=t.backBuffer)==null?void 0:f.useBackBuffer)??!0)){ne("Blend filter requires backBuffer on WebGL renderer to be enabled. Set `useBackBuffer: true` in the renderer options."),u=!1;break}u=g.enabled||u,h=h||g.blendRequired}if(!u){s.skip=!0;return}const d=t.renderTarget.rootViewPort;if(i.scale(a).fitBounds(0,d.width,0,d.height).scale(1/a).pad(l).ceil(),!i.isPositive){s.skip=!0;return}s.skip=!1,s.bounds=i,s.blendRequired=h,s.container=e.container,s.filterEffect=e.filterEffect,s.previousRenderSurface=t.renderTarget.renderSurface,s.inputTexture=at.getOptimalTexture(i.width,i.height,a,c),t.renderTarget.bind(s.inputTexture,!0),t.globalUniforms.push({offset:i})}pop(){const e=this.renderer;this._filterStackIndex--;const t=this._filterStack[this._filterStackIndex];if(t.skip)return;this._activeFilterData=t;const n=t.inputTexture,s=t.bounds;let i=$.EMPTY;if(e.renderTarget.finishRenderPass(),t.blendRequired){const a=this._filterStackIndex>0?this._filterStack[this._filterStackIndex-1].bounds:null,l=e.renderTarget.getRenderTarget(t.previousRenderSurface);i=this.getBackTexture(l,s,a)}t.backTexture=i;const o=t.filterEffect.filters;if(this._globalFilterBindGroup.setResource(n.source.style,2),this._globalFilterBindGroup.setResource(i.source,3),e.globalUniforms.pop(),o.length===1)o[0].apply(this,n,t.previousRenderSurface,!1),at.returnTexture(n);else{let a=t.inputTexture,l=at.getOptimalTexture(s.width,s.height,a.source._resolution,!1),c=0;for(c=0;c<o.length-1;++c){o[c].apply(this,a,l,!0);const u=a;a=l,l=u}o[c].apply(this,a,t.previousRenderSurface,!1),at.returnTexture(a),at.returnTexture(l)}t.blendRequired&&at.returnTexture(i)}getBackTexture(e,t,n){const s=e.colorTexture.source._resolution,i=at.getOptimalTexture(t.width,t.height,s,!1);let o=t.minX,a=t.minY;n&&(o-=n.minX,a-=n.minY),o=Math.floor(o*s),a=Math.floor(a*s);const l=Math.ceil(t.width*s),c=Math.ceil(t.height*s);return this.renderer.renderTarget.copyToTexture(e,i,{x:o,y:a},{width:l,height:c},{x:0,y:0}),i}applyFilter(e,t,n,s){const i=this.renderer,o=this._filterStack[this._filterStackIndex],a=o.bounds,l=ce.shared,h=o.previousRenderSurface===n;let u=this.renderer.renderTarget.rootRenderTarget.colorTexture.source._resolution,d=this._filterStackIndex-1;for(;d>0&&this._filterStack[d].skip;)--d;d>0&&(u=this._filterStack[d].inputTexture.source._resolution);const f=this._filterGlobalUniforms,p=f.uniforms,g=p.uOutputFrame,m=p.uInputSize,_=p.uInputPixel,b=p.uInputClamp,y=p.uGlobalFrame,x=p.uOutputTexture;if(h){let P=this._filterStackIndex;for(;P>0;){P--;const T=this._filterStack[this._filterStackIndex-1];if(!T.skip){l.x=T.bounds.minX,l.y=T.bounds.minY;break}}g[0]=a.minX-l.x,g[1]=a.minY-l.y}else g[0]=0,g[1]=0;g[2]=t.frame.width,g[3]=t.frame.height,m[0]=t.source.width,m[1]=t.source.height,m[2]=1/m[0],m[3]=1/m[1],_[0]=t.source.pixelWidth,_[1]=t.source.pixelHeight,_[2]=1/_[0],_[3]=1/_[1],b[0]=.5*_[2],b[1]=.5*_[3],b[2]=t.frame.width*m[2]-.5*_[2],b[3]=t.frame.height*m[3]-.5*_[3];const S=this.renderer.renderTarget.rootRenderTarget.colorTexture;y[0]=l.x*u,y[1]=l.y*u,y[2]=S.source.width*u,y[3]=S.source.height*u;const k=this.renderer.renderTarget.getRenderTarget(n);if(i.renderTarget.bind(n,!!s),n instanceof $?(x[0]=n.frame.width,x[1]=n.frame.height):(x[0]=k.width,x[1]=k.height),x[2]=k.isRoot?-1:1,f.update(),i.renderPipes.uniformBatch){const P=i.renderPipes.uniformBatch.getUboResource(f);this._globalFilterBindGroup.setResource(P,0)}else this._globalFilterBindGroup.setResource(f,0);this._globalFilterBindGroup.setResource(t.source,1),this._globalFilterBindGroup.setResource(t.source.style,2),e.groups[0]=this._globalFilterBindGroup,i.encoder.draw({geometry:Jy,shader:e,state:e._state,topology:"triangle-list"}),i.type===Et.WEBGL&&i.renderTarget.finishRenderPass()}_getFilterData(){return{skip:!1,inputTexture:null,bounds:new Ze,container:null,filterEffect:null,blendRequired:!1,previousRenderSurface:null}}calculateSpriteMatrix(e,t){const n=this._activeFilterData,s=e.set(n.inputTexture._source.width,0,0,n.inputTexture._source.height,n.bounds.minX,n.bounds.minY),i=t.worldTransform.copyTo(W.shared);return i.invert(),s.prepend(i),s.scale(1/t.texture.frame.width,1/t.texture.frame.height),s.translate(t.anchor.x,t.anchor.y),s}}Zc.extension={type:[M.WebGLSystem,M.WebGPUSystem],name:"filter"};var eb=`in vec2 vMaskCoord;
in vec2 vTextureCoord;

uniform sampler2D uTexture;
uniform sampler2D uMaskTexture;

uniform float uAlpha;
uniform vec4 uMaskClamp;

out vec4 finalColor;

void main(void)
{
    float clip = step(3.5,
        step(uMaskClamp.x, vMaskCoord.x) +
        step(uMaskClamp.y, vMaskCoord.y) +
        step(vMaskCoord.x, uMaskClamp.z) +
        step(vMaskCoord.y, uMaskClamp.w));

    // TODO look into why this is needed
    float npmAlpha = uAlpha; 
    vec4 original = texture(uTexture, vTextureCoord);
    vec4 masky = texture(uMaskTexture, vMaskCoord);
    float alphaMul = 1.0 - npmAlpha * (1.0 - masky.a);

    original *= (alphaMul * masky.r * uAlpha * clip);

    finalColor = original;
}
`,tb=`in vec2 aPosition;

out vec2 vTextureCoord;
out vec2 vMaskCoord;


uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;
uniform mat3 uFilterMatrix;

vec4 filterVertexPosition(  vec2 aPosition )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
       
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord(  vec2 aPosition )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

vec2 getFilterCoord( vec2 aPosition )
{
    return  ( uFilterMatrix * vec3( filterTextureCoord(aPosition), 1.0)  ).xy;
}   

void main(void)
{
    gl_Position = filterVertexPosition(aPosition);
    vTextureCoord = filterTextureCoord(aPosition);
    vMaskCoord = getFilterCoord(aPosition);
}
`,Qc=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,  
};

struct MaskUniforms {
  uFilterMatrix:mat3x3<f32>,
  uMaskClamp:vec4<f32>,
  uAlpha:f32,
};


@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> filterUniforms : MaskUniforms;
@group(1) @binding(1) var uMaskTexture: texture_2d<f32>;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>,
    @location(1) filterUv : vec2<f32>,
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getFilterCoord(aPosition:vec2<f32> ) -> vec2<f32>
{
  return ( filterUniforms.uFilterMatrix * vec3( filterTextureCoord(aPosition), 1.0)  ).xy;
}

fn getSize() -> vec2<f32>
{

  
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition),
   getFilterCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @location(1) filterUv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {

    var maskClamp = filterUniforms.uMaskClamp;

     var clip = step(3.5,
        step(maskClamp.x, filterUv.x) +
        step(maskClamp.y, filterUv.y) +
        step(filterUv.x, maskClamp.z) +
        step(filterUv.y, maskClamp.w));

    var mask = textureSample(uMaskTexture, uSampler, filterUv);
    var source = textureSample(uTexture, uSampler, uv);
    
    var npmAlpha = 0.0;

    var alphaMul = 1.0 - npmAlpha * (1.0 - mask.a);

    var a = (alphaMul * mask.r) * clip;

    return vec4(source.rgb, source.a) * a;
}`;class rb extends P_{constructor(e){const{sprite:t,...n}=e,s=new _l(t.texture),i=new Qe({uFilterMatrix:{value:new W,type:"mat3x3<f32>"},uMaskClamp:{value:s.uClampFrame,type:"vec4<f32>"},uAlpha:{value:1,type:"f32"}}),o=Ur.from({vertex:{source:Qc,entryPoint:"mainVertex"},fragment:{source:Qc,entryPoint:"mainFragment"}}),a=nn.from({vertex:tb,fragment:eb,name:"mask-filter"});super({...n,gpuProgram:o,glProgram:a,resources:{filterUniforms:i,uMaskTexture:t.texture.source}}),this.sprite=t,this._textureMatrix=s}apply(e,t,n,s){this._textureMatrix.texture=this.sprite.texture,e.calculateSpriteMatrix(this.resources.filterUniforms.uniforms.uFilterMatrix,this.sprite).prepend(this._textureMatrix.mapCoord),this.resources.uMaskTexture=this.sprite.texture.source,e.applyFilter(this,t,n,s)}}class Lr extends Se{constructor(e){e instanceof ar&&(e={context:e});const{context:t,roundPixels:n,...s}=e||{};super({label:"Graphics",...s}),this.canBundle=!0,this.renderPipeId="graphics",this._roundPixels=0,t?this._context=t:this._context=this._ownedContext=new ar,this._context.on("update",this.onViewUpdate,this),this.allowChildren=!1,this.roundPixels=n??!1}set context(e){e!==this._context&&(this._context.off("update",this.onViewUpdate,this),this._context=e,this._context.on("update",this.onViewUpdate,this),this.onViewUpdate())}get context(){return this._context}get bounds(){return this._context.bounds}addBounds(e){e.addBounds(this._context.bounds)}containsPoint(e){return this._context.containsPoint(e)}get roundPixels(){return!!this._roundPixels}set roundPixels(e){this._roundPixels=e?1:0}onViewUpdate(){this._didChangeId+=4096,this._didGraphicsUpdate=!0,!this.didViewUpdate&&(this.didViewUpdate=!0,this.renderGroup&&this.renderGroup.onChildViewUpdate(this))}destroy(e){this._ownedContext&&!e?this._ownedContext.destroy(e):(e===!0||(e==null?void 0:e.context)===!0)&&this._context.destroy(e),this._ownedContext=null,this._context=null,super.destroy(e)}_callContextMethod(e,t){return this.context[e](...t),this}setFillStyle(...e){return this._callContextMethod("setFillStyle",e)}setStrokeStyle(...e){return this._callContextMethod("setStrokeStyle",e)}fill(...e){return this._callContextMethod("fill",e)}stroke(...e){return this._callContextMethod("stroke",e)}texture(...e){return this._callContextMethod("texture",e)}beginPath(){return this._callContextMethod("beginPath",[])}cut(){return this._callContextMethod("cut",[])}arc(...e){return this._callContextMethod("arc",e)}arcTo(...e){return this._callContextMethod("arcTo",e)}arcToSvg(...e){return this._callContextMethod("arcToSvg",e)}bezierCurveTo(...e){return this._callContextMethod("bezierCurveTo",e)}closePath(){return this._callContextMethod("closePath",[])}ellipse(...e){return this._callContextMethod("ellipse",e)}circle(...e){return this._callContextMethod("circle",e)}path(...e){return this._callContextMethod("path",e)}lineTo(...e){return this._callContextMethod("lineTo",e)}moveTo(...e){return this._callContextMethod("moveTo",e)}quadraticCurveTo(...e){return this._callContextMethod("quadraticCurveTo",e)}rect(...e){return this._callContextMethod("rect",e)}roundRect(...e){return this._callContextMethod("roundRect",e)}poly(...e){return this._callContextMethod("poly",e)}regularPoly(...e){return this._callContextMethod("regularPoly",e)}roundPoly(...e){return this._callContextMethod("roundPoly",e)}roundShape(...e){return this._callContextMethod("roundShape",e)}filletRect(...e){return this._callContextMethod("filletRect",e)}chamferRect(...e){return this._callContextMethod("chamferRect",e)}star(...e){return this._callContextMethod("star",e)}svg(...e){return this._callContextMethod("svg",e)}restore(...e){return this._callContextMethod("restore",e)}save(){return this._callContextMethod("save",[])}getTransform(){return this.context.getTransform()}resetTransform(){return this._callContextMethod("resetTransform",[])}rotateTransform(...e){return this._callContextMethod("rotate",e)}scaleTransform(...e){return this._callContextMethod("scale",e)}setTransform(...e){return this._callContextMethod("setTransform",e)}transform(...e){return this._callContextMethod("transform",e)}translateTransform(...e){return this._callContextMethod("translate",e)}clear(){return this._callContextMethod("clear",[])}get fillStyle(){return this._context.fillStyle}set fillStyle(e){this._context.fillStyle=e}get strokeStyle(){return this._context.strokeStyle}set strokeStyle(e){this._context.strokeStyle=e}clone(e=!1){return e?new Lr(this._context.clone()):(this._ownedContext=null,new Lr(this._context))}lineStyle(e,t,n){ie(le,"Graphics#lineStyle is no longer needed. Use Graphics#setStrokeStyle to set the stroke style.");const s={};return e&&(s.width=e),t&&(s.color=t),n&&(s.alpha=n),this.context.strokeStyle=s,this}beginFill(e,t){ie(le,"Graphics#beginFill is no longer needed. Use Graphics#fill to fill the shape with the desired style.");const n={};return e&&(n.color=e),t&&(n.alpha=t),this.context.fillStyle=n,this}endFill(){ie(le,"Graphics#endFill is no longer needed. Use Graphics#fill to fill the shape with the desired style."),this.context.fill();const e=this.context.strokeStyle;return(e.width!==ar.defaultStrokeStyle.width||e.color!==ar.defaultStrokeStyle.color||e.alpha!==ar.defaultStrokeStyle.alpha)&&this.context.stroke(),this}drawCircle(...e){return ie(le,"Graphics#drawCircle has been renamed to Graphics#circle"),this._callContextMethod("circle",e)}drawEllipse(...e){return ie(le,"Graphics#drawEllipse has been renamed to Graphics#ellipse"),this._callContextMethod("ellipse",e)}drawPolygon(...e){return ie(le,"Graphics#drawPolygon has been renamed to Graphics#poly"),this._callContextMethod("poly",e)}drawRect(...e){return ie(le,"Graphics#drawRect has been renamed to Graphics#rect"),this._callContextMethod("rect",e)}drawRoundedRect(...e){return ie(le,"Graphics#drawRoundedRect has been renamed to Graphics#roundRect"),this._callContextMethod("roundRect",e)}drawStar(...e){return ie(le,"Graphics#drawStar has been renamed to Graphics#star"),this._callContextMethod("star",e)}}const Jc=class zd extends us{constructor(...e){let t=e[0]??{};t instanceof Float32Array&&(ie(le,"use new MeshGeometry({ positions, uvs, indices }) instead"),t={positions:t,uvs:e[1],indices:e[2]}),t={...zd.defaultOptions,...t};const n=t.positions||new Float32Array([0,0,1,0,1,1,0,1]),s=t.uvs||new Float32Array([0,0,1,0,1,1,0,1]),i=t.indices||new Uint32Array([0,1,2,0,2,3]),o=t.shrinkBuffersToFit,a=new pt({data:n,label:"attribute-mesh-positions",shrinkToFit:o,usage:ae.VERTEX|ae.COPY_DST}),l=new pt({data:s,label:"attribute-mesh-uvs",shrinkToFit:o,usage:ae.VERTEX|ae.COPY_DST}),c=new pt({data:i,label:"index-mesh-buffer",shrinkToFit:o,usage:ae.INDEX|ae.COPY_DST});super({attributes:{aPosition:{buffer:a,format:"float32x2",stride:2*4,offset:0},aUV:{buffer:l,format:"float32x2",stride:2*4,offset:0}},indexBuffer:c,topology:t.topology}),this.batchMode="auto"}get positions(){return this.attributes.aPosition.buffer.data}set positions(e){this.attributes.aPosition.buffer.data=e}get uvs(){return this.attributes.aUV.buffer.data}set uvs(e){this.attributes.aUV.buffer.data=e}get indices(){return this.indexBuffer.data}set indices(e){this.indexBuffer.data=e}};Jc.defaultOptions={topology:"triangle-list",shrinkBuffersToFit:!1};let ao=Jc;const nb=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function ps(r){const e=typeof r.fontSize=="number"?`${r.fontSize}px`:r.fontSize;let t=r.fontFamily;Array.isArray(r.fontFamily)||(t=r.fontFamily.split(","));for(let n=t.length-1;n>=0;n--){let s=t[n].trim();!/([\"\'])[^\'\"]+\1/.test(s)&&!nb.includes(s)&&(s=`"${s}"`),t[n]=s}return`${r.fontStyle} ${r.fontVariant} ${r.fontWeight} ${e} ${t.join(",")}`}const lo={willReadFrequently:!0},_t=class z{static get experimentalLetterSpacingSupported(){let e=z._experimentalLetterSpacingSupported;if(e!==void 0){const t=xe.get().getCanvasRenderingContext2D().prototype;e=z._experimentalLetterSpacingSupported="letterSpacing"in t||"textLetterSpacing"in t}return e}constructor(e,t,n,s,i,o,a,l,c){this.text=e,this.style=t,this.width=n,this.height=s,this.lines=i,this.lineWidths=o,this.lineHeight=a,this.maxLineWidth=l,this.fontProperties=c}static measureText(e=" ",t,n=z._canvas,s=t.wordWrap){var b;const i=`${e}:${t.styleKey}`;if(z._measurementCache[i])return z._measurementCache[i];const o=ps(t),a=z.measureFont(o);a.fontSize===0&&(a.fontSize=t.fontSize,a.ascent=t.fontSize);const l=z.__context;l.font=o;const h=(s?z._wordWrap(e,t,n):e).split(/(?:\r\n|\r|\n)/),u=new Array(h.length);let d=0;for(let y=0;y<h.length;y++){const x=z._measureText(h[y],t.letterSpacing,l);u[y]=x,d=Math.max(d,x)}const f=((b=t._stroke)==null?void 0:b.width)||0;let p=d+f;t.dropShadow&&(p+=t.dropShadow.distance);const g=t.lineHeight||a.fontSize+f;let m=Math.max(g,a.fontSize+f*2)+(h.length-1)*(g+t.leading);return t.dropShadow&&(m+=t.dropShadow.distance),new z(e,t,p,m,h,u,g+t.leading,d,a)}static _measureText(e,t,n){let s=!1;z.experimentalLetterSpacingSupported&&(z.experimentalLetterSpacing?(n.letterSpacing=`${t}px`,n.textLetterSpacing=`${t}px`,s=!0):(n.letterSpacing="0px",n.textLetterSpacing="0px"));let i=n.measureText(e).width;return i>0&&(s?i-=t:i+=(z.graphemeSegmenter(e).length-1)*t),i}static _wordWrap(e,t,n=z._canvas){const s=n.getContext("2d",lo);let i=0,o="",a="";const l=Object.create(null),{letterSpacing:c,whiteSpace:h}=t,u=z._collapseSpaces(h),d=z._collapseNewlines(h);let f=!u;const p=t.wordWrapWidth+c,g=z._tokenize(e);for(let m=0;m<g.length;m++){let _=g[m];if(z._isNewline(_)){if(!d){a+=z._addLine(o),f=!u,o="",i=0;continue}_=" "}if(u){const y=z.isBreakingSpace(_),x=z.isBreakingSpace(o[o.length-1]);if(y&&x)continue}const b=z._getFromCache(_,c,l,s);if(b>p)if(o!==""&&(a+=z._addLine(o),o="",i=0),z.canBreakWords(_,t.breakWords)){const y=z.wordWrapSplit(_);for(let x=0;x<y.length;x++){let S=y[x],k=S,P=1;for(;y[x+P];){const E=y[x+P];if(!z.canBreakChars(k,E,_,x,t.breakWords))S+=E;else break;k=E,P++}x+=P-1;const T=z._getFromCache(S,c,l,s);T+i>p&&(a+=z._addLine(o),f=!1,o="",i=0),o+=S,i+=T}}else{o.length>0&&(a+=z._addLine(o),o="",i=0);const y=m===g.length-1;a+=z._addLine(_,!y),f=!1,o="",i=0}else b+i>p&&(f=!1,a+=z._addLine(o),o="",i=0),(o.length>0||!z.isBreakingSpace(_)||f)&&(o+=_,i+=b)}return a+=z._addLine(o,!1),a}static _addLine(e,t=!0){return e=z._trimRight(e),e=t?`${e}
`:e,e}static _getFromCache(e,t,n,s){let i=n[e];return typeof i!="number"&&(i=z._measureText(e,t,s)+t,n[e]=i),i}static _collapseSpaces(e){return e==="normal"||e==="pre-line"}static _collapseNewlines(e){return e==="normal"}static _trimRight(e){if(typeof e!="string")return"";for(let t=e.length-1;t>=0;t--){const n=e[t];if(!z.isBreakingSpace(n))break;e=e.slice(0,-1)}return e}static _isNewline(e){return typeof e!="string"?!1:z._newlines.includes(e.charCodeAt(0))}static isBreakingSpace(e,t){return typeof e!="string"?!1:z._breakingSpaces.includes(e.charCodeAt(0))}static _tokenize(e){const t=[];let n="";if(typeof e!="string")return t;for(let s=0;s<e.length;s++){const i=e[s],o=e[s+1];if(z.isBreakingSpace(i,o)||z._isNewline(i)){n!==""&&(t.push(n),n=""),t.push(i);continue}n+=i}return n!==""&&t.push(n),t}static canBreakWords(e,t){return t}static canBreakChars(e,t,n,s,i){return!0}static wordWrapSplit(e){return z.graphemeSegmenter(e)}static measureFont(e){if(z._fonts[e])return z._fonts[e];const t=z._context;t.font=e;const n=t.measureText(z.METRICS_STRING+z.BASELINE_SYMBOL),s={ascent:n.actualBoundingBoxAscent,descent:n.actualBoundingBoxDescent,fontSize:n.actualBoundingBoxAscent+n.actualBoundingBoxDescent};return z._fonts[e]=s,s}static clearMetrics(e=""){e?delete z._fonts[e]:z._fonts={}}static get _canvas(){if(!z.__canvas){let e;try{const t=new OffscreenCanvas(0,0),n=t.getContext("2d",lo);if(n!=null&&n.measureText)return z.__canvas=t,t;e=xe.get().createCanvas()}catch{e=xe.get().createCanvas()}e.width=e.height=10,z.__canvas=e}return z.__canvas}static get _context(){return z.__context||(z.__context=z._canvas.getContext("2d",lo)),z.__context}};_t.METRICS_STRING="|ÉqÅ",_t.BASELINE_SYMBOL="M",_t.BASELINE_MULTIPLIER=1.4,_t.HEIGHT_MULTIPLIER=2,_t.graphemeSegmenter=(()=>{if(typeof(Intl==null?void 0:Intl.Segmenter)=="function"){const r=new Intl.Segmenter;return e=>[...r.segment(e)].map(t=>t.segment)}return r=>[...r]})(),_t.experimentalLetterSpacing=!1,_t._fonts={},_t._newlines=[10,13],_t._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288],_t._measurementCache={};let Lt=_t;const eh=["_fontFamily","_fontStyle","_fontSize","_fontVariant","_fontWeight","_breakWords","_align","_leading","_letterSpacing","_lineHeight","_textBaseline","_whiteSpace","_wordWrap","_wordWrapWidth","_padding","_cssOverrides","_trim"];function th(r){const e=[];let t=0;for(let n=0;n<eh.length;n++){const s=eh[n];e[t++]=r[s]}return t=rh(r._fill,e,t),t=sb(r._stroke,e,t),e.join("-")}function rh(r,e,t){var n;return r&&(e[t++]=r.color,e[t++]=r.alpha,e[t++]=(n=r.fill)==null?void 0:n.uid),t}function sb(r,e,t){return r&&(t=rh(r,e,t),e[t++]=r.width,e[t++]=r.alignment,e[t++]=r.cap,e[t++]=r.join,e[t++]=r.miterLimit),t}const co=class $r extends Ke{constructor(e={}){super(),ib(e);const t={...$r.defaultTextStyle,...e};for(const n in t){const s=n;this[s]=t[n]}this.update()}get align(){return this._align}set align(e){this._align=e,this.update()}get breakWords(){return this._breakWords}set breakWords(e){this._breakWords=e,this.update()}get dropShadow(){return this._dropShadow}set dropShadow(e){e!==null&&typeof e=="object"?this._dropShadow={...$r.defaultDropShadow,...e}:this._dropShadow=e?{...$r.defaultDropShadow}:null,this.update()}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily=e,this.update()}get fontSize(){return this._fontSize}set fontSize(e){typeof e=="string"?this._fontSize=parseInt(e,10):this._fontSize=e,this.update()}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle=e,this.update()}get fontVariant(){return this._fontVariant}set fontVariant(e){this._fontVariant=e,this.update()}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight=e,this.update()}get leading(){return this._leading}set leading(e){this._leading=e,this.update()}get letterSpacing(){return this._letterSpacing}set letterSpacing(e){this._letterSpacing=e,this.update()}get lineHeight(){return this._lineHeight}set lineHeight(e){this._lineHeight=e,this.update()}get padding(){return this._padding}set padding(e){this._padding=e,this.update()}get trim(){return this._trim}set trim(e){this._trim=e,this.update()}get textBaseline(){return this._textBaseline}set textBaseline(e){this._textBaseline=e,this.update()}get whiteSpace(){return this._whiteSpace}set whiteSpace(e){this._whiteSpace=e,this.update()}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap=e,this.update()}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(e){this._wordWrapWidth=e,this.update()}get fill(){return this._originalFill}set fill(e){e!==this._originalFill&&(this._originalFill=e,this._fill=Xt(e===0?"black":e,ar.defaultFillStyle),this.update())}get stroke(){return this._originalStroke}set stroke(e){e!==this._originalStroke&&(this._originalStroke=e,this._stroke=Xt(e,ar.defaultStrokeStyle),this.update())}_generateKey(){return this._styleKey=th(this),this._styleKey}update(){this._styleKey=null,this.emit("update",this)}reset(){const e=$r.defaultTextStyle;for(const t in e)this[t]=e[t]}get styleKey(){return this._styleKey||this._generateKey()}clone(){return new $r({align:this.align,breakWords:this.breakWords,dropShadow:this.dropShadow,fill:this._fill,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,leading:this.leading,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke,textBaseline:this.textBaseline,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth})}destroy(e=!1){var n,s,i,o;if(this.removeAllListeners(),typeof e=="boolean"?e:e==null?void 0:e.texture){const a=typeof e=="boolean"?e:e==null?void 0:e.textureSource;(n=this._fill)!=null&&n.texture&&this._fill.texture.destroy(a),(s=this._originalFill)!=null&&s.texture&&this._originalFill.texture.destroy(a),(i=this._stroke)!=null&&i.texture&&this._stroke.texture.destroy(a),(o=this._originalStroke)!=null&&o.texture&&this._originalStroke.texture.destroy(a)}this._fill=null,this._stroke=null,this.dropShadow=null,this._originalStroke=null,this._originalFill=null}};co.defaultDropShadow={alpha:1,angle:Math.PI/6,blur:0,color:"black",distance:5},co.defaultTextStyle={align:"left",breakWords:!1,dropShadow:null,fill:"black",fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,padding:0,stroke:null,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let Nr=co;function ib(r){const e=r;if(typeof e.dropShadow=="boolean"&&e.dropShadow){const t=Nr.defaultDropShadow;r.dropShadow={alpha:e.dropShadowAlpha??t.alpha,angle:e.dropShadowAngle??t.angle,blur:e.dropShadowBlur??t.blur,color:e.dropShadowColor??t.color,distance:e.dropShadowDistance??t.distance}}if(e.strokeThickness!==void 0){ie(le,"strokeThickness is now a part of stroke");const t=e.stroke;r.stroke={color:t,width:e.strokeThickness}}if(Array.isArray(e.fill)){ie(le,"gradient fill is now a fill pattern: `new FillGradient(...)`");const t=new so(0,0,0,r.fontSize*1.7),n=e.fill.map(s=>ue.shared.setValue(s).toNumber());n.forEach((s,i)=>{const o=e.fillGradientStops[i]??i/n.length;t.addColorStop(o,s)}),r.fill={fill:t}}}class ob{constructor(e){this._canvasPool=Object.create(null),this.canvasOptions=e||{},this.enableFullScreen=!1}_createCanvasAndContext(e,t){const n=xe.get().createCanvas();n.width=e,n.height=t;const s=n.getContext("2d");return{canvas:n,context:s}}getOptimalCanvasAndContext(e,t,n=1){e=Math.ceil(e*n-1e-6),t=Math.ceil(t*n-1e-6),e=Mr(e),t=Mr(t);const s=(e<<17)+(t<<1);this._canvasPool[s]||(this._canvasPool[s]=[]);let i=this._canvasPool[s].pop();return i||(i=this._createCanvasAndContext(e,t)),i}returnCanvasAndContext(e){const{width:t,height:n}=e.canvas,s=(t<<17)+(n<<1);this._canvasPool[s].push(e)}clear(){this._canvasPool={}}}const Nt=new ob;function ms(r,e){if(r.texture===$.WHITE&&!r.fill)return ue.shared.setValue(r.color).toHex();if(r.fill){if(r.fill instanceof Xc){const t=r.fill,n=e.createPattern(t.texture.source.resource,"repeat"),s=t.transform.copyTo(W.shared);return s.scale(t.texture.frame.width,t.texture.frame.height),n.setTransform(s),n}else if(r.fill instanceof so){const t=r.fill;if(t.type==="linear"){const n=e.createLinearGradient(t.x0,t.y0,t.x1,t.y1);return t.gradientStops.forEach(s=>{n.addColorStop(s.offset,ue.shared.setValue(s.color).toHex())}),n}}}else{const t=e.createPattern(r.texture.source.resource,"repeat"),n=r.matrix.copyTo(W.shared);return n.scale(r.texture.frame.width,r.texture.frame.height),t.setTransform(n),t}return ne("FillStyle not recognised",r),"red"}class nh extends Ke{constructor(){super(...arguments),this.chars=Object.create(null),this.lineHeight=0,this.fontFamily="",this.fontMetrics={fontSize:0,ascent:0,descent:0},this.baseLineOffset=0,this.distanceField={type:"none",range:0},this.pages=[],this.baseMeasurementFontSize=100,this.baseRenderedFontSize=100}get font(){return ie(le,"BitmapFont.font is deprecated, please use BitmapFont.fontFamily instead."),this.fontFamily}get pageTextures(){return ie(le,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}get size(){return ie(le,"BitmapFont.size is deprecated, please use BitmapFont.fontMetrics.fontSize instead."),this.fontMetrics.fontSize}get distanceFieldRange(){return ie(le,"BitmapFont.distanceFieldRange is deprecated, please use BitmapFont.distanceField.range instead."),this.distanceField.range}get distanceFieldType(){return ie(le,"BitmapFont.distanceFieldType is deprecated, please use BitmapFont.distanceField.type instead."),this.distanceField.type}destroy(e=!1){this.emit("destroy",this),this.removeAllListeners();for(const t in this.chars)this.chars[t].texture.destroy();this.chars=null,e&&(this.pages.forEach(t=>t.texture.destroy(!0)),this.pages=null)}}function sh(r){if(r==="")return[];typeof r=="string"&&(r=[r]);const e=[];for(let t=0,n=r.length;t<n;t++){const s=r[t];if(Array.isArray(s)){if(s.length!==2)throw new Error(`[BitmapFont]: Invalid character range length, expecting 2 got ${s.length}.`);if(s[0].length===0||s[1].length===0)throw new Error("[BitmapFont]: Invalid character delimiter.");const i=s[0].charCodeAt(0),o=s[1].charCodeAt(0);if(o<i)throw new Error("[BitmapFont]: Invalid character range.");for(let a=i,l=o;a<=l;a++)e.push(String.fromCharCode(a))}else e.push(...Array.from(s))}if(e.length===0)throw new Error("[BitmapFont]: Empty set when resolving characters.");return e}class ih extends nh{constructor(e){super(),this.resolution=1,this.pages=[],this._padding=4,this._measureCache=Object.create(null),this._currentChars=[],this._currentX=0,this._currentY=0,this._currentPageIndex=-1,this._skipKerning=!1;const t=e,n=t.style.clone();t.overrideFill&&(n._fill.color=16777215,n._fill.alpha=1,n._fill.texture=$.WHITE,n._fill.fill=null);const s=n.fontSize;n.fontSize=this.baseMeasurementFontSize;const i=ps(n);t.overrideSize?n._stroke&&(n._stroke.width*=this.baseRenderedFontSize/s):n.fontSize=this.baseRenderedFontSize=s,this._style=n,this._skipKerning=t.skipKerning??!1,this.resolution=t.resolution??1,this._padding=t.padding??4,this.fontMetrics=Lt.measureFont(i),this.lineHeight=n.lineHeight||this.fontMetrics.fontSize||n.fontSize}ensureCharacters(e){var g,m;const t=sh(e).filter(_=>!this._currentChars.includes(_)).filter((_,b,y)=>y.indexOf(_)===b);if(!t.length)return;this._currentChars=[...this._currentChars,...t];let n;this._currentPageIndex===-1?n=this._nextPage():n=this.pages[this._currentPageIndex];let{canvas:s,context:i}=n.canvasAndContext,o=n.texture.source;const a=this._style;let l=this._currentX,c=this._currentY;const h=this.baseRenderedFontSize/this.baseMeasurementFontSize,u=this._padding*h,d=a.fontStyle==="italic"?2:1;let f=0,p=!1;for(let _=0;_<t.length;_++){const b=t[_],y=Lt.measureText(b,a,s,!1);y.lineHeight=y.height;const x=d*y.width*h,S=y.height*h,k=x+u*2,P=S+u*2;if(p=!1,b!==`
`&&b!=="\r"&&b!=="	"&&b!==" "&&(p=!0,f=Math.ceil(Math.max(P,f))),l+k>512&&(c+=f,f=P,l=0,c+f>512)){o.update();const E=this._nextPage();s=E.canvasAndContext.canvas,i=E.canvasAndContext.context,o=E.texture.source,c=0}const T=x/h-(((g=a.dropShadow)==null?void 0:g.distance)??0)-(((m=a._stroke)==null?void 0:m.width)??0);if(this.chars[b]={id:b.codePointAt(0),xOffset:-this._padding,yOffset:-this._padding,xAdvance:T,kerning:{}},p){this._drawGlyph(i,y,l+u,c+u,h,a);const E=o.width*h,v=o.height*h,R=new he(l/E*o.width,c/v*o.height,k/E*o.width,P/v*o.height);this.chars[b].texture=new $({source:o,frame:R}),l+=Math.ceil(k)}}o.update(),this._currentX=l,this._currentY=c,this._skipKerning&&this._applyKerning(t,i)}get pageTextures(){return ie(le,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}_applyKerning(e,t){const n=this._measureCache;for(let s=0;s<e.length;s++){const i=e[s];for(let o=0;o<this._currentChars.length;o++){const a=this._currentChars[o];let l=n[i];l||(l=n[i]=t.measureText(i).width);let c=n[a];c||(c=n[a]=t.measureText(a).width);let h=t.measureText(i+a).width,u=h-(l+c);u&&(this.chars[i].kerning[a]=u),h=t.measureText(i+a).width,u=h-(l+c),u&&(this.chars[a].kerning[i]=u)}}}_nextPage(){this._currentPageIndex++;const e=this.resolution,t=Nt.getOptimalCanvasAndContext(512,512,e);this._setupContext(t.context,this._style,e);const n=e*(this.baseRenderedFontSize/this.baseMeasurementFontSize),s=new $({source:new Zn({resource:t.canvas,resolution:n,alphaMode:"premultiply-alpha-on-upload"})}),i={canvasAndContext:t,texture:s};return this.pages[this._currentPageIndex]=i,i}_setupContext(e,t,n){t.fontSize=this.baseRenderedFontSize,e.scale(n,n),e.font=ps(t),t.fontSize=this.baseMeasurementFontSize,e.textBaseline=t.textBaseline;const s=t._stroke,i=(s==null?void 0:s.width)??0;if(s&&(e.lineWidth=i,e.lineJoin=s.join,e.miterLimit=s.miterLimit,e.strokeStyle=ms(s,e)),t._fill&&(e.fillStyle=ms(t._fill,e)),t.dropShadow){const o=t.dropShadow,a=ue.shared.setValue(o.color).toArray(),l=o.blur*n,c=o.distance*n;e.shadowColor=`rgba(${a[0]*255},${a[1]*255},${a[2]*255},${o.alpha})`,e.shadowBlur=l,e.shadowOffsetX=Math.cos(o.angle)*c,e.shadowOffsetY=Math.sin(o.angle)*c}else e.shadowColor="black",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0}_drawGlyph(e,t,n,s,i,o){const a=t.text,l=t.fontProperties,c=o._stroke,h=((c==null?void 0:c.width)??0)*i,u=n+h/2,d=s-h/2,f=l.descent*i,p=t.lineHeight*i;o.stroke&&h&&e.strokeText(a,u,d+p-f),o._fill&&e.fillText(a,u,d+p-f)}destroy(){super.destroy();for(let e=0;e<this.pages.length;e++){const{canvasAndContext:t,texture:n}=this.pages[e];Nt.returnCanvasAndContext(t),n.destroy(!0)}this.pages=null}}function oh(r,e,t){const n={width:0,height:0,offsetY:0,scale:e.fontSize/t.baseMeasurementFontSize,lines:[{width:0,charPositions:[],spaceWidth:0,spacesIndex:[],chars:[]}]};n.offsetY=t.baseLineOffset;let s=n.lines[0],i=null,o=!0;const a={spaceWord:!1,width:0,start:0,index:0,positions:[],chars:[]},l=f=>{const p=s.width;for(let g=0;g<a.index;g++){const m=f.positions[g];s.chars.push(f.chars[g]),s.charPositions.push(m+p)}s.width+=f.width,o=!1,a.width=0,a.index=0,a.chars.length=0},c=()=>{let f=s.chars.length-1,p=s.chars[f];for(;p===" ";)s.width-=t.chars[p].xAdvance,p=s.chars[--f];n.width=Math.max(n.width,s.width),s={width:0,charPositions:[],chars:[],spaceWidth:0,spacesIndex:[]},o=!0,n.lines.push(s),n.height+=t.lineHeight},h=t.baseMeasurementFontSize/e.fontSize,u=e.letterSpacing*h,d=e.wordWrapWidth*h;for(let f=0;f<r.length+1;f++){let p;const g=f===r.length;g||(p=r[f]);const m=t.chars[p]||t.chars[" "];if(/(?:\s)/.test(p)||p==="\r"||p===`
`||g){if(!o&&e.wordWrap&&s.width+a.width-u>d?(c(),l(a),g||s.charPositions.push(0)):(a.start=s.width,l(a),g||s.charPositions.push(0)),p==="\r"||p===`
`)s.width!==0&&c();else if(!g){const x=m.xAdvance+(m.kerning[i]||0)+u;s.width+=x,s.spaceWidth=x,s.spacesIndex.push(s.charPositions.length),s.chars.push(p)}}else{const y=m.kerning[i]||0,x=m.xAdvance+y+u;a.positions[a.index++]=a.width+y,a.chars.push(p),a.width+=x}i=p}return c(),e.align==="center"?ab(n):e.align==="right"?lb(n):e.align==="justify"&&cb(n),n}function ab(r){for(let e=0;e<r.lines.length;e++){const t=r.lines[e],n=r.width/2-t.width/2;for(let s=0;s<t.charPositions.length;s++)t.charPositions[s]+=n}}function lb(r){for(let e=0;e<r.lines.length;e++){const t=r.lines[e],n=r.width-t.width;for(let s=0;s<t.charPositions.length;s++)t.charPositions[s]+=n}}function cb(r){const e=r.width;for(let t=0;t<r.lines.length;t++){const n=r.lines[t];let s=0,i=n.spacesIndex[s++],o=0;const a=n.spacesIndex.length,c=(e-n.width)/a;for(let h=0;h<n.charPositions.length;h++)h===i&&(i=n.spacesIndex[s++],o+=c),n.charPositions[h]+=o}}class hb{constructor(){this.ALPHA=[["a","z"],["A","Z"]," "],this.NUMERIC=[["0","9"]],this.ALPHANUMERIC=[["a","z"],["A","Z"],["0","9"]," "],this.ASCII=[[" ","~"]],this.defaultOptions={chars:this.ALPHANUMERIC,resolution:1,padding:4,skipKerning:!1}}getFont(e,t){var o;let n=`${t.fontFamily}-bitmap`,s=!0;if(t._fill.fill&&(n+=t._fill.fill.uid,s=!1),!Ge.has(n)){const a=new ih({style:t,overrideFill:s,overrideSize:!0,...this.defaultOptions});a.once("destroy",()=>Ge.remove(n)),Ge.set(n,a)}const i=Ge.get(n);return(o=i.ensureCharacters)==null||o.call(i,e),i}getLayout(e,t){const n=this.getFont(e,t);return oh(e.split(""),t,n)}measureText(e,t){return this.getLayout(e,t)}install(...e){var c,h,u,d;let t=e[0];typeof t=="string"&&(t={name:t,style:e[1],chars:(c=e[2])==null?void 0:c.chars,resolution:(h=e[2])==null?void 0:h.resolution,padding:(u=e[2])==null?void 0:u.padding,skipKerning:(d=e[2])==null?void 0:d.skipKerning},ie(le,"BitmapFontManager.install(name, style, options) is deprecated, use BitmapFontManager.install({name, style, ...options})"));const n=t==null?void 0:t.name;if(!n)throw new Error("[BitmapFontManager] Property `name` is required.");t={...this.defaultOptions,...t};const s=t.style,i=s instanceof Nr?s:new Nr(s),o=i._fill.fill!==null&&i._fill.fill!==void 0,a=new ih({style:i,overrideFill:o,skipKerning:t.skipKerning,padding:t.padding,resolution:t.resolution,overrideSize:!1}),l=sh(t.chars);return a.ensureCharacters(l.join("")),Ge.set(`${n}-bitmap`,a),a.once("destroy",()=>Ge.remove(`${n}-bitmap`)),a}uninstall(e){const t=`${e}-bitmap`,n=Ge.get(t);n&&(Ge.remove(t),n.destroy())}}const ho=new hb;function ub(r){const e=r._stroke,t=r._fill,s=[`div { ${[`color: ${ue.shared.setValue(t.color).toHex()}`,`font-size: ${r.fontSize}px`,`font-family: ${r.fontFamily}`,`font-weight: ${r.fontWeight}`,`font-style: ${r.fontStyle}`,`font-variant: ${r.fontVariant}`,`letter-spacing: ${r.letterSpacing}px`,`text-align: ${r.align}`,`padding: ${r.padding}px`,`white-space: ${r.whiteSpace==="pre"&&r.wordWrap?"pre-wrap":r.whiteSpace}`,...r.lineHeight?[`line-height: ${r.lineHeight}px`]:[],...r.wordWrap?[`word-wrap: ${r.breakWords?"break-all":"break-word"}`,`max-width: ${r.wordWrapWidth}px`]:[],...e?[lh(e)]:[],...r.dropShadow?[ah(r.dropShadow)]:[],...r.cssOverrides].join(";")} }`];return db(r.tagStyles,s),s.join(" ")}function ah(r){const e=ue.shared.setValue(r.color).setAlpha(r.alpha).toHexa(),t=Math.round(Math.cos(r.angle)*r.distance),n=Math.round(Math.sin(r.angle)*r.distance),s=`${t}px ${n}px`;return r.blur>0?`text-shadow: ${s} ${r.blur}px ${e}`:`text-shadow: ${s} ${e}`}function lh(r){return[`-webkit-text-stroke-width: ${r.width}px`,`-webkit-text-stroke-color: ${ue.shared.setValue(r.color).toHex()}`,`text-stroke-width: ${r.width}px`,`text-stroke-color: ${ue.shared.setValue(r.color).toHex()}`,"paint-order: stroke"].join(";")}const ch={fontSize:"font-size: {{VALUE}}px",fontFamily:"font-family: {{VALUE}}",fontWeight:"font-weight: {{VALUE}}",fontStyle:"font-style: {{VALUE}}",fontVariant:"font-variant: {{VALUE}}",letterSpacing:"letter-spacing: {{VALUE}}px",align:"text-align: {{VALUE}}",padding:"padding: {{VALUE}}px",whiteSpace:"white-space: {{VALUE}}",lineHeight:"line-height: {{VALUE}}px",wordWrapWidth:"max-width: {{VALUE}}px"},hh={fill:r=>`color: ${ue.shared.setValue(r).toHex()}`,breakWords:r=>`word-wrap: ${r?"break-all":"break-word"}`,stroke:lh,dropShadow:ah};function db(r,e){for(const t in r){const n=r[t],s=[];for(const i in n)hh[i]?s.push(hh[i](n[i])):ch[i]&&s.push(ch[i].replace("{{VALUE}}",n[i]));e.push(`${t} { ${s.join(";")} }`)}}class uo extends Nr{constructor(e={}){super(e),this._cssOverrides=[],this.cssOverrides??(this.cssOverrides=e.cssOverrides),this.tagStyles=e.tagStyles??{}}set cssOverrides(e){this._cssOverrides=e instanceof Array?e:[e],this.update()}get cssOverrides(){return this._cssOverrides}_generateKey(){return this._styleKey=th(this)+this._cssOverrides.join("-"),this._styleKey}update(){this._cssStyle=null,super.update()}clone(){return new uo({align:this.align,breakWords:this.breakWords,dropShadow:this.dropShadow,fill:this._fill,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,cssOverrides:this.cssOverrides})}get cssStyle(){return this._cssStyle||(this._cssStyle=ub(this)),this._cssStyle}addOverride(...e){const t=e.filter(n=>!this.cssOverrides.includes(n));t.length>0&&(this.cssOverrides.push(...t),this.update())}removeOverride(...e){const t=e.filter(n=>this.cssOverrides.includes(n));t.length>0&&(this.cssOverrides=this.cssOverrides.filter(n=>!t.includes(n)),this.update())}set fill(e){typeof e!="string"&&typeof e!="number"&&ne("[HTMLTextStyle] only color fill is not supported by HTMLText"),super.fill=e}set stroke(e){e&&typeof e!="string"&&typeof e!="number"&&ne("[HTMLTextStyle] only color stroke is not supported by HTMLText"),super.stroke=e}}const uh="http://www.w3.org/2000/svg",dh="http://www.w3.org/1999/xhtml";class fh{constructor(){this.svgRoot=document.createElementNS(uh,"svg"),this.foreignObject=document.createElementNS(uh,"foreignObject"),this.domElement=document.createElementNS(dh,"div"),this.styleElement=document.createElementNS(dh,"style"),this.image=new Image;const{foreignObject:e,svgRoot:t,styleElement:n,domElement:s}=this;e.setAttribute("width","10000"),e.setAttribute("height","10000"),e.style.overflow="hidden",t.appendChild(e),e.appendChild(n),e.appendChild(s)}}let ph;function fb(r,e,t,n){n=n||ph||(ph=new fh);const{domElement:s,styleElement:i,svgRoot:o}=n;s.innerHTML=`<style>${e.cssStyle}</style><div>${r}</div>`,s.setAttribute("style","transform-origin: top left; display: inline-block"),t&&(i.textContent=t),document.body.appendChild(o);const a=s.getBoundingClientRect();o.remove();const l=Lt.measureFont(e.fontStyle).descent;return{width:a.width,height:a.height+l}}function mh(r,e,t){if(r)for(const n in r){const s=n.toLocaleLowerCase(),i=e[s];if(i){let o=r[n];n==="header"&&(o=o.replace(/@in\s+[^;]+;\s*/g,"").replace(/@out\s+[^;]+;\s*/g,"")),t&&i.push(`//----${t}----//`),i.push(o)}else ne(`${n} placement hook does not exist in shader`)}}const pb=/\{\{(.*?)\}\}/g;function gh(r){var n;const e={};return(((n=r.match(pb))==null?void 0:n.map(s=>s.replace(/[{()}]/g,"")))??[]).forEach(s=>{e[s]=[]}),e}function _h(r,e){let t;const n=/@in\s+([^;]+);/g;for(;(t=n.exec(r))!==null;)e.push(t[1])}function yh(r,e,t=!1){const n=[];_h(e,n),r.forEach(a=>{a.header&&_h(a.header,n)});const s=n;t&&s.sort();const i=s.map((a,l)=>`       @location(${l}) ${a},`).join(`
`);let o=e.replace(/@in\s+[^;]+;\s*/g,"");return o=o.replace("{{in}}",`
${i}
`),o}function bh(r,e){let t;const n=/@out\s+([^;]+);/g;for(;(t=n.exec(r))!==null;)e.push(t[1])}function mb(r){const t=/\b(\w+)\s*:/g.exec(r);return t?t[1]:""}function gb(r){const e=/@.*?\s+/g;return r.replace(e,"")}function _b(r,e){const t=[];bh(e,t),r.forEach(l=>{l.header&&bh(l.header,t)});let n=0;const s=t.sort().map(l=>l.indexOf("builtin")>-1?l:`@location(${n++}) ${l}`).join(`,
`),i=t.sort().map(l=>`       var ${gb(l)};`).join(`
`),o=`return VSOutput(
                ${t.sort().map(l=>` ${mb(l)}`).join(`,
`)});`;let a=e.replace(/@out\s+[^;]+;\s*/g,"");return a=a.replace("{{struct}}",`
${s}
`),a=a.replace("{{start}}",`
${i}
`),a=a.replace("{{return}}",`
${o}
`),a}function xh(r,e){let t=r;for(const n in e){const s=e[n];s.join(`
`).length?t=t.replace(`{{${n}}}`,`//-----${n} START-----//
${s.join(`
`)}
//----${n} FINISH----//`):t=t.replace(`{{${n}}}`,"")}return t}const jt=Object.create(null),fo=new Map;let yb=0;function bb({template:r,bits:e}){const t=vh(r,e);if(jt[t])return jt[t];const{vertex:n,fragment:s}=vb(r,e);return jt[t]=wh(n,s,e),jt[t]}function xb({template:r,bits:e}){const t=vh(r,e);return jt[t]||(jt[t]=wh(r.vertex,r.fragment,e)),jt[t]}function vb(r,e){const t=e.map(o=>o.vertex).filter(o=>!!o),n=e.map(o=>o.fragment).filter(o=>!!o);let s=yh(t,r.vertex,!0);s=_b(t,s);const i=yh(n,r.fragment,!0);return{vertex:s,fragment:i}}function vh(r,e){return e.map(t=>(fo.has(t)||fo.set(t,yb++),fo.get(t))).sort((t,n)=>t-n).join("-")+r.vertex+r.fragment}function wh(r,e,t){const n=gh(r),s=gh(e);return t.forEach(i=>{mh(i.vertex,n,i.name),mh(i.fragment,s,i.name)}),{vertex:xh(r,n),fragment:xh(e,s)}}const wb=`
    @in aPosition: vec2<f32>;
    @in aUV: vec2<f32>;

    @out @builtin(position) vPosition: vec4<f32>;
    @out vUV : vec2<f32>;
    @out vColor : vec4<f32>;

    {{header}}

    struct VSOutput {
        {{struct}}
    };

    @vertex
    fn main( {{in}} ) -> VSOutput {

        var worldTransformMatrix = globalUniforms.uWorldTransformMatrix;
        var modelMatrix = mat3x3<f32>(
            1.0, 0.0, 0.0,
            0.0, 1.0, 0.0,
            0.0, 0.0, 1.0
          );
        var position = aPosition;
        var uv = aUV;

        {{start}}
        
        vColor = vec4<f32>(1., 1., 1., 1.);

        {{main}}

        vUV = uv;

        var modelViewProjectionMatrix = globalUniforms.uProjectionMatrix * worldTransformMatrix * modelMatrix;

        vPosition =  vec4<f32>((modelViewProjectionMatrix *  vec3<f32>(position, 1.0)).xy, 0.0, 1.0);
       
        vColor *= globalUniforms.uWorldColorAlpha;

        {{end}}

        {{return}}
    };
`,Sb=`
    @in vUV : vec2<f32>;
    @in vColor : vec4<f32>;
   
    {{header}}

    @fragment
    fn main(
        {{in}}
      ) -> @location(0) vec4<f32> {
        
        {{start}}

        var outColor:vec4<f32>;
      
        {{main}}
        
        return outColor * vColor;
      };
`,Tb=`
    in vec2 aPosition;
    in vec2 aUV;

    out vec4 vColor;
    out vec2 vUV;

    {{header}}

    void main(void){

        mat3 worldTransformMatrix = uWorldTransformMatrix;
        mat3 modelMatrix = mat3(
            1.0, 0.0, 0.0,
            0.0, 1.0, 0.0,
            0.0, 0.0, 1.0
          );
        vec2 position = aPosition;
        vec2 uv = aUV;
        
        {{start}}
        
        vColor = vec4(1.);
        
        {{main}}
        
        vUV = uv;
        
        mat3 modelViewProjectionMatrix = uProjectionMatrix * worldTransformMatrix * modelMatrix;

        gl_Position = vec4((modelViewProjectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);

        vColor *= uWorldColorAlpha;

        {{end}}
    }
`,Eb=`
   
    in vec4 vColor;
    in vec2 vUV;

    out vec4 finalColor;

    {{header}}

    void main(void) {
        
        {{start}}

        vec4 outColor;
      
        {{main}}
        
        finalColor = outColor * vColor;
    }
`,Pb={name:"global-uniforms-bit",vertex:{header:`
        struct GlobalUniforms {
            uProjectionMatrix:mat3x3<f32>,
            uWorldTransformMatrix:mat3x3<f32>,
            uWorldColorAlpha: vec4<f32>,
            uResolution: vec2<f32>,
        }

        @group(0) @binding(0) var<uniform> globalUniforms : GlobalUniforms;
        `}},Ab={name:"global-uniforms-bit",vertex:{header:`
          uniform mat3 uProjectionMatrix;
          uniform mat3 uWorldTransformMatrix;
          uniform vec4 uWorldColorAlpha;
          uniform vec2 uResolution;
        `}};function gn({bits:r,name:e}){const t=bb({template:{fragment:Sb,vertex:wb},bits:[Pb,...r]});return Ur.from({name:e,vertex:{source:t.vertex,entryPoint:"main"},fragment:{source:t.fragment,entryPoint:"main"}})}function _n({bits:r,name:e}){return new nn({name:e,...xb({template:{vertex:Tb,fragment:Eb},bits:[Ab,...r]})})}const po={name:"color-bit",vertex:{header:`
            @in aColor: vec4<f32>;
        `,main:`
            vColor *= vec4<f32>(aColor.rgb * aColor.a, aColor.a);
        `}},mo={name:"color-bit",vertex:{header:`
            in vec4 aColor;
        `,main:`
            vColor *= vec4(aColor.rgb * aColor.a, aColor.a);
        `}},go={};function Mb(r){const e=[];{let t=0;for(let n=0;n<r;n++)e.push(`@group(1) @binding(${t++}) var textureSource${n+1}: texture_2d<f32>;`),e.push(`@group(1) @binding(${t++}) var textureSampler${n+1}: sampler;`)}return e.join(`
`)}function Cb(r){const e=[];{e.push("switch vTextureId {");for(let t=0;t<r;t++)t===r-1?e.push("  default:{"):e.push(`  case ${t}:{`),e.push(`      outColor = textureSampleGrad(textureSource${t+1}, textureSampler${t+1}, vUV, uvDx, uvDy);`),e.push("      break;}");e.push("}")}return e.join(`
`)}function _o(r){return go[r]||(go[r]={name:"texture-batch-bit",vertex:{header:`
                @in aTextureIdAndRound: vec2<u32>;
                @out @interpolate(flat) vTextureId : u32;
            `,main:`
                vTextureId = aTextureIdAndRound.y;
            `,end:`
                if(aTextureIdAndRound.x == 1)
                {
                    vPosition = vec4<f32>(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);
                }
            `},fragment:{header:`
                @in @interpolate(flat) vTextureId: u32;
    
                ${Mb(16)}
            `,main:`
                var uvDx = dpdx(vUV);
                var uvDy = dpdy(vUV);
    
                ${Cb(16)}
            `}}),go[r]}const yo={};function Bb(r){const e=[];for(let t=0;t<r;t++)t>0&&e.push("else"),t<r-1&&e.push(`if(vTextureId < ${t}.5)`),e.push("{"),e.push(`	outColor = texture(uTextures[${t}], vUV);`),e.push("}");return e.join(`
`)}function bo(r){return yo[r]||(yo[r]={name:"texture-batch-bit",vertex:{header:`
                in vec2 aTextureIdAndRound;
                out float vTextureId;
              
            `,main:`
                vTextureId = aTextureIdAndRound.y;
            `,end:`
                if(aTextureIdAndRound.x == 1.)
                {
                    gl_Position.xy = roundPixels(gl_Position.xy, uResolution);
                }
            `},fragment:{header:`
                in float vTextureId;
    
                uniform sampler2D uTextures[${r}];
              
            `,main:`
    
                ${Bb(16)}
            `}}),yo[r]}const yn={name:"round-pixels-bit",vertex:{header:`
            fn roundPixels(position: vec2<f32>, targetSize: vec2<f32>) -> vec2<f32> 
            {
                return (floor(((position * 0.5 + 0.5) * targetSize) + 0.5) / targetSize) * 2.0 - 1.0;
            }
        `}},bn={name:"round-pixels-bit",vertex:{header:`   
            vec2 roundPixels(vec2 position, vec2 targetSize)
            {       
                return (floor(((position * 0.5 + 0.5) * targetSize) + 0.5) / targetSize) * 2.0 - 1.0;
            }
        `}},Sh=new Int32Array(mt);for(let r=0;r<mt;r++)Sh[r]=r;const xo=new Qe({uTextures:{value:Sh,type:"i32",size:mt}},{isStatic:!0});class Th{constructor(){this._didUpload=!1,this._tempState=Dt.for2d()}init(e){const t=_n({name:"batch",bits:[mo,bo(mt),bn]});this._shader=new ot({glProgram:t,resources:{batchSamplers:xo}}),e.renderer.runners.contextChange.add(this)}contextChange(){this._didUpload=!1}start(e,t){const n=e.renderer;n.shader.bind(this._shader,this._didUpload),n.shader.updateUniformGroup(n.globalUniforms.uniformGroup),n.geometry.bind(t,this._shader.glProgram)}execute(e,t){const n=e.renderer;this._didUpload=!0,this._tempState.blendMode=t.blendMode,n.state.set(this._tempState);const s=t.textures.textures;for(let i=0;i<s.length;i++)n.texture.bind(s[i],i);n.geometry.draw("triangle-list",t.size,t.start)}destroy(){this._shader.destroy(!0),this._shader=null}}Th.extension={type:[M.WebGLPipesAdaptor],name:"batch"};const gs=Dt.for2d();class Eh{init(){const e=gn({name:"batch",bits:[po,_o(mt),yn]});this._shader=new ot({gpuProgram:e,groups:{}})}start(e,t){const n=e.renderer,s=n.encoder,i=this._shader.gpuProgram;this._geometry=t,s.setGeometry(t),gs.blendMode="normal",n.pipeline.getPipeline(t,i,gs);const o=n.globalUniforms.bindGroup;s.resetBindGroup(1),s.setBindGroup(0,o,i)}execute(e,t){const n=this._shader.gpuProgram,s=e.renderer,i=s.encoder;if(!t.bindGroup){const l=t.textures;t.bindGroup=Yi(l.textures,l.count)}gs.blendMode=t.blendMode;const o=s.bindGroup.getBindGroup(t.bindGroup,n,1),a=s.pipeline.getPipeline(this._geometry,n,gs);t.bindGroup._touch(s.textureGC.count),i.setPipeline(a),i.renderPassEncoder.setBindGroup(1,o),i.renderPassEncoder.drawIndexed(t.size,1,t.start)}destroy(){this._shader.destroy(!0),this._shader=null}}Eh.extension={type:[M.WebGPUPipesAdaptor],name:"batch"};class Ph{constructor(e,t){this.state=Dt.for2d(),this._batches=Object.create(null),this._geometries=Object.create(null),this.renderer=e,this._adaptor=t,this._adaptor.init(this)}buildStart(e){if(!this._batches[e.uid]){const t=new Gc;this._batches[e.uid]=t,this._geometries[t.uid]=new Ac}this._activeBatch=this._batches[e.uid],this._activeGeometry=this._geometries[this._activeBatch.uid],this._activeBatch.begin()}addToBatch(e){this._activeBatch.add(e)}break(e){this._activeBatch.break(e)}buildEnd(e){const t=this._activeBatch,n=this._activeGeometry;t.finish(e),n.indexBuffer.setDataWithSize(t.indexBuffer,t.indexSize,!0),n.buffers[0].setDataWithSize(t.attributeBuffer.float32View,t.attributeSize,!1)}upload(e){const t=this._batches[e.uid],n=this._geometries[t.uid];t.dirty&&(t.dirty=!1,n.buffers[0].update(t.attributeSize*4))}execute(e){if(e.action==="startBatch"){const t=e.batcher,n=this._geometries[t.uid];this._adaptor.start(this,n)}this._adaptor.execute(this,e)}destroy(){this.state=null,this.renderer=null,this._adaptor.destroy(),this._adaptor=null;for(const e in this._batches)this._batches[e].destroy();this._batches=null;for(const e in this._geometries)this._geometries[e].destroy();this._geometries=null}}Ph.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"batch"};const xn={name:"local-uniform-bit",vertex:{header:`

            struct LocalUniforms {
                uTransformMatrix:mat3x3<f32>,
                uColor:vec4<f32>,
                uRound:f32,
            }

            @group(1) @binding(0) var<uniform> localUniforms : LocalUniforms;
        `,main:`
            vColor *= localUniforms.uColor;
            modelMatrix *= localUniforms.uTransformMatrix;
        `,end:`
            if(localUniforms.uRound == 1)
            {
                vPosition = vec4(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);
            }
        `}},Rb={...xn,vertex:{...xn.vertex,header:xn.vertex.header.replace("group(1)","group(2)")}},vo={name:"local-uniform-bit",vertex:{header:`

            uniform mat3 uTransformMatrix;
            uniform vec4 uColor;
            uniform float uRound;
        `,main:`
            vColor *= uColor;
            modelMatrix = uTransformMatrix;
        `,end:`
            if(uRound == 1.)
            {
                gl_Position.xy = roundPixels(gl_Position.xy, uResolution);
            }
        `}},kb={name:"texture-bit",vertex:{header:`

        struct TextureUniforms {
            uTextureMatrix:mat3x3<f32>,
        }

        @group(2) @binding(2) var<uniform> textureUniforms : TextureUniforms;
        `,main:`
            uv = (textureUniforms.uTextureMatrix * vec3(uv, 1.0)).xy;
        `},fragment:{header:`
            @group(2) @binding(0) var uTexture: texture_2d<f32>;
            @group(2) @binding(1) var uSampler: sampler;

         
        `,main:`
            outColor = textureSample(uTexture, uSampler, vUV);
        `}},Ib={name:"texture-bit",vertex:{header:`
            uniform mat3 uTextureMatrix;
        `,main:`
            uv = (uTextureMatrix * vec3(uv, 1.0)).xy;
        `},fragment:{header:`
        uniform sampler2D uTexture;

         
        `,main:`
            outColor = texture(uTexture, vUV);
        `}};function Gb(r,e){const t=r.root,n=r.instructionSet;n.reset(),e.batch.buildStart(n),e.blendMode.buildStart(),e.colorMask.buildStart(),t.sortableChildren&&t.sortChildren(),Ah(t,n,e,!0),e.batch.buildEnd(n),e.blendMode.buildEnd(n)}function _s(r,e,t){r.globalDisplayStatus<7||!r.includeInBuild||(r.sortableChildren&&r.sortChildren(),r.isSimple?Ub(r,e,t):Ah(r,e,t,!1))}function Ub(r,e,t){if(r.renderPipeId&&(t.blendMode.setBlendMode(r,r.groupBlendMode,e),r.didViewUpdate=!1,t[r.renderPipeId].addRenderable(r,e)),!r.isRenderGroupRoot){const n=r.children,s=n.length;for(let i=0;i<s;i++)_s(n[i],e,t)}}function Ah(r,e,t,n){if(!n&&r.isRenderGroupRoot)t.renderGroup.addRenderGroup(r.renderGroup,e);else{for(let o=0;o<r.effects.length;o++){const a=r.effects[o];t[a.pipe].push(a,r,e)}const s=r.renderPipeId;s&&(t.blendMode.setBlendMode(r,r.groupBlendMode,e),r.didViewUpdate=!1,t[s].addRenderable(r,e));const i=r.children;if(i.length)for(let o=0;o<i.length;o++)_s(i[o],e,t);for(let o=r.effects.length-1;o>=0;o--){const a=r.effects[o];t[a.pipe].pop(a,r,e)}}}const Fb=new Ze;class Ob extends ci{constructor(){super({filters:[new rb({sprite:new Br($.EMPTY)})]})}get sprite(){return this.filters[0].sprite}set sprite(e){this.filters[0].sprite=e}}class Mh{constructor(e){this._activeMaskStage=[],this._renderer=e}push(e,t,n){const s=this._renderer;if(s.renderPipes.batch.break(n),n.add({renderPipeId:"alphaMask",action:"pushMaskBegin",mask:e,canBundle:!1,maskedContainer:t}),e.renderMaskToTexture){const i=e.mask;i.includeInBuild=!0,_s(i,n,s.renderPipes),i.includeInBuild=!1}s.renderPipes.batch.break(n),n.add({renderPipeId:"alphaMask",action:"pushMaskEnd",mask:e,maskedContainer:t,canBundle:!1})}pop(e,t,n){this._renderer.renderPipes.batch.break(n),n.add({renderPipeId:"alphaMask",action:"popMaskEnd",mask:e,canBundle:!1})}execute(e){const t=this._renderer,n=e.mask.renderMaskToTexture;if(e.action==="pushMaskBegin"){const s=oe.get(Ob);if(n){e.mask.mask.measurable=!0;const i=di(e.mask.mask,!0,Fb);e.mask.mask.measurable=!1,i.ceil();const o=at.getOptimalTexture(i.width,i.height,1,!1);t.renderTarget.push(o,!0),t.globalUniforms.push({offset:i,worldColor:4294967295});const a=s.sprite;a.texture=o,a.worldTransform.tx=i.minX,a.worldTransform.ty=i.minY,this._activeMaskStage.push({filterEffect:s,maskedContainer:e.maskedContainer,filterTexture:o})}else s.sprite=e.mask.mask,this._activeMaskStage.push({filterEffect:s,maskedContainer:e.maskedContainer})}else if(e.action==="pushMaskEnd"){const s=this._activeMaskStage[this._activeMaskStage.length-1];n&&(t.renderTarget.pop(),t.globalUniforms.pop()),t.filter.push({renderPipeId:"filter",action:"pushFilter",container:s.maskedContainer,filterEffect:s.filterEffect,canBundle:!1})}else if(e.action==="popMaskEnd"){t.filter.pop();const s=this._activeMaskStage.pop();n&&at.returnTexture(s.filterTexture),oe.return(s.filterEffect)}}destroy(){this._renderer=null,this._activeMaskStage=null}}Mh.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"alphaMask"};class Ch{constructor(e){this._colorStack=[],this._colorStackIndex=0,this._currentColor=0,this._renderer=e}buildStart(){this._colorStack[0]=15,this._colorStackIndex=1,this._currentColor=15}push(e,t,n){this._renderer.renderPipes.batch.break(n);const i=this._colorStack;i[this._colorStackIndex]=i[this._colorStackIndex-1]&e.mask;const o=this._colorStack[this._colorStackIndex];o!==this._currentColor&&(this._currentColor=o,n.add({renderPipeId:"colorMask",colorMask:o,canBundle:!1})),this._colorStackIndex++}pop(e,t,n){this._renderer.renderPipes.batch.break(n);const i=this._colorStack;this._colorStackIndex--;const o=i[this._colorStackIndex-1];o!==this._currentColor&&(this._currentColor=o,n.add({renderPipeId:"colorMask",colorMask:o,canBundle:!1}))}execute(e){this._renderer.colorMask.setMask(e.colorMask)}destroy(){this._colorStack=null}}Ch.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"colorMask"};class Bh{constructor(e){this._maskStackHash={},this._maskHash=new WeakMap,this._renderer=e}push(e,t,n){var s;const i=e,o=this._renderer;o.renderPipes.batch.break(n),o.renderPipes.blendMode.setBlendMode(i.mask,"none",n),n.add({renderPipeId:"stencilMask",action:"pushMaskBegin",mask:e,canBundle:!1});const a=i.mask;a.includeInBuild=!0,this._maskHash.has(i)||this._maskHash.set(i,{instructionsStart:0,instructionsLength:0});const l=this._maskHash.get(i);l.instructionsStart=n.instructionSize,_s(a,n,o.renderPipes),a.includeInBuild=!1,o.renderPipes.batch.break(n),n.add({renderPipeId:"stencilMask",action:"pushMaskEnd",mask:e,canBundle:!1});const c=n.instructionSize-l.instructionsStart-1;l.instructionsLength=c;const h=o.renderTarget.renderTarget.uid;(s=this._maskStackHash)[h]??(s[h]=0)}pop(e,t,n){const s=e,i=this._renderer;i.renderPipes.batch.break(n),i.renderPipes.blendMode.setBlendMode(s.mask,"none",n),n.add({renderPipeId:"stencilMask",action:"popMaskBegin",canBundle:!1});const o=this._maskHash.get(e);for(let a=0;a<o.instructionsLength;a++)n.instructions[n.instructionSize++]=n.instructions[o.instructionsStart++];n.add({renderPipeId:"stencilMask",action:"popMaskEnd",canBundle:!1})}execute(e){var t;const n=this._renderer,s=n.renderTarget.renderTarget.uid;let i=(t=this._maskStackHash)[s]??(t[s]=0);e.action==="pushMaskBegin"?(n.renderTarget.ensureDepthStencil(),n.stencil.setStencilMode(Me.RENDERING_MASK_ADD,i),i++,n.colorMask.setMask(0)):e.action==="pushMaskEnd"?(n.stencil.setStencilMode(Me.MASK_ACTIVE,i),n.colorMask.setMask(15)):e.action==="popMaskBegin"?(n.colorMask.setMask(0),i!==0?n.stencil.setStencilMode(Me.RENDERING_MASK_REMOVE,i):(n.renderTarget.clear(null,Je.STENCIL),n.stencil.setStencilMode(Me.DISABLED,i)),i--):e.action==="popMaskEnd"&&(n.stencil.setStencilMode(Me.MASK_ACTIVE,i),n.colorMask.setMask(15)),this._maskStackHash[s]=i}destroy(){this._renderer=null,this._maskStackHash=null,this._maskHash=null}}Bh.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"stencilMask"};var ys=(r=>(r[r.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",r[r.ARRAY_BUFFER=34962]="ARRAY_BUFFER",r[r.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",r))(ys||{});class Db{constructor(e,t){this.buffer=e||null,this.updateID=-1,this.byteLength=-1,this.type=t}}class Rh{constructor(e){this._gpuBuffers=Object.create(null),this._boundBufferBases=Object.create(null),this._renderer=e}destroy(){this._renderer=null,this._gl=null,this._gpuBuffers=null,this._boundBufferBases=null}contextChange(){this._gpuBuffers=Object.create(null),this._gl=this._renderer.gl}getGlBuffer(e){return this._gpuBuffers[e.uid]||this.createGLBuffer(e)}bind(e){const{_gl:t}=this,n=this.getGlBuffer(e);t.bindBuffer(n.type,n.buffer)}bindBufferBase(e,t){const{_gl:n}=this;if(this._boundBufferBases[t]!==e){const s=this.getGlBuffer(e);this._boundBufferBases[t]=e,n.bindBufferBase(n.UNIFORM_BUFFER,t,s.buffer)}}bindBufferRange(e,t,n){const{_gl:s}=this;n=n||0;const i=this.getGlBuffer(e);s.bindBufferRange(s.UNIFORM_BUFFER,t||0,i.buffer,n*256,256)}updateBuffer(e){const{_gl:t}=this,n=this.getGlBuffer(e);if(e._updateID===n.updateID)return n;n.updateID=e._updateID,t.bindBuffer(n.type,n.buffer);const s=e.data;if(n.byteLength>=e.data.byteLength)t.bufferSubData(n.type,0,s,0,e._updateSize/s.BYTES_PER_ELEMENT);else{const i=e.descriptor.usage&ae.STATIC?t.STATIC_DRAW:t.DYNAMIC_DRAW;n.byteLength=s.byteLength,t.bufferData(n.type,s,i)}return n}destroyAll(){const e=this._gl;for(const t in this._gpuBuffers)e.deleteBuffer(this._gpuBuffers[t].buffer);this._gpuBuffers=Object.create(null)}onBufferDestroy(e,t){const n=this._gpuBuffers[e.uid],s=this._gl;t||s.deleteBuffer(n.buffer),this._gpuBuffers[e.uid]=null}createGLBuffer(e){const{_gl:t}=this;let n=ys.ARRAY_BUFFER;e.descriptor.usage&ae.INDEX?n=ys.ELEMENT_ARRAY_BUFFER:e.descriptor.usage&ae.UNIFORM&&(n=ys.UNIFORM_BUFFER);const s=new Db(t.createBuffer(),n);return this._gpuBuffers[e.uid]=s,e.on("destroy",this.onBufferDestroy,this),s}}Rh.extension={type:[M.WebGLSystem],name:"buffer"};const wo=class $d{constructor(e){this.supports={uint32Indices:!0,uniformBufferObject:!0,vertexArrayObject:!0,srgbTextures:!0,nonPowOf2wrapping:!0,msaa:!0,nonPowOf2mipmaps:!0},this._renderer=e,this.extensions=Object.create(null),this.handleContextLost=this.handleContextLost.bind(this),this.handleContextRestored=this.handleContextRestored.bind(this)}get isLost(){return!this.gl||this.gl.isContextLost()}contextChange(e){this.gl=e,this._renderer.gl=e}init(e){if(e={...$d.defaultOptions,...e},e.context)this.initFromContext(e.context);else{const t=this._renderer.background.alpha<1,n=e.premultipliedAlpha??!0,s=e.antialias&&!this._renderer.backBuffer.useBackBuffer;this.createContext(e.preferWebGLVersion,{alpha:t,premultipliedAlpha:n,antialias:s,stencil:!0,preserveDrawingBuffer:e.preserveDrawingBuffer,powerPreference:e.powerPreference??"default"})}}initFromContext(e){this.gl=e,this.webGLVersion=e instanceof xe.get().getWebGLRenderingContext()?1:2,this.getExtensions(),this.validateContext(e),this._renderer.runners.contextChange.emit(e);const t=this._renderer.view.canvas;t.addEventListener("webglcontextlost",this.handleContextLost,!1),t.addEventListener("webglcontextrestored",this.handleContextRestored,!1)}createContext(e,t){let n;const s=this._renderer.view.canvas;if(e===2&&(n=s.getContext("webgl2",t)),!n&&(n=s.getContext("webgl",t),!n))throw new Error("This browser does not support WebGL. Try using the canvas renderer");this.gl=n,this.initFromContext(this.gl)}getExtensions(){const{gl:e}=this,t={anisotropicFiltering:e.getExtension("EXT_texture_filter_anisotropic"),floatTextureLinear:e.getExtension("OES_texture_float_linear"),s3tc:e.getExtension("WEBGL_compressed_texture_s3tc"),s3tc_sRGB:e.getExtension("WEBGL_compressed_texture_s3tc_srgb"),etc:e.getExtension("WEBGL_compressed_texture_etc"),etc1:e.getExtension("WEBGL_compressed_texture_etc1"),pvrtc:e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),atc:e.getExtension("WEBGL_compressed_texture_atc"),astc:e.getExtension("WEBGL_compressed_texture_astc"),bptc:e.getExtension("EXT_texture_compression_bptc"),rgtc:e.getExtension("EXT_texture_compression_rgtc"),loseContext:e.getExtension("WEBGL_lose_context")};if(this.webGLVersion===1)this.extensions={...t,drawBuffers:e.getExtension("WEBGL_draw_buffers"),depthTexture:e.getExtension("WEBGL_depth_texture"),vertexArrayObject:e.getExtension("OES_vertex_array_object")||e.getExtension("MOZ_OES_vertex_array_object")||e.getExtension("WEBKIT_OES_vertex_array_object"),uint32ElementIndex:e.getExtension("OES_element_index_uint"),floatTexture:e.getExtension("OES_texture_float"),floatTextureLinear:e.getExtension("OES_texture_float_linear"),textureHalfFloat:e.getExtension("OES_texture_half_float"),textureHalfFloatLinear:e.getExtension("OES_texture_half_float_linear"),vertexAttribDivisorANGLE:e.getExtension("ANGLE_instanced_arrays"),srgb:e.getExtension("EXT_sRGB")};else{this.extensions={...t,colorBufferFloat:e.getExtension("EXT_color_buffer_float")};const n=e.getExtension("WEBGL_provoking_vertex");n&&n.provokingVertexWEBGL(n.FIRST_VERTEX_CONVENTION_WEBGL)}}handleContextLost(e){e.preventDefault(),this._contextLossForced&&(this._contextLossForced=!1,setTimeout(()=>{var t;this.gl.isContextLost()&&((t=this.extensions.loseContext)==null||t.restoreContext())},0))}handleContextRestored(){this._renderer.runners.contextChange.emit(this.gl)}destroy(){var t;const e=this._renderer.view.canvas;this._renderer=null,e.removeEventListener("webglcontextlost",this.handleContextLost),e.removeEventListener("webglcontextrestored",this.handleContextRestored),this.gl.useProgram(null),(t=this.extensions.loseContext)==null||t.loseContext()}forceContextLoss(){var e;(e=this.extensions.loseContext)==null||e.loseContext(),this._contextLossForced=!0}validateContext(e){const t=e.getContextAttributes();t&&!t.stencil&&ne("Provided WebGL context does not have a stencil buffer, masks may not render correctly");const n=this.supports,s=this.webGLVersion===2,i=this.extensions;n.uint32Indices=s||!!i.uint32ElementIndex,n.uniformBufferObject=s,n.vertexArrayObject=s||!!i.vertexArrayObject,n.srgbTextures=s||!!i.srgb,n.nonPowOf2wrapping=s,n.nonPowOf2mipmaps=s,n.msaa=s,n.uint32Indices||ne("Provided WebGL context does not support 32 index buffer, large scenes may not render correctly")}};wo.extension={type:[M.WebGLSystem],name:"context"},wo.defaultOptions={context:null,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:void 0,preferWebGLVersion:2};let Lb=wo;function kh(r,e){for(const t in r.attributes){const n=r.attributes[t],s=e[t];s?(n.location??(n.location=s.location),n.format??(n.format=s.format),n.offset??(n.offset=s.offset),n.instance??(n.instance=s.instance)):ne(`Attribute ${t} is not present in the shader, but is present in the geometry. Unable to infer attribute details.`)}Nb(r)}function Nb(r){const{buffers:e,attributes:t}=r,n={},s={};for(const i in e){const o=e[i];n[o.uid]=0,s[o.uid]=0}for(const i in t){const o=t[i];n[o.buffer.uid]+=sn(o.format).stride}for(const i in t){const o=t[i];o.stride??(o.stride=n[o.buffer.uid]),o.start??(o.start=s[o.buffer.uid]),s[o.buffer.uid]+=sn(o.format).stride}}var So=(r=>(r[r.RGBA=6408]="RGBA",r[r.RGB=6407]="RGB",r[r.RG=33319]="RG",r[r.RED=6403]="RED",r[r.RGBA_INTEGER=36249]="RGBA_INTEGER",r[r.RGB_INTEGER=36248]="RGB_INTEGER",r[r.RG_INTEGER=33320]="RG_INTEGER",r[r.RED_INTEGER=36244]="RED_INTEGER",r[r.ALPHA=6406]="ALPHA",r[r.LUMINANCE=6409]="LUMINANCE",r[r.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",r[r.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",r[r.DEPTH_STENCIL=34041]="DEPTH_STENCIL",r))(So||{}),Ih=(r=>(r[r.TEXTURE_2D=3553]="TEXTURE_2D",r[r.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",r[r.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",r[r.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",r[r.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",r[r.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",r[r.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",r[r.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",r[r.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",r))(Ih||{}),se=(r=>(r[r.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",r[r.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",r[r.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",r[r.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",r[r.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",r[r.UNSIGNED_INT=5125]="UNSIGNED_INT",r[r.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",r[r.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",r[r.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",r[r.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",r[r.BYTE=5120]="BYTE",r[r.SHORT=5122]="SHORT",r[r.INT=5124]="INT",r[r.FLOAT=5126]="FLOAT",r[r.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",r[r.HALF_FLOAT=36193]="HALF_FLOAT",r))(se||{});const Gh={uint8x2:se.UNSIGNED_BYTE,uint8x4:se.UNSIGNED_BYTE,sint8x2:se.BYTE,sint8x4:se.BYTE,unorm8x2:se.UNSIGNED_BYTE,unorm8x4:se.UNSIGNED_BYTE,snorm8x2:se.BYTE,snorm8x4:se.BYTE,uint16x2:se.UNSIGNED_SHORT,uint16x4:se.UNSIGNED_SHORT,sint16x2:se.SHORT,sint16x4:se.SHORT,unorm16x2:se.UNSIGNED_SHORT,unorm16x4:se.UNSIGNED_SHORT,snorm16x2:se.SHORT,snorm16x4:se.SHORT,float16x2:se.HALF_FLOAT,float16x4:se.HALF_FLOAT,float32:se.FLOAT,float32x2:se.FLOAT,float32x3:se.FLOAT,float32x4:se.FLOAT,uint32:se.UNSIGNED_INT,uint32x2:se.UNSIGNED_INT,uint32x3:se.UNSIGNED_INT,uint32x4:se.UNSIGNED_INT,sint32:se.INT,sint32x2:se.INT,sint32x3:se.INT,sint32x4:se.INT};function Hb(r){return Gh[r]??Gh.float32}const zb={"point-list":0,"line-list":1,"line-strip":3,"triangle-list":4,"triangle-strip":5};class Uh{constructor(e){this._geometryVaoHash=Object.create(null),this._renderer=e,this._activeGeometry=null,this._activeVao=null,this.hasVao=!0,this.hasInstance=!0}contextChange(){const e=this.gl=this._renderer.gl;if(!this._renderer.context.supports.vertexArrayObject)throw new Error("[PixiJS] Vertex Array Objects are not supported on this device");const t=this._renderer.context.extensions.vertexArrayObject;t&&(e.createVertexArray=()=>t.createVertexArrayOES(),e.bindVertexArray=s=>t.bindVertexArrayOES(s),e.deleteVertexArray=s=>t.deleteVertexArrayOES(s));const n=this._renderer.context.extensions.vertexAttribDivisorANGLE;n&&(e.drawArraysInstanced=(s,i,o,a)=>{n.drawArraysInstancedANGLE(s,i,o,a)},e.drawElementsInstanced=(s,i,o,a,l)=>{n.drawElementsInstancedANGLE(s,i,o,a,l)},e.vertexAttribDivisor=(s,i)=>n.vertexAttribDivisorANGLE(s,i)),this._activeGeometry=null,this._activeVao=null,this._geometryVaoHash=Object.create(null)}bind(e,t){const n=this.gl;this._activeGeometry=e;const s=this.getVao(e,t);this._activeVao!==s&&(this._activeVao=s,n.bindVertexArray(s)),this.updateBuffers()}reset(){this.unbind()}updateBuffers(){const e=this._activeGeometry,t=this._renderer.buffer;for(let n=0;n<e.buffers.length;n++){const s=e.buffers[n];t.updateBuffer(s)}}checkCompatibility(e,t){const n=e.attributes,s=t._attributeData;for(const i in s)if(!n[i])throw new Error(`shader and geometry incompatible, geometry missing the "${i}" attribute`)}getSignature(e,t){const n=e.attributes,s=t._attributeData,i=["g",e.uid];for(const o in n)s[o]&&i.push(o,s[o].location);return i.join("-")}getVao(e,t){var n;return((n=this._geometryVaoHash[e.uid])==null?void 0:n[t._key])||this.initGeometryVao(e,t)}initGeometryVao(e,t,n=!0){const s=this._renderer.gl,i=this._renderer.buffer;this._renderer.shader._getProgramData(t),this.checkCompatibility(e,t);const o=this.getSignature(e,t);this._geometryVaoHash[e.uid]||(this._geometryVaoHash[e.uid]=Object.create(null),e.on("destroy",this.onGeometryDestroy,this));const a=this._geometryVaoHash[e.uid];let l=a[o];if(l)return a[t._key]=l,l;kh(e,t._attributeData);const c=e.buffers;l=s.createVertexArray(),s.bindVertexArray(l);for(let h=0;h<c.length;h++){const u=c[h];i.bind(u)}return this.activateVao(e,t),a[t._key]=l,a[o]=l,s.bindVertexArray(null),l}onGeometryDestroy(e,t){const n=this._geometryVaoHash[e.uid],s=this.gl;if(n){if(t)for(const i in n)this._activeVao!==n[i]&&this.unbind(),s.deleteVertexArray(n[i]);this._geometryVaoHash[e.uid]=null}}destroyAll(e=!1){const t=this.gl;for(const n in this._geometryVaoHash){if(e)for(const s in this._geometryVaoHash[n]){const i=this._geometryVaoHash[n];this._activeVao!==i&&this.unbind(),t.deleteVertexArray(i[s])}this._geometryVaoHash[n]=null}}activateVao(e,t){var a;const n=this._renderer.gl,s=this._renderer.buffer,i=e.attributes;e.indexBuffer&&s.bind(e.indexBuffer);let o=null;for(const l in i){const c=i[l],h=c.buffer,u=s.getGlBuffer(h),d=t._attributeData[l];if(d){o!==u&&(s.bind(h),o=u);const f=c.location;n.enableVertexAttribArray(f);const p=sn(c.format),g=Hb(c.format);if(((a=d.format)==null?void 0:a.substring(1,4))==="int"?n.vertexAttribIPointer(f,p.size,g,c.stride,c.offset):n.vertexAttribPointer(f,p.size,g,p.normalised,c.stride,c.offset),c.instance)if(this.hasInstance)n.vertexAttribDivisor(f,1);else throw new Error("geometry error, GPU Instancing is not supported on this device")}}}draw(e,t,n,s){const{gl:i}=this._renderer,o=this._activeGeometry,a=zb[o.topology||e];if(s||(s=o.instanceCount),o.indexBuffer){const l=o.indexBuffer.data.BYTES_PER_ELEMENT,c=l===2?i.UNSIGNED_SHORT:i.UNSIGNED_INT;s>1?i.drawElementsInstanced(a,t||o.indexBuffer.data.length,c,(n||0)*l,s):i.drawElements(a,t||o.indexBuffer.data.length,c,(n||0)*l)}else s>1?i.drawArraysInstanced(a,n||0,t||o.getSize(),s):i.drawArrays(a,n||0,t||o.getSize());return this}unbind(){this.gl.bindVertexArray(null),this._activeVao=null,this._activeGeometry=null}destroy(){this._renderer=null,this.gl=null,this._activeVao=null,this._activeGeometry=null}}Uh.extension={type:[M.WebGLSystem],name:"geometry"};const $b=new us({attributes:{aPosition:[-1,-1,3,-1,-1,3]}}),To=class Wd{constructor(e){this.useBackBuffer=!1,this._useBackBufferThisRender=!1,this._renderer=e}init(e={}){const{useBackBuffer:t,antialias:n}={...Wd.defaultOptions,...e};this.useBackBuffer=t,this._antialias=n,this._renderer.context.supports.msaa||(ne("antialiasing, is not supported on when using the back buffer"),this._antialias=!1),this._state=Dt.for2d();const s=new nn({vertex:`
                attribute vec2 aPosition;
                out vec2 vUv;

                void main() {
                    gl_Position = vec4(aPosition, 0.0, 1.0);

                    vUv = (aPosition + 1.0) / 2.0;

                    // flip dem UVs
                    vUv.y = 1.0 - vUv.y;
                }`,fragment:`
                in vec2 vUv;
                out vec4 finalColor;

                uniform sampler2D uTexture;

                void main() {
                    finalColor = texture(uTexture, vUv);
                }`,name:"big-triangle"});this._bigTriangleShader=new ot({glProgram:s,resources:{uTexture:$.WHITE.source}})}renderStart(e){const t=this._renderer.renderTarget.getRenderTarget(e.target);if(this._useBackBufferThisRender=this.useBackBuffer&&!!t.isRoot,this._useBackBufferThisRender){const n=this._renderer.renderTarget.getRenderTarget(e.target);this._targetTexture=n.colorTexture,e.target=this._getBackBufferTexture(n.colorTexture)}}renderEnd(){this._presentBackBuffer()}_presentBackBuffer(){const e=this._renderer;e.renderTarget.finishRenderPass(),this._useBackBufferThisRender&&(e.renderTarget.bind(this._targetTexture,!1),this._bigTriangleShader.resources.uTexture=this._backBufferTexture.source,e.encoder.draw({geometry:$b,shader:this._bigTriangleShader,state:this._state}))}_getBackBufferTexture(e){return this._backBufferTexture=this._backBufferTexture||new $({source:new Ie({width:e.width,height:e.height,resolution:e._resolution,antialias:this._antialias})}),this._backBufferTexture.source.resize(e.width,e.height,e._resolution),this._backBufferTexture}destroy(){this._backBufferTexture&&(this._backBufferTexture.destroy(),this._backBufferTexture=null)}};To.extension={type:[M.WebGLSystem],name:"backBuffer",priority:1},To.defaultOptions={useBackBuffer:!1};let Wb=To;class Fh{constructor(e){this._colorMaskCache=15,this._renderer=e}setMask(e){this._colorMaskCache!==e&&(this._colorMaskCache=e,this._renderer.gl.colorMask(!!(e&8),!!(e&4),!!(e&2),!!(e&1)))}}Fh.extension={type:[M.WebGLSystem],name:"colorMask"};class Oh{constructor(e){this.commandFinished=Promise.resolve(),this._renderer=e}setGeometry(e,t){this._renderer.geometry.bind(e,t.glProgram)}finishRenderPass(){}draw(e){const t=this._renderer,{geometry:n,shader:s,state:i,skipSync:o,topology:a,size:l,start:c,instanceCount:h}=e;t.shader.bind(s,o),t.geometry.bind(n,t.shader._activeProgram),i&&t.state.set(i),t.geometry.draw(a,l,c,h??n.instanceCount)}destroy(){this._renderer=null}}Oh.extension={type:[M.WebGLSystem],name:"encoder"};class Vb{constructor(){this.width=-1,this.height=-1,this.msaa=!1,this.msaaRenderBuffer=[]}}const lr=[];lr[Me.NONE]=void 0,lr[Me.DISABLED]={stencilWriteMask:0,stencilReadMask:0},lr[Me.RENDERING_MASK_ADD]={stencilFront:{compare:"equal",passOp:"increment-clamp"},stencilBack:{compare:"equal",passOp:"increment-clamp"}},lr[Me.RENDERING_MASK_REMOVE]={stencilFront:{compare:"equal",passOp:"decrement-clamp"},stencilBack:{compare:"equal",passOp:"decrement-clamp"}},lr[Me.MASK_ACTIVE]={stencilWriteMask:0,stencilFront:{compare:"equal",passOp:"keep"},stencilBack:{compare:"equal",passOp:"keep"}};class Dh{constructor(e){this._stencilCache={enabled:!1,stencilReference:0,stencilMode:Me.NONE},this._renderTargetStencilState=Object.create(null),e.renderTarget.onRenderTargetChange.add(this)}contextChange(e){this._gl=e,this._comparisonFuncMapping={always:e.ALWAYS,never:e.NEVER,equal:e.EQUAL,"not-equal":e.NOTEQUAL,less:e.LESS,"less-equal":e.LEQUAL,greater:e.GREATER,"greater-equal":e.GEQUAL},this._stencilOpsMapping={keep:e.KEEP,zero:e.ZERO,replace:e.REPLACE,invert:e.INVERT,"increment-clamp":e.INCR,"decrement-clamp":e.DECR,"increment-wrap":e.INCR_WRAP,"decrement-wrap":e.DECR_WRAP},this._stencilCache.enabled=!1,this._stencilCache.stencilMode=Me.NONE,this._stencilCache.stencilReference=0}onRenderTargetChange(e){if(this._activeRenderTarget===e)return;this._activeRenderTarget=e;let t=this._renderTargetStencilState[e.uid];t||(t=this._renderTargetStencilState[e.uid]={stencilMode:Me.DISABLED,stencilReference:0}),this.setStencilMode(t.stencilMode,t.stencilReference)}setStencilMode(e,t){const n=this._renderTargetStencilState[this._activeRenderTarget.uid],s=this._gl,i=lr[e],o=this._stencilCache;if(n.stencilMode=e,n.stencilReference=t,e===Me.DISABLED){this._stencilCache.enabled&&(this._stencilCache.enabled=!1,s.disable(s.STENCIL_TEST));return}this._stencilCache.enabled||(this._stencilCache.enabled=!0,s.enable(s.STENCIL_TEST)),(e!==o.stencilMode||o.stencilReference!==t)&&(o.stencilMode=e,o.stencilReference=t,s.stencilFunc(this._comparisonFuncMapping[i.stencilBack.compare],t,255),s.stencilOp(s.KEEP,s.KEEP,this._stencilOpsMapping[i.stencilBack.passOp]))}}Dh.extension={type:[M.WebGLSystem],name:"stencil"};class Lh{constructor(e){this._syncFunctionHash=Object.create(null),this._adaptor=e,this._systemCheck()}_systemCheck(){if(!gc())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}ensureUniformGroup(e){const t=this.getUniformGroupData(e);e.buffer||(e.buffer=new pt({data:new Float32Array(t.layout.size/4),usage:ae.UNIFORM|ae.COPY_DST}))}getUniformGroupData(e){return this._syncFunctionHash[e._signature]||this._initUniformGroup(e)}_initUniformGroup(e){const t=e._signature;let n=this._syncFunctionHash[t];if(!n){const s=Object.keys(e.uniformStructures).map(a=>e.uniformStructures[a]),i=this._adaptor.createUboElements(s),o=this._generateUboSync(i.uboElements);n=this._syncFunctionHash[t]={layout:i,syncFunction:o}}return this._syncFunctionHash[t]}_generateUboSync(e){return this._adaptor.generateUboSync(e)}syncUniformGroup(e,t,n){const s=this.getUniformGroupData(e);return e.buffer||(e.buffer=new pt({data:new Float32Array(s.layout.size/4),usage:ae.UNIFORM|ae.COPY_DST})),t||(t=e.buffer.data),n||(n=0),s.syncFunction(e.uniforms,t,n),!0}updateUniformGroup(e){if(e.isStatic&&!e._dirtyId)return!1;e._dirtyId=0;const t=this.syncUniformGroup(e);return e.buffer.update(),t}destroy(){this._syncFunctionHash=null}}const Nh={f32:4,"vec2<f32>":8,"vec3<f32>":12,"vec4<f32>":16,"mat2x2<f32>":16*2,"mat3x3<f32>":16*3,"mat4x4<f32>":16*4};function Xb(r){const e=r.map(i=>({data:i,offset:0,size:0}));let t=0,n=0,s=0;for(let i=0;i<e.length;i++){const o=e[i];if(t=Nh[o.data.type],!t)throw new Error(`Unknown type ${o.data.type}`);if(o.data.size>1&&(t=Math.max(t,16)*o.data.size),o.size=t,n%t!==0&&n<16){const a=n%t%16;n+=a,s+=a}n+t>16?(s=Math.ceil(s/16)*16,o.offset=s,s+=t,n=t):(o.offset=s,n+=t,s+=t)}return s=Math.ceil(s/16)*16,{uboElements:e,size:s}}const cr=[{type:"mat3x3<f32>",test:r=>r.value.a!==void 0,ubo:`
            var matrix = uv[name].toArray(true);
            data[offset] = matrix[0];
            data[offset + 1] = matrix[1];
            data[offset + 2] = matrix[2];
            data[offset + 4] = matrix[3];
            data[offset + 5] = matrix[4];
            data[offset + 6] = matrix[5];
            data[offset + 8] = matrix[6];
            data[offset + 9] = matrix[7];
            data[offset + 10] = matrix[8];
        `,uniform:` 
            gl.uniformMatrix3fv(ud[name].location, false, uv[name].toArray(true));
        `},{type:"vec4<f32>",test:r=>r.type==="vec4<f32>"&&r.size===1&&r.value.width!==void 0,ubo:`
            v = uv[name];
            data[offset] = v.x;
            data[offset + 1] = v.y;
            data[offset + 2] = v.width;
            data[offset + 3] = v.height;
        `,uniform:`
            cv = ud[name].value;
            v = uv[name];
            if (cv[0] !== v.x || cv[1] !== v.y || cv[2] !== v.width || cv[3] !== v.height) {
                cv[0] = v.x;
                cv[1] = v.y;
                cv[2] = v.width;
                cv[3] = v.height;
                gl.uniform4f(ud[name].location, v.x, v.y, v.width, v.height);
            }
        `},{type:"vec2<f32>",test:r=>r.type==="vec2<f32>"&&r.size===1&&r.value.x!==void 0,ubo:`
            v = uv[name];
            data[offset] = v.x;
            data[offset + 1] = v.y;
        `,uniform:`
            cv = ud[name].value;
            v = uv[name];
            if (cv[0] !== v.x || cv[1] !== v.y) {
                cv[0] = v.x;
                cv[1] = v.y;
                gl.uniform2f(ud[name].location, v.x, v.y);
            }
        `},{type:"vec4<f32>",test:r=>r.type==="vec4<f32>"&&r.size===1&&r.value.red!==void 0,ubo:`
            v = uv[name];
            data[offset] = v.red;
            data[offset + 1] = v.green;
            data[offset + 2] = v.blue;
            data[offset + 3] = v.alpha;
        `,uniform:`
            cv = ud[name].value;
            v = uv[name];
            if (cv[0] !== v.red || cv[1] !== v.green || cv[2] !== v.blue || cv[3] !== v.alpha) {
                cv[0] = v.red;
                cv[1] = v.green;
                cv[2] = v.blue;
                cv[3] = v.alpha;
                gl.uniform4f(ud[name].location, v.red, v.green, v.blue, v.alpha);
            }
        `},{type:"vec3<f32>",test:r=>r.type==="vec3<f32>"&&r.size===1&&r.value.red!==void 0,ubo:`
            v = uv[name];
            data[offset] = v.red;
            data[offset + 1] = v.green;
            data[offset + 2] = v.blue;
        `,uniform:`
            cv = ud[name].value;
            v = uv[name];
            if (cv[0] !== v.red || cv[1] !== v.green || cv[2] !== v.blue) {
                cv[0] = v.red;
                cv[1] = v.green;
                cv[2] = v.blue;
                gl.uniform3f(ud[name].location, v.red, v.green, v.blue);
            }
        `}];function Hh(r,e,t,n){const s=[`
        var v = null;
        var v2 = null;
        var t = 0;
        var index = 0;
        var name = null;
        var arrayOffset = null;
    `];let i=0;for(let a=0;a<r.length;a++){const l=r[a],c=l.data.name;let h=!1,u=0;for(let d=0;d<cr.length;d++)if(cr[d].test(l.data)){u=l.offset/4,s.push(`name = "${c}";`,`offset += ${u-i};`,cr[d][e]||cr[d].ubo),h=!0;break}if(!h)if(l.data.size>1)u=l.offset/4,s.push(t(l,u-i));else{const d=n[l.data.type];u=l.offset/4,s.push(`
                    v = uv.${c};
                    offset += ${u-i};
                    ${d};
                `)}i=u}const o=s.join(`
`);return new Function("uv","data","offset",o)}function Hr(r,e){return`
        for (let i = 0; i < ${r*e}; i++) {
            data[offset + (((i / ${r})|0) * 4) + (i % ${r})] = v[i];
        }
    `}const zh={f32:`
        data[offset] = v;`,i32:`
        data[offset] = v;`,"vec2<f32>":`
        data[offset] = v[0];
        data[offset + 1] = v[1];`,"vec3<f32>":`
        data[offset] = v[0];
        data[offset + 1] = v[1];
        data[offset + 2] = v[2];`,"vec4<f32>":`
        data[offset] = v[0];
        data[offset + 1] = v[1];
        data[offset + 2] = v[2];
        data[offset + 3] = v[3];`,"mat2x2<f32>":`
        data[offset] = v[0];
        data[offset + 1] = v[1];
        data[offset + 4] = v[2];
        data[offset + 5] = v[3];`,"mat3x3<f32>":`
        data[offset] = v[0];
        data[offset + 1] = v[1];
        data[offset + 2] = v[2];
        data[offset + 4] = v[3];
        data[offset + 5] = v[4];
        data[offset + 6] = v[5];
        data[offset + 8] = v[6];
        data[offset + 9] = v[7];
        data[offset + 10] = v[8];`,"mat4x4<f32>":`
        for (let i = 0; i < 16; i++) {
            data[offset + i] = v[i];
        }`,"mat3x2<f32>":Hr(3,2),"mat4x2<f32>":Hr(4,2),"mat2x3<f32>":Hr(2,3),"mat4x3<f32>":Hr(4,3),"mat2x4<f32>":Hr(2,4),"mat3x4<f32>":Hr(3,4)},Yb={...zh,"mat2x2<f32>":`
        data[offset] = v[0];
        data[offset + 1] = v[1];
        data[offset + 2] = v[2];
        data[offset + 3] = v[3];
    `};function jb(r,e){const t=Math.max(Nh[r.data.type]/16,1),n=r.data.value.length/r.data.size,s=(4-n%4)%4;return`
        v = uv.${r.data.name};
        offset += ${e};

        arrayOffset = offset;

        t = 0;

        for(var i=0; i < ${r.data.size*t}; i++)
        {
            for(var j = 0; j < ${n}; j++)
            {
                data[arrayOffset++] = v[t++];
            }
            ${s!==0?`arrayOffset += ${s};`:""}
        }
    `}function qb(r){return Hh(r,"uboStd40",jb,zh)}class $h extends Lh{constructor(){super({createUboElements:Xb,generateUboSync:qb})}}$h.extension={type:[M.WebGLSystem],name:"ubo"};class Kb{constructor(){this._clearColorCache=[0,0,0,0],this._viewPortCache=new he}init(e,t){this._renderer=e,this._renderTargetSystem=t,e.runners.contextChange.add(this)}contextChange(){this._clearColorCache=[0,0,0,0],this._viewPortCache=new he}copyToTexture(e,t,n,s,i){const o=this._renderTargetSystem,a=this._renderer,l=o.getGpuRenderTarget(e),c=a.gl;return this.finishRenderPass(e),c.bindFramebuffer(c.FRAMEBUFFER,l.resolveTargetFramebuffer),a.texture.bind(t,0),c.copyTexSubImage2D(c.TEXTURE_2D,0,i.x,i.y,n.x,n.y,s.width,s.height),t}startRenderPass(e,t=!0,n,s){const i=this._renderTargetSystem,o=e.colorTexture,a=i.getGpuRenderTarget(e);let l=s.y;e.isRoot&&(l=o.pixelHeight-s.height),e.colorTextures.forEach(u=>{this._renderer.texture.unbind(u)});const c=this._renderer.gl;c.bindFramebuffer(c.FRAMEBUFFER,a.framebuffer);const h=this._viewPortCache;(h.x!==s.x||h.y!==l||h.width!==s.width||h.height!==s.height)&&(h.x=s.x,h.y=l,h.width=s.width,h.height=s.height,c.viewport(s.x,l,s.width,s.height)),!a.depthStencilRenderBuffer&&(e.stencil||e.depth)&&this._initStencil(a),this.clear(e,t,n)}finishRenderPass(e){const n=this._renderTargetSystem.getGpuRenderTarget(e);if(!n.msaa)return;const s=this._renderer.gl;s.bindFramebuffer(s.FRAMEBUFFER,n.resolveTargetFramebuffer),s.bindFramebuffer(s.READ_FRAMEBUFFER,n.framebuffer),s.blitFramebuffer(0,0,n.width,n.height,0,0,n.width,n.height,s.COLOR_BUFFER_BIT,s.NEAREST),s.bindFramebuffer(s.FRAMEBUFFER,n.framebuffer)}initGpuRenderTarget(e){const t=this._renderer,n=t.gl,s=new Vb;return e.colorTexture.resource===t.gl.canvas?(s.framebuffer=null,s):(this._initColor(e,s),n.bindFramebuffer(n.FRAMEBUFFER,null),s)}destroyGpuRenderTarget(e){const t=this._renderer.gl;e.framebuffer&&(t.deleteFramebuffer(e.framebuffer),e.framebuffer=null),e.resolveTargetFramebuffer&&(t.deleteFramebuffer(e.resolveTargetFramebuffer),e.resolveTargetFramebuffer=null),e.depthStencilRenderBuffer&&(t.deleteRenderbuffer(e.depthStencilRenderBuffer),e.depthStencilRenderBuffer=null),e.msaaRenderBuffer.forEach(n=>{t.deleteRenderbuffer(n)}),e.msaaRenderBuffer=null}clear(e,t,n){if(!t)return;const s=this._renderTargetSystem;typeof t=="boolean"&&(t=t?Je.ALL:Je.NONE);const i=this._renderer.gl;if(t&Je.COLOR){n??(n=s.defaultClearColor);const o=this._clearColorCache,a=n;(o[0]!==a[0]||o[1]!==a[1]||o[2]!==a[2]||o[3]!==a[3])&&(o[0]=a[0],o[1]=a[1],o[2]=a[2],o[3]=a[3],i.clearColor(a[0],a[1],a[2],a[3]))}i.clear(t)}resizeGpuRenderTarget(e){if(e.isRoot)return;const n=this._renderTargetSystem.getGpuRenderTarget(e);this._resizeColor(e,n),e.stencil&&this._resizeStencil(n)}_initColor(e,t){const n=this._renderer,s=n.gl,i=s.createFramebuffer();if(t.resolveTargetFramebuffer=i,s.bindFramebuffer(s.FRAMEBUFFER,i),t.width=e.colorTexture.source.pixelWidth,t.height=e.colorTexture.source.pixelHeight,e.colorTextures.forEach((o,a)=>{const l=o.source;l.antialias&&(n.context.supports.msaa?t.msaa=!0:ne("[RenderTexture] Antialiasing on textures is not supported in WebGL1")),n.texture.bindSource(l,0);const h=n.texture.getGlSource(l).texture;s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+a,3553,h,0)}),t.msaa){const o=s.createFramebuffer();t.framebuffer=o,s.bindFramebuffer(s.FRAMEBUFFER,o),e.colorTextures.forEach((a,l)=>{const c=s.createRenderbuffer();t.msaaRenderBuffer[l]=c})}else t.framebuffer=i;this._resizeColor(e,t)}_resizeColor(e,t){const n=e.colorTexture.source;if(t.width=n.pixelWidth,t.height=n.pixelHeight,e.colorTextures.forEach((s,i)=>{i!==0&&s.source.resize(n.width,n.height,n._resolution)}),t.msaa){const s=this._renderer,i=s.gl,o=t.framebuffer;i.bindFramebuffer(i.FRAMEBUFFER,o),e.colorTextures.forEach((a,l)=>{const c=a.source;s.texture.bindSource(c,0);const u=s.texture.getGlSource(c).internalFormat,d=t.msaaRenderBuffer[l];i.bindRenderbuffer(i.RENDERBUFFER,d),i.renderbufferStorageMultisample(i.RENDERBUFFER,4,u,c.pixelWidth,c.pixelHeight),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+l,i.RENDERBUFFER,d)})}}_initStencil(e){if(e.framebuffer===null)return;const t=this._renderer.gl,n=t.createRenderbuffer();e.depthStencilRenderBuffer=n,t.bindRenderbuffer(t.RENDERBUFFER,n),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,n),this._resizeStencil(e)}_resizeStencil(e){const t=this._renderer.gl;t.bindRenderbuffer(t.RENDERBUFFER,e.depthStencilRenderBuffer),e.msaa?t.renderbufferStorageMultisample(t.RENDERBUFFER,4,t.DEPTH24_STENCIL8,e.width,e.height):t.renderbufferStorage(t.RENDERBUFFER,this._renderer.context.webGLVersion===2?t.DEPTH24_STENCIL8:t.DEPTH_STENCIL,e.width,e.height)}}function Zb(r,e,t,n,s,i){const o=i?1:-1;return r.identity(),r.a=1/n*2,r.d=o*(1/s*2),r.tx=-1-e*r.a,r.ty=-o-t*r.d,r}const vn=new Map;function Wh(r,e){if(!vn.has(r)){const t=new $({source:new Rr({resource:r,...e})}),n=()=>{vn.get(r)===t&&vn.delete(r)};t.once("destroy",n),t.source.once("destroy",n),vn.set(r,t)}return vn.get(r)}function Qb(r){const e=r.colorTexture.source.resource;return globalThis.HTMLCanvasElement&&e instanceof HTMLCanvasElement&&document.body.contains(e)}const Vh=class Vd{constructor(e={}){if(this.uid=be("renderTarget"),this.colorTextures=[],this.dirtyId=0,this.isRoot=!1,this._size=new Float32Array(2),this._managedColorTextures=!1,e={...Vd.defaultOptions,...e},this.stencil=e.stencil,this.depth=e.depth,this.isRoot=e.isRoot,typeof e.colorTextures=="number"){this._managedColorTextures=!0;for(let t=0;t<e.colorTextures;t++)this.colorTextures.push(new Ie({width:e.width,height:e.height,resolution:e.resolution,antialias:e.antialias}))}else{this.colorTextures=[...e.colorTextures.map(n=>n.source)];const t=this.colorTexture.source;this.resize(t.width,t.height,t._resolution)}this.colorTexture.source.on("resize",this.onSourceResize,this),(e.depthStencilTexture||this.stencil)&&(e.depthStencilTexture instanceof $||e.depthStencilTexture instanceof Ie?this.depthStencilTexture=e.depthStencilTexture.source:this.ensureDepthStencilTexture())}get size(){const e=this._size;return e[0]=this.pixelWidth,e[1]=this.pixelHeight,e}get width(){return this.colorTexture.source.width}get height(){return this.colorTexture.source.height}get pixelWidth(){return this.colorTexture.source.pixelWidth}get pixelHeight(){return this.colorTexture.source.pixelHeight}get resolution(){return this.colorTexture.source._resolution}get colorTexture(){return this.colorTextures[0]}onSourceResize(e){this.resize(e.width,e.height,e._resolution,!0)}ensureDepthStencilTexture(){this.depthStencilTexture||(this.depthStencilTexture=new Ie({width:this.width,height:this.height,resolution:this.resolution,format:"depth24plus-stencil8",autoGenerateMipmaps:!1,antialias:!1,mipLevelCount:1}))}resize(e,t,n=this.resolution,s=!1){this.dirtyId++,this.colorTextures.forEach((i,o)=>{s&&o===0||i.source.resize(e,t,n)}),this.depthStencilTexture&&this.depthStencilTexture.source.resize(e,t,n)}destroy(){this.colorTexture.source.off("resize",this.onSourceResize,this),this._managedColorTextures&&this.colorTextures.forEach(e=>{e.destroy()}),this.depthStencilTexture&&(this.depthStencilTexture.destroy(),delete this.depthStencilTexture)}};Vh.defaultOptions={width:0,height:0,resolution:1,colorTextures:1,stencil:!1,depth:!1,antialias:!1,isRoot:!1};let Eo=Vh;class Xh{constructor(e){this.rootViewPort=new he,this.viewport=new he,this.onRenderTargetChange=new vc("onRenderTargetChange"),this.projectionMatrix=new W,this.defaultClearColor=[0,0,0,0],this._renderSurfaceToRenderTargetHash=new Map,this._gpuRenderTargetHash=Object.create(null),this._renderTargetStack=[],this._renderer=e}finishRenderPass(){this.adaptor.finishRenderPass(this.renderTarget)}renderStart({target:e,clear:t,clearColor:n,frame:s}){this._renderTargetStack.length=0,this.push(e,t,n,s),this.rootViewPort.copyFrom(this.viewport),this.rootRenderTarget=this.renderTarget,this.renderingToScreen=Qb(this.rootRenderTarget)}bind(e,t=!0,n,s){const i=this.getRenderTarget(e),o=this.renderTarget!==i;this.renderTarget=i,this.renderSurface=e;const a=this.getGpuRenderTarget(i);(i.pixelWidth!==a.width||i.pixelHeight!==a.height)&&(this.adaptor.resizeGpuRenderTarget(i),a.width=i.pixelWidth,a.height=i.pixelHeight);const l=i.colorTexture,c=this.viewport,h=l.pixelWidth,u=l.pixelHeight;if(!s&&e instanceof $&&(s=e.frame),s){const d=l._resolution;c.x=s.x*d+.5|0,c.y=s.y*d+.5|0,c.width=s.width*d+.5|0,c.height=s.height*d+.5|0}else c.x=0,c.y=0,c.width=h,c.height=u;return Zb(this.projectionMatrix,0,0,c.width/l.resolution,c.height/l.resolution,!i.isRoot),this.adaptor.startRenderPass(i,t,n,c),o&&this.onRenderTargetChange.emit(i),i}clear(e,t=Je.ALL,n){t&&(e&&(e=this.getRenderTarget(e)),this.adaptor.clear(e||this.renderTarget,t,n,this.viewport))}contextChange(){this._gpuRenderTargetHash=Object.create(null)}push(e,t=Je.ALL,n,s){const i=this.bind(e,t,n,s);return this._renderTargetStack.push({renderTarget:i,frame:s}),i}pop(){this._renderTargetStack.pop();const e=this._renderTargetStack[this._renderTargetStack.length-1];this.bind(e.renderTarget,!1,null,e.frame)}getRenderTarget(e){return e.isTexture&&(e=e.source),this._renderSurfaceToRenderTargetHash.get(e)??this._initRenderTarget(e)}copyToTexture(e,t,n,s,i){n.x<0&&(s.width+=n.x,i.x-=n.x,n.x=0),n.y<0&&(s.height+=n.y,i.y-=n.y,n.y=0);const{pixelWidth:o,pixelHeight:a}=e;return s.width=Math.min(s.width,o-n.x),s.height=Math.min(s.height,a-n.y),this.adaptor.copyToTexture(e,t,n,s,i)}ensureDepthStencil(){this.renderTarget.stencil||(this.renderTarget.stencil=!0,this.adaptor.startRenderPass(this.renderTarget,!1,null,this.viewport))}destroy(){this._renderer=null,this._renderSurfaceToRenderTargetHash.forEach((e,t)=>{e!==t&&e.destroy()}),this._renderSurfaceToRenderTargetHash.clear(),this._gpuRenderTargetHash=Object.create(null)}_initRenderTarget(e){let t=null;return Rr.test(e)&&(e=Wh(e)),e instanceof Eo?t=e:e instanceof Ie&&(t=new Eo({colorTextures:[e]}),Rr.test(e.source.resource)&&(t.isRoot=!0),e.once("destroy",()=>{t.destroy();const n=this._gpuRenderTargetHash[t.uid];n&&(this._gpuRenderTargetHash[t.uid]=null,this.adaptor.destroyGpuRenderTarget(n))})),this._renderSurfaceToRenderTargetHash.set(e,t),t}getGpuRenderTarget(e){return this._gpuRenderTargetHash[e.uid]||(this._gpuRenderTargetHash[e.uid]=this.adaptor.initGpuRenderTarget(e))}}class Yh extends Xh{constructor(e){super(e),this.adaptor=new Kb,this.adaptor.init(e,this)}}Yh.extension={type:[M.WebGLSystem],name:"renderTarget"};class Po extends Ke{constructor({buffer:e,offset:t,size:n}){super(),this.uid=be("buffer"),this._resourceType="bufferResource",this._touched=0,this._resourceId=be("resource"),this._bufferResource=!0,this.destroyed=!1,this.buffer=e,this.offset=t|0,this.size=n,this.buffer.on("change",this.onBufferChange,this)}onBufferChange(){this._resourceId=be("resource"),this.emit("change",this)}destroy(e=!1){this.destroyed=!0,e&&this.buffer.destroy(),this.emit("change",this),this.buffer=null}}function Jb(r,e){const t=[],n=[`
        var g = s.groups;
        var sS = r.shader;
        var p = s.glProgram;
        var ugS = r.uniformGroup;
        var resources;
    `];let s=!1,i=0,o=0;const a=e._getProgramData(r.glProgram);for(const c in r.groups){const h=r.groups[c];t.push(`
            resources = g[${c}].resources;
        `);for(const u in h.resources){const d=h.resources[u];if(d instanceof Qe)d.ubo?t.push(`
                        sS.bindUniformBlock(
                            resources[${u}],
                            sS._uniformBindMap[${c}[${u}],
                            ${i++}
                        );
                    `):t.push(`
                        ugS.updateUniformGroup(resources[${u}], p, sD);
                    `);else if(d instanceof Po)t.push(`
                    sS.bindUniformBlock(
                        resources[${u}],
                        sS._uniformBindMap[${c}[${u}],
                        ${i++}
                    );
                `);else if(d instanceof Ie){const f=r._uniformBindMap[c][u],p=a.uniformData[f];p&&(s||(s=!0,n.push(`
                        var tS = r.texture;
                        `)),e._gl.uniform1i(p.location,o),t.push(`
                        tS.bind(resources[${u}], ${o});
                    `),o++)}}}const l=[...n,...t].join(`
`);return new Function("r","s","sD",l)}class ex{constructor(e,t){this.program=e,this.uniformData=t,this.uniformGroups={},this.uniformDirtyGroups={},this.uniformBlockBindings={}}destroy(){this.uniformData=null,this.uniformGroups=null,this.uniformDirtyGroups=null,this.uniformBlockBindings=null,this.program=null}}function jh(r,e,t){const n=r.createShader(e);return r.shaderSource(n,t),r.compileShader(n),n}function Ao(r){const e=new Array(r);for(let t=0;t<e.length;t++)e[t]=!1;return e}function qh(r,e){switch(r){case"float":return 0;case"vec2":return new Float32Array(2*e);case"vec3":return new Float32Array(3*e);case"vec4":return new Float32Array(4*e);case"int":case"uint":case"sampler2D":case"sampler2DArray":return 0;case"ivec2":return new Int32Array(2*e);case"ivec3":return new Int32Array(3*e);case"ivec4":return new Int32Array(4*e);case"uvec2":return new Uint32Array(2*e);case"uvec3":return new Uint32Array(3*e);case"uvec4":return new Uint32Array(4*e);case"bool":return!1;case"bvec2":return Ao(2*e);case"bvec3":return Ao(3*e);case"bvec4":return Ao(4*e);case"mat2":return new Float32Array([1,0,0,1]);case"mat3":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}let bs=null;const Kh={FLOAT:"float",FLOAT_VEC2:"vec2",FLOAT_VEC3:"vec3",FLOAT_VEC4:"vec4",INT:"int",INT_VEC2:"ivec2",INT_VEC3:"ivec3",INT_VEC4:"ivec4",UNSIGNED_INT:"uint",UNSIGNED_INT_VEC2:"uvec2",UNSIGNED_INT_VEC3:"uvec3",UNSIGNED_INT_VEC4:"uvec4",BOOL:"bool",BOOL_VEC2:"bvec2",BOOL_VEC3:"bvec3",BOOL_VEC4:"bvec4",FLOAT_MAT2:"mat2",FLOAT_MAT3:"mat3",FLOAT_MAT4:"mat4",SAMPLER_2D:"sampler2D",INT_SAMPLER_2D:"sampler2D",UNSIGNED_INT_SAMPLER_2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT_SAMPLER_CUBE:"samplerCube",UNSIGNED_INT_SAMPLER_CUBE:"samplerCube",SAMPLER_2D_ARRAY:"sampler2DArray",INT_SAMPLER_2D_ARRAY:"sampler2DArray",UNSIGNED_INT_SAMPLER_2D_ARRAY:"sampler2DArray"},tx={float:"float32",vec2:"float32x2",vec3:"float32x3",vec4:"float32x4",int:"sint32",ivec2:"sint32x2",ivec3:"sint32x3",ivec4:"sint32x4",uint:"uint32",uvec2:"uint32x2",uvec3:"uint32x3",uvec4:"uint32x4",bool:"uint32",bvec2:"uint32x2",bvec3:"uint32x3",bvec4:"uint32x4"};function Zh(r,e){if(!bs){const t=Object.keys(Kh);bs={};for(let n=0;n<t.length;++n){const s=t[n];bs[r[s]]=Kh[s]}}return bs[e]}function rx(r,e){const t=Zh(r,e);return tx[t]||"float32"}function nx(r,e,t=!1){const n={},s=e.getProgramParameter(r,e.ACTIVE_ATTRIBUTES);for(let o=0;o<s;o++){const a=e.getActiveAttrib(r,o);if(a.name.startsWith("gl_"))continue;const l=rx(e,a.type);n[a.name]={location:0,format:l,stride:sn(l).stride,offset:0,instance:!1,start:0}}const i=Object.keys(n);if(t){i.sort((o,a)=>o>a?1:-1);for(let o=0;o<i.length;o++)n[i[o]].location=o,e.bindAttribLocation(r,o,i[o]);e.linkProgram(r)}else for(let o=0;o<i.length;o++)n[i[o]].location=e.getAttribLocation(r,i[o]);return n}function sx(r,e){if(!e.ACTIVE_UNIFORM_BLOCKS)return{};const t={},n=e.getProgramParameter(r,e.ACTIVE_UNIFORM_BLOCKS);for(let s=0;s<n;s++){const i=e.getActiveUniformBlockName(r,s),o=e.getUniformBlockIndex(r,i),a=e.getActiveUniformBlockParameter(r,s,e.UNIFORM_BLOCK_DATA_SIZE);t[i]={name:i,index:o,size:a}}return t}function ix(r,e){const t={},n=e.getProgramParameter(r,e.ACTIVE_UNIFORMS);for(let s=0;s<n;s++){const i=e.getActiveUniform(r,s),o=i.name.replace(/\[.*?\]$/,""),a=!!i.name.match(/\[.*?\]$/),l=Zh(e,i.type);t[o]={name:o,index:s,type:l,size:i.size,isArray:a,value:qh(l,i.size)}}return t}function Qh(r,e){const t=r.getShaderSource(e).split(`
`).map((c,h)=>`${h}: ${c}`),n=r.getShaderInfoLog(e),s=n.split(`
`),i={},o=s.map(c=>parseFloat(c.replace(/^ERROR\: 0\:([\d]+)\:.*$/,"$1"))).filter(c=>c&&!i[c]?(i[c]=!0,!0):!1),a=[""];o.forEach(c=>{t[c-1]=`%c${t[c-1]}%c`,a.push("background: #FF0000; color:#FFFFFF; font-size: 10px","font-size: 10px")});const l=t.join(`
`);a[0]=l,console.error(n),console.groupCollapsed("click to view full shader code"),console.warn(...a),console.groupEnd()}function ox(r,e,t,n){r.getProgramParameter(e,r.LINK_STATUS)||(r.getShaderParameter(t,r.COMPILE_STATUS)||Qh(r,t),r.getShaderParameter(n,r.COMPILE_STATUS)||Qh(r,n),console.error("PixiJS Error: Could not initialize shader."),r.getProgramInfoLog(e)!==""&&console.warn("PixiJS Warning: gl.getProgramInfoLog()",r.getProgramInfoLog(e)))}function ax(r,e){const t=jh(r,r.VERTEX_SHADER,e.vertex),n=jh(r,r.FRAGMENT_SHADER,e.fragment),s=r.createProgram();r.attachShader(s,t),r.attachShader(s,n);const i=e.transformFeedbackVaryings;i&&(typeof r.transformFeedbackVaryings!="function"?ne("TransformFeedback is not supported but TransformFeedbackVaryings are given."):r.transformFeedbackVaryings(s,i.names,i.bufferMode==="separate"?r.SEPARATE_ATTRIBS:r.INTERLEAVED_ATTRIBS)),r.linkProgram(s),r.getProgramParameter(s,r.LINK_STATUS)||ox(r,s,t,n),e._attributeData=nx(s,r,!/^[ \t]*#[ \t]*version[ \t]+300[ \t]+es[ \t]*$/m.test(e.vertex)),e._uniformData=ix(s,r),e._uniformBlockData=sx(s,r),r.deleteShader(t),r.deleteShader(n);const o={};for(const l in e._uniformData){const c=e._uniformData[l];o[l]={location:r.getUniformLocation(s,l),value:qh(c.type,c.size)}}return new ex(s,o)}const xs={textureCount:0,blockIndex:0};class Jh{constructor(e){this._activeProgram=null,this._programDataHash=Object.create(null),this._nextIndex=0,this._boundUniformsIdsToIndexHash=Object.create(null),this._boundIndexToUniformsHash=Object.create(null),this._shaderSyncFunctions=Object.create(null),this._renderer=e}contextChange(e){this._gl=e,this._maxBindings=e.MAX_UNIFORM_BUFFER_BINDINGS?e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS):0,this._programDataHash=Object.create(null),this._boundUniformsIdsToIndexHash=Object.create(null),this._boundIndexToUniformsHash=Object.create(null),this._activeProgram=null}bind(e,t){if(this._setProgram(e.glProgram),t)return;xs.textureCount=0,xs.blockIndex=0;let n=this._shaderSyncFunctions[e.glProgram._key];n||(n=this._shaderSyncFunctions[e.glProgram._key]=this._generateShaderSync(e,this)),n(this._renderer,e,xs)}updateUniformGroup(e){this._renderer.uniformGroup.updateUniformGroup(e,this._activeProgram,xs)}bindUniformBlock(e,t,n=0){const s=this._renderer.buffer,i=this._getProgramData(this._activeProgram),o=e._bufferResource;o&&this._renderer.ubo.updateUniformGroup(e),s.updateBuffer(e.buffer);let a=this._boundUniformsIdsToIndexHash[e.uid];if(a===void 0){const h=this._nextIndex++%this._maxBindings,u=this._boundIndexToUniformsHash[h];u&&(this._boundUniformsIdsToIndexHash[u.uid]=void 0),a=this._boundUniformsIdsToIndexHash[e.uid]=h,this._boundIndexToUniformsHash[h]=e,o?s.bindBufferRange(e.buffer,h,e.offset):s.bindBufferBase(e.buffer,h)}const l=this._gl,c=this._activeProgram._uniformBlockData[t].index;i.uniformBlockBindings[n]!==a&&(i.uniformBlockBindings[n]=a,l.uniformBlockBinding(i.program,c,a))}_setProgram(e){if(this._activeProgram===e)return;this._activeProgram=e;const t=this._getProgramData(e);this._gl.useProgram(t.program)}_getProgramData(e){return this._programDataHash[e._key]||this._createProgramData(e)}_createProgramData(e){const t=e._key;return this._programDataHash[t]=ax(this._gl,e),this._programDataHash[t]}destroy(){for(const e of Object.keys(this._programDataHash))this._programDataHash[e].destroy(),this._programDataHash[e]=null;this._programDataHash=null,this._boundUniformsIdsToIndexHash=null}_generateShaderSync(e,t){return Jb(e,t)}}Jh.extension={type:[M.WebGLSystem],name:"shader"};const lx={f32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1f(location, v);
        }`,"vec2<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2f(location, v[0], v[1]);
        }`,"vec3<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3f(location, v[0], v[1], v[2]);
        }`,"vec4<f32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4f(location, v[0], v[1], v[2], v[3]);
        }`,i32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1i(location, v);
        }`,"vec2<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2i(location, v[0], v[1]);
        }`,"vec3<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3i(location, v[0], v[1], v[2]);
        }`,"vec4<i32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4i(location, v[0], v[1], v[2], v[3]);
        }`,u32:`if (cv !== v) {
            cu.value = v;
            gl.uniform1ui(location, v);
        }`,"vec2<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2ui(location, v[0], v[1]);
        }`,"vec3<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3ui(location, v[0], v[1], v[2]);
        }`,"vec4<u32>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4ui(location, v[0], v[1], v[2], v[3]);
        }`,bool:`if (cv !== v) {
            cu.value = v;
            gl.uniform1i(location, v);
        }`,"vec2<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1]) {
            cv[0] = v[0];
            cv[1] = v[1];
            gl.uniform2i(location, v[0], v[1]);
        }`,"vec3<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            gl.uniform3i(location, v[0], v[1], v[2]);
        }`,"vec4<bool>":`if (cv[0] !== v[0] || cv[1] !== v[1] || cv[2] !== v[2] || cv[3] !== v[3]) {
            cv[0] = v[0];
            cv[1] = v[1];
            cv[2] = v[2];
            cv[3] = v[3];
            gl.uniform4i(location, v[0], v[1], v[2], v[3]);
        }`,"mat2x2<f32>":"gl.uniformMatrix2fv(location, false, v);","mat3x3<f32>":"gl.uniformMatrix3fv(location, false, v);","mat4x4<f32>":"gl.uniformMatrix4fv(location, false, v);"},cx={f32:"gl.uniform1fv(location, v);","vec2<f32>":"gl.uniform2fv(location, v);","vec3<f32>":"gl.uniform3fv(location, v);","vec4<f32>":"gl.uniform4fv(location, v);","mat2x2<f32>":"gl.uniformMatrix2fv(location, false, v);","mat3x3<f32>":"gl.uniformMatrix3fv(location, false, v);","mat4x4<f32>":"gl.uniformMatrix4fv(location, false, v);",i32:"gl.uniform1iv(location, v);","vec2<i32>":"gl.uniform2iv(location, v);","vec3<i32>":"gl.uniform3iv(location, v);","vec4<i32>":"gl.uniform4iv(location, v);",u32:"gl.uniform1iv(location, v);","vec2<u32>":"gl.uniform2iv(location, v);","vec3<u32>":"gl.uniform3iv(location, v);","vec4<u32>":"gl.uniform4iv(location, v);",bool:"gl.uniform1iv(location, v);","vec2<bool>":"gl.uniform2iv(location, v);","vec3<bool>":"gl.uniform3iv(location, v);","vec4<bool>":"gl.uniform4iv(location, v);"};function hx(r,e){const t=[`
        var v = null;
        var cv = null;
        var cu = null;
        var t = 0;
        var gl = renderer.gl;
        var name = null;
    `];for(const n in r.uniforms){if(!e[n]){r.uniforms[n]instanceof Qe?r.uniforms[n].ubo?t.push(`
                        renderer.shader.bindUniformBlock(uv.${n}, "${n}");
                    `):t.push(`
                        renderer.shader.updateUniformGroup(uv.${n});
                    `):r.uniforms[n]instanceof Po&&t.push(`
                        renderer.shader.bindBufferResource(uv.${n}, "${n}");
                    `);continue}const s=r.uniformStructures[n];let i=!1;for(let o=0;o<cr.length;o++){const a=cr[o];if(s.type===a.type&&a.test(s)){t.push(`name = "${n}";`,cr[o].uniform),i=!0;break}}if(!i){const a=(s.size===1?lx:cx)[s.type].replace("location",`ud["${n}"].location`);t.push(`
            cu = ud["${n}"];
            cv = cu.value;
            v = uv["${n}"];
            ${a};`)}}return new Function("ud","uv","renderer","syncData",t.join(`
`))}class eu{constructor(e){this._cache={},this._uniformGroupSyncHash={},this._renderer=e,this.gl=null,this._cache={}}contextChange(e){this.gl=e}updateUniformGroup(e,t,n){const s=this._renderer.shader._getProgramData(t);(!e.isStatic||e._dirtyId!==s.uniformDirtyGroups[e.uid])&&(s.uniformDirtyGroups[e.uid]=e._dirtyId,this._getUniformSyncFunction(e,t)(s.uniformData,e.uniforms,this._renderer,n))}_getUniformSyncFunction(e,t){var n;return((n=this._uniformGroupSyncHash[e._signature])==null?void 0:n[t._key])||this._createUniformSyncFunction(e,t)}_createUniformSyncFunction(e,t){const n=this._uniformGroupSyncHash[e._signature]||(this._uniformGroupSyncHash[e._signature]={}),s=this._getSignature(e,t._uniformData,"u");return this._cache[s]||(this._cache[s]=this._generateUniformsSync(e,t._uniformData)),n[t._key]=this._cache[s],n[t._key]}_generateUniformsSync(e,t){return hx(e,t)}_getSignature(e,t,n){const s=e.uniforms,i=[`${n}-`];for(const o in s)i.push(o),t[o]&&i.push(t[o].type);return i.join("-")}destroy(){this._renderer=null,this._cache=null}}eu.extension={type:[M.WebGLSystem],name:"uniformGroup"};function ux(r){const e={};return e.normal=[r.ONE,r.ONE_MINUS_SRC_ALPHA],e.add=[r.ONE,r.ONE],e.multiply=[r.DST_COLOR,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA],e.screen=[r.ONE,r.ONE_MINUS_SRC_COLOR,r.ONE,r.ONE_MINUS_SRC_ALPHA],e.none=[0,0],e["normal-npm"]=[r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA],e["add-npm"]=[r.SRC_ALPHA,r.ONE,r.ONE,r.ONE],e["screen-npm"]=[r.SRC_ALPHA,r.ONE_MINUS_SRC_COLOR,r.ONE,r.ONE_MINUS_SRC_ALPHA],e.erase=[r.ZERO,r.ONE_MINUS_SRC_ALPHA],e}const dx=0,fx=1,px=2,mx=3,gx=4,_x=5,tu=class Jo{constructor(){this.gl=null,this.stateId=0,this.polygonOffset=0,this.blendMode="none",this._blendEq=!1,this.map=[],this.map[dx]=this.setBlend,this.map[fx]=this.setOffset,this.map[px]=this.setCullFace,this.map[mx]=this.setDepthTest,this.map[gx]=this.setFrontFace,this.map[_x]=this.setDepthMask,this.checks=[],this.defaultState=Dt.for2d()}contextChange(e){this.gl=e,this.blendModesMap=ux(e),this.reset()}set(e){if(e=e||this.defaultState,this.stateId!==e.data){let t=this.stateId^e.data,n=0;for(;t;)t&1&&this.map[n].call(this,!!(e.data&1<<n)),t=t>>1,n++;this.stateId=e.data}for(let t=0;t<this.checks.length;t++)this.checks[t](this,e)}forceState(e){e=e||this.defaultState;for(let t=0;t<this.map.length;t++)this.map[t].call(this,!!(e.data&1<<t));for(let t=0;t<this.checks.length;t++)this.checks[t](this,e);this.stateId=e.data}setBlend(e){this._updateCheck(Jo._checkBlendMode,e),this.gl[e?"enable":"disable"](this.gl.BLEND)}setOffset(e){this._updateCheck(Jo._checkPolygonOffset,e),this.gl[e?"enable":"disable"](this.gl.POLYGON_OFFSET_FILL)}setDepthTest(e){this.gl[e?"enable":"disable"](this.gl.DEPTH_TEST)}setDepthMask(e){this.gl.depthMask(e)}setCullFace(e){this.gl[e?"enable":"disable"](this.gl.CULL_FACE)}setFrontFace(e){this.gl.frontFace(this.gl[e?"CW":"CCW"])}setBlendMode(e){if(this.blendModesMap[e]||(e="normal"),e===this.blendMode)return;this.blendMode=e;const t=this.blendModesMap[e],n=this.gl;t.length===2?n.blendFunc(t[0],t[1]):n.blendFuncSeparate(t[0],t[1],t[2],t[3]),t.length===6?(this._blendEq=!0,n.blendEquationSeparate(t[4],t[5])):this._blendEq&&(this._blendEq=!1,n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD))}setPolygonOffset(e,t){this.gl.polygonOffset(e,t)}reset(){this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!1),this.forceState(this.defaultState),this._blendEq=!0,this.blendMode="",this.setBlendMode("normal")}_updateCheck(e,t){const n=this.checks.indexOf(e);t&&n===-1?this.checks.push(e):!t&&n!==-1&&this.checks.splice(n,1)}static _checkBlendMode(e,t){e.setBlendMode(t.blendMode)}static _checkPolygonOffset(e,t){e.setPolygonOffset(1,t.polygonOffset)}destroy(){this.gl=null,this.checks.length=0}};tu.extension={type:[M.WebGLSystem],name:"state"};let yx=tu;class bx{constructor(e){this.target=Ih.TEXTURE_2D,this.texture=e,this.width=-1,this.height=-1,this.type=se.UNSIGNED_BYTE,this.internalFormat=So.RGBA,this.format=So.RGBA,this.samplerType=0}}const xx={id:"image",upload(r,e,t){e.width===r.width||e.height===r.height?t.texSubImage2D(t.TEXTURE_2D,0,0,0,e.format,e.type,r.resource):t.texImage2D(e.target,0,e.internalFormat,r.width,r.height,0,e.format,e.type,r.resource),e.width=r.width,e.height=r.height}},vx={"bc1-rgba-unorm":!0,"bc1-rgba-unorm-srgb":!0,"bc2-rgba-unorm":!0,"bc2-rgba-unorm-srgb":!0,"bc3-rgba-unorm":!0,"bc3-rgba-unorm-srgb":!0,"bc4-r-unorm":!0,"bc4-r-snorm":!0,"bc5-rg-unorm":!0,"bc5-rg-snorm":!0,"bc6h-rgb-ufloat":!0,"bc6h-rgb-float":!0,"bc7-rgba-unorm":!0,"bc7-rgba-unorm-srgb":!0,"etc2-rgb8unorm":!0,"etc2-rgb8unorm-srgb":!0,"etc2-rgb8a1unorm":!0,"etc2-rgb8a1unorm-srgb":!0,"etc2-rgba8unorm":!0,"etc2-rgba8unorm-srgb":!0,"eac-r11unorm":!0,"eac-r11snorm":!0,"eac-rg11unorm":!0,"eac-rg11snorm":!0,"astc-4x4-unorm":!0,"astc-4x4-unorm-srgb":!0,"astc-5x4-unorm":!0,"astc-5x4-unorm-srgb":!0,"astc-5x5-unorm":!0,"astc-5x5-unorm-srgb":!0,"astc-6x5-unorm":!0,"astc-6x5-unorm-srgb":!0,"astc-6x6-unorm":!0,"astc-6x6-unorm-srgb":!0,"astc-8x5-unorm":!0,"astc-8x5-unorm-srgb":!0,"astc-8x6-unorm":!0,"astc-8x6-unorm-srgb":!0,"astc-8x8-unorm":!0,"astc-8x8-unorm-srgb":!0,"astc-10x5-unorm":!0,"astc-10x5-unorm-srgb":!0,"astc-10x6-unorm":!0,"astc-10x6-unorm-srgb":!0,"astc-10x8-unorm":!0,"astc-10x8-unorm-srgb":!0,"astc-10x10-unorm":!0,"astc-10x10-unorm-srgb":!0,"astc-12x10-unorm":!0,"astc-12x10-unorm-srgb":!0,"astc-12x12-unorm":!0,"astc-12x12-unorm-srgb":!0},wx={id:"compressed",upload(r,e,t){t.pixelStorei(t.UNPACK_ALIGNMENT,4);let n=r.pixelWidth,s=r.pixelHeight;const i=!!vx[r.format];for(let o=0;o<r.resource.length;o++){const a=r.resource[o];i?t.compressedTexImage2D(t.TEXTURE_2D,o,e.internalFormat,n,s,0,a):t.texImage2D(t.TEXTURE_2D,o,e.internalFormat,n,s,0,e.format,e.type,a),n=Math.max(n>>1,1),s=Math.max(s>>1,1)}}},ru={id:"image",upload(r,e,t,n){const s=r.alphaMode==="premultiply-alpha-on-upload";t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s);const i=e.width,o=e.height,a=r.pixelWidth,l=r.pixelHeight,c=r.resourceWidth,h=r.resourceHeight;c<a||h<l?((i!==a||o!==l)&&t.texImage2D(e.target,0,e.internalFormat,a,l,0,e.format,e.type,null),n===2?t.texSubImage2D(t.TEXTURE_2D,0,0,0,c,h,e.format,e.type,r.resource):t.texSubImage2D(t.TEXTURE_2D,0,0,0,e.format,e.type,r.resource)):i===a||o===l?t.texSubImage2D(t.TEXTURE_2D,0,0,0,e.format,e.type,r.resource):n===2?t.texImage2D(e.target,0,e.internalFormat,a,l,0,e.format,e.type,r.resource):t.texImage2D(e.target,0,e.internalFormat,e.format,e.type,r.resource),e.width=a,e.height=l}},Sx={id:"video",upload(r,e,t,n){if(!r.isValid){t.texImage2D(e.target,0,e.internalFormat,1,1,0,e.format,e.type,null);return}ru.upload(r,e,t,n)}},nu={linear:9729,nearest:9728},Tx={linear:{linear:9987,nearest:9985},nearest:{linear:9986,nearest:9984}},Mo={"clamp-to-edge":33071,repeat:10497,"mirror-repeat":33648},Ex={never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519};function su(r,e,t,n,s,i,o,a){const l=i;if(!a||r.addressModeU!=="repeat"||r.addressModeV!=="repeat"||r.addressModeW!=="repeat"){const c=Mo[o?"clamp-to-edge":r.addressModeU],h=Mo[o?"clamp-to-edge":r.addressModeV],u=Mo[o?"clamp-to-edge":r.addressModeW];e[s](l,e.TEXTURE_WRAP_S,c),e[s](l,e.TEXTURE_WRAP_T,h),e.TEXTURE_WRAP_R&&e[s](l,e.TEXTURE_WRAP_R,u)}if((!a||r.magFilter!=="linear")&&e[s](l,e.TEXTURE_MAG_FILTER,nu[r.magFilter]),t){if(!a||r.mipmapFilter!=="linear"){const c=Tx[r.minFilter][r.mipmapFilter];e[s](l,e.TEXTURE_MIN_FILTER,c)}}else e[s](l,e.TEXTURE_MIN_FILTER,nu[r.minFilter]);if(n&&r.maxAnisotropy>1){const c=Math.min(r.maxAnisotropy,e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT));e[s](l,n.TEXTURE_MAX_ANISOTROPY_EXT,c)}r.compare&&e[s](l,e.TEXTURE_COMPARE_FUNC,Ex[r.compare])}function Px(r){return{r8unorm:r.RED,r8snorm:r.RED,r8uint:r.RED,r8sint:r.RED,r16uint:r.RED,r16sint:r.RED,r16float:r.RED,rg8unorm:r.RG,rg8snorm:r.RG,rg8uint:r.RG,rg8sint:r.RG,r32uint:r.RED,r32sint:r.RED,r32float:r.RED,rg16uint:r.RG,rg16sint:r.RG,rg16float:r.RG,rgba8unorm:r.RGBA,"rgba8unorm-srgb":r.RGBA,rgba8snorm:r.RGBA,rgba8uint:r.RGBA,rgba8sint:r.RGBA,bgra8unorm:r.RGBA,"bgra8unorm-srgb":r.RGBA,rgb9e5ufloat:r.RGB,rgb10a2unorm:r.RGBA,rg11b10ufloat:r.RGB,rg32uint:r.RG,rg32sint:r.RG,rg32float:r.RG,rgba16uint:r.RGBA,rgba16sint:r.RGBA,rgba16float:r.RGBA,rgba32uint:r.RGBA,rgba32sint:r.RGBA,rgba32float:r.RGBA,stencil8:r.STENCIL_INDEX8,depth16unorm:r.DEPTH_COMPONENT,depth24plus:r.DEPTH_COMPONENT,"depth24plus-stencil8":r.DEPTH_STENCIL,depth32float:r.DEPTH_COMPONENT,"depth32float-stencil8":r.DEPTH_STENCIL}}function Ax(r,e){let t={},n=r.RGBA;return r instanceof xe.get().getWebGLRenderingContext()?e.srgb&&(t={"rgba8unorm-srgb":e.srgb.SRGB8_ALPHA8_EXT,"bgra8unorm-srgb":e.srgb.SRGB8_ALPHA8_EXT}):(t={"rgba8unorm-srgb":r.SRGB8_ALPHA8,"bgra8unorm-srgb":r.SRGB8_ALPHA8},n=r.RGBA8),{r8unorm:r.R8,r8snorm:r.R8_SNORM,r8uint:r.R8UI,r8sint:r.R8I,r16uint:r.R16UI,r16sint:r.R16I,r16float:r.R16F,rg8unorm:r.RG8,rg8snorm:r.RG8_SNORM,rg8uint:r.RG8UI,rg8sint:r.RG8I,r32uint:r.R32UI,r32sint:r.R32I,r32float:r.R32F,rg16uint:r.RG16UI,rg16sint:r.RG16I,rg16float:r.RG16F,rgba8unorm:r.RGBA,...t,rgba8snorm:r.RGBA8_SNORM,rgba8uint:r.RGBA8UI,rgba8sint:r.RGBA8I,bgra8unorm:n,rgb9e5ufloat:r.RGB9_E5,rgb10a2unorm:r.RGB10_A2,rg11b10ufloat:r.R11F_G11F_B10F,rg32uint:r.RG32UI,rg32sint:r.RG32I,rg32float:r.RG32F,rgba16uint:r.RGBA16UI,rgba16sint:r.RGBA16I,rgba16float:r.RGBA16F,rgba32uint:r.RGBA32UI,rgba32sint:r.RGBA32I,rgba32float:r.RGBA32F,stencil8:r.STENCIL_INDEX8,depth16unorm:r.DEPTH_COMPONENT16,depth24plus:r.DEPTH_COMPONENT24,"depth24plus-stencil8":r.DEPTH24_STENCIL8,depth32float:r.DEPTH_COMPONENT32F,"depth32float-stencil8":r.DEPTH32F_STENCIL8,...e.s3tc?{"bc1-rgba-unorm":e.s3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,"bc2-rgba-unorm":e.s3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,"bc3-rgba-unorm":e.s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT}:{},...e.s3tc_sRGB?{"bc1-rgba-unorm-srgb":e.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,"bc2-rgba-unorm-srgb":e.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT,"bc3-rgba-unorm-srgb":e.s3tc_sRGB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}:{},...e.rgtc?{"bc4-r-unorm":e.rgtc.COMPRESSED_RED_RGTC1_EXT,"bc4-r-snorm":e.rgtc.COMPRESSED_SIGNED_RED_RGTC1_EXT,"bc5-rg-unorm":e.rgtc.COMPRESSED_RED_GREEN_RGTC2_EXT,"bc5-rg-snorm":e.rgtc.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}:{},...e.bptc?{"bc6h-rgb-float":e.bptc.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT,"bc6h-rgb-ufloat":e.bptc.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT,"bc7-rgba-unorm":e.bptc.COMPRESSED_RGBA_BPTC_UNORM_EXT,"bc7-rgba-unorm-srgb":e.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT}:{},...e.etc?{"etc2-rgb8unorm":e.etc.COMPRESSED_RGB8_ETC2,"etc2-rgb8unorm-srgb":e.etc.COMPRESSED_SRGB8_ETC2,"etc2-rgb8a1unorm":e.etc.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,"etc2-rgb8a1unorm-srgb":e.etc.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,"etc2-rgba8unorm":e.etc.COMPRESSED_RGBA8_ETC2_EAC,"etc2-rgba8unorm-srgb":e.etc.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,"eac-r11unorm":e.etc.COMPRESSED_R11_EAC,"eac-rg11unorm":e.etc.COMPRESSED_SIGNED_RG11_EAC}:{},...e.astc?{"astc-4x4-unorm":e.astc.COMPRESSED_RGBA_ASTC_4x4_KHR,"astc-4x4-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,"astc-5x4-unorm":e.astc.COMPRESSED_RGBA_ASTC_5x4_KHR,"astc-5x4-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR,"astc-5x5-unorm":e.astc.COMPRESSED_RGBA_ASTC_5x5_KHR,"astc-5x5-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR,"astc-6x5-unorm":e.astc.COMPRESSED_RGBA_ASTC_6x5_KHR,"astc-6x5-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR,"astc-6x6-unorm":e.astc.COMPRESSED_RGBA_ASTC_6x6_KHR,"astc-6x6-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,"astc-8x5-unorm":e.astc.COMPRESSED_RGBA_ASTC_8x5_KHR,"astc-8x5-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR,"astc-8x6-unorm":e.astc.COMPRESSED_RGBA_ASTC_8x6_KHR,"astc-8x6-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR,"astc-8x8-unorm":e.astc.COMPRESSED_RGBA_ASTC_8x8_KHR,"astc-8x8-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,"astc-10x5-unorm":e.astc.COMPRESSED_RGBA_ASTC_10x5_KHR,"astc-10x5-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR,"astc-10x6-unorm":e.astc.COMPRESSED_RGBA_ASTC_10x6_KHR,"astc-10x6-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR,"astc-10x8-unorm":e.astc.COMPRESSED_RGBA_ASTC_10x8_KHR,"astc-10x8-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR,"astc-10x10-unorm":e.astc.COMPRESSED_RGBA_ASTC_10x10_KHR,"astc-10x10-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,"astc-12x10-unorm":e.astc.COMPRESSED_RGBA_ASTC_12x10_KHR,"astc-12x10-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR,"astc-12x12-unorm":e.astc.COMPRESSED_RGBA_ASTC_12x12_KHR,"astc-12x12-unorm-srgb":e.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR}:{}}}function Mx(r){return{r8unorm:r.UNSIGNED_BYTE,r8snorm:r.BYTE,r8uint:r.UNSIGNED_BYTE,r8sint:r.BYTE,r16uint:r.UNSIGNED_SHORT,r16sint:r.SHORT,r16float:r.HALF_FLOAT,rg8unorm:r.UNSIGNED_BYTE,rg8snorm:r.BYTE,rg8uint:r.UNSIGNED_BYTE,rg8sint:r.BYTE,r32uint:r.UNSIGNED_INT,r32sint:r.INT,r32float:r.FLOAT,rg16uint:r.UNSIGNED_SHORT,rg16sint:r.SHORT,rg16float:r.HALF_FLOAT,rgba8unorm:r.UNSIGNED_BYTE,"rgba8unorm-srgb":r.UNSIGNED_BYTE,rgba8snorm:r.BYTE,rgba8uint:r.UNSIGNED_BYTE,rgba8sint:r.BYTE,bgra8unorm:r.UNSIGNED_BYTE,"bgra8unorm-srgb":r.UNSIGNED_BYTE,rgb9e5ufloat:r.UNSIGNED_INT_5_9_9_9_REV,rgb10a2unorm:r.UNSIGNED_INT_2_10_10_10_REV,rg11b10ufloat:r.UNSIGNED_INT_10F_11F_11F_REV,rg32uint:r.UNSIGNED_INT,rg32sint:r.INT,rg32float:r.FLOAT,rgba16uint:r.UNSIGNED_SHORT,rgba16sint:r.SHORT,rgba16float:r.HALF_FLOAT,rgba32uint:r.UNSIGNED_INT,rgba32sint:r.INT,rgba32float:r.FLOAT,stencil8:r.UNSIGNED_BYTE,depth16unorm:r.UNSIGNED_SHORT,depth24plus:r.UNSIGNED_INT,"depth24plus-stencil8":r.UNSIGNED_INT_24_8,depth32float:r.FLOAT,"depth32float-stencil8":r.FLOAT_32_UNSIGNED_INT_24_8_REV}}const Cx=4;class iu{constructor(e){this.managedTextures=[],this._glTextures=Object.create(null),this._glSamplers=Object.create(null),this._boundTextures=[],this._activeTextureLocation=-1,this._boundSamplers=Object.create(null),this._uploads={image:ru,buffer:xx,video:Sx,compressed:wx},this._useSeparateSamplers=!1,this._renderer=e}contextChange(e){this._gl=e,this._mapFormatToInternalFormat||(this._mapFormatToInternalFormat=Ax(e,this._renderer.context.extensions),this._mapFormatToType=Mx(e),this._mapFormatToFormat=Px(e)),this._glTextures=Object.create(null),this._glSamplers=Object.create(null),this._boundSamplers=Object.create(null);for(let t=0;t<16;t++)this.bind($.EMPTY,t)}initSource(e){this.bind(e)}bind(e,t=0){const n=e.source;e?(this.bindSource(n,t),this._useSeparateSamplers&&this._bindSampler(n.style,t)):(this.bindSource(null,t),this._useSeparateSamplers&&this._bindSampler(null,t))}bindSource(e,t=0){const n=this._gl;if(e._touched=this._renderer.textureGC.count,this._boundTextures[t]!==e){this._boundTextures[t]=e,this._activateLocation(t),e=e||$.EMPTY.source;const s=this.getGlSource(e);n.bindTexture(s.target,s.texture)}}_bindSampler(e,t=0){const n=this._gl;if(!e){this._boundSamplers[t]=null,n.bindSampler(t,null);return}const s=this._getGlSampler(e);this._boundSamplers[t]!==s&&(this._boundSamplers[t]=s,n.bindSampler(t,s))}unbind(e){const t=e.source,n=this._boundTextures,s=this._gl;for(let i=0;i<n.length;i++)if(n[i]===t){this._activateLocation(i);const o=this.getGlSource(t);s.bindTexture(o.target,null),n[i]=null}}_activateLocation(e){this._activeTextureLocation!==e&&(this._activeTextureLocation=e,this._gl.activeTexture(this._gl.TEXTURE0+e))}_initSource(e){const t=this._gl,n=new bx(t.createTexture());if(n.type=this._mapFormatToType[e.format],n.internalFormat=this._mapFormatToInternalFormat[e.format],n.format=this._mapFormatToFormat[e.format],e.autoGenerateMipmaps&&(this._renderer.context.supports.nonPowOf2mipmaps||e.isPowerOfTwo)){const s=Math.max(e.width,e.height);e.mipLevelCount=Math.floor(Math.log2(s))+1}return this._glTextures[e.uid]=n,this.managedTextures.includes(e)||(e.on("update",this.onSourceUpdate,this),e.on("resize",this.onSourceUpdate,this),e.on("styleChange",this.onStyleChange,this),e.on("destroy",this.onSourceDestroy,this),e.on("unload",this.onSourceUnload,this),e.on("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.push(e)),this.onSourceUpdate(e),this.updateStyle(e,!1),n}onStyleChange(e){this.updateStyle(e,!1)}updateStyle(e,t){const n=this._gl,s=this.getGlSource(e);n.bindTexture(n.TEXTURE_2D,s.texture),this._boundTextures[this._activeTextureLocation]=e,su(e.style,n,e.mipLevelCount>1,this._renderer.context.extensions.anisotropicFiltering,"texParameteri",n.TEXTURE_2D,!this._renderer.context.supports.nonPowOf2wrapping&&!e.isPowerOfTwo,t)}onSourceUnload(e){const t=this._glTextures[e.uid];t&&(this.unbind(e),this._glTextures[e.uid]=null,this._gl.deleteTexture(t.texture))}onSourceUpdate(e){const t=this._gl,n=this.getGlSource(e);t.bindTexture(t.TEXTURE_2D,n.texture),this._boundTextures[this._activeTextureLocation]=e,this._uploads[e.uploadMethodId]?this._uploads[e.uploadMethodId].upload(e,n,t,this._renderer.context.webGLVersion):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.pixelWidth,e.pixelHeight,0,t.RGBA,t.UNSIGNED_BYTE,null),e.autoGenerateMipmaps&&e.mipLevelCount>1&&this.onUpdateMipmaps(e,!1)}onUpdateMipmaps(e,t=!0){t&&this.bindSource(e,0);const n=this.getGlSource(e);this._gl.generateMipmap(n.target)}onSourceDestroy(e){e.off("destroy",this.onSourceDestroy,this),e.off("update",this.onSourceUpdate,this),e.off("resize",this.onSourceUpdate,this),e.off("unload",this.onSourceUnload,this),e.off("styleChange",this.onStyleChange,this),e.off("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.splice(this.managedTextures.indexOf(e),1),this.onSourceUnload(e)}_initSampler(e){const t=this._gl,n=this._gl.createSampler();return this._glSamplers[e._resourceId]=n,su(e,t,this._boundTextures[this._activeTextureLocation].mipLevelCount>1,this._renderer.context.extensions.anisotropicFiltering,"samplerParameteri",n,!1,!0),this._glSamplers[e._resourceId]}_getGlSampler(e){return this._glSamplers[e._resourceId]||this._initSampler(e)}getGlSource(e){return this._glTextures[e.uid]||this._initSource(e)}generateCanvas(e){const{pixels:t,width:n,height:s}=this.getPixels(e),i=xe.get().createCanvas();i.width=n,i.height=s;const o=i.getContext("2d");if(o){const a=o.createImageData(n,s);a.data.set(t),o.putImageData(a,0,0)}return i}getPixels(e){const t=e.source.resolution,n=e.frame,s=Math.max(Math.round(n.width*t),1),i=Math.max(Math.round(n.height*t),1),o=new Uint8Array(Cx*s*i),a=this._renderer,l=a.renderTarget.getRenderTarget(e),c=a.renderTarget.getGpuRenderTarget(l),h=a.gl;return h.bindFramebuffer(h.FRAMEBUFFER,c.resolveTargetFramebuffer),h.readPixels(Math.round(n.x*t),Math.round(n.y*t),s,i,h.RGBA,h.UNSIGNED_BYTE,o),{pixels:new Uint8ClampedArray(o.buffer),width:s,height:i}}destroy(){this.managedTextures.slice().forEach(e=>this.onSourceDestroy(e)),this.managedTextures=null,this._renderer=null}}iu.extension={type:[M.WebGLSystem],name:"texture"};class ou{init(){const e=new Qe({uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uTransformMatrix:{value:new W,type:"mat3x3<f32>"},uRound:{value:0,type:"f32"}}),t=_n({name:"graphics",bits:[mo,bo(mt),vo,bn]});this.shader=new ot({glProgram:t,resources:{localUniforms:e,batchSamplers:xo}})}execute(e,t){const n=t.context,s=n.customShader||this.shader,i=e.renderer,o=i.graphicsContext,{geometry:a,instructions:l}=o.getContextRenderData(n);s.groups[0]=i.globalUniforms.bindGroup,i.state.set(e.state),i.shader.bind(s),i.geometry.bind(a,s.glProgram);const c=l.instructions;for(let h=0;h<l.instructionSize;h++){const u=c[h];if(u.size){for(let d=0;d<u.textures.textures.length;d++)i.texture.bind(u.textures.textures[d],d);i.geometry.draw("triangle-list",u.size,u.start)}}}destroy(){this.shader.destroy(!0),this.shader=null}}ou.extension={type:[M.WebGLPipesAdaptor],name:"graphics"};class au{init(){const e=_n({name:"mesh",bits:[vo,Ib,bn]});this._shader=new ot({glProgram:e,resources:{uTexture:$.EMPTY.source,textureUniforms:{uTextureMatrix:{type:"mat3x3<f32>",value:new W}}}})}execute(e,t){const n=e.renderer;let s=t._shader;if(s){if(!s.glProgram){ne("Mesh shader has no glProgram",t.shader);return}}else{s=this._shader;const i=t.texture,o=i.source;s.resources.uTexture=o,s.resources.uSampler=o.style,s.resources.textureUniforms.uniforms.uTextureMatrix=i.textureMatrix.mapCoord}s.groups[100]=n.globalUniforms.bindGroup,s.groups[101]=e.localUniformsBindGroup,n.encoder.draw({geometry:t._geometry,shader:s,state:t.state})}destroy(){this._shader.destroy(!0),this._shader=null}}au.extension={type:[M.WebGLPipesAdaptor],name:"mesh"};class lu{constructor(e){this._renderer=e}addRenderable(e,t){this._renderer.renderPipes.batch.break(t),t.add(e)}execute(e){e.isRenderable&&e.render(this._renderer)}destroy(){this._renderer=null}}lu.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"customRender"};function cu(r,e){const t=r.instructionSet,n=t.instructions;for(let s=0;s<t.instructionSize;s++){const i=n[s];e[i.renderPipeId].execute(i)}}class hu{constructor(e){this._renderer=e}addRenderGroup(e,t){this._renderer.renderPipes.batch.break(t),t.add(e)}execute(e){e.isRenderable&&(this._renderer.globalUniforms.push({worldTransformMatrix:e.worldTransform,worldColor:e.worldColorAlpha}),cu(e,this._renderer.renderPipes),this._renderer.globalUniforms.pop())}destroy(){this._renderer=null}}hu.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"renderGroup"};function uu(r,e=[]){e.push(r);for(let t=0;t<r.renderGroupChildren.length;t++)uu(r.renderGroupChildren[t],e);return e}function Bx(r,e,t){const n=r>>16&255,s=r>>8&255,i=r&255,o=e>>16&255,a=e>>8&255,l=e&255,c=n+(o-n)*t,h=s+(a-s)*t,u=i+(l-i)*t;return(c<<16)+(h<<8)+u}const Co=16777215;function du(r,e){return r===Co||e===Co?r+e-Co:Bx(r,e,.5)}const Rx=new Se;function fu(r,e=!1){kx(r);const t=r.childrenToUpdate,n=r.updateTick;r.updateTick++;for(const s in t){const i=t[s],o=i.list,a=i.index;for(let l=0;l<a;l++)pu(o[l],n,0);i.index=0}if(e)for(let s=0;s<r.renderGroupChildren.length;s++)fu(r.renderGroupChildren[s],e)}function kx(r){const e=r.root;let t;if(r.renderGroupParent){const n=r.renderGroupParent;r.worldTransform.appendFrom(e.relativeGroupTransform,n.worldTransform),r.worldColor=du(e.groupColor,n.worldColor),t=e.groupAlpha*n.worldAlpha}else r.worldTransform.copyFrom(e.localTransform),r.worldColor=e.localColor,t=e.localAlpha;t=t<0?0:t>1?1:t,r.worldAlpha=t,r.worldColorAlpha=r.worldColor+((t*255|0)<<24)}function pu(r,e,t){if(e===r.updateTick)return;r.updateTick=e,r.didChange=!1;const n=r.localTransform;r.updateLocalTransform();const s=r.parent;if(s&&!s.isRenderGroupRoot?(t=t|r._updateFlags,r.relativeGroupTransform.appendFrom(n,s.relativeGroupTransform),t&&mu(r,s,t)):(t=r._updateFlags,r.relativeGroupTransform.copyFrom(n),t&&mu(r,Rx,t)),!r.isRenderGroupRoot){const i=r.children,o=i.length;for(let l=0;l<o;l++)pu(i[l],e,t);const a=r.renderGroup;r.renderPipeId&&!a.structureDidChange&&a.updateRenderable(r)}}function mu(r,e,t){if(t&yi){r.groupColor=du(r.localColor,e.groupColor);let n=r.localAlpha*e.groupAlpha;n=n<0?0:n>1?1:n,r.groupAlpha=n,r.groupColorAlpha=r.groupColor+((n*255|0)<<24)}t&Ul&&(r.groupBlendMode=r.localBlendMode==="inherit"?e.groupBlendMode:r.localBlendMode),t&Kn&&(r.globalDisplayStatus=r.localDisplayStatus&e.globalDisplayStatus),r._updateFlags=0}function Ix(r,e){const{list:t,index:n}=r.childrenRenderablesToUpdate;let s=!1;for(let i=0;i<n;i++){const o=t[i];if(s=e[o.renderPipeId].validateRenderable(o),s)break}return r.structureDidChange=s,s}const Gx=new W;class gu{constructor(e){this._renderer=e}render({container:e,transform:t}){e.isRenderGroup=!0;const n=e.parent,s=e.renderGroup.renderGroupParent;e.parent=null,e.renderGroup.renderGroupParent=null;const i=this._renderer,o=uu(e.renderGroup,[]);let a=Gx;t&&(a=a.copyFrom(e.renderGroup.localTransform),e.renderGroup.localTransform.copyFrom(t));const l=i.renderPipes;for(let c=0;c<o.length;c++){const h=o[c];h.runOnRender(),h.instructionSet.renderPipes=l,h.structureDidChange||Ix(h,l),fu(h),h.structureDidChange?(h.structureDidChange=!1,Gb(h,l)):Ux(h),h.childrenRenderablesToUpdate.index=0,i.renderPipes.batch.upload(h.instructionSet)}i.globalUniforms.start({worldTransformMatrix:t?e.renderGroup.localTransform:e.renderGroup.worldTransform,worldColor:e.renderGroup.worldColorAlpha}),cu(e.renderGroup,l),l.uniformBatch&&l.uniformBatch.renderEnd(),t&&e.renderGroup.localTransform.copyFrom(a),e.parent=n,e.renderGroup.renderGroupParent=s}destroy(){this._renderer=null}}gu.extension={type:[M.WebGLSystem,M.WebGPUSystem,M.CanvasSystem],name:"renderGroup"};function Ux(r){const{list:e,index:t}=r.childrenRenderablesToUpdate;for(let n=0;n<t;n++){const s=e[n];s.didViewUpdate&&r.updateRenderable(s)}}class Bo{constructor(){this.vertexSize=4,this.indexSize=6,this.location=0,this.batcher=null,this.batch=null,this.roundPixels=0}get blendMode(){return this.renderable.groupBlendMode}packAttributes(e,t,n,s){const i=this.renderable,o=this.texture,a=i.groupTransform,l=a.a,c=a.b,h=a.c,u=a.d,d=a.tx,f=a.ty,p=this.bounds,g=p.maxX,m=p.minX,_=p.maxY,b=p.minY,y=o.uvs,x=i.groupColorAlpha,S=s<<16|this.roundPixels&65535;e[n+0]=l*m+h*b+d,e[n+1]=u*b+c*m+f,e[n+2]=y.x0,e[n+3]=y.y0,t[n+4]=x,t[n+5]=S,e[n+6]=l*g+h*b+d,e[n+7]=u*b+c*g+f,e[n+8]=y.x1,e[n+9]=y.y1,t[n+10]=x,t[n+11]=S,e[n+12]=l*g+h*_+d,e[n+13]=u*_+c*g+f,e[n+14]=y.x2,e[n+15]=y.y2,t[n+16]=x,t[n+17]=S,e[n+18]=l*m+h*_+d,e[n+19]=u*_+c*m+f,e[n+20]=y.x3,e[n+21]=y.y3,t[n+22]=x,t[n+23]=S}packIndex(e,t,n){e[t]=n+0,e[t+1]=n+1,e[t+2]=n+2,e[t+3]=n+0,e[t+4]=n+2,e[t+5]=n+3}reset(){this.renderable=null,this.texture=null,this.batcher=null,this.batch=null,this.bounds=null}}class _u{constructor(e){this._gpuSpriteHash=Object.create(null),this._renderer=e}addRenderable(e,t){const n=this._getGpuSprite(e);e._didSpriteUpdate&&this._updateBatchableSprite(e,n),this._renderer.renderPipes.batch.addToBatch(n)}updateRenderable(e){const t=this._gpuSpriteHash[e.uid];e._didSpriteUpdate&&this._updateBatchableSprite(e,t),t.batcher.updateElement(t)}validateRenderable(e){const t=e._texture,n=this._getGpuSprite(e);return n.texture._source!==t._source?!n.batcher.checkAndUpdateTexture(n,t):!1}destroyRenderable(e){const t=this._gpuSpriteHash[e.uid];oe.return(t),this._gpuSpriteHash[e.uid]=null}_updateBatchableSprite(e,t){e._didSpriteUpdate=!1,t.bounds=e.bounds,t.texture=e._texture}_getGpuSprite(e){return this._gpuSpriteHash[e.uid]||this._initGPUSprite(e)}_initGPUSprite(e){const t=oe.get(Bo);return t.renderable=e,t.texture=e._texture,t.bounds=e.bounds,t.roundPixels=this._renderer._roundPixels|e._roundPixels,this._gpuSpriteHash[e.uid]=t,e._didSpriteUpdate=!1,e.on("destroyed",()=>{this.destroyRenderable(e)}),t}destroy(){for(const e in this._gpuSpriteHash)oe.return(this._gpuSpriteHash[e]);this._gpuSpriteHash=null,this._renderer=null}}_u.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"sprite"};const Ro=class Xd{constructor(){this.clearBeforeRender=!0,this._backgroundColor=new ue(0),this.color=this._backgroundColor,this.alpha=1}init(e){e={...Xd.defaultOptions,...e},this.clearBeforeRender=e.clearBeforeRender,this.color=e.background||e.backgroundColor||this._backgroundColor,this.alpha=e.backgroundAlpha,this._backgroundColor.setAlpha(e.backgroundAlpha)}get color(){return this._backgroundColor}set color(e){this._backgroundColor.setValue(e)}get alpha(){return this._backgroundColor.alpha}set alpha(e){this._backgroundColor.setAlpha(e)}get colorRgba(){return this._backgroundColor.toArray()}destroy(){}};Ro.extension={type:[M.WebGLSystem,M.WebGPUSystem,M.CanvasSystem],name:"background",priority:0},Ro.defaultOptions={backgroundAlpha:1,backgroundColor:0,clearBeforeRender:!0};let Fx=Ro;const wn={};re.handle(M.BlendMode,r=>{if(!r.name)throw new Error("BlendMode extension must have a name property");wn[r.name]=r.ref},r=>{delete wn[r.name]});class yu{constructor(e){this._isAdvanced=!1,this._filterHash=Object.create(null),this._renderer=e}setBlendMode(e,t,n){if(this._activeBlendMode===t){this._isAdvanced&&this._renderableList.push(e);return}this._activeBlendMode=t,this._isAdvanced&&this._endAdvancedBlendMode(n),this._isAdvanced=!!wn[t],this._isAdvanced&&(this._beginAdvancedBlendMode(n),this._renderableList.push(e))}_beginAdvancedBlendMode(e){this._renderer.renderPipes.batch.break(e);const t=this._activeBlendMode;if(!wn[t]){ne(`Unable to assign BlendMode: '${t}'. You may want to include: import 'pixi.js/advanced-blend-modes'`);return}this._filterHash[t]||(this._filterHash[t]=new ci({filters:[new wn[t]]}));const n={renderPipeId:"filter",action:"pushFilter",renderables:[],filterEffect:this._filterHash[t],canBundle:!1};this._renderableList=n.renderables,e.add(n)}_endAdvancedBlendMode(e){this._renderableList=null,this._renderer.renderPipes.batch.break(e),e.add({renderPipeId:"filter",action:"popFilter",canBundle:!1})}buildStart(){this._isAdvanced=!1}buildEnd(e){this._isAdvanced&&this._endAdvancedBlendMode(e)}destroy(){this._renderer=null,this._renderableList=null;for(const e in this._filterHash)this._filterHash[e].destroy();this._filterHash=null}}yu.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"blendMode"};const ko={png:"image/png",jpg:"image/jpeg",webp:"image/webp"},Io=class Yd{constructor(e){this._renderer=e}_normalizeOptions(e,t={}){return e instanceof Se||e instanceof $?{target:e,...t}:{...t,...e}}async image(e){const t=new Image;return t.src=await this.base64(e),t}async base64(e){e=this._normalizeOptions(e,Yd.defaultImageOptions);const{format:t,quality:n}=e,s=this.canvas(e);if(s.toBlob!==void 0)return new Promise((i,o)=>{s.toBlob(a=>{if(!a){o(new Error("ICanvas.toBlob failed!"));return}const l=new FileReader;l.onload=()=>i(l.result),l.onerror=o,l.readAsDataURL(a)},ko[t],n)});if(s.toDataURL!==void 0)return s.toDataURL(ko[t],n);if(s.convertToBlob!==void 0){const i=await s.convertToBlob({type:ko[t],quality:n});return new Promise((o,a)=>{const l=new FileReader;l.onload=()=>o(l.result),l.onerror=a,l.readAsDataURL(i)})}throw new Error("Extract.base64() requires ICanvas.toDataURL, ICanvas.toBlob, or ICanvas.convertToBlob to be implemented")}canvas(e){e=this._normalizeOptions(e);const t=e.target,n=this._renderer;if(t instanceof $)return n.texture.generateCanvas(t);const s=n.textureGenerator.generateTexture(e),i=n.texture.generateCanvas(s);return s.destroy(),i}pixels(e){e=this._normalizeOptions(e);const t=e.target,n=this._renderer,s=t instanceof $?t:n.textureGenerator.generateTexture(e),i=n.texture.getPixels(s);return t instanceof Se&&s.destroy(),i}texture(e){return e=this._normalizeOptions(e),e.target instanceof $?e.target:this._renderer.textureGenerator.generateTexture(e)}download(e){e=this._normalizeOptions(e);const t=this.canvas(e),n=document.createElement("a");n.download=e.filename??"image.png",n.href=t.toDataURL("image/png"),document.body.appendChild(n),n.click(),document.body.removeChild(n)}log(e){const t=e.width??200;e=this._normalizeOptions(e);const n=this.canvas(e),s=n.toDataURL();console.log(`[Pixi Texture] ${n.width}px ${n.height}px`);const i=["font-size: 1px;",`padding: ${t}px 300px;`,`background: url(${s}) no-repeat;`,"background-size: contain;"].join(" ");console.log("%c ",i)}destroy(){this._renderer=null}};Io.extension={type:[M.WebGLSystem,M.WebGPUSystem],name:"extract"},Io.defaultImageOptions={format:"png",quality:1};let Ox=Io;class Dx extends ${static create(e){return new $({source:new Ie(e)})}resize(e,t,n){return this.source.resize(e,t,n),this}}const Lx=new he,Nx=new Ze,Hx=[0,0,0,0];class bu{constructor(e){this._renderer=e}generateTexture(e){var c;e instanceof Se&&(e={target:e,frame:void 0,textureSourceOptions:{},resolution:void 0});const t=e.resolution||this._renderer.resolution,n=e.antialias||this._renderer.view.antialias,s=e.target;let i=e.clearColor;i?i=Array.isArray(i)&&i.length===4?i:ue.shared.setValue(i).toArray():i=Hx;const o=((c=e.frame)==null?void 0:c.copyTo(Lx))||pi(s,Nx).rectangle;o.width=Math.max(o.width,1/t)|0,o.height=Math.max(o.height,1/t)|0;const a=Dx.create({...e.textureSourceOptions,width:o.width,height:o.height,resolution:t,antialias:n}),l=W.shared.translate(-o.x,-o.y);return this._renderer.render({container:s,transform:l,target:a,clearColor:i}),a}destroy(){this._renderer=null}}bu.extension={type:[M.WebGLSystem,M.WebGPUSystem],name:"textureGenerator"};function vs(r,e,t){const n=(r>>24&255)/255;e[t++]=(r&255)/255*n,e[t++]=(r>>8&255)/255*n,e[t++]=(r>>16&255)/255*n,e[t++]=n}class xu{constructor(e){this._stackIndex=0,this._globalUniformDataStack=[],this._uniformsPool=[],this._activeUniforms=[],this._bindGroupPool=[],this._activeBindGroups=[],this._renderer=e}reset(){this._stackIndex=0;for(let e=0;e<this._activeUniforms.length;e++)this._uniformsPool.push(this._activeUniforms[e]);for(let e=0;e<this._activeBindGroups.length;e++)this._bindGroupPool.push(this._activeBindGroups[e]);this._activeUniforms.length=0,this._activeBindGroups.length=0}start(e){this.reset(),this.push(e)}bind({size:e,projectionMatrix:t,worldTransformMatrix:n,worldColor:s,offset:i}){const o=this._renderer.renderTarget.renderTarget,a=this._stackIndex?this._globalUniformDataStack[this._stackIndex-1]:{projectionData:o,worldTransformMatrix:new W,worldColor:4294967295,offset:new ce},l={projectionMatrix:t||this._renderer.renderTarget.projectionMatrix,resolution:e||o.size,worldTransformMatrix:n||a.worldTransformMatrix,worldColor:s||a.worldColor,offset:i||a.offset,bindGroup:null},c=this._uniformsPool.pop()||this._createUniforms();this._activeUniforms.push(c);const h=c.uniforms;h.uProjectionMatrix=l.projectionMatrix,h.uResolution=l.resolution,h.uWorldTransformMatrix.copyFrom(l.worldTransformMatrix),h.uWorldTransformMatrix.tx-=l.offset.x,h.uWorldTransformMatrix.ty-=l.offset.y,vs(l.worldColor,h.uWorldColorAlpha,0),c.update();let u;this._renderer.renderPipes.uniformBatch?u=this._renderer.renderPipes.uniformBatch.getUniformBindGroup(c,!1):(u=this._bindGroupPool.pop()||new Ot,this._activeBindGroups.push(u),u.setResource(c,0)),l.bindGroup=u,this._currentGlobalUniformData=l}push(e){this.bind(e),this._globalUniformDataStack[this._stackIndex++]=this._currentGlobalUniformData}pop(){this._currentGlobalUniformData=this._globalUniformDataStack[--this._stackIndex-1],this._renderer.type===Et.WEBGL&&this._currentGlobalUniformData.bindGroup.resources[0].update()}get bindGroup(){return this._currentGlobalUniformData.bindGroup}get uniformGroup(){return this._currentGlobalUniformData.bindGroup.resources[0]}_createUniforms(){return new Qe({uProjectionMatrix:{value:new W,type:"mat3x3<f32>"},uWorldTransformMatrix:{value:new W,type:"mat3x3<f32>"},uWorldColorAlpha:{value:new Float32Array(4),type:"vec4<f32>"},uResolution:{value:[0,0],type:"vec2<f32>"}},{isStatic:!0})}destroy(){this._renderer=null}}xu.extension={type:[M.WebGLSystem,M.WebGPUSystem,M.CanvasSystem],name:"globalUniforms"};let vu=!1;const wu="8.1.1";function zx(r){if(!vu){if(xe.get().getNavigator().userAgent.toLowerCase().indexOf("chrome")>-1){const e=[`%c  %c  %c  %c  %c PixiJS %c v${wu} (${r}) http://www.pixijs.com/

`,"background: #E72264; padding:5px 0;","background: #6CA2EA; padding:5px 0;","background: #B5D33D; padding:5px 0;","background: #FED23F; padding:5px 0;","color: #FFFFFF; background: #E72264; padding:5px 0;","color: #E72264; background: #FFFFFF; padding:5px 0;"];globalThis.console.log(...e)}else globalThis.console&&globalThis.console.log(`PixiJS ${wu} - ${r} - http://www.pixijs.com/`);vu=!0}}class Go{constructor(e){this._renderer=e}init(e){if(e.hello){let t=this._renderer.name;this._renderer.type===Et.WEBGL&&(t+=` ${this._renderer.context.webGLVersion}`),zx(t)}}}Go.extension={type:[M.WebGLSystem,M.WebGPUSystem,M.CanvasSystem],name:"hello",priority:-2},Go.defaultOptions={hello:!1};const Uo=class jd{constructor(e){this._renderer=e,this.count=0,this.checkCount=0}init(e){e={...jd.defaultOptions,...e},this.checkCountMax=e.textureGCCheckCountMax,this.maxIdle=e.textureGCAMaxIdle,this.active=e.textureGCActive}postrender(){this._renderer.renderingToScreen&&(this.count++,this.active&&(this.checkCount++,this.checkCount>this.checkCountMax&&(this.checkCount=0,this.run())))}run(){const e=this._renderer.texture.managedTextures;for(let t=0;t<e.length;t++){const n=e[t];n.autoGarbageCollect&&n.resource&&n._touched>-1&&this.count-n._touched>this.maxIdle&&(n._touched=-1,n.unload())}}destroy(){this._renderer=null}};Uo.extension={type:[M.WebGLSystem,M.WebGPUSystem],name:"textureGC"},Uo.defaultOptions={textureGCActive:!0,textureGCAMaxIdle:60*60,textureGCCheckCountMax:600};let Su=Uo;re.add(Su);const Fo=class qd{get resolution(){return this.texture.source._resolution}set resolution(e){this.texture.source.resize(this.texture.source.width,this.texture.source.height,e)}init(e){e={...qd.defaultOptions,...e},e.view&&(ie(le,"ViewSystem.view has been renamed to ViewSystem.canvas"),e.canvas=e.view),this.screen=new he(0,0,e.width,e.height),this.canvas=e.canvas||xe.get().createCanvas(),this.antialias=!!e.antialias,this.texture=Wh(this.canvas,e),this.renderTarget=new Eo({colorTextures:[this.texture],depth:!!e.depth,isRoot:!0}),this.texture.source.transparent=e.backgroundAlpha<1,this.multiView=!!e.multiView,this.autoDensity&&(this.canvas.style.width=`${this.texture.width}px`,this.canvas.style.height=`${this.texture.height}px`),this.resolution=e.resolution}resize(e,t,n){this.texture.source.resize(e,t,n),this.screen.width=this.texture.frame.width,this.screen.height=this.texture.frame.height,this.autoDensity&&(this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`)}destroy(e=!1){(typeof e=="boolean"?e:!!(e!=null&&e.removeView))&&this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas)}};Fo.extension={type:[M.WebGLSystem,M.WebGPUSystem,M.CanvasSystem],name:"view",priority:0},Fo.defaultOptions={width:800,height:600,autoDensity:!1,antialias:!1};const Tu=[Fx,xu,Go,Fo,gu,Su,bu,Ox],Eu=[yu,Ph,_u,hu,Mh,Bh,Ch,lu],$x=[...Tu,$h,Wb,Lb,Rh,iu,Yh,Uh,eu,Jh,Oh,yx,Dh,Fh],Wx=[...Eu],Vx=[Th,au,ou],Pu=[],Au=[],Mu=[];re.handleByNamedList(M.WebGLSystem,Pu),re.handleByNamedList(M.WebGLPipes,Au),re.handleByNamedList(M.WebGLPipesAdaptor,Mu),re.add(...$x,...Wx,...Vx);class Xx extends as{constructor(){const e={name:"webgl",type:Et.WEBGL,systems:Pu,renderPipes:Au,renderPipeAdaptors:Mu};super(e)}}const Yx=Object.freeze(Object.defineProperty({__proto__:null,WebGLRenderer:Xx},Symbol.toStringTag,{value:"Module"}));class Cu{constructor(e){this._hash=Object.create(null),this._renderer=e}contextChange(e){this._gpu=e}getBindGroup(e,t,n){return e._updateKey(),this._hash[e._key]||this._createBindGroup(e,t,n)}_createBindGroup(e,t,n){const s=this._gpu.device,i=t.layout[n],o=[],a=this._renderer;for(const h in i){const u=e.resources[h]??e.resources[i[h]];let d;if(u._resourceType==="uniformGroup"){const f=u;a.ubo.updateUniformGroup(f);const p=f.buffer;d={buffer:a.buffer.getGPUBuffer(p),offset:0,size:p.descriptor.size}}else if(u._resourceType==="buffer"){const f=u;d={buffer:a.buffer.getGPUBuffer(f),offset:0,size:f.descriptor.size}}else if(u._resourceType==="bufferResource"){const f=u;d={buffer:a.buffer.getGPUBuffer(f.buffer),offset:f.offset,size:f.size}}else if(u._resourceType==="textureSampler"){const f=u;d=a.texture.getGpuSampler(f)}else if(u._resourceType==="textureSource"){const f=u;d=a.texture.getGpuSource(f).createView({})}o.push({binding:i[h],resource:d})}const l=a.shader.getProgramData(t).bindGroups[n],c=s.createBindGroup({layout:l,entries:o});return this._hash[e._key]=c,c}destroy(){for(const e of Object.keys(this._hash))this._hash[e]=null;this._hash=null,this._renderer=null}}Cu.extension={type:[M.WebGPUSystem],name:"bindGroup"};class Bu{constructor(){this._gpuBuffers=Object.create(null),this._managedBuffers=[]}contextChange(e){this._gpu=e}getGPUBuffer(e){return this._gpuBuffers[e.uid]||this.createGPUBuffer(e)}updateBuffer(e){const t=this._gpuBuffers[e.uid]||this.createGPUBuffer(e),n=e.data;return e._updateID&&n&&(e._updateID=0,this._gpu.device.queue.writeBuffer(t,0,n.buffer,0,(e._updateSize||n.byteLength)+3&-4)),t}destroyAll(){for(const e in this._gpuBuffers)this._gpuBuffers[e].destroy();this._gpuBuffers={}}createGPUBuffer(e){this._gpuBuffers[e.uid]||(e.on("update",this.updateBuffer,this),e.on("change",this.onBufferChange,this),e.on("destroy",this.onBufferDestroy,this));const t=this._gpu.device.createBuffer(e.descriptor);return e._updateID=0,e.data&&(ji(e.data.buffer,t.getMappedRange()),t.unmap()),this._gpuBuffers[e.uid]=t,this._managedBuffers.push(e),t}onBufferChange(e){this._gpuBuffers[e.uid].destroy(),e._updateID=0,this._gpuBuffers[e.uid]=this.createGPUBuffer(e)}onBufferDestroy(e){this._managedBuffers.splice(this._managedBuffers.indexOf(e),1),this._destroyBuffer(e)}destroy(){this._managedBuffers.forEach(e=>this._destroyBuffer(e)),this._managedBuffers=null,this._gpuBuffers=null}_destroyBuffer(e){this._gpuBuffers[e.uid].destroy(),e.off("update",this.updateBuffer,this),e.off("change",this.onBufferChange,this),e.off("destroy",this.onBufferDestroy,this),this._gpuBuffers[e.uid]=null}}Bu.extension={type:[M.WebGPUSystem],name:"buffer"};class jx{constructor({minUniformOffsetAlignment:e}){this._minUniformOffsetAlignment=256,this.byteIndex=0,this._minUniformOffsetAlignment=e,this.data=new Float32Array(65535)}clear(){this.byteIndex=0}addEmptyGroup(e){if(e>this._minUniformOffsetAlignment/4)throw new Error(`UniformBufferBatch: array is too large: ${e*4}`);const t=this.byteIndex;let n=t+e*4;if(n=Math.ceil(n/this._minUniformOffsetAlignment)*this._minUniformOffsetAlignment,n>this.data.length*4)throw new Error("UniformBufferBatch: ubo batch got too big");return this.byteIndex=n,t}addGroup(e){const t=this.addEmptyGroup(e.length);for(let n=0;n<e.length;n++)this.data[t/4+n]=e[n];return t}destroy(){this._buffer.destroy(),this._buffer=null,this.data=null}}class Ru{constructor(e){this._colorMaskCache=15,this._renderer=e}setMask(e){this._colorMaskCache!==e&&(this._colorMaskCache=e,this._renderer.pipeline.setColorMask(e))}destroy(){this._renderer=null,this._colorMaskCache=null}}Ru.extension={type:[M.WebGPUSystem],name:"colorMask"};class Oo{constructor(e){this._renderer=e}async init(e){return this._initPromise?this._initPromise:(this._initPromise=this._createDeviceAndAdaptor(e).then(t=>{this.gpu=t,this._renderer.runners.contextChange.emit(this.gpu)}),this._initPromise)}contextChange(e){this._renderer.gpu=e}async _createDeviceAndAdaptor(e){const t=await navigator.gpu.requestAdapter({powerPreference:e.powerPreference,forceFallbackAdapter:e.forceFallbackAdapter}),n=["texture-compression-bc","texture-compression-astc","texture-compression-etc2"].filter(i=>t.features.has(i)),s=await t.requestDevice({requiredFeatures:n});return{adapter:t,device:s}}destroy(){this.gpu=null,this._renderer=null}}Oo.extension={type:[M.WebGPUSystem],name:"device"},Oo.defaultOptions={powerPreference:void 0,forceFallbackAdapter:!1};class ku{constructor(e){this._boundBindGroup=Object.create(null),this._boundVertexBuffer=Object.create(null),this._renderer=e}renderStart(){this.commandFinished=new Promise(e=>{this._resolveCommandFinished=e}),this.commandEncoder=this._renderer.gpu.device.createCommandEncoder()}beginRenderPass(e){this.endRenderPass(),this._clearCache(),this.renderPassEncoder=this.commandEncoder.beginRenderPass(e.descriptor)}endRenderPass(){this.renderPassEncoder&&this.renderPassEncoder.end(),this.renderPassEncoder=null}setViewport(e){this.renderPassEncoder.setViewport(e.x,e.y,e.width,e.height,0,1)}setPipelineFromGeometryProgramAndState(e,t,n,s){const i=this._renderer.pipeline.getPipeline(e,t,n,s);this.setPipeline(i)}setPipeline(e){this._boundPipeline!==e&&(this._boundPipeline=e,this.renderPassEncoder.setPipeline(e))}_setVertexBuffer(e,t){this._boundVertexBuffer[e]!==t&&(this._boundVertexBuffer[e]=t,this.renderPassEncoder.setVertexBuffer(e,this._renderer.buffer.updateBuffer(t)))}_setIndexBuffer(e){if(this._boundIndexBuffer===e)return;this._boundIndexBuffer=e;const t=e.data.BYTES_PER_ELEMENT===2?"uint16":"uint32";this.renderPassEncoder.setIndexBuffer(this._renderer.buffer.updateBuffer(e),t)}resetBindGroup(e){this._boundBindGroup[e]=null}setBindGroup(e,t,n){if(this._boundBindGroup[e]===t)return;this._boundBindGroup[e]=t,t._touch(this._renderer.textureGC.count);const s=this._renderer.bindGroup.getBindGroup(t,n,e);this.renderPassEncoder.setBindGroup(e,s)}setGeometry(e){for(const t in e.attributes){const n=e.attributes[t];this._setVertexBuffer(n.location,n.buffer)}e.indexBuffer&&this._setIndexBuffer(e.indexBuffer)}_setShaderBindGroups(e,t){for(const n in e.groups){const s=e.groups[n];t||this._syncBindGroup(s),this.setBindGroup(n,s,e.gpuProgram)}}_syncBindGroup(e){for(const t in e.resources){const n=e.resources[t];n.isUniformGroup&&this._renderer.ubo.updateUniformGroup(n)}}draw(e){const{geometry:t,shader:n,state:s,topology:i,size:o,start:a,instanceCount:l,skipSync:c}=e;this.setPipelineFromGeometryProgramAndState(t,n.gpuProgram,s,i),this.setGeometry(t),this._setShaderBindGroups(n,c),t.indexBuffer?this.renderPassEncoder.drawIndexed(o||t.indexBuffer.data.length,l||t.instanceCount,a||0):this.renderPassEncoder.draw(o||t.getSize(),l||t.instanceCount,a||0)}finishRenderPass(){this.renderPassEncoder&&(this.renderPassEncoder.end(),this.renderPassEncoder=null)}postrender(){this.finishRenderPass(),this._gpu.device.queue.submit([this.commandEncoder.finish()]),this._resolveCommandFinished(),this.commandEncoder=null}restoreRenderPass(){const e=this._renderer.renderTarget.adaptor.getDescriptor(this._renderer.renderTarget.renderTarget,!1,[0,0,0,1]);this.renderPassEncoder=this.commandEncoder.beginRenderPass(e);const t=this._boundPipeline,n={...this._boundVertexBuffer},s=this._boundIndexBuffer,i={...this._boundBindGroup};this._clearCache();const o=this._renderer.renderTarget.viewport;this.renderPassEncoder.setViewport(o.x,o.y,o.width,o.height,0,1),this.setPipeline(t);for(const a in n)this._setVertexBuffer(a,n[a]);for(const a in i)this.setBindGroup(a,i[a],null);this._setIndexBuffer(s)}_clearCache(){for(let e=0;e<16;e++)this._boundBindGroup[e]=null,this._boundVertexBuffer[e]=null;this._boundIndexBuffer=null,this._boundPipeline=null}destroy(){this._renderer=null,this._gpu=null,this._boundBindGroup=null,this._boundVertexBuffer=null,this._boundIndexBuffer=null,this._boundPipeline=null}contextChange(e){this._gpu=e}}ku.extension={type:[M.WebGPUSystem],name:"encoder",priority:1};class Iu{constructor(e){this._renderTargetStencilState=Object.create(null),this._renderer=e,e.renderTarget.onRenderTargetChange.add(this)}onRenderTargetChange(e){let t=this._renderTargetStencilState[e.uid];t||(t=this._renderTargetStencilState[e.uid]={stencilMode:Me.DISABLED,stencilReference:0}),this._activeRenderTarget=e,this.setStencilMode(t.stencilMode,t.stencilReference)}setStencilMode(e,t){const n=this._renderTargetStencilState[this._activeRenderTarget.uid];n.stencilMode=e,n.stencilReference=t;const s=this._renderer;s.pipeline.setStencilMode(e),s.encoder.renderPassEncoder.setStencilReference(t)}destroy(){this._renderer.renderTarget.onRenderTargetChange.remove(this),this._renderer=null,this._activeRenderTarget=null,this._renderTargetStencilState=null}}Iu.extension={type:[M.WebGPUSystem],name:"stencil"};const ws={i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},f16:{align:2,size:2},"vec2<i32>":{align:8,size:8},"vec2<u32>":{align:8,size:8},"vec2<f32>":{align:8,size:8},"vec2<f16>":{align:4,size:4},"vec3<i32>":{align:16,size:12},"vec3<u32>":{align:16,size:12},"vec3<f32>":{align:16,size:12},"vec3<f16>":{align:8,size:6},"vec4<i32>":{align:16,size:16},"vec4<u32>":{align:16,size:16},"vec4<f32>":{align:16,size:16},"vec4<f16>":{align:8,size:8},"mat2x2<f32>":{align:8,size:16},"mat2x2<f16>":{align:4,size:8},"mat3x2<f32>":{align:8,size:24},"mat3x2<f16>":{align:4,size:12},"mat4x2<f32>":{align:8,size:32},"mat4x2<f16>":{align:4,size:16},"mat2x3<f32>":{align:16,size:32},"mat2x3<f16>":{align:8,size:16},"mat3x3<f32>":{align:16,size:48},"mat3x3<f16>":{align:8,size:24},"mat4x3<f32>":{align:16,size:64},"mat4x3<f16>":{align:8,size:32},"mat2x4<f32>":{align:16,size:32},"mat2x4<f16>":{align:8,size:16},"mat3x4<f32>":{align:16,size:48},"mat3x4<f16>":{align:8,size:24},"mat4x4<f32>":{align:16,size:64},"mat4x4<f16>":{align:8,size:32}};function qx(r){const e=r.map(n=>({data:n,offset:0,size:0}));let t=0;for(let n=0;n<e.length;n++){const s=e[n];let i=ws[s.data.type].size;const o=ws[s.data.type].align;if(!ws[s.data.type])throw new Error(`[Pixi.js] WebGPU UniformBuffer: Unknown type ${s.data.type}`);s.data.size>1&&(i=Math.max(i,o)*s.data.size),t=Math.ceil(t/o)*o,s.size=i,s.offset=t,t+=i}return t=Math.ceil(t/16)*16,{uboElements:e,size:t}}function Kx(r,e){const{size:t,align:n}=ws[r.data.type],s=(n-t)/4;return`
         v = uv.${r.data.name};
         ${e!==0?`offset += ${e};`:""}

         arrayOffset = offset;

         t = 0;

         for(var i=0; i < ${r.data.size*(t/4)}; i++)
         {
             for(var j = 0; j < ${t/4}; j++)
             {
                 data[arrayOffset++] = v[t++];
             }
             ${s!==0?`arrayOffset += ${s};`:""}
         }
     `}function Zx(r){return Hh(r,"uboWgsl",Kx,Yb)}class Gu extends Lh{constructor(){super({createUboElements:qx,generateUboSync:Zx})}}Gu.extension={type:[M.WebGPUSystem],name:"ubo"};const qt=128;class Uu{constructor(e){this._bindGroupHash=Object.create(null),this._buffers=[],this._bindGroups=[],this._bufferResources=[],this._renderer=e,this._batchBuffer=new jx({minUniformOffsetAlignment:qt});const t=256/qt;for(let n=0;n<t;n++){let s=ae.UNIFORM|ae.COPY_DST;n===0&&(s|=ae.COPY_SRC),this._buffers.push(new pt({data:this._batchBuffer.data,usage:s}))}}renderEnd(){this._uploadBindGroups(),this._resetBindGroups()}_resetBindGroups(){for(const e in this._bindGroupHash)this._bindGroupHash[e]=null;this._batchBuffer.clear()}getUniformBindGroup(e,t){if(!t&&this._bindGroupHash[e.uid])return this._bindGroupHash[e.uid];this._renderer.ubo.ensureUniformGroup(e);const n=e.buffer.data,s=this._batchBuffer.addEmptyGroup(n.length);return this._renderer.ubo.syncUniformGroup(e,this._batchBuffer.data,s/4),this._bindGroupHash[e.uid]=this._getBindGroup(s/qt),this._bindGroupHash[e.uid]}getUboResource(e){this._renderer.ubo.updateUniformGroup(e);const t=e.buffer.data,n=this._batchBuffer.addGroup(t);return this._getBufferResource(n/qt)}getArrayBindGroup(e){const t=this._batchBuffer.addGroup(e);return this._getBindGroup(t/qt)}getArrayBufferResource(e){const n=this._batchBuffer.addGroup(e)/qt;return this._getBufferResource(n)}_getBufferResource(e){if(!this._bufferResources[e]){const t=this._buffers[e%2];this._bufferResources[e]=new Po({buffer:t,offset:(e/2|0)*256,size:qt})}return this._bufferResources[e]}_getBindGroup(e){if(!this._bindGroups[e]){const t=new Ot({0:this._getBufferResource(e)});this._bindGroups[e]=t}return this._bindGroups[e]}_uploadBindGroups(){const e=this._renderer.buffer,t=this._buffers[0];t.update(this._batchBuffer.byteIndex),e.updateBuffer(t);const n=this._renderer.gpu.device.createCommandEncoder();for(let s=1;s<this._buffers.length;s++){const i=this._buffers[s];n.copyBufferToBuffer(e.getGPUBuffer(t),qt,e.getGPUBuffer(i),0,this._batchBuffer.byteIndex)}this._renderer.gpu.device.queue.submit([n.finish()])}destroy(){for(let e=0;e<this._bindGroups.length;e++)this._bindGroups[e].destroy();this._bindGroups=null,this._bindGroupHash=null;for(let e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers=null;for(let e=0;e<this._bufferResources.length;e++)this._bufferResources[e].destroy();this._bufferResources=null,this._batchBuffer.destroy(),this._bindGroupHash=null,this._renderer=null}}Uu.extension={type:[M.WebGPUPipes],name:"uniformBatch"};const Qx={"point-list":0,"line-list":1,"line-strip":2,"triangle-list":3,"triangle-strip":4};function Jx(r,e,t,n,s){return r<<24|e<<16|t<<10|n<<5|s}function e0(r,e,t,n){return t<<6|r<<3|n<<1|e}class Fu{constructor(e){this._moduleCache=Object.create(null),this._bufferLayoutsCache=Object.create(null),this._pipeCache=Object.create(null),this._pipeStateCaches=Object.create(null),this._colorMask=15,this._multisampleCount=1,this._renderer=e}contextChange(e){this._gpu=e,this.setStencilMode(Me.DISABLED),this._updatePipeHash()}setMultisampleCount(e){this._multisampleCount!==e&&(this._multisampleCount=e,this._updatePipeHash())}setRenderTarget(e){this._multisampleCount=e.msaaSamples,this._depthStencilAttachment=e.descriptor.depthStencilAttachment?1:0,this._updatePipeHash()}setColorMask(e){this._colorMask!==e&&(this._colorMask=e,this._updatePipeHash())}setStencilMode(e){this._stencilMode!==e&&(this._stencilMode=e,this._stencilState=lr[e],this._updatePipeHash())}setPipeline(e,t,n,s){const i=this.getPipeline(e,t,n);s.setPipeline(i)}getPipeline(e,t,n,s){e._layoutKey||(kh(e,t.attributeData),this._generateBufferKey(e)),s=s||e.topology;const i=Jx(e._layoutKey,t._layoutKey,n.data,n._blendModeId,Qx[s]);return this._pipeCache[i]?this._pipeCache[i]:(this._pipeCache[i]=this._createPipeline(e,t,n,s),this._pipeCache[i])}_createPipeline(e,t,n,s){const i=this._gpu.device,o=this._createVertexBufferLayouts(e),a=this._renderer.state.getColorTargets(n);a[0].writeMask=this._stencilMode===Me.RENDERING_MASK_ADD?0:this._colorMask;const l=this._renderer.shader.getProgramData(t).pipeline,c={vertex:{module:this._getModule(t.vertex.source),entryPoint:t.vertex.entryPoint,buffers:o},fragment:{module:this._getModule(t.fragment.source),entryPoint:t.fragment.entryPoint,targets:a},primitive:{topology:s,cullMode:n.cullMode},layout:l,multisample:{count:this._multisampleCount},label:"PIXI Pipeline"};return this._depthStencilAttachment&&(c.depthStencil={...this._stencilState,format:"depth24plus-stencil8",depthWriteEnabled:n.depthTest,depthCompare:n.depthTest?"less":"always"}),i.createRenderPipeline(c)}_getModule(e){return this._moduleCache[e]||this._createModule(e)}_createModule(e){const t=this._gpu.device;return this._moduleCache[e]=t.createShaderModule({code:e}),this._moduleCache[e]}_generateBufferKey(e){const t=[];let n=0;const s=Object.keys(e.attributes).sort();for(let o=0;o<s.length;o++){const a=e.attributes[s[o]];t[n++]=a.location,t[n++]=a.offset,t[n++]=a.format,t[n++]=a.stride}const i=t.join("");return e._layoutKey=ts(i,"geometry"),e._layoutKey}_createVertexBufferLayouts(e){if(this._bufferLayoutsCache[e._layoutKey])return this._bufferLayoutsCache[e._layoutKey];const t=[];return e.buffers.forEach(n=>{const s={arrayStride:0,stepMode:"vertex",attributes:[]},i=s.attributes;for(const o in e.attributes){const a=e.attributes[o];a.buffer===n&&(s.arrayStride=a.stride,s.stepMode=a.instance?"instance":"vertex",i.push({shaderLocation:a.location,offset:a.offset,format:a.format}))}i.length&&t.push(s)}),this._bufferLayoutsCache[e._layoutKey]=t,t}_updatePipeHash(){const e=e0(this._stencilMode,this._multisampleCount,this._colorMask,this._depthStencilAttachment);this._pipeStateCaches[e]||(this._pipeStateCaches[e]=Object.create(null)),this._pipeCache=this._pipeStateCaches[e]}destroy(){this._renderer=null,this._bufferLayoutsCache=null}}Fu.extension={type:[M.WebGPUSystem],name:"pipeline"};class t0{constructor(){this.contexts=[],this.msaaTextures=[],this.msaaSamples=1}}class r0{init(e,t){this._renderer=e,this._renderTargetSystem=t}copyToTexture(e,t,n,s,i){const o=this._renderer,a=this._getGpuColorTexture(e),l=o.texture.getGpuSource(t.source);return o.encoder.commandEncoder.copyTextureToTexture({texture:a,origin:n},{texture:l,origin:i},s),t}startRenderPass(e,t=!0,n,s){const o=this._renderTargetSystem.getGpuRenderTarget(e),a=this.getDescriptor(e,t,n);o.descriptor=a,this._renderer.pipeline.setRenderTarget(o),this._renderer.encoder.beginRenderPass(o),this._renderer.encoder.setViewport(s)}finishRenderPass(){this._renderer.encoder.endRenderPass()}_getGpuColorTexture(e){const t=this._renderTargetSystem.getGpuRenderTarget(e);return t.contexts[0]?t.contexts[0].getCurrentTexture():this._renderer.texture.getGpuSource(e.colorTextures[0].source)}getDescriptor(e,t,n){typeof t=="boolean"&&(t=t?Je.ALL:Je.NONE);const s=this._renderTargetSystem,i=s.getGpuRenderTarget(e),o=e.colorTextures.map((c,h)=>{const u=i.contexts[h];let d,f;u?d=u.getCurrentTexture().createView():d=this._renderer.texture.getGpuSource(c).createView({mipLevelCount:1}),i.msaaTextures[h]&&(f=d,d=this._renderer.texture.getTextureView(i.msaaTextures[h]));const p=t&Je.COLOR?"clear":"load";return n??(n=s.defaultClearColor),{view:d,resolveTarget:f,clearValue:n,storeOp:"store",loadOp:p}});let a;if((e.stencil||e.depth)&&!e.depthStencilTexture&&(e.ensureDepthStencilTexture(),e.depthStencilTexture.source.sampleCount=i.msaa?4:1),e.depthStencilTexture){const c=t&Je.STENCIL?"clear":"load",h=t&Je.DEPTH?"clear":"load";a={view:this._renderer.texture.getGpuSource(e.depthStencilTexture.source).createView(),stencilStoreOp:"store",stencilLoadOp:c,depthClearValue:1,depthLoadOp:h,depthStoreOp:"store"}}return{colorAttachments:o,depthStencilAttachment:a}}clear(e,t=!0,n,s){if(!t)return;const{gpu:i,encoder:o}=this._renderer,a=i.device;if(o.commandEncoder===null){const c=a.createCommandEncoder(),h=this.getDescriptor(e,t,n),u=c.beginRenderPass(h);u.setViewport(s.x,s.y,s.width,s.height,0,1),u.end();const d=c.finish();a.queue.submit([d])}else this.startRenderPass(e,t,n,s)}initGpuRenderTarget(e){e.isRoot=!0;const t=new t0;return e.colorTextures.forEach((n,s)=>{if(Rr.test(n.resource)){const i=n.resource.getContext("webgpu"),o=n.transparent?"premultiplied":"opaque";try{i.configure({device:this._renderer.gpu.device,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,format:"bgra8unorm",alphaMode:o})}catch(a){console.error(a)}t.contexts[s]=i}if(t.msaa=n.source.antialias,n.source.antialias){const i=new Ie({width:0,height:0,sampleCount:4});t.msaaTextures[s]=i}}),t.msaa&&(t.msaaSamples=4,e.depthStencilTexture&&(e.depthStencilTexture.source.sampleCount=4)),t}destroyGpuRenderTarget(e){e.contexts.forEach(t=>{t.unconfigure()}),e.msaaTextures.forEach(t=>{t.destroy()}),e.msaaTextures.length=0,e.contexts.length=0}ensureDepthStencilTexture(e){const t=this._renderTargetSystem.getGpuRenderTarget(e);e.depthStencilTexture&&t.msaa&&(e.depthStencilTexture.source.sampleCount=4)}resizeGpuRenderTarget(e){const t=this._renderTargetSystem.getGpuRenderTarget(e);t.width=e.width,t.height=e.height,t.msaa&&e.colorTextures.forEach((n,s)=>{const i=t.msaaTextures[s];i==null||i.resize(n.source.width,n.source.height,n.source._resolution)})}}class Ou extends Xh{constructor(e){super(e),this.adaptor=new r0,this.adaptor.init(e,this)}}Ou.extension={type:[M.WebGPUSystem],name:"renderTarget"};class Du{constructor(){this._gpuProgramData=Object.create(null)}contextChange(e){this._gpu=e}getProgramData(e){return this._gpuProgramData[e._layoutKey]||this._createGPUProgramData(e)}_createGPUProgramData(e){const t=this._gpu.device,n=e.gpuLayout.map(i=>t.createBindGroupLayout({entries:i})),s={bindGroupLayouts:n};return this._gpuProgramData[e._layoutKey]={bindGroups:n,pipeline:t.createPipelineLayout(s)},this._gpuProgramData[e._layoutKey]}destroy(){this._gpu=null,this._gpuProgramData=null}}Du.extension={type:[M.WebGPUSystem],name:"shader"};const lt={};lt.normal={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}},lt.add={alpha:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one",operation:"add"}},lt.multiply={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"dst",dstFactor:"one-minus-src-alpha",operation:"add"}},lt.screen={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src",operation:"add"}},lt.overlay={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"one",dstFactor:"one-minus-src",operation:"add"}},lt.none={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"zero",dstFactor:"zero",operation:"add"}},lt["normal-npm"]={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"}},lt["add-npm"]={alpha:{srcFactor:"one",dstFactor:"one",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one",operation:"add"}},lt["screen-npm"]={alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"src-alpha",dstFactor:"one-minus-src",operation:"add"}},lt.erase={alpha:{srcFactor:"zero",dstFactor:"one-minus-src-alpha",operation:"add"},color:{srcFactor:"zero",dstFactor:"one-minus-src",operation:"add"}};class Lu{constructor(){this.defaultState=new Dt,this.defaultState.blend=!0}contextChange(e){this.gpu=e}getColorTargets(e){return[{format:"bgra8unorm",writeMask:0,blend:lt[e.blendMode]||lt.normal}]}destroy(){this.gpu=null}}Lu.extension={type:[M.WebGPUSystem],name:"state"};const n0={type:"image",upload(r,e,t){const n=r.resource,s=(r.pixelWidth|0)*(r.pixelHeight|0),i=n.byteLength/s;t.device.queue.writeTexture({texture:e},n,{offset:0,rowsPerImage:r.pixelHeight,bytesPerRow:r.pixelHeight*i},{width:r.pixelWidth,height:r.pixelHeight,depthOrArrayLayers:1})}},Nu={"bc1-rgba-unorm":{blockBytes:8,blockWidth:4,blockHeight:4},"bc2-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"bc3-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"bc7-rgba-unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"etc1-rgb-unorm":{blockBytes:8,blockWidth:4,blockHeight:4},"etc2-rgba8unorm":{blockBytes:16,blockWidth:4,blockHeight:4},"astc-4x4-unorm":{blockBytes:16,blockWidth:4,blockHeight:4}},s0={blockBytes:4,blockWidth:1,blockHeight:1},i0={type:"compressed",upload(r,e,t){let n=r.pixelWidth,s=r.pixelHeight;const i=Nu[r.format]||s0;for(let o=0;o<r.resource.length;o++){const a=r.resource[o],l=Math.ceil(n/i.blockWidth)*i.blockBytes;t.device.queue.writeTexture({texture:e,mipLevel:o},a,{offset:0,bytesPerRow:l},{width:Math.ceil(n/i.blockWidth)*i.blockWidth,height:Math.ceil(s/i.blockHeight)*i.blockHeight,depthOrArrayLayers:1}),n=Math.max(n>>1,1),s=Math.max(s>>1,1)}}},Hu={type:"image",upload(r,e,t){const n=r.resource;if(!n)return;const s=Math.min(e.width,r.resourceWidth||r.pixelWidth),i=Math.min(e.height,r.resourceHeight||r.pixelHeight),o=r.alphaMode==="premultiply-alpha-on-upload";t.device.queue.copyExternalImageToTexture({source:n},{texture:e,premultipliedAlpha:o},{width:s,height:i})}},o0={type:"video",upload(r,e,t){Hu.upload(r,e,t)}};class a0{constructor(e){this.device=e,this.sampler=e.createSampler({minFilter:"linear"}),this.pipelines={}}_getMipmapPipeline(e){let t=this.pipelines[e];return t||(this.mipmapShaderModule||(this.mipmapShaderModule=this.device.createShaderModule({code:`
                        var<private> pos : array<vec2<f32>, 3> = array<vec2<f32>, 3>(
                        vec2<f32>(-1.0, -1.0), vec2<f32>(-1.0, 3.0), vec2<f32>(3.0, -1.0));

                        struct VertexOutput {
                        @builtin(position) position : vec4<f32>,
                        @location(0) texCoord : vec2<f32>,
                        };

                        @vertex
                        fn vertexMain(@builtin(vertex_index) vertexIndex : u32) -> VertexOutput {
                        var output : VertexOutput;
                        output.texCoord = pos[vertexIndex] * vec2<f32>(0.5, -0.5) + vec2<f32>(0.5);
                        output.position = vec4<f32>(pos[vertexIndex], 0.0, 1.0);
                        return output;
                        }

                        @group(0) @binding(0) var imgSampler : sampler;
                        @group(0) @binding(1) var img : texture_2d<f32>;

                        @fragment
                        fn fragmentMain(@location(0) texCoord : vec2<f32>) -> @location(0) vec4<f32> {
                        return textureSample(img, imgSampler, texCoord);
                        }
                    `})),t=this.device.createRenderPipeline({layout:"auto",vertex:{module:this.mipmapShaderModule,entryPoint:"vertexMain"},fragment:{module:this.mipmapShaderModule,entryPoint:"fragmentMain",targets:[{format:e}]}}),this.pipelines[e]=t),t}generateMipmap(e){const t=this._getMipmapPipeline(e.format);if(e.dimension==="3d"||e.dimension==="1d")throw new Error("Generating mipmaps for non-2d textures is currently unsupported!");let n=e;const s=e.depthOrArrayLayers||1,i=e.usage&GPUTextureUsage.RENDER_ATTACHMENT;if(!i){const l={size:{width:Math.ceil(e.width/2),height:Math.ceil(e.height/2),depthOrArrayLayers:s},format:e.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT,mipLevelCount:e.mipLevelCount-1};n=this.device.createTexture(l)}const o=this.device.createCommandEncoder({}),a=t.getBindGroupLayout(0);for(let l=0;l<s;++l){let c=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:"2d",baseArrayLayer:l,arrayLayerCount:1}),h=i?1:0;for(let u=1;u<e.mipLevelCount;++u){const d=n.createView({baseMipLevel:h++,mipLevelCount:1,dimension:"2d",baseArrayLayer:l,arrayLayerCount:1}),f=o.beginRenderPass({colorAttachments:[{view:d,storeOp:"store",loadOp:"clear",clearValue:{r:0,g:0,b:0,a:0}}]}),p=this.device.createBindGroup({layout:a,entries:[{binding:0,resource:this.sampler},{binding:1,resource:c}]});f.setPipeline(t),f.setBindGroup(0,p),f.draw(3,1,0,0),f.end(),c=d}}if(!i){const l={width:Math.ceil(e.width/2),height:Math.ceil(e.height/2),depthOrArrayLayers:s};for(let c=1;c<e.mipLevelCount;++c)o.copyTextureToTexture({texture:n,mipLevel:c-1},{texture:e,mipLevel:c},l),l.width=Math.ceil(l.width/2),l.height=Math.ceil(l.height/2)}return this.device.queue.submit([o.finish()]),i||n.destroy(),e}}class zu{constructor(e){this.managedTextures=[],this._gpuSources=Object.create(null),this._gpuSamplers=Object.create(null),this._bindGroupHash=Object.create(null),this._textureViewHash=Object.create(null),this._uploads={image:Hu,buffer:n0,video:o0,compressed:i0},this._renderer=e}contextChange(e){this._gpu=e}initSource(e){if(e.autoGenerateMipmaps){const l=Math.max(e.pixelWidth,e.pixelHeight);e.mipLevelCount=Math.floor(Math.log2(l))+1}let t=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST;e.uploadMethodId!=="compressed"&&(t|=GPUTextureUsage.RENDER_ATTACHMENT,t|=GPUTextureUsage.COPY_SRC);const n=Nu[e.format]||{blockBytes:4,blockWidth:1,blockHeight:1},s=Math.ceil(e.pixelWidth/n.blockWidth)*n.blockWidth,i=Math.ceil(e.pixelHeight/n.blockHeight)*n.blockHeight,o={label:e.label,size:{width:s,height:i},format:e.format,sampleCount:e.sampleCount,mipLevelCount:e.mipLevelCount,dimension:e.dimension,usage:t},a=this._gpu.device.createTexture(o);return this._gpuSources[e.uid]=a,this.managedTextures.includes(e)||(e.on("update",this.onSourceUpdate,this),e.on("resize",this.onSourceResize,this),e.on("destroy",this.onSourceDestroy,this),e.on("unload",this.onSourceUnload,this),e.on("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.push(e)),this.onSourceUpdate(e),a}onSourceUpdate(e){const t=this.getGpuSource(e);t&&(this._uploads[e.uploadMethodId]&&this._uploads[e.uploadMethodId].upload(e,t,this._gpu),e.autoGenerateMipmaps&&e.mipLevelCount>1&&this.onUpdateMipmaps(e))}onSourceUnload(e){const t=this._gpuSources[e.uid];t&&(this._gpuSources[e.uid]=null,t.destroy())}onUpdateMipmaps(e){this._mipmapGenerator||(this._mipmapGenerator=new a0(this._gpu.device));const t=this.getGpuSource(e);this._mipmapGenerator.generateMipmap(t)}onSourceDestroy(e){e.off("update",this.onSourceUpdate,this),e.off("unload",this.onSourceUnload,this),e.off("destroy",this.onSourceDestroy,this),e.off("resize",this.onSourceResize,this),e.off("updateMipmaps",this.onUpdateMipmaps,this),this.managedTextures.splice(this.managedTextures.indexOf(e),1),this.onSourceUnload(e)}onSourceResize(e){const t=this._gpuSources[e.uid];t?(t.width!==e.pixelWidth||t.height!==e.pixelHeight)&&(this._textureViewHash[e.uid]=null,this._bindGroupHash[e.uid]=null,this.onSourceUnload(e),this.initSource(e)):this.initSource(e)}_initSampler(e){return this._gpuSamplers[e._resourceId]=this._gpu.device.createSampler(e),this._gpuSamplers[e._resourceId]}getGpuSampler(e){return this._gpuSamplers[e._resourceId]||this._initSampler(e)}getGpuSource(e){return this._gpuSources[e.uid]||this.initSource(e)}getTextureBindGroup(e){return this._bindGroupHash[e.uid]??this._createTextureBindGroup(e)}_createTextureBindGroup(e){const t=e.source,n=t.uid;return this._bindGroupHash[n]=new Ot({0:t,1:t.style}),this._bindGroupHash[n]}getTextureView(e){const t=e.source;return this._textureViewHash[t.uid]??this._createTextureView(t)}_createTextureView(e){return this._textureViewHash[e.uid]=this.getGpuSource(e).createView(),this._textureViewHash[e.uid]}generateCanvas(e){const t=this._renderer,n=t.gpu.device.createCommandEncoder(),s=xe.get().createCanvas();s.width=e.source.pixelWidth,s.height=e.source.pixelHeight;const i=s.getContext("webgpu");return i.configure({device:t.gpu.device,usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC,format:navigator.gpu.getPreferredCanvasFormat(),alphaMode:"premultiplied"}),n.copyTextureToTexture({texture:t.texture.getGpuSource(e.source),origin:{x:0,y:0}},{texture:i.getCurrentTexture()},{width:s.width,height:s.height}),t.gpu.device.queue.submit([n.finish()]),s}getPixels(e){const t=this.generateCanvas(e),n=Nt.getOptimalCanvasAndContext(t.width,t.height),s=n.context;s.drawImage(t,0,0);const{width:i,height:o}=t,a=s.getImageData(0,0,i,o),l=new Uint8ClampedArray(a.data.buffer);return Nt.returnCanvasAndContext(n),{pixels:l,width:i,height:o}}destroy(){this.managedTextures.slice().forEach(e=>this.onSourceDestroy(e)),this.managedTextures=null;for(const e of Object.keys(this._bindGroupHash)){const t=Number(e),n=this._bindGroupHash[t];n==null||n.destroy(),this._bindGroupHash[t]=null}this._gpu=null,this._mipmapGenerator=null,this._gpuSources=null,this._bindGroupHash=null,this._textureViewHash=null,this._gpuSamplers=null}}zu.extension={type:[M.WebGPUSystem],name:"texture"};class $u{init(){const e=new Qe({uTransformMatrix:{value:new W,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),t=gn({name:"graphics",bits:[po,_o(mt),Rb,yn]});this.shader=new ot({gpuProgram:t,resources:{localUniforms:e}})}execute(e,t){const n=t.context,s=n.customShader||this.shader,i=e.renderer,o=i.graphicsContext,{geometry:a,instructions:l}=o.getContextRenderData(n),c=i.encoder;c.setPipelineFromGeometryProgramAndState(a,s.gpuProgram,e.state),c.setGeometry(a);const h=i.globalUniforms.bindGroup;c.setBindGroup(0,h,s.gpuProgram);const u=i.renderPipes.uniformBatch.getUniformBindGroup(s.resources.localUniforms,!0);c.setBindGroup(2,u,s.gpuProgram);const d=l.instructions;for(let f=0;f<l.instructionSize;f++){const p=d[f];if(s.groups[1]=p.bindGroup,!p.gpuBindGroup){const g=p.textures;p.bindGroup=Yi(g.textures,g.count),p.gpuBindGroup=i.bindGroup.getBindGroup(p.bindGroup,s.gpuProgram,1)}c.setBindGroup(1,p.bindGroup,s.gpuProgram),c.renderPassEncoder.drawIndexed(p.size,1,p.start)}}destroy(){this.shader.destroy(!0),this.shader=null}}$u.extension={type:[M.WebGPUPipesAdaptor],name:"graphics"};class Wu{init(){const e=gn({name:"mesh",bits:[xn,kb,yn]});this._shader=new ot({gpuProgram:e,resources:{uTexture:$.EMPTY._source,uSampler:$.EMPTY._source.style,textureUniforms:{uTextureMatrix:{type:"mat3x3<f32>",value:new W}}}})}execute(e,t){const n=e.renderer;let s=t._shader;if(!s)s=this._shader,s.resources.uTexture=t.texture.source,s.resources.uSampler=t.texture.source.style,s.resources.textureUniforms.uniforms.uTextureMatrix=t.texture.textureMatrix.mapCoord;else if(!s.gpuProgram){ne("Mesh shader has no gpuProgram",t.shader);return}const i=s.gpuProgram;if(i.autoAssignGlobalUniforms&&(s.groups[0]=n.globalUniforms.bindGroup),i.autoAssignLocalUniforms){const o=e.localUniforms;s.groups[1]=n.renderPipes.uniformBatch.getUniformBindGroup(o,!0)}n.encoder.draw({geometry:t._geometry,shader:s,state:t.state})}destroy(){this._shader.destroy(!0),this._shader=null}}Wu.extension={type:[M.WebGPUPipesAdaptor],name:"mesh"};const l0=[...Tu,Gu,ku,Oo,Bu,zu,Ou,Du,Lu,Fu,Ru,Iu,Cu],c0=[...Eu,Uu],h0=[Eh,Wu,$u],Vu=[],Xu=[],Yu=[];re.handleByNamedList(M.WebGPUSystem,Vu),re.handleByNamedList(M.WebGPUPipes,Xu),re.handleByNamedList(M.WebGPUPipesAdaptor,Yu),re.add(...l0,...c0,...h0);class u0 extends as{constructor(){const e={name:"webgpu",type:Et.WEBGPU,systems:Vu,renderPipes:Xu,renderPipeAdaptors:Yu};super(e)}}const d0=Object.freeze(Object.defineProperty({__proto__:null,WebGPURenderer:u0},Symbol.toStringTag,{value:"Module"}));class ju{constructor(e,t){this.state=Dt.for2d(),this._graphicsBatchesHash=Object.create(null),this.renderer=e,this._adaptor=t,this._adaptor.init()}validateRenderable(e){const t=e.context,n=!!this._graphicsBatchesHash[e.uid],s=this.renderer.graphicsContext.updateGpuContext(t);return!!(s.isBatchable||n!==s.isBatchable)}addRenderable(e,t){const n=this.renderer.graphicsContext.updateGpuContext(e.context);e._didGraphicsUpdate&&(e._didGraphicsUpdate=!1,this._rebuild(e)),n.isBatchable?this._addToBatcher(e,t):(this.renderer.renderPipes.batch.break(t),t.add(e))}updateRenderable(e){const t=this._graphicsBatchesHash[e.uid];if(t)for(let n=0;n<t.length;n++){const s=t[n];s.batcher.updateElement(s)}}destroyRenderable(e){this._graphicsBatchesHash[e.uid]&&this._removeBatchForRenderable(e.uid)}execute(e){if(!e.isRenderable)return;const t=this.renderer,n=e.context;if(!t.graphicsContext.getGpuContext(n).batches.length)return;const i=n.customShader||this._adaptor.shader;this.state.blendMode=e.groupBlendMode;const o=i.resources.localUniforms.uniforms;o.uTransformMatrix=e.groupTransform,o.uRound=t._roundPixels|e._roundPixels,vs(e.groupColorAlpha,o.uColor,0),this._adaptor.execute(this,e)}_rebuild(e){const t=!!this._graphicsBatchesHash[e.uid],n=this.renderer.graphicsContext.updateGpuContext(e.context);t&&this._removeBatchForRenderable(e.uid),n.isBatchable&&this._initBatchesForRenderable(e),e.batched=n.isBatchable}_addToBatcher(e,t){const n=this.renderer.renderPipes.batch,s=this._getBatchesForRenderable(e);for(let i=0;i<s.length;i++){const o=s[i];n.addToBatch(o,t)}}_getBatchesForRenderable(e){return this._graphicsBatchesHash[e.uid]||this._initBatchesForRenderable(e)}_initBatchesForRenderable(e){const t=e.context,n=this.renderer.graphicsContext.getGpuContext(t),s=this.renderer._roundPixels|e._roundPixels,i=n.batches.map(o=>{const a=oe.get(qi);return o.copyTo(a),a.renderable=e,a.roundPixels=s,a});return this._graphicsBatchesHash[e.uid]=i,e.on("destroyed",()=>{this.destroyRenderable(e)}),i}_removeBatchForRenderable(e){this._graphicsBatchesHash[e].forEach(t=>{oe.return(t)}),this._graphicsBatchesHash[e]=null}destroy(){this.renderer=null,this._adaptor.destroy(),this._adaptor=null,this.state=null;for(const e in this._graphicsBatchesHash)this._removeBatchForRenderable(e);this._graphicsBatchesHash=null}}ju.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"graphics"};const qu=class Kd extends ao{constructor(...e){super({});let t=e[0]??{};typeof t=="number"&&(ie(le,"PlaneGeometry constructor changed please use { width, height, verticesX, verticesY } instead"),t={width:t,height:e[1],verticesX:e[2],verticesY:e[3]}),this.build(t)}build(e){e={...Kd.defaultOptions,...e},this.verticesX=this.verticesX??e.verticesX,this.verticesY=this.verticesY??e.verticesY,this.width=this.width??e.width,this.height=this.height??e.height;const t=this.verticesX*this.verticesY,n=[],s=[],i=[],o=this.verticesX-1,a=this.verticesY-1,l=this.width/o,c=this.height/a;for(let u=0;u<t;u++){const d=u%this.verticesX,f=u/this.verticesX|0;n.push(d*l,f*c),s.push(d/o,f/a)}const h=o*a;for(let u=0;u<h;u++){const d=u%o,f=u/o|0,p=f*this.verticesX+d,g=f*this.verticesX+d+1,m=(f+1)*this.verticesX+d,_=(f+1)*this.verticesX+d+1;i.push(p,g,m,g,_,m)}this.buffers[0].data=new Float32Array(n),this.buffers[1].data=new Float32Array(s),this.indexBuffer.data=new Uint32Array(i),this.buffers[0].update(),this.buffers[1].update(),this.indexBuffer.update()}};qu.defaultOptions={width:100,height:100,verticesX:10,verticesY:10};let f0=qu;class Do{constructor(){this.batcher=null,this.batch=null,this.roundPixels=0,this._uvUpdateId=-1,this._textureMatrixUpdateId=-1}get blendMode(){return this.mesh.groupBlendMode}reset(){this.mesh=null,this.texture=null,this.batcher=null,this.batch=null}packIndex(e,t,n){const s=this.geometry.indices;for(let i=0;i<s.length;i++)e[t++]=s[i]+n}packAttributes(e,t,n,s){const i=this.mesh,o=this.geometry,a=i.groupTransform,l=s<<16|this.roundPixels&65535,c=a.a,h=a.b,u=a.c,d=a.d,f=a.tx,p=a.ty,g=o.positions,m=o.getBuffer("aUV"),_=m.data;let b=_;const y=this.texture.textureMatrix;y.isSimple||(b=this._transformedUvs,(this._textureMatrixUpdateId!==y._updateID||this._uvUpdateId!==m._updateID)&&((!b||b.length<_.length)&&(b=this._transformedUvs=new Float32Array(_.length)),this._textureMatrixUpdateId=y._updateID,this._uvUpdateId=m._updateID,y.multiplyUvs(_,b)));const x=i.groupColorAlpha;for(let S=0;S<g.length;S+=2){const k=g[S],P=g[S+1];e[n]=c*k+u*P+f,e[n+1]=h*k+d*P+p,e[n+2]=b[S],e[n+3]=b[S+1],t[n+4]=x,t[n+5]=l,n+=6}}get vertexSize(){return this.geometry.positions.length/2}get indexSize(){return this.geometry.indices.length}}class Ku{constructor(e,t){this.localUniforms=new Qe({uTransformMatrix:{value:new W,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),this.localUniformsBindGroup=new Ot({0:this.localUniforms}),this._meshDataHash=Object.create(null),this._gpuBatchableMeshHash=Object.create(null),this.renderer=e,this._adaptor=t,this._adaptor.init()}validateRenderable(e){const t=this._getMeshData(e),n=t.batched,s=e.batched;if(t.batched=s,n!==s)return!0;if(s){const i=e._geometry;if(i.indices.length!==t.indexSize||i.positions.length!==t.vertexSize)return t.indexSize=i.indices.length,t.vertexSize=i.positions.length,!0;const o=this._getBatchableMesh(e),a=e.texture;if(o.texture._source!==a._source&&o.texture._source!==a._source)return!o.batcher.checkAndUpdateTexture(o,a)}return!1}addRenderable(e,t){const n=this.renderer.renderPipes.batch,{batched:s}=this._getMeshData(e);if(s){const i=this._getBatchableMesh(e);i.texture=e._texture,i.geometry=e._geometry,n.addToBatch(i)}else n.break(t),t.add({renderPipeId:"mesh",mesh:e})}updateRenderable(e){if(e.batched){const t=this._gpuBatchableMeshHash[e.uid];t.texture=e._texture,t.geometry=e._geometry,t.batcher.updateElement(t)}}destroyRenderable(e){this._meshDataHash[e.uid]=null;const t=this._gpuBatchableMeshHash[e.uid];t&&(oe.return(t),this._gpuBatchableMeshHash[e.uid]=null)}execute({mesh:e}){if(!e.isRenderable)return;e.state.blendMode=e.groupBlendMode;const t=this.localUniforms;t.uniforms.uTransformMatrix=e.groupTransform,t.uniforms.uRound=this.renderer._roundPixels|e._roundPixels,t.update(),vs(e.groupColorAlpha,t.uniforms.uColor,0),this._adaptor.execute(this,e)}_getMeshData(e){return this._meshDataHash[e.uid]||this._initMeshData(e)}_initMeshData(e){var t,n;return this._meshDataHash[e.uid]={batched:e.batched,indexSize:(t=e._geometry.indices)==null?void 0:t.length,vertexSize:(n=e._geometry.positions)==null?void 0:n.length},e.on("destroyed",()=>{this.destroyRenderable(e)}),this._meshDataHash[e.uid]}_getBatchableMesh(e){return this._gpuBatchableMeshHash[e.uid]||this._initBatchableMesh(e)}_initBatchableMesh(e){const t=oe.get(Do);return t.mesh=e,t.texture=e._texture,t.roundPixels=this.renderer._roundPixels|e._roundPixels,this._gpuBatchableMeshHash[e.uid]=t,t.mesh=e,t}destroy(){for(const e in this._gpuBatchableMeshHash)this._gpuBatchableMeshHash[e]&&oe.return(this._gpuBatchableMeshHash[e]);this._gpuBatchableMeshHash=null,this._meshDataHash=null,this.localUniforms=null,this.localUniformsBindGroup=null,this._adaptor.destroy(),this._adaptor=null,this.renderer=null}}Ku.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"mesh"};const Zu=class Zd extends f0{constructor(e={}){e={...Zd.defaultOptions,...e},super({width:e.width,height:e.height,verticesX:4,verticesY:4}),this.update(e)}update(e){this.width=e.width??this.width,this.height=e.height??this.height,this._originalWidth=e.originalWidth??this._originalWidth,this._originalHeight=e.originalHeight??this._originalHeight,this._leftWidth=e.leftWidth??this._leftWidth,this._rightWidth=e.rightWidth??this._rightWidth,this._topHeight=e.topHeight??this._topHeight,this._bottomHeight=e.bottomHeight??this._bottomHeight,this.updateUvs(),this.updatePositions()}updatePositions(){const e=this.positions,t=this._leftWidth+this._rightWidth,n=this.width>t?1:this.width/t,s=this._topHeight+this._bottomHeight,i=this.height>s?1:this.height/s,o=Math.min(n,i);e[9]=e[11]=e[13]=e[15]=this._topHeight*o,e[17]=e[19]=e[21]=e[23]=this.height-this._bottomHeight*o,e[25]=e[27]=e[29]=e[31]=this.height,e[2]=e[10]=e[18]=e[26]=this._leftWidth*o,e[4]=e[12]=e[20]=e[28]=this.width-this._rightWidth*o,e[6]=e[14]=e[22]=e[30]=this.width,this.getBuffer("aPosition").update()}updateUvs(){const e=this.uvs;e[0]=e[8]=e[16]=e[24]=0,e[1]=e[3]=e[5]=e[7]=0,e[6]=e[14]=e[22]=e[30]=1,e[25]=e[27]=e[29]=e[31]=1;const t=1/this._originalWidth,n=1/this._originalHeight;e[2]=e[10]=e[18]=e[26]=t*this._leftWidth,e[9]=e[11]=e[13]=e[15]=n*this._topHeight,e[4]=e[12]=e[20]=e[28]=1-t*this._rightWidth,e[17]=e[19]=e[21]=e[23]=1-n*this._bottomHeight,this.getBuffer("aUV").update()}};Zu.defaultOptions={width:100,height:100,leftWidth:10,topHeight:10,rightWidth:10,bottomHeight:10,originalWidth:100,originalHeight:100};let p0=Zu;class Qu{constructor(e){this._gpuSpriteHash=Object.create(null),this._renderer=e}addRenderable(e,t){const n=this._getGpuSprite(e);e._didSpriteUpdate&&this._updateBatchableSprite(e,n),this._renderer.renderPipes.batch.addToBatch(n)}updateRenderable(e){const t=this._gpuSpriteHash[e.uid];e._didSpriteUpdate&&this._updateBatchableSprite(e,t),t.batcher.updateElement(t)}validateRenderable(e){const t=e._texture,n=this._getGpuSprite(e);return n.texture._source!==t._source?!n.batcher.checkAndUpdateTexture(n,t):!1}destroyRenderable(e){const t=this._gpuSpriteHash[e.uid];oe.return(t),this._gpuSpriteHash[e.uid]=null}_updateBatchableSprite(e,t){e._didSpriteUpdate=!1,t.geometry.update(e),t.texture=e._texture}_getGpuSprite(e){return this._gpuSpriteHash[e.uid]||this._initGPUSprite(e)}_initGPUSprite(e){const t=new Do;return t.geometry=new p0,t.mesh=e,t.texture=e._texture,t.roundPixels=this._renderer._roundPixels|e._roundPixels,this._gpuSpriteHash[e.uid]=t,e.on("destroyed",()=>{this.destroyRenderable(e)}),t}destroy(){for(const e in this._gpuSpriteHash)this._gpuSpriteHash[e].geometry.destroy();this._gpuSpriteHash=null,this._renderer=null}}Qu.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"nineSliceSprite"};const m0={name:"tiling-bit",vertex:{header:`
            struct TilingUniforms {
                uMapCoord:mat3x3<f32>,
                uClampFrame:vec4<f32>,
                uClampOffset:vec2<f32>,
                uTextureTransform:mat3x3<f32>,
                uSizeAnchor:vec4<f32>
            };

            @group(2) @binding(0) var<uniform> tilingUniforms: TilingUniforms;
            @group(2) @binding(1) var uTexture: texture_2d<f32>;
            @group(2) @binding(2) var uSampler: sampler;
        `,main:`
            uv = (tilingUniforms.uTextureTransform * vec3(uv, 1.0)).xy;

            position = (position - tilingUniforms.uSizeAnchor.zw) * tilingUniforms.uSizeAnchor.xy;
        `},fragment:{header:`
            struct TilingUniforms {
                uMapCoord:mat3x3<f32>,
                uClampFrame:vec4<f32>,
                uClampOffset:vec2<f32>,
                uTextureTransform:mat3x3<f32>,
                uSizeAnchor:vec4<f32>
            };

            @group(2) @binding(0) var<uniform> tilingUniforms: TilingUniforms;
            @group(2) @binding(1) var uTexture: texture_2d<f32>;
            @group(2) @binding(2) var uSampler: sampler;
        `,main:`

            var coord = vUV + ceil(tilingUniforms.uClampOffset - vUV);
            coord = (tilingUniforms.uMapCoord * vec3(coord, 1.0)).xy;
            var unclamped = coord;
            coord = clamp(coord, tilingUniforms.uClampFrame.xy, tilingUniforms.uClampFrame.zw);

            var bias = 0.;

            if(unclamped.x == coord.x && unclamped.y == coord.y)
            {
                bias = -32.;
            } 

            outColor = textureSampleBias(uTexture, uSampler, coord, bias);
        `}},g0={name:"tiling-bit",vertex:{header:`
            uniform mat3 uTextureTransform;
            uniform vec4 uSizeAnchor;
        
        `,main:`
            uv = (uTextureTransform * vec3(aUV, 1.0)).xy;

            position = (position - uSizeAnchor.zw) * uSizeAnchor.xy;
        `},fragment:{header:`
            uniform sampler2D uTexture;
            uniform mat3 uMapCoord;
            uniform vec4 uClampFrame;
            uniform vec2 uClampOffset;
        `,main:`

        vec2 coord = vUV + ceil(uClampOffset - vUV);
        coord = (uMapCoord * vec3(coord, 1.0)).xy;
        vec2 unclamped = coord;
        coord = clamp(coord, uClampFrame.xy, uClampFrame.zw);
        
        outColor = texture(uTexture, coord, unclamped == coord ? 0.0 : -32.0);// lod-bias very negative to force lod 0
    
        `}};let Lo,No;class _0 extends ot{constructor(){Lo??(Lo=gn({name:"tiling-sprite-shader",bits:[xn,m0,yn]})),No??(No=_n({name:"tiling-sprite-shader",bits:[vo,g0,bn]}));const e=new Qe({uMapCoord:{value:new W,type:"mat3x3<f32>"},uClampFrame:{value:new Float32Array([0,0,1,1]),type:"vec4<f32>"},uClampOffset:{value:new Float32Array([0,0]),type:"vec2<f32>"},uTextureTransform:{value:new W,type:"mat3x3<f32>"},uSizeAnchor:{value:new Float32Array([100,100,.5,.5]),type:"vec4<f32>"}});super({glProgram:No,gpuProgram:Lo,resources:{localUniforms:new Qe({uTransformMatrix:{value:new W,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),tilingUniforms:e,uTexture:$.EMPTY.source,uSampler:$.EMPTY.source.style}})}updateUniforms(e,t,n,s,i,o){const a=this.resources.tilingUniforms,l=o.width,c=o.height,h=o.textureMatrix,u=a.uniforms.uTextureTransform;u.set(n.a*l/e,n.b*l/t,n.c*c/e,n.d*c/t,n.tx/e,n.ty/t),u.invert(),a.uniforms.uMapCoord=h.mapCoord,a.uniforms.uClampFrame=h.uClampFrame,a.uniforms.uClampOffset=h.uClampOffset,a.uniforms.uTextureTransform=u,a.uniforms.uSizeAnchor[0]=e,a.uniforms.uSizeAnchor[1]=t,a.uniforms.uSizeAnchor[2]=s,a.uniforms.uSizeAnchor[3]=i,o&&(this.resources.uTexture=o.source,this.resources.uSampler=o.source.style)}}class y0 extends ao{constructor(){super({positions:new Float32Array([0,0,1,0,1,1,0,1]),uvs:new Float32Array([0,0,1,0,1,1,0,1]),indices:new Uint32Array([0,1,2,0,2,3])})}}function b0(r,e){const t=r.anchor.x,n=r.anchor.y;e[0]=-t*r.width,e[1]=-n*r.height,e[2]=(1-t)*r.width,e[3]=-n*r.height,e[4]=(1-t)*r.width,e[5]=(1-n)*r.height,e[6]=-t*r.width,e[7]=(1-n)*r.height}function x0(r,e,t,n){let s=0;const i=r.length/e,o=n.a,a=n.b,l=n.c,c=n.d,h=n.tx,u=n.ty;for(t*=e;s<i;){const d=r[t],f=r[t+1];r[t]=o*d+l*f+h,r[t+1]=a*d+c*f+u,t+=e,s++}}function v0(r,e){const t=r.texture,n=t.frame.width,s=t.frame.height;let i=0,o=0;r._applyAnchorToTexture&&(i=r.anchor.x,o=r.anchor.y),e[0]=e[6]=-i,e[2]=e[4]=1-i,e[1]=e[3]=-o,e[5]=e[7]=1-o;const a=W.shared;a.copyFrom(r._tileTransform.matrix),a.tx/=r.width,a.ty/=r.height,a.invert(),a.scale(r.width/n,r.height/s),x0(e,2,0,a)}const Ss=new y0;class Ju{constructor(e){this._tilingSpriteDataHash=Object.create(null),this._renderer=e}validateRenderable(e){const t=this._getTilingSpriteData(e),n=t.canBatch;this._updateCanBatch(e);const s=t.canBatch;if(s&&s===n){const{batchableMesh:i}=t;if(i.texture._source!==e.texture._source)return!i.batcher.checkAndUpdateTexture(i,e.texture)}return n!==s}addRenderable(e,t){const n=this._renderer.renderPipes.batch;this._updateCanBatch(e);const s=this._getTilingSpriteData(e),{geometry:i,canBatch:o}=s;if(o){s.batchableMesh||(s.batchableMesh=new Do);const a=s.batchableMesh;e._didTilingSpriteUpdate&&(e._didTilingSpriteUpdate=!1,this._updateBatchableMesh(e),a.geometry=i,a.mesh=e,a.texture=e._texture),a.roundPixels=this._renderer._roundPixels|e._roundPixels,n.addToBatch(a)}else n.break(t),s.shader||(s.shader=new _0),this.updateRenderable(e),t.add(e)}execute(e){const{shader:t}=this._tilingSpriteDataHash[e.uid];t.groups[0]=this._renderer.globalUniforms.bindGroup;const n=t.resources.localUniforms.uniforms;n.uTransformMatrix=e.groupTransform,n.uRound=this._renderer._roundPixels|e._roundPixels,vs(e.groupColorAlpha,n.uColor,0),this._renderer.encoder.draw({geometry:Ss,shader:t,state:Dt.default2d})}updateRenderable(e){const t=this._getTilingSpriteData(e),{canBatch:n}=t;if(n){const{batchableMesh:s}=t;e._didTilingSpriteUpdate&&this._updateBatchableMesh(e),s.batcher.updateElement(s)}else if(e._didTilingSpriteUpdate){const{shader:s}=t;s.updateUniforms(e.width,e.height,e._tileTransform.matrix,e.anchor.x,e.anchor.y,e.texture)}e._didTilingSpriteUpdate=!1}destroyRenderable(e){var n;const t=this._getTilingSpriteData(e);t.batchableMesh=null,(n=t.shader)==null||n.destroy(),this._tilingSpriteDataHash[e.uid]=null}_getTilingSpriteData(e){return this._tilingSpriteDataHash[e.uid]||this._initTilingSpriteData(e)}_initTilingSpriteData(e){const t=new ao({indices:Ss.indices,positions:Ss.positions.slice(),uvs:Ss.uvs.slice()});return this._tilingSpriteDataHash[e.uid]={canBatch:!0,renderable:e,geometry:t},e.on("destroyed",()=>{this.destroyRenderable(e)}),this._tilingSpriteDataHash[e.uid]}_updateBatchableMesh(e){const t=this._getTilingSpriteData(e),{geometry:n}=t,s=e.texture.source.style;s.addressMode!=="repeat"&&(s.addressMode="repeat",s.update()),v0(e,n.uvs),b0(e,n.positions)}destroy(){for(const e in this._tilingSpriteDataHash)this.destroyRenderable(this._tilingSpriteDataHash[e].renderable);this._tilingSpriteDataHash=null,this._renderer=null}_updateCanBatch(e){const t=this._getTilingSpriteData(e),n=e.texture;let s=!0;return this._renderer.type===Et.WEBGL&&(s=this._renderer.context.supports.nonPowOf2wrapping),t.canBatch=n.textureMatrix.isSimple&&(s||n.source.isPowerOfTwo),t.canBatch}}Ju.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"tilingSprite"};const Ho={test(r){return typeof r=="string"&&r.startsWith("info face=")},parse(r){const e=r.match(/^[a-z]+\s+.+$/gm),t={info:[],common:[],page:[],char:[],chars:[],kerning:[],kernings:[],distanceField:[]};for(const u in e){const d=e[u].match(/^[a-z]+/gm)[0],f=e[u].match(/[a-zA-Z]+=([^\s"']+|"([^"]*)")/gm),p={};for(const g in f){const m=f[g].split("="),_=m[0],b=m[1].replace(/"/gm,""),y=parseFloat(b),x=isNaN(y)?b:y;p[_]=x}t[d].push(p)}const n={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},[s]=t.info,[i]=t.common,[o]=t.distanceField??[];o&&(n.distanceField={range:parseInt(o.distanceRange,10),type:o.fieldType}),n.fontSize=parseInt(s.size,10),n.fontFamily=s.face,n.lineHeight=parseInt(i.lineHeight,10);const a=t.page;for(let u=0;u<a.length;u++)n.pages.push({id:parseInt(a[u].id,10)||0,file:a[u].file});const l={};n.baseLineOffset=n.lineHeight-parseInt(i.base,10);const c=t.char;for(let u=0;u<c.length;u++){const d=c[u],f=parseInt(d.id,10);let p=d.letter??d.char??String.fromCharCode(f);p==="space"&&(p=" "),l[f]=p,n.chars[p]={id:f,page:parseInt(d.page,10)||0,x:parseInt(d.x,10),y:parseInt(d.y,10),width:parseInt(d.width,10),height:parseInt(d.height,10),xOffset:parseInt(d.xoffset,10),yOffset:parseInt(d.yoffset,10),xAdvance:parseInt(d.xadvance,10),kerning:{}}}const h=t.kerning||[];for(let u=0;u<h.length;u++){const d=parseInt(h[u].first,10),f=parseInt(h[u].second,10),p=parseInt(h[u].amount,10);n.chars[l[f]].kerning[l[d]]=p}return n}},ed={test(r){const e=r;return typeof e!="string"&&"getElementsByTagName"in e&&e.getElementsByTagName("page").length&&e.getElementsByTagName("info")[0].getAttribute("face")!==null},parse(r){const e={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},t=r.getElementsByTagName("info")[0],n=r.getElementsByTagName("common")[0],s=r.getElementsByTagName("distanceField")[0];s&&(e.distanceField={type:s.getAttribute("fieldType"),range:parseInt(s.getAttribute("distanceRange"),10)});const i=r.getElementsByTagName("page"),o=r.getElementsByTagName("char"),a=r.getElementsByTagName("kerning");e.fontSize=parseInt(t.getAttribute("size"),10),e.fontFamily=t.getAttribute("face"),e.lineHeight=parseInt(n.getAttribute("lineHeight"),10);for(let c=0;c<i.length;c++)e.pages.push({id:parseInt(i[c].getAttribute("id"),10)||0,file:i[c].getAttribute("file")});const l={};e.baseLineOffset=e.lineHeight-parseInt(n.getAttribute("base"),10);for(let c=0;c<o.length;c++){const h=o[c],u=parseInt(h.getAttribute("id"),10);let d=h.getAttribute("letter")??h.getAttribute("char")??String.fromCharCode(u);d==="space"&&(d=" "),l[u]=d,e.chars[d]={id:u,page:parseInt(h.getAttribute("page"),10)||0,x:parseInt(h.getAttribute("x"),10),y:parseInt(h.getAttribute("y"),10),width:parseInt(h.getAttribute("width"),10),height:parseInt(h.getAttribute("height"),10),xOffset:parseInt(h.getAttribute("xoffset"),10),yOffset:parseInt(h.getAttribute("yoffset"),10),xAdvance:parseInt(h.getAttribute("xadvance"),10),kerning:{}}}for(let c=0;c<a.length;c++){const h=parseInt(a[c].getAttribute("first"),10),u=parseInt(a[c].getAttribute("second"),10),d=parseInt(a[c].getAttribute("amount"),10);e.chars[l[u]].kerning[l[h]]=d}return e}},td={test(r){return typeof r=="string"&&r.includes("<font>")?ed.test(xe.get().parseXML(r)):!1},parse(r){return ed.parse(xe.get().parseXML(r))}};class rd extends nh{constructor(e,t){super();const{textures:n,data:s}=e;Object.keys(s.pages).forEach(i=>{const o=s.pages[parseInt(i,10)],a=n[o.id];this.pages.push({texture:a})}),Object.keys(s.chars).forEach(i=>{const o=s.chars[i],{frame:a,source:l}=n[o.page],c=new he(o.x+a.x,o.y+a.y,o.width,o.height),h=new $({source:l,frame:c});this.chars[i]={id:i.codePointAt(0),xOffset:o.xOffset,yOffset:o.yOffset,xAdvance:o.xAdvance,kerning:o.kerning??{},texture:h}}),this.baseRenderedFontSize=s.fontSize,this.baseMeasurementFontSize=s.fontSize,this.fontMetrics={ascent:0,descent:0,fontSize:s.fontSize},this.baseLineOffset=s.baseLineOffset,this.lineHeight=s.lineHeight,this.fontFamily=s.fontFamily,this.distanceField=s.distanceField??{type:"none",range:0},this.url=t}destroy(){super.destroy();for(let e=0;e<this.pages.length;e++){const{texture:t}=this.pages[e];t.destroy(!0)}this.pages=null}static install(e){ho.install(e)}static uninstall(e){ho.uninstall(e)}}const w0=[".xml",".fnt"],S0={extension:M.CacheParser,test:r=>r instanceof rd,getCacheableAssets(r,e){const t={};return r.forEach(n=>{t[n]=e}),t[`${e.fontFamily}-bitmap`]=e,t}},T0={extension:{type:M.LoadParser,priority:wi.Normal},test(r){return w0.includes(Vt.extname(r).toLowerCase())},async testParse(r){return Ho.test(r)||td.test(r)},async parse(r,e,t){const n=Ho.test(r)?Ho.parse(r):td.parse(r),{src:s}=e,{pages:i}=n,o=[];for(let h=0;h<i.length;++h){const u=i[h].file;let d=Vt.join(Vt.dirname(s),u);d=Si(d,s),o.push(d)}const a=await t.load(o),l=o.map(h=>a[h]);return new rd({data:n,textures:l},s)},async load(r,e){return await(await xe.get().fetch(r)).text()},async unload(r,e,t){await Promise.all(r.pages.map(n=>t.unload(n.texture.source._sourceOrigin))),r.destroy()}},E0={name:"local-uniform-msdf-bit",vertex:{header:`
            struct LocalUniforms {
                uColor:vec4<f32>,
                uTransformMatrix:mat3x3<f32>,
                uDistance: f32,
                uRound:f32,
            }

            @group(2) @binding(0) var<uniform> localUniforms : LocalUniforms;
        `,main:`
            vColor *= localUniforms.uColor;
            modelMatrix *= localUniforms.uTransformMatrix;
        `,end:`
            if(localUniforms.uRound == 1)
            {
                vPosition = vec4(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);
            }
        `},fragment:{header:`
            struct LocalUniforms {
                uColor:vec4<f32>,
                uTransformMatrix:mat3x3<f32>,
                uDistance: f32
            }

            @group(2) @binding(0) var<uniform> localUniforms : LocalUniforms;
         `,main:` 
            outColor = vColor * calculateMSDFAlpha(outColor, localUniforms.uDistance);
        `}},P0={name:"local-uniform-msdf-bit",vertex:{header:`
            uniform mat3 uTransformMatrix;
            uniform vec4 uColor;
            uniform float uRound;
        `,main:`
            vColor *= uColor;
            modelMatrix *= uTransformMatrix;
        `,end:`
            if(uRound == 1.)
            {
                gl_Position.xy = roundPixels(gl_Position.xy, uResolution);
            }
        `},fragment:{header:`
            uniform float uDistance;
         `,main:` 
            outColor = vColor * calculateMSDFAlpha(outColor, uDistance);
        `}},A0={name:"msdf-bit",fragment:{header:`
            fn calculateMSDFAlpha(msdfColor:vec4<f32>, distance:f32) -> f32 {
                
                // MSDF
                var median = msdfColor.r + msdfColor.g + msdfColor.b -
                    min(msdfColor.r, min(msdfColor.g, msdfColor.b)) -
                    max(msdfColor.r, max(msdfColor.g, msdfColor.b));
            
                // SDF
                median = min(median, msdfColor.a);

                var screenPxDistance = distance * (median - 0.5);
                var alpha = clamp(screenPxDistance + 0.5, 0.0, 1.0);
                if (median < 0.01) {
                    alpha = 0.0;
                } else if (median > 0.99) {
                    alpha = 1.0;
                }

                return alpha;
            }
        `}},M0={name:"msdf-bit",fragment:{header:`
            float calculateMSDFAlpha(vec4 msdfColor, float distance) {
                
                // MSDF
                float median = msdfColor.r + msdfColor.g + msdfColor.b -
                                min(msdfColor.r, min(msdfColor.g, msdfColor.b)) -
                                max(msdfColor.r, max(msdfColor.g, msdfColor.b));
               
                // SDF
                median = min(median, msdfColor.a);
            
                float screenPxDistance = distance * (median - 0.5);
                float alpha = clamp(screenPxDistance + 0.5, 0.0, 1.0);
           
                if (median < 0.01) {
                    alpha = 0.0;
                } else if (median > 0.99) {
                    alpha = 1.0;
                }

                return alpha;
            }
        `}};class C0 extends ot{constructor(){const e=new Qe({uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uTransformMatrix:{value:new W,type:"mat3x3<f32>"},uDistance:{value:4,type:"f32"},uRound:{value:0,type:"f32"}}),t=gn({name:"sdf-shader",bits:[po,_o(mt),E0,A0,yn]}),n=_n({name:"sdf-shader",bits:[mo,bo(mt),P0,M0,bn]});super({glProgram:n,gpuProgram:t,resources:{localUniforms:e,batchSamplers:xo}})}}class nd{constructor(e){this._gpuBitmapText={},this._renderer=e}validateRenderable(e){const t=this._getGpuBitmapText(e);return e._didTextUpdate&&(e._didTextUpdate=!1,this._updateContext(e,t)),this._renderer.renderPipes.graphics.validateRenderable(t)}addRenderable(e,t){const n=this._getGpuBitmapText(e);sd(e,n),e._didTextUpdate&&(e._didTextUpdate=!1,this._updateContext(e,n)),this._renderer.renderPipes.graphics.addRenderable(n,t),n.context.customShader&&this._updateDistanceField(e)}destroyRenderable(e){this._destroyRenderableByUid(e.uid)}_destroyRenderableByUid(e){oe.return(this._gpuBitmapText[e]),this._gpuBitmapText[e]=null}updateRenderable(e){const t=this._getGpuBitmapText(e);sd(e,t),this._renderer.renderPipes.graphics.updateRenderable(t),t.context.customShader&&this._updateDistanceField(e)}_updateContext(e,t){var f;const{context:n}=t,s=ho.getFont(e.text,e._style);n.clear(),s.distanceField.type!=="none"&&(n.customShader||(this._sdfShader||(this._sdfShader=new C0),n.customShader=this._sdfShader));const i=Array.from(e.text),o=e._style;let a=(((f=o._stroke)==null?void 0:f.width)||0)/2;a+=s.baseLineOffset;const l=oh(i,o,s);let c=0;const h=o.padding,u=l.scale;n.translate(-e._anchor._x*l.width-h,-e._anchor._y*(l.height+l.offsetY)-h).scale(u,u);const d=o._fill.color;for(let p=0;p<l.lines.length;p++){const g=l.lines[p];for(let m=0;m<g.charPositions.length;m++){const _=i[c++],b=s.chars[_];b!=null&&b.texture&&n.texture(b.texture,d||"black",Math.round(g.charPositions[m]+b.xOffset),Math.round(a+b.yOffset))}a+=s.lineHeight}}_getGpuBitmapText(e){return this._gpuBitmapText[e.uid]||this.initGpuText(e)}initGpuText(e){const t=oe.get(Lr);return this._gpuBitmapText[e.uid]=t,this._updateContext(e,t),e.on("destroyed",()=>{this.destroyRenderable(e)}),this._gpuBitmapText[e.uid]}_updateDistanceField(e){const t=this._getGpuBitmapText(e).context,n=e._style.fontFamily,s=Ge.get(`${n}-bitmap`),{a:i,b:o,c:a,d:l}=e.groupTransform,c=Math.sqrt(i*i+o*o),h=Math.sqrt(a*a+l*l),u=(Math.abs(c)+Math.abs(h))/2,d=s.baseRenderedFontSize/e._style.fontSize,f=e.resolution??this._renderer.resolution,p=u*s.distanceField.range*(1/d)*f;t.customShader.resources.localUniforms.uniforms.uDistance=p}destroy(){var e;for(const t in this._gpuBitmapText)this._destroyRenderableByUid(t);this._gpuBitmapText=null,(e=this._sdfShader)==null||e.destroy(!0),this._sdfShader=null,this._renderer=null}}nd.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"bitmapText"};function sd(r,e){e.groupTransform=r.groupTransform,e.groupColorAlpha=r.groupColorAlpha,e.groupColor=r.groupColor,e.groupBlendMode=r.groupBlendMode,e.globalDisplayStatus=r.globalDisplayStatus,e.groupTransform=r.groupTransform,e.localDisplayStatus=r.localDisplayStatus,e.groupAlpha=r.groupAlpha,e._roundPixels=r._roundPixels}class id{constructor(e){this._gpuText=Object.create(null),this._renderer=e}validateRenderable(e){const t=this._getGpuText(e),n=e._getKey();return t.textureNeedsUploading?(t.textureNeedsUploading=!1,!0):t.currentKey!==n}addRenderable(e){const n=this._getGpuText(e).batchableSprite;e._didTextUpdate&&this._updateText(e),this._renderer.renderPipes.batch.addToBatch(n)}updateRenderable(e){const n=this._getGpuText(e).batchableSprite;e._didTextUpdate&&this._updateText(e),n.batcher.updateElement(n)}destroyRenderable(e){this._destroyRenderableById(e.uid)}_destroyRenderableById(e){const t=this._gpuText[e];this._renderer.htmlText.decreaseReferenceCount(t.currentKey),oe.return(t.batchableSprite),this._gpuText[e]=null}_updateText(e){const t=e._getKey(),n=this._getGpuText(e),s=n.batchableSprite;n.currentKey!==t&&this._updateGpuText(e).catch(o=>{console.error(o)}),e._didTextUpdate=!1;const i=e._style.padding;Yn(s.bounds,e._anchor,s.texture,i)}async _updateGpuText(e){e._didTextUpdate=!1;const t=this._getGpuText(e);if(t.generatingTexture)return;const n=e._getKey();this._renderer.htmlText.decreaseReferenceCount(t.currentKey),t.generatingTexture=!0,t.currentKey=n;const s=e.resolution??this._renderer.resolution,i=await this._renderer.htmlText.getManagedTexture(e.text,s,e._style,e._getKey()),o=t.batchableSprite;o.texture=t.texture=i,t.generatingTexture=!1,t.textureNeedsUploading=!0,e.onViewUpdate();const a=e._style.padding;Yn(o.bounds,e._anchor,o.texture,a)}_getGpuText(e){return this._gpuText[e.uid]||this.initGpuText(e)}initGpuText(e){const t={texture:$.EMPTY,currentKey:"--",batchableSprite:oe.get(Bo),textureNeedsUploading:!1,generatingTexture:!1},n=t.batchableSprite;return n.renderable=e,n.texture=$.EMPTY,n.bounds={minX:0,maxX:1,minY:0,maxY:0},n.roundPixels=this._renderer._roundPixels|e._roundPixels,this._gpuText[e.uid]=t,e.on("destroyed",()=>{this.destroyRenderable(e)}),t}destroy(){for(const e in this._gpuText)this._destroyRenderableById(e);this._gpuText=null,this._renderer=null}}id.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"htmlText"};function B0(){const{userAgent:r}=xe.get().getNavigator();return/^((?!chrome|android).)*safari/i.test(r)}const R0=new Ze;function od(r,e,t,n){const s=R0;s.minX=0,s.minY=0,s.maxX=r.width/n|0,s.maxY=r.height/n|0;const i=at.getOptimalTexture(s.width,s.height,n,!1);return i.source.uploadMethodId="image",i.source.resource=r,i.source.alphaMode="premultiply-alpha-on-upload",i.frame.width=e/n,i.frame.height=t/n,i.source.emit("update",i.source),i.updateUvs(),i}function k0(r,e){const t=e.fontFamily,n=[],s={},i=/font-family:([^;"\s]+)/g,o=r.match(i);function a(l){s[l]||(n.push(l),s[l]=!0)}if(Array.isArray(t))for(let l=0;l<t.length;l++)a(t[l]);else a(t);o&&o.forEach(l=>{const c=l.split(":")[1].trim();a(c)});for(const l in e.tagStyles){const c=e.tagStyles[l].fontFamily;a(c)}return n}async function I0(r){const t=await(await xe.get().fetch(r)).blob(),n=new FileReader;return await new Promise((i,o)=>{n.onloadend=()=>i(n.result),n.onerror=o,n.readAsDataURL(t)})}async function ad(r,e){const t=await I0(e);return`@font-face {
        font-family: "${r.fontFamily}";
        src: url('${t}');
        font-weight: ${r.fontWeight};
        font-style: ${r.fontStyle};
    }`}const Ts=new Map;async function G0(r,e,t){const n=r.filter(s=>Ge.has(`${s}-and-url`)).map((s,i)=>{if(!Ts.has(s)){const{url:o}=Ge.get(`${s}-and-url`);i===0?Ts.set(s,ad(e,o)):Ts.set(s,ad({fontWeight:t.fontWeight,fontStyle:t.fontStyle,fontFamily:s},o))}return Ts.get(s)});return(await Promise.all(n)).join(`
`)}function U0(r,e,t,n,s){const{domElement:i,styleElement:o,svgRoot:a}=s;i.innerHTML=`<style>${e.cssStyle}</style><div>${r}</div>`,i.setAttribute("style",`transform: scale(${t});transform-origin: top left; display: inline-block`),o.textContent=n;const{width:l,height:c}=s.image;return a.setAttribute("width",l.toString()),a.setAttribute("height",c.toString()),new XMLSerializer().serializeToString(a)}function F0(r,e){const t=Nt.getOptimalCanvasAndContext(r.width,r.height,e),{context:n}=t;return n.clearRect(0,0,r.width,r.height),n.drawImage(r,0,0),Nt.returnCanvasAndContext(t),t.canvas}function O0(r,e,t){return new Promise(async n=>{t&&await new Promise(s=>setTimeout(s,100)),r.onload=()=>{n()},r.src=`data:image/svg+xml;charset=utf8,${encodeURIComponent(e)}`,r.crossOrigin="anonymous"})}class zo{constructor(e){this._activeTextures={},this._renderer=e,this._createCanvas=e.type===Et.WEBGPU}getTexture(e){return this._buildTexturePromise(e.text,e.resolution,e.style)}getManagedTexture(e,t,n,s){if(this._activeTextures[s])return this._increaseReferenceCount(s),this._activeTextures[s].promise;const i=this._buildTexturePromise(e,t,n).then(o=>(this._activeTextures[s].texture=o,o));return this._activeTextures[s]={texture:null,promise:i,usageCount:1},i}async _buildTexturePromise(e,t,n){const s=oe.get(fh),i=k0(e,n),o=await G0(i,n,uo.defaultTextStyle),a=fb(e,n,o,s),l=Math.ceil(Math.ceil(Math.max(1,a.width)+n.padding*2)*t),c=Math.ceil(Math.ceil(Math.max(1,a.height)+n.padding*2)*t),h=s.image;h.width=l|0,h.height=c|0;const u=U0(e,n,t,o,s);await O0(h,u,B0()&&i.length>0);let d=h;this._createCanvas&&(d=F0(h,t));const f=od(d,h.width,h.height,t);return this._createCanvas&&this._renderer.texture.initSource(f.source),oe.return(s),f}_increaseReferenceCount(e){this._activeTextures[e].usageCount++}decreaseReferenceCount(e){const t=this._activeTextures[e];t&&(t.usageCount--,t.usageCount===0&&(t.texture?this._cleanUp(t):t.promise.then(n=>{t.texture=n,this._cleanUp(t)}).catch(()=>{ne("HTMLTextSystem: Failed to clean texture")}),this._activeTextures[e]=null))}_cleanUp(e){at.returnTexture(e.texture),e.texture.source.resource=null,e.texture.source.uploadMethodId="unknown"}getReferenceCount(e){return this._activeTextures[e].usageCount}destroy(){this._activeTextures=null}}zo.extension={type:[M.WebGLSystem,M.WebGPUSystem,M.CanvasSystem],name:"htmlText"},zo.defaultFontOptions={fontFamily:"Arial",fontStyle:"normal",fontWeight:"normal"};class ld{constructor(e){this._gpuText=Object.create(null),this._renderer=e}validateRenderable(e){const t=this._getGpuText(e),n=e._getKey();if(t.currentKey!==n){const s=e.resolution??this._renderer.resolution,{width:i,height:o}=this._renderer.canvasText.getTextureSize(e.text,s,e._style);return!(this._renderer.canvasText.getReferenceCount(t.currentKey)===1&&i===t.texture._source.width&&o===t.texture._source.height)}return!1}addRenderable(e,t){const s=this._getGpuText(e).batchableSprite;e._didTextUpdate&&this._updateText(e),this._renderer.renderPipes.batch.addToBatch(s)}updateRenderable(e){const n=this._getGpuText(e).batchableSprite;e._didTextUpdate&&this._updateText(e),n.batcher.updateElement(n)}destroyRenderable(e){this._destroyRenderableById(e.uid)}_destroyRenderableById(e){const t=this._gpuText[e];this._renderer.canvasText.decreaseReferenceCount(t.currentKey),oe.return(t.batchableSprite),this._gpuText[e]=null}_updateText(e){const t=e._getKey(),n=this._getGpuText(e),s=n.batchableSprite;n.currentKey!==t&&this._updateGpuText(e),e._didTextUpdate=!1;const i=e._style.padding;Yn(s.bounds,e._anchor,s.texture,i)}_updateGpuText(e){const t=this._getGpuText(e),n=t.batchableSprite;t.texture&&this._renderer.canvasText.decreaseReferenceCount(t.currentKey),t.texture=n.texture=this._renderer.canvasText.getManagedTexture(e),t.currentKey=e._getKey(),n.texture=t.texture}_getGpuText(e){return this._gpuText[e.uid]||this.initGpuText(e)}initGpuText(e){const t={texture:null,currentKey:"--",batchableSprite:oe.get(Bo)};return t.batchableSprite.renderable=e,t.batchableSprite.bounds={minX:0,maxX:1,minY:0,maxY:0},t.batchableSprite.roundPixels=this._renderer._roundPixels|e._roundPixels,this._gpuText[e.uid]=t,this._updateText(e),e.on("destroyed",()=>{this.destroyRenderable(e)}),t}destroy(){for(const e in this._gpuText)this._destroyRenderableById(e);this._gpuText=null,this._renderer=null}}ld.extension={type:[M.WebGLPipes,M.WebGPUPipes,M.CanvasPipes],name:"text"};function cd(r,e,t){for(let n=0,s=4*t*e;n<e;++n,s+=4)if(r[s+3]!==0)return!1;return!0}function hd(r,e,t,n,s){const i=4*e;for(let o=n,a=n*i+4*t;o<=s;++o,a+=i)if(r[a+3]!==0)return!1;return!0}function D0(r,e=1){const{width:t,height:n}=r,s=r.getContext("2d",{willReadFrequently:!0});if(s===null)throw new TypeError("Failed to get canvas 2D context");const o=s.getImageData(0,0,t,n).data;let a=0,l=0,c=t-1,h=n-1;for(;l<n&&cd(o,t,l);)++l;if(l===n)return he.EMPTY;for(;cd(o,t,h);)--h;for(;hd(o,t,a,l,h);)++a;for(;hd(o,t,c,l,h);)--c;return++c,++h,new he(a/e,l/e,(c-a)/e,(h-l)/e)}class ud{constructor(e){this._activeTextures={},this._renderer=e}getTextureSize(e,t,n){const s=Lt.measureText(e||" ",n);let i=Math.ceil(Math.ceil(Math.max(1,s.width)+n.padding*2)*t),o=Math.ceil(Math.ceil(Math.max(1,s.height)+n.padding*2)*t);return i=Math.ceil(i-1e-6),o=Math.ceil(o-1e-6),i=Mr(i),o=Mr(o),{width:i,height:o}}getTexture(e,t,n,s){typeof e=="string"&&(ie("8.0.0","CanvasTextSystem.getTexture: Use object TextOptions instead of separate arguments"),e={text:e,style:n,resolution:t}),e.style instanceof Nr||(e.style=new Nr(e.style));const{texture:i,canvasAndContext:o}=this.createTextureAndCanvas(e);return this._renderer.texture.initSource(i._source),Nt.returnCanvasAndContext(o),i}createTextureAndCanvas(e){const{text:t,style:n}=e,s=e.resolution??this._renderer.resolution,i=Lt.measureText(t||" ",n),o=Math.ceil(Math.ceil(Math.max(1,i.width)+n.padding*2)*s),a=Math.ceil(Math.ceil(Math.max(1,i.height)+n.padding*2)*s),l=Nt.getOptimalCanvasAndContext(o,a),{canvas:c}=l;this.renderTextToCanvas(t,n,s,l);const h=od(c,o,a,s);if(n.trim){const u=D0(c,s);h.frame.copyFrom(u),h.updateUvs()}return{texture:h,canvasAndContext:l}}getManagedTexture(e){const t=e._getKey();if(this._activeTextures[t])return this._increaseReferenceCount(t),this._activeTextures[t].texture;const{texture:n,canvasAndContext:s}=this.createTextureAndCanvas(e);return this._activeTextures[t]={canvasAndContext:s,texture:n,usageCount:1},n}_increaseReferenceCount(e){this._activeTextures[e].usageCount++}decreaseReferenceCount(e){const t=this._activeTextures[e];if(t.usageCount--,t.usageCount===0){Nt.returnCanvasAndContext(t.canvasAndContext),at.returnTexture(t.texture);const n=t.texture.source;n.resource=null,n.uploadMethodId="unknown",n.alphaMode="no-premultiply-alpha",this._activeTextures[e]=null}}getReferenceCount(e){return this._activeTextures[e].usageCount}renderTextToCanvas(e,t,n,s){var y,x,S,k,P;const{canvas:i,context:o}=s,a=ps(t),l=Lt.measureText(e||" ",t),c=l.lines,h=l.lineHeight,u=l.lineWidths,d=l.maxLineWidth,f=l.fontProperties,p=i.height;o.resetTransform(),o.scale(n,n);const g=t.padding*2;if(o.clearRect(0,0,l.width+4+g,l.height+4+g),(y=t._stroke)!=null&&y.width){const T=t._stroke;o.lineWidth=T.width,o.miterLimit=T.miterLimit,o.lineJoin=T.join,o.lineCap=T.cap}o.font=a;let m,_;const b=t.dropShadow?2:1;for(let T=0;T<b;++T){const E=t.dropShadow&&T===0,v=E?Math.ceil(Math.max(1,p)+t.padding*2):0,R=v*n;if(E){o.fillStyle="black",o.strokeStyle="black";const A=t.dropShadow,F=A.color,D=A.alpha;o.shadowColor=ue.shared.setValue(F).setAlpha(D).toRgbaString();const V=A.blur*n,K=A.distance*n;o.shadowBlur=V,o.shadowOffsetX=Math.cos(A.angle)*K,o.shadowOffsetY=Math.sin(A.angle)*K+R}else o.globalAlpha=((x=t._fill)==null?void 0:x.alpha)??1,o.fillStyle=t._fill?ms(t._fill,o):null,(S=t._stroke)!=null&&S.width&&(o.strokeStyle=ms(t._stroke,o)),o.shadowColor="black";let I=(h-f.fontSize)/2;h-f.fontSize<0&&(I=0);const C=((k=t._stroke)==null?void 0:k.width)??0;for(let A=0;A<c.length;A++)m=C/2,_=C/2+A*h+f.ascent+I,t.align==="right"?m+=d-u[A]:t.align==="center"&&(m+=(d-u[A])/2),(P=t._stroke)!=null&&P.width&&this._drawLetterSpacing(c[A],t,s,m+t.padding,_+t.padding-v,!0),t._fill!==void 0&&this._drawLetterSpacing(c[A],t,s,m+t.padding,_+t.padding-v)}}_drawLetterSpacing(e,t,n,s,i,o=!1){const{context:a}=n,l=t.letterSpacing;let c=!1;if(Lt.experimentalLetterSpacingSupported&&(Lt.experimentalLetterSpacing?(a.letterSpacing=`${l}px`,a.textLetterSpacing=`${l}px`,c=!0):(a.letterSpacing="0px",a.textLetterSpacing="0px")),l===0||c){o?a.strokeText(e,s,i):a.fillText(e,s,i);return}let h=s;const u=Lt.graphemeSegmenter(e);let d=a.measureText(e).width,f=0;for(let p=0;p<u.length;++p){const g=u[p];o?a.strokeText(g,h,i):a.fillText(g,h,i);let m="";for(let _=p+1;_<u.length;++_)m+=u[_];f=a.measureText(m).width,h+=d-f+l,d=f}}destroy(){this._activeTextures=null}}ud.extension={type:[M.WebGLSystem,M.WebGPUSystem,M.CanvasSystem],name:"canvasText"},re.add(og,ag);const L0=1733608,N0=.25,H0=.02;let Sn;const $o=r=>{const e={tint:r!=null&&r.fill?new ue(r.fill).toNumber():L0,alpha:(r==null?void 0:r.fillOpacity)===void 0?N0:Math.min(r.fillOpacity,1)},t={tint:(r==null?void 0:r.stroke)&&new ue(r.stroke).toNumber(),alpha:(r==null?void 0:r.strokeOpacity)===void 0?r!=null&&r.stroke?1:0:Math.min(r.strokeOpacity,1),lineWidth:r!=null&&r.stroke?(r==null?void 0:r.strokeWidth)||1:0};return{fillStyle:e,strokeStyle:t}},Wo=r=>(e,t,n)=>{const{fillStyle:s,strokeStyle:i}=$o(n),o=new Lr;r(t,o),o.fill(16777215),o.tint=s.tint,o.alpha=s.alpha,e.addChild(o);const a=i.lineWidth/Sn,l=new Lr;return r(t,l),l.stroke({color:16777215,width:a,alpha:1,alignment:.5}),l.tint=i.tint||16777215,l.alpha=i.alpha,e.addChild(l),{fill:o,stroke:l,strokeWidth:i.lineWidth,drawFn:c=>r(t,c)}},z0=Wo((r,e)=>{const{cx:t,cy:n,rx:s,ry:i}=r.geometry;e.ellipse(t,n,s,i)}),$0=Wo((r,e)=>{const t=r.geometry.points.reduce((n,s)=>[...n,...s],[]);e.poly(t)}),W0=Wo((r,e)=>{const{x:t,y:n,w:s,h:i}=r.geometry;e.rect(t,n,s,i)}),dd=r=>{const e=r.viewport.getContainerSize().x;return r.viewport.getZoom(!0)*e/r.world.getContentFactor()},V0=(r,e,t,n)=>()=>{const s=r.viewport.viewportToImageRectangle(r.viewport.getBounds(!0)),i=dd(r);i!==Sn&&Math.abs(i-Sn)>H0&&(t.forEach(({stroke:u,strokeWidth:d,drawFn:f})=>{u.clear(),f(u),u.stroke({color:16777215,width:d/i,alpha:1,alignment:.5})}),Sn=i);const o=Math.PI*r.viewport.getRotation()/180,a=-s.x*i,l=-s.y*i;let c,h;o>0&&o<=Math.PI/2?(c=s.height*i,h=0):o>Math.PI/2&&o<=Math.PI?(c=s.width*i,h=s.height*i):o>Math.PI&&o<=Math.PI*1.5?(c=0,h=s.width*i):(c=0,h=0),e.position.x=c+a*Math.cos(o)-l*Math.sin(o),e.position.y=h+a*Math.sin(o)+l*Math.cos(o),e.scale.set(i,i),e.rotation=o,n.render(e)},X0=async(r,e)=>{const t=new Se,n=await j_({width:e.width,height:e.height,backgroundAlpha:0,canvas:e,antialias:!0,resolution:2}),s=new Map;let i=new Set,o,a;Sn=dd(r);const l=(y,x)=>{const{selector:S}=y.target,k=typeof a=="function"?a(y,x):a;let P;S.type===fe.RECTANGLE?P=W0(t,S,k):S.type===fe.POLYGON?P=$0(t,S,k):S.type===fe.ELLIPSE?P=z0(t,S,k):console.warn(`Unsupported shape type: ${S.type}`),P&&s.set(y.id,{annotation:y,...P})},c=y=>{const x=s.get(y.id);x&&(s.delete(y.id),x.fill.destroy(),x.stroke.destroy())},h=(y,x,S)=>{const k=s.get(y.id);k&&(s.delete(y.id),k.fill.destroy(),k.stroke.destroy(),l(x,S))},u=(y,x)=>{const S=s.get(y);S&&(s.delete(y),S.fill.destroy(),S.stroke.destroy(),l(S.annotation,x))},d=(y,x)=>{n.resize(y,x),n.render(t)},f=y=>{const{children:x}=t;s.forEach(({fill:S,stroke:k,annotation:P})=>{const T=y?i.has(P.id)||y(P):!0;T&&!x.includes(S)?(t.addChild(S),t.addChild(k)):!T&&x.includes(S)&&(t.removeChild(S),t.removeChild(k))}),n.render(t)},p=y=>{o!==y&&(o&&u(o,{selected:i.has(o)}),y&&u(y,{selected:i.has(y),hovered:!0}),o=y,n.render(t))},g=y=>{const x=y.selected.map(P=>P.id),S=x.filter(P=>!i.has(P)),k=[...i].filter(P=>!x.includes(P));[...S,...k].forEach(P=>u(P,{selected:x.includes(P),hovered:P===o})),i=new Set(x),n.render(t)},m=y=>{if(typeof y=="function")s.forEach(({annotation:x,fill:S,stroke:k,strokeWidth:P,drawFn:T},E)=>{const{fillStyle:v,strokeStyle:R}=$o(y(x));S.tint=v.tint,S.alpha=v.alpha,k.tint=R.tint||16777215,k.alpha=R.alpha,s.set(x.id,{annotation:x,fill:S,stroke:k,strokeWidth:P,drawFn:T})});else{const{fillStyle:x,strokeStyle:S}=$o(y);s.forEach(({annotation:k,fill:P,stroke:T,strokeWidth:E,drawFn:v},R)=>{P.tint=x.tint,P.alpha=x.alpha,T.tint=S.tint||16777215,T.alpha=S.alpha,s.set(k.id,{annotation:k,fill:P,stroke:T,strokeWidth:E,drawFn:v})})}a=y,n.render(t)},_=y=>{y?e.classList.remove("hidden"):e.classList.add("hidden")};return{addAnnotation:l,destroy:()=>n.destroy(),redraw:V0(r,t,s,n),removeAnnotation:c,resize:d,setFilter:f,setHovered:p,setSelected:g,setStyle:m,setVisible:_,updateAnnotation:h}};function Y0(r,e,t){let n,s,{filter:i}=e,{state:o}=e,{style:a}=e,{viewer:l}=e,{visible:c=!0}=e;const{store:h,hover:u,selection:d,viewport:f}=o;Vs(r,u,T=>t(12,n=T)),Vs(r,d,T=>t(8,s=T));const p=Hn();let g,m,_=new Promise(T=>{m=T}),b;const y=T=>{const E=new Fe.Point(T.x,T.y),{x:v,y:R}=l.viewport.pointFromPixel(E);return l.viewport.viewportToImageCoordinates(v,R)},x=T=>{const{x:E,y:v}=T.position;b={x:E,y:v}},S=T=>E=>{const{x:v,y:R}=y(new Fe.Point(E.offsetX,E.offsetY)),I=h.getAt(v,R);I&&(!i||i(I))?(T.classList.add("hover"),n!==I.id&&(u.set(I.id),g.setHovered(I.id))):(T.classList.remove("hover"),n&&(u.set(void 0),g.setHovered(void 0)))},k=T=>{const E=T.originalEvent,{x:v,y:R}=T.position,I=v-b.x,C=R-b.y;if(Math.sqrt(I*I+C*C)<5){const{x:F,y:D}=y(T.position),V=h.getAt(F,D);V?p("click",{originalEvent:E,annotation:V}):p("click",{originalEvent:E})}b=void 0};let P;return Nn(()=>{var C;const{offsetWidth:T,offsetHeight:E}=l.canvas,v=document.createElement("canvas");v.width=T,v.height=E,v.className="a9s-gl-canvas",(C=l.element.querySelector(".openseadragon-canvas"))==null||C.appendChild(v);const R=S(v),I=()=>{const A=l.viewport.getBounds();P=l.viewport.viewportToImageRectangle(A);const{x:F,y:D,width:V,height:K}=P,N=h.getIntersecting(F,D,V,K);f.set(N.map(U=>U.id))};return X0(l,v).then(A=>{t(7,g=A),v.addEventListener("pointermove",R),new ResizeObserver(D=>{try{const{width:V,height:K}=D[0].contentRect;g.resize(V,K)}catch{console.warn("WebGL canvas already disposed")}}).observe(v),l.addHandler("canvas-press",x),l.addHandler("canvas-release",k),l.addHandler("update-viewport",g.redraw),l.addHandler("animation-finish",I),m()}),()=>{var A;v.removeEventListener("pointermove",R),l.removeHandler("canvas-press",x),l.removeHandler("canvas-release",k),l.removeHandler("update-viewport",g.redraw),l.removeHandler("animation-finish",I),g.destroy(),(A=v.parentNode)==null||A.removeChild(v)}}),h.observe(async T=>{await _;const{created:E,updated:v,deleted:R}=T.changes;if((E||[]).forEach(I=>g.addAnnotation(I)),(v||[]).forEach(({oldValue:I,newValue:C})=>g.updateAnnotation(I,C)),(R||[]).forEach(I=>g.removeAnnotation(I)),P){const{x:I,y:C,width:A,height:F}=P,D=h.getIntersecting(I,C,A,F);f.set(D.map(V=>V.id))}else f.set(h.all().map(I=>I.id));g.redraw()}),r.$$set=T=>{"filter"in T&&t(2,i=T.filter),"state"in T&&t(3,o=T.state),"style"in T&&t(4,a=T.style),"viewer"in T&&t(5,l=T.viewer),"visible"in T&&t(6,c=T.visible)},r.$$.update=()=>{r.$$.dirty&132&&(g==null||g.setFilter(i)),r.$$.dirty&384&&(g==null||g.setSelected(s)),r.$$.dirty&144&&(g==null||g.setStyle(a)),r.$$.dirty&192&&(g==null||g.setVisible(c))},[u,d,i,o,a,l,c,g,s]}class j0 extends je{constructor(e){super(),Ye(this,e,Y0,null,He,{filter:2,state:3,style:4,viewer:5,visible:6})}}let Es;const q0=new Uint8Array(16);function K0(){if(!Es&&(Es=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Es))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Es(q0)}const Ue=[];for(let r=0;r<256;++r)Ue.push((r+256).toString(16).slice(1));function Z0(r,e=0){return Ue[r[e+0]]+Ue[r[e+1]]+Ue[r[e+2]]+Ue[r[e+3]]+"-"+Ue[r[e+4]]+Ue[r[e+5]]+"-"+Ue[r[e+6]]+Ue[r[e+7]]+"-"+Ue[r[e+8]]+Ue[r[e+9]]+"-"+Ue[r[e+10]]+Ue[r[e+11]]+Ue[r[e+12]]+Ue[r[e+13]]+Ue[r[e+14]]+Ue[r[e+15]]}const fd={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Q0(r,e,t){if(fd.randomUUID&&!e&&!r)return fd.randomUUID();r=r||{};const n=r.random||(r.rng||K0)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,Z0(n)}var zr=(r=>(r.ELLIPSE="ELLIPSE",r.POLYGON="POLYGON",r.RECTANGLE="RECTANGLE",r))(zr||{});const Vo=(r,e)=>e,J0=r=>{let e=1/0,t=1/0,n=-1/0,s=-1/0;return r.forEach(([i,o])=>{e=Math.min(e,i),t=Math.min(t,o),n=Math.max(n,i),s=Math.max(s,o)}),{minX:e,minY:t,maxX:n,maxY:s}},ev={area:r=>Math.PI*r.geometry.rx*r.geometry.ry,intersects:(r,e,t)=>{const{cx:n,cy:s,rx:i,ry:o}=r.geometry,a=0,l=Math.cos(a),c=Math.sin(a),h=e-n,u=t-s,d=l*h+c*u,f=c*h-l*u;return d*d/(i*i)+f*f/(o*o)<=1}};Vo(zr.ELLIPSE,ev);const tv={area:r=>{const{points:e}=r.geometry;let t=0,n=e.length-1;for(let s=0;s<e.length;s++)t+=(e[n][0]+e[s][0])*(e[n][1]-e[s][1]),n=s;return Math.abs(.5*t)},intersects:(r,e,t)=>{const{points:n}=r.geometry;let s=!1;for(let i=0,o=n.length-1;i<n.length;o=i++){const a=n[i][0],l=n[i][1],c=n[o][0],h=n[o][1];l>t!=h>t&&e<(c-a)*(t-l)/(h-l)+a&&(s=!s)}return s}};Vo(zr.POLYGON,tv);const rv={area:r=>r.geometry.w*r.geometry.h,intersects:(r,e,t)=>e>=r.geometry.x&&e<=r.geometry.x+r.geometry.w&&t>=r.geometry.y&&t<=r.geometry.y+r.geometry.h};Vo(zr.RECTANGLE,rv);function pd(r,e,t){const n=r.slice();return n[10]=e[t],n[12]=t,n}function md(r){let e,t;return e=new Tn({props:{x:r[10][0],y:r[10][1],scale:r[3]}}),e.$on("pointerdown",function(){De(r[9](`HANDLE-${r[12]}`))&&r[9](`HANDLE-${r[12]}`).apply(this,arguments)}),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,s){r=n;const i={};s&16&&(i.x=r[10][0]),s&16&&(i.y=r[10][1]),s&8&&(i.scale=r[3]),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}function nv(r){let e,t,n,s,i,o,a,l,c,h,u,d=Ar(r[4].points),f=[];for(let g=0;g<d.length;g+=1)f[g]=md(pd(r,d,g));const p=g=>J(f[g],1,1,()=>{f[g]=null});return{c(){e=me("polygon"),s=dt(),i=me("polygon"),a=dt();for(let g=0;g<f.length;g+=1)f[g].c();l=$t(),B(e,"class","a9s-outer"),B(e,"style",t=r[1]?"display:none;":void 0),B(e,"points",n=r[4].points.map(gd).join(" ")),B(i,"class","a9s-inner a9s-shape-handle"),B(i,"style",r[1]),B(i,"points",o=r[4].points.map(_d).join(" "))},m(g,m){Q(g,e,m),Q(g,s,m),Q(g,i,m),Q(g,a,m);for(let _=0;_<f.length;_+=1)f[_]&&f[_].m(g,m);Q(g,l,m),c=!0,h||(u=[ke(e,"pointerdown",function(){De(r[9]("SHAPE"))&&r[9]("SHAPE").apply(this,arguments)}),ke(i,"pointerdown",function(){De(r[9]("SHAPE"))&&r[9]("SHAPE").apply(this,arguments)})],h=!0)},p(g,m){if(r=g,(!c||m&2&&t!==(t=r[1]?"display:none;":void 0))&&B(e,"style",t),(!c||m&16&&n!==(n=r[4].points.map(gd).join(" ")))&&B(e,"points",n),(!c||m&2)&&B(i,"style",r[1]),(!c||m&16&&o!==(o=r[4].points.map(_d).join(" ")))&&B(i,"points",o),m&536){d=Ar(r[4].points);let _;for(_=0;_<d.length;_+=1){const b=pd(r,d,_);f[_]?(f[_].p(b,m),j(f[_],1)):(f[_]=md(b),f[_].c(),j(f[_],1),f[_].m(l.parentNode,l))}for(Rt(),_=d.length;_<f.length;_+=1)p(_);kt()}},i(g){if(!c){for(let m=0;m<d.length;m+=1)j(f[m]);c=!0}},o(g){f=f.filter(Boolean);for(let m=0;m<f.length;m+=1)J(f[m]);c=!1},d(g){g&&(Z(e),Z(s),Z(i),Z(a),Z(l)),Xs(f,g),h=!1,Mt(u)}}}function sv(r){let e,t;return e=new bd({props:{shape:r[0],transform:r[2],editor:r[5],$$slots:{default:[nv,({grab:n})=>({9:n}),({grab:n})=>n?512:0]},$$scope:{ctx:r}}}),e.$on("change",r[6]),e.$on("grab",r[7]),e.$on("release",r[8]),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,[s]){const i={};s&1&&(i.shape=n[0]),s&4&&(i.transform=n[2]),s&8730&&(i.$$scope={dirty:s,ctx:n}),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}const gd=r=>r.join(","),_d=r=>r.join(",");function iv(r,e,t){let n,{shape:s}=e,{computedStyle:i}=e,{transform:o}=e,{viewportScale:a=1}=e;const l=(d,f,p)=>{let g;const m=d.geometry;f==="SHAPE"?g=m.points.map(([b,y])=>[b+p[0],y+p[1]]):g=m.points.map(([b,y],x)=>f===`HANDLE-${x}`?[b+p[0],y+p[1]]:[b,y]);const _=J0(g);return{...d,geometry:{points:g,bounds:_}}};function c(d){Bt.call(this,r,d)}function h(d){Bt.call(this,r,d)}function u(d){Bt.call(this,r,d)}return r.$$set=d=>{"shape"in d&&t(0,s=d.shape),"computedStyle"in d&&t(1,i=d.computedStyle),"transform"in d&&t(2,o=d.transform),"viewportScale"in d&&t(3,a=d.viewportScale)},r.$$.update=()=>{r.$$.dirty&1&&t(4,n=s.geometry)},[s,i,o,a,n,l,c,h,u]}class ov extends je{constructor(e){super(),Ye(this,e,iv,sv,He,{shape:0,computedStyle:1,transform:2,viewportScale:3})}}const av="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;function lv(r){let e,t,n,s,i,o;return{c(){e=me("rect"),B(e,"class",t=Dn(`a9s-handle ${r[8].class||""}`.trim())+" svelte-1sgkh33"),B(e,"x",n=r[0]-r[5]/2),B(e,"y",s=r[1]-r[5]/2),B(e,"width",r[5]),B(e,"height",r[5])},m(a,l){Q(a,e,l),i||(o=ke(e,"pointerdown",r[11]),i=!0)},p(a,l){l&256&&t!==(t=Dn(`a9s-handle ${a[8].class||""}`.trim())+" svelte-1sgkh33")&&B(e,"class",t),l&33&&n!==(n=a[0]-a[5]/2)&&B(e,"x",n),l&34&&s!==(s=a[1]-a[5]/2)&&B(e,"y",s),l&32&&B(e,"width",a[5]),l&32&&B(e,"height",a[5])},d(a){a&&Z(e),i=!1,o()}}}function cv(r){let e,t,n,s,i,o,a,l,c;return{c(){e=me("g"),t=me("circle"),s=me("rect"),B(t,"cx",r[0]),B(t,"cy",r[1]),B(t,"r",n=r[3]/r[2]),B(t,"class","a9s-touch-halo svelte-1sgkh33"),Ln(t,"touched",r[4]),B(s,"class",i=Dn(`a9s-handle ${r[8].class||""}`.trim())+" svelte-1sgkh33"),B(s,"x",o=r[0]-r[5]/2),B(s,"y",a=r[1]-r[5]/2),B(s,"width",r[5]),B(s,"height",r[5]),B(e,"class","a9s-touch-handle")},m(h,u){Q(h,e,u),Ct(e,t),Ct(e,s),l||(c=[ke(t,"pointerdown",r[10]),ke(t,"pointerdown",r[6]),ke(t,"pointerup",r[7]),ke(s,"pointerdown",r[9]),ke(s,"pointerdown",r[6]),ke(s,"pointerup",r[7])],l=!0)},p(h,u){u&1&&B(t,"cx",h[0]),u&2&&B(t,"cy",h[1]),u&12&&n!==(n=h[3]/h[2])&&B(t,"r",n),u&16&&Ln(t,"touched",h[4]),u&256&&i!==(i=Dn(`a9s-handle ${h[8].class||""}`.trim())+" svelte-1sgkh33")&&B(s,"class",i),u&33&&o!==(o=h[0]-h[5]/2)&&B(s,"x",o),u&34&&a!==(a=h[1]-h[5]/2)&&B(s,"y",a),u&32&&B(s,"width",h[5]),u&32&&B(s,"height",h[5])},d(h){h&&Z(e),l=!1,Mt(c)}}}function hv(r){let e;function t(i,o){return av?cv:lv}let s=t()(r);return{c(){s.c(),e=$t()},m(i,o){s.m(i,o),Q(i,e,o)},p(i,[o]){s.p(i,o)},i:St,o:St,d(i){i&&Z(e),s.d(i)}}}function uv(r,e,t){let n,{x:s}=e,{y:i}=e,{scale:o}=e,{radius:a=30}=e,l=!1;const c=p=>{p.pointerType==="touch"&&t(4,l=!0)},h=()=>t(4,l=!1);function u(p){Bt.call(this,r,p)}function d(p){Bt.call(this,r,p)}function f(p){Bt.call(this,r,p)}return r.$$set=p=>{t(8,e=Ws(Ws({},e),il(p))),"x"in p&&t(0,s=p.x),"y"in p&&t(1,i=p.y),"scale"in p&&t(2,o=p.scale),"radius"in p&&t(3,a=p.radius)},r.$$.update=()=>{r.$$.dirty&4&&t(5,n=10/o)},e=il(e),[s,i,o,a,l,n,c,h,e,u,d,f]}class Tn extends je{constructor(e){super(),Ye(this,e,uv,hv,He,{x:0,y:1,scale:2,radius:3})}}function dv(r){let e,t,n,s,i,o,a,l,c,h,u,d,f,p,g,m,_,b,y,x,S,k,P,T,E,v,R,I,C,A,F,D,V,K,N,U,we,H,pe,de,L,et,Kt;return K=new Tn({props:{class:"a9s-corner-handle-topleft",x:r[4].x,y:r[4].y,scale:r[3]}}),K.$on("pointerdown",function(){De(r[9]("TOP_LEFT"))&&r[9]("TOP_LEFT").apply(this,arguments)}),U=new Tn({props:{class:"a9s-corner-handle-topright",x:r[4].x+r[4].w,y:r[4].y,scale:r[3]}}),U.$on("pointerdown",function(){De(r[9]("TOP_RIGHT"))&&r[9]("TOP_RIGHT").apply(this,arguments)}),H=new Tn({props:{class:"a9s-corner-handle-bottomright",x:r[4].x+r[4].w,y:r[4].y+r[4].h,scale:r[3]}}),H.$on("pointerdown",function(){De(r[9]("BOTTOM_RIGHT"))&&r[9]("BOTTOM_RIGHT").apply(this,arguments)}),de=new Tn({props:{class:"a9s-corner-handle-bottomleft",x:r[4].x,y:r[4].y+r[4].h,scale:r[3]}}),de.$on("pointerdown",function(){De(r[9]("BOTTOM_LEFT"))&&r[9]("BOTTOM_LEFT").apply(this,arguments)}),{c(){e=me("rect"),a=dt(),l=me("rect"),f=dt(),p=me("rect"),b=dt(),y=me("rect"),P=dt(),T=me("rect"),I=dt(),C=me("rect"),V=dt(),ze(K.$$.fragment),N=dt(),ze(U.$$.fragment),we=dt(),ze(H.$$.fragment),pe=dt(),ze(de.$$.fragment),B(e,"class","a9s-outer"),B(e,"style",t=r[1]?"display:none;":void 0),B(e,"x",n=r[4].x),B(e,"y",s=r[4].y),B(e,"width",i=r[4].w),B(e,"height",o=r[4].h),B(l,"class","a9s-inner a9s-shape-handle"),B(l,"style",r[1]),B(l,"x",c=r[4].x),B(l,"y",h=r[4].y),B(l,"width",u=r[4].w),B(l,"height",d=r[4].h),B(p,"class","a9s-edge-handle a9s-edge-handle-top"),B(p,"x",g=r[4].x),B(p,"y",m=r[4].y),B(p,"height",1),B(p,"width",_=r[4].w),B(y,"class","a9s-edge-handle a9s-edge-handle-right"),B(y,"x",x=r[4].x+r[4].w),B(y,"y",S=r[4].y),B(y,"height",k=r[4].h),B(y,"width",1),B(T,"class","a9s-edge-handle a9s-edge-handle-bottom"),B(T,"x",E=r[4].x),B(T,"y",v=r[4].y+r[4].h),B(T,"height",1),B(T,"width",R=r[4].w),B(C,"class","a9s-edge-handle a9s-edge-handle-left"),B(C,"x",A=r[4].x),B(C,"y",F=r[4].y),B(C,"height",D=r[4].h),B(C,"width",1)},m(O,G){Q(O,e,G),Q(O,a,G),Q(O,l,G),Q(O,f,G),Q(O,p,G),Q(O,b,G),Q(O,y,G),Q(O,P,G),Q(O,T,G),Q(O,I,G),Q(O,C,G),Q(O,V,G),Le(K,O,G),Q(O,N,G),Le(U,O,G),Q(O,we,G),Le(H,O,G),Q(O,pe,G),Le(de,O,G),L=!0,et||(Kt=[ke(e,"pointerdown",function(){De(r[9]("SHAPE"))&&r[9]("SHAPE").apply(this,arguments)}),ke(l,"pointerdown",function(){De(r[9]("SHAPE"))&&r[9]("SHAPE").apply(this,arguments)}),ke(p,"pointerdown",function(){De(r[9]("TOP"))&&r[9]("TOP").apply(this,arguments)}),ke(y,"pointerdown",function(){De(r[9]("RIGHT"))&&r[9]("RIGHT").apply(this,arguments)}),ke(T,"pointerdown",function(){De(r[9]("BOTTOM"))&&r[9]("BOTTOM").apply(this,arguments)}),ke(C,"pointerdown",function(){De(r[9]("LEFT"))&&r[9]("LEFT").apply(this,arguments)})],et=!0)},p(O,G){r=O,(!L||G&2&&t!==(t=r[1]?"display:none;":void 0))&&B(e,"style",t),(!L||G&16&&n!==(n=r[4].x))&&B(e,"x",n),(!L||G&16&&s!==(s=r[4].y))&&B(e,"y",s),(!L||G&16&&i!==(i=r[4].w))&&B(e,"width",i),(!L||G&16&&o!==(o=r[4].h))&&B(e,"height",o),(!L||G&2)&&B(l,"style",r[1]),(!L||G&16&&c!==(c=r[4].x))&&B(l,"x",c),(!L||G&16&&h!==(h=r[4].y))&&B(l,"y",h),(!L||G&16&&u!==(u=r[4].w))&&B(l,"width",u),(!L||G&16&&d!==(d=r[4].h))&&B(l,"height",d),(!L||G&16&&g!==(g=r[4].x))&&B(p,"x",g),(!L||G&16&&m!==(m=r[4].y))&&B(p,"y",m),(!L||G&16&&_!==(_=r[4].w))&&B(p,"width",_),(!L||G&16&&x!==(x=r[4].x+r[4].w))&&B(y,"x",x),(!L||G&16&&S!==(S=r[4].y))&&B(y,"y",S),(!L||G&16&&k!==(k=r[4].h))&&B(y,"height",k),(!L||G&16&&E!==(E=r[4].x))&&B(T,"x",E),(!L||G&16&&v!==(v=r[4].y+r[4].h))&&B(T,"y",v),(!L||G&16&&R!==(R=r[4].w))&&B(T,"width",R),(!L||G&16&&A!==(A=r[4].x))&&B(C,"x",A),(!L||G&16&&F!==(F=r[4].y))&&B(C,"y",F),(!L||G&16&&D!==(D=r[4].h))&&B(C,"height",D);const ct={};G&16&&(ct.x=r[4].x),G&16&&(ct.y=r[4].y),G&8&&(ct.scale=r[3]),K.$set(ct);const ht={};G&16&&(ht.x=r[4].x+r[4].w),G&16&&(ht.y=r[4].y),G&8&&(ht.scale=r[3]),U.$set(ht);const $e={};G&16&&($e.x=r[4].x+r[4].w),G&16&&($e.y=r[4].y+r[4].h),G&8&&($e.scale=r[3]),H.$set($e);const We={};G&16&&(We.x=r[4].x),G&16&&(We.y=r[4].y+r[4].h),G&8&&(We.scale=r[3]),de.$set(We)},i(O){L||(j(K.$$.fragment,O),j(U.$$.fragment,O),j(H.$$.fragment,O),j(de.$$.fragment,O),L=!0)},o(O){J(K.$$.fragment,O),J(U.$$.fragment,O),J(H.$$.fragment,O),J(de.$$.fragment,O),L=!1},d(O){O&&(Z(e),Z(a),Z(l),Z(f),Z(p),Z(b),Z(y),Z(P),Z(T),Z(I),Z(C),Z(V),Z(N),Z(we),Z(pe)),Ne(K,O),Ne(U,O),Ne(H,O),Ne(de,O),et=!1,Mt(Kt)}}}function fv(r){let e,t;return e=new bd({props:{shape:r[0],transform:r[2],editor:r[5],$$slots:{default:[dv,({grab:n})=>({9:n}),({grab:n})=>n?512:0]},$$scope:{ctx:r}}}),e.$on("grab",r[6]),e.$on("change",r[7]),e.$on("release",r[8]),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,[s]){const i={};s&1&&(i.shape=n[0]),s&4&&(i.transform=n[2]),s&1562&&(i.$$scope={dirty:s,ctx:n}),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}function pv(r,e,t){let n,{shape:s}=e,{computedStyle:i}=e,{transform:o}=e,{viewportScale:a=1}=e;const l=(d,f,p)=>{const g=d.geometry.bounds;let[m,_]=[g.minX,g.minY],[b,y]=[g.maxX,g.maxY];const[x,S]=p;if(f==="SHAPE")m+=x,b+=x,_+=S,y+=S;else{switch(f){case"TOP":case"TOP_LEFT":case"TOP_RIGHT":{_+=S;break}case"BOTTOM":case"BOTTOM_LEFT":case"BOTTOM_RIGHT":{y+=S;break}}switch(f){case"LEFT":case"TOP_LEFT":case"BOTTOM_LEFT":{m+=x;break}case"RIGHT":case"TOP_RIGHT":case"BOTTOM_RIGHT":{b+=x;break}}}const k=Math.min(m,b),P=Math.min(_,y),T=Math.abs(b-m),E=Math.abs(y-_);return{...d,geometry:{x:k,y:P,w:T,h:E,bounds:{minX:k,minY:P,maxX:k+T,maxY:P+E}}}};function c(d){Bt.call(this,r,d)}function h(d){Bt.call(this,r,d)}function u(d){Bt.call(this,r,d)}return r.$$set=d=>{"shape"in d&&t(0,s=d.shape),"computedStyle"in d&&t(1,i=d.computedStyle),"transform"in d&&t(2,o=d.transform),"viewportScale"in d&&t(3,a=d.viewportScale)},r.$$.update=()=>{r.$$.dirty&1&&t(4,n=s.geometry)},[s,i,o,a,n,l,c,h,u]}class mv extends je{constructor(e){super(),Ye(this,e,pv,fv,He,{shape:0,computedStyle:1,transform:2,viewportScale:3})}}zr.RECTANGLE,zr.POLYGON;const gv=r=>({}),yd=r=>({grab:r[0]});function _v(r){let e,t,n,s;const i=r[7].default,o=el(i,r,r[6],yd);return{c(){e=me("g"),o&&o.c(),B(e,"class","a9s-annotation selected")},m(a,l){Q(a,e,l),o&&o.m(e,null),t=!0,n||(s=[ke(e,"pointerup",r[2]),ke(e,"pointermove",r[1])],n=!0)},p(a,[l]){o&&o.p&&(!t||l&64)&&nl(o,i,a,a[6],t?rl(i,a[6],l,gv):sl(a[6]),yd)},i(a){t||(j(o,a),t=!0)},o(a){J(o,a),t=!1},d(a){a&&Z(e),o&&o.d(a),n=!1,Mt(s)}}}function yv(r,e,t){let{$$slots:n={},$$scope:s}=e;const i=Hn();let{shape:o}=e,{editor:a}=e,{transform:l}=e,c,h,u;const d=g=>m=>{c=g,h=l.elementToImage(m.offsetX,m.offsetY),u=o,m.target.setPointerCapture(m.pointerId),i("grab",m)},f=g=>{if(c){const[m,_]=l.elementToImage(g.offsetX,g.offsetY),b=[m-h[0],_-h[1]];t(3,o=a(u,c,b)),i("change",o)}},p=g=>{g.target.releasePointerCapture(g.pointerId),c=void 0,u=o,i("release",g)};return r.$$set=g=>{"shape"in g&&t(3,o=g.shape),"editor"in g&&t(4,a=g.editor),"transform"in g&&t(5,l=g.transform),"$$scope"in g&&t(6,s=g.$$scope)},[d,f,p,o,a,l,s,n]}class bd extends je{constructor(e){super(),Ye(this,e,yv,_v,He,{shape:3,editor:4,transform:5})}}const bv=(r,e)=>{const t=typeof e=="function"?e(r):e;if(t){const{fill:n,fillOpacity:s}=t;let i="";return n&&(i+=`fill:${n};stroke:${n};`),i+=`fill-opacity:${s||"0.25"};`,i}};function xv(r,e,t){let n;const s=Hn();let{annotation:i}=e,{editor:o}=e,{style:a}=e,{target:l}=e,{transform:c}=e,{viewportScale:h}=e,u;return Nn(()=>(t(6,u=new o({target:l,props:{shape:i.target.selector,computedStyle:n,transform:c,viewportScale:h}})),u.$on("change",d=>{u.$$set({shape:d.detail}),s("change",d.detail)}),u.$on("grab",d=>s("grab",d.detail)),u.$on("release",d=>s("release",d.detail)),()=>{u.$destroy()})),r.$$set=d=>{"annotation"in d&&t(0,i=d.annotation),"editor"in d&&t(1,o=d.editor),"style"in d&&t(2,a=d.style),"target"in d&&t(3,l=d.target),"transform"in d&&t(4,c=d.transform),"viewportScale"in d&&t(5,h=d.viewportScale)},r.$$.update=()=>{r.$$.dirty&5&&(n=bv(i,a)),r.$$.dirty&65&&i&&(u==null||u.$set({shape:i.target.selector})),r.$$.dirty&80&&u&&u.$set({transform:c}),r.$$.dirty&96&&u&&u.$set({viewportScale:h})},[i,o,a,l,c,h,u]}class vv extends je{constructor(e){super(),Ye(this,e,xv,null,He,{annotation:0,editor:1,style:2,target:3,transform:4,viewportScale:5})}}navigator.userAgent.indexOf("Mac OS X");const wv=r=>({transform:r&2,scale:r&1}),xd=r=>({transform:r[1],scale:r[0]});function Sv(r){let e;const t=r[4].default,n=el(t,r,r[3],xd);return{c(){n&&n.c()},m(s,i){n&&n.m(s,i),e=!0},p(s,[i]){n&&n.p&&(!e||i&11)&&nl(n,t,s,s[3],e?rl(t,s[3],i,wv):sl(s[3]),xd)},i(s){e||(j(n,s),e=!0)},o(s){J(n,s),e=!1},d(s){n&&n.d(s)}}}function Tv(r,e,t){let{$$slots:n={},$$scope:s}=e,{viewer:i}=e,o=1,a;const l=()=>{const c=i.viewport.getContainerSize().x,h=i.viewport.getZoom(!0),u=i.viewport.getFlip(),d=i.viewport.pixelFromPoint(new Fe.Point(0,0),!0);u&&(d.x=c-d.x);const f=h*c/i.world.getContentFactor(),p=u?-f:f,g=i.viewport.getRotation();t(1,a=`translate(${d.x}, ${d.y}) scale(${p}, ${f}) rotate(${g})`),t(0,o=h*c/i.world.getContentFactor())};return Nn(()=>(i.addHandler("update-viewport",l),()=>{i.removeHandler("update-viewport",l)})),r.$$set=c=>{"viewer"in c&&t(2,i=c.viewer),"$$scope"in c&&t(3,s=c.$$scope)},[o,a,i,s,n]}class vd extends je{constructor(e){super(),Ye(this,e,Tv,Sv,He,{viewer:2})}}function Ev(r,e,t){const n=Hn();let{drawingMode:s}=e,{target:i}=e,{tool:o}=e,{transform:a}=e,{viewer:l}=e,{viewportScale:c}=e,h;return Nn(()=>{const u=i.closest("svg"),d=[],f=(p,g,m)=>{if(u==null||u.addEventListener(p,g,m),d.push(()=>u==null?void 0:u.removeEventListener(p,g,m)),p==="pointerup"||p==="dblclick"){const _=y=>{const{originalEvent:x}=y;g(x)},b=p==="pointerup"?"canvas-click":"canvas-double-click";l.addHandler(b,_),d.push(()=>l.removeHandler(b,_))}else if(p==="pointermove"){const _=b=>{const{originalEvent:y}=b;g(y)};l.addHandler("canvas-drag",_),d.push(()=>l.removeHandler("canvas-drag",_))}};return t(6,h=new o({target:i,props:{addEventListener:f,drawingMode:s,transform:a,viewportScale:c}})),h.$on("create",p=>n("create",p.detail)),()=>{d.forEach(p=>p()),h.$destroy()}}),r.$$set=u=>{"drawingMode"in u&&t(0,s=u.drawingMode),"target"in u&&t(1,i=u.target),"tool"in u&&t(2,o=u.tool),"transform"in u&&t(3,a=u.transform),"viewer"in u&&t(4,l=u.viewer),"viewportScale"in u&&t(5,c=u.viewportScale)},r.$$.update=()=>{r.$$.dirty&72&&h&&h.$set({transform:a}),r.$$.dirty&96&&h&&h.$set({viewportScale:c})},[s,i,o,a,l,c,h]}class Pv extends je{constructor(e){super(),Ye(this,e,Ev,null,He,{drawingMode:0,target:1,tool:2,transform:3,viewer:4,viewportScale:5})}}function wd(r,e,t){const n=r.slice();return n[29]=e[t],n}function Av(r){let e=r[2],t,n,s=Sd(r);return{c(){s.c(),t=$t()},m(i,o){s.m(i,o),Q(i,t,o),n=!0},p(i,o){o[0]&4&&He(e,e=i[2])?(Rt(),J(s,1,1,St),kt(),s=Sd(i),s.c(),j(s,1),s.m(t.parentNode,t)):s.p(i,o)},i(i){n||(j(s),n=!0)},o(i){J(s),n=!1},d(i){i&&Z(t),s.d(i)}}}function Mv(r){let e,t,n=Ar(r[6]),s=[];for(let o=0;o<n.length;o+=1)s[o]=Ed(wd(r,n,o));const i=o=>J(s[o],1,1,()=>{s[o]=null});return{c(){for(let o=0;o<s.length;o+=1)s[o].c();e=$t()},m(o,a){for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(o,a);Q(o,e,a),t=!0},p(o,a){if(a[0]&268459618){n=Ar(o[6]);let l;for(l=0;l<n.length;l+=1){const c=wd(o,n,l);s[l]?(s[l].p(c,a),j(s[l],1)):(s[l]=Ed(c),s[l].c(),j(s[l],1),s[l].m(e.parentNode,e))}for(Rt(),l=n.length;l<s.length;l+=1)i(l);kt()}},i(o){if(!t){for(let a=0;a<n.length;a+=1)j(s[a]);t=!0}},o(o){s=s.filter(Boolean);for(let a=0;a<s.length;a+=1)J(s[a]);t=!1},d(o){o&&Z(e),Xs(s,o)}}}function Sd(r){let e,t;return e=new Pv({props:{target:r[5],tool:r[7],drawingMode:r[4],transform:{elementToImage:r[9]},viewer:r[3],viewportScale:r[28]}}),e.$on("create",r[13]),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,s){const i={};s[0]&32&&(i.target=n[5]),s[0]&128&&(i.tool=n[7]),s[0]&16&&(i.drawingMode=n[4]),s[0]&8&&(i.viewer=n[3]),s[0]&268435456&&(i.viewportScale=n[28]),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}function Td(r){let e,t;return e=new vv({props:{target:r[5],editor:r[14](r[29].target.selector),annotation:r[29],style:r[1],transform:{elementToImage:r[9]},viewportScale:r[28]}}),e.$on("grab",r[10]),e.$on("change",function(){De(r[12](r[29]))&&r[12](r[29]).apply(this,arguments)}),e.$on("release",r[11]),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,s){r=n;const i={};s[0]&32&&(i.target=r[5]),s[0]&64&&(i.editor=r[14](r[29].target.selector)),s[0]&64&&(i.annotation=r[29]),s[0]&2&&(i.style=r[1]),s[0]&268435456&&(i.viewportScale=r[28]),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}function Ed(r){let e=r[29].id,t,n,s=Td(r);return{c(){s.c(),t=$t()},m(i,o){s.m(i,o),Q(i,t,o),n=!0},p(i,o){o[0]&64&&He(e,e=i[29].id)?(Rt(),J(s,1,1,St),kt(),s=Td(i),s.c(),j(s,1),s.m(t.parentNode,t)):s.p(i,o)},i(i){n||(j(s),n=!0)},o(i){J(s),n=!1},d(i){i&&Z(t),s.d(i)}}}function Cv(r){let e,t,n,s,i,o;const a=[Mv,Av],l=[];function c(h,u){return h[5]&&h[6]?0:h[5]&&h[7]&&h[0]?1:-1}return~(n=c(r))&&(s=l[n]=a[n](r)),{c(){e=me("svg"),t=me("g"),s&&s.c(),B(t,"transform",i=r[27]),B(t,"class","svelte-190cqdf"),B(e,"class","a9s-annotationlayer a9s-osd-drawinglayer svelte-190cqdf"),Ln(e,"drawing",r[0])},m(h,u){Q(h,e,u),Ct(e,t),~n&&l[n].m(t,null),r[21](t),o=!0},p(h,u){let d=n;n=c(h),n===d?~n&&l[n].p(h,u):(s&&(Rt(),J(l[d],1,1,()=>{l[d]=null}),kt()),~n?(s=l[n],s?s.p(h,u):(s=l[n]=a[n](h),s.c()),j(s,1),s.m(t,null)):s=null),(!o||u[0]&134217728&&i!==(i=h[27]))&&B(t,"transform",i),(!o||u[0]&1)&&Ln(e,"drawing",h[0])},i(h){o||(j(s),o=!0)},o(h){J(s),o=!1},d(h){h&&Z(e),~n&&l[n].d(),r[21](null)}}}function Bv(r){let e,t;return e=new vd({props:{viewer:r[3],$$slots:{default:[Cv,({transform:n,scale:s})=>({27:n,28:s}),({transform:n,scale:s})=>[(n?134217728:0)|(s?268435456:0)]]},$$scope:{ctx:r}}}),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,s){const i={};s[0]&8&&(i.viewer=n[3]),s[0]&402653439|s[1]&2&&(i.$$scope={dirty:s,ctx:n}),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}function Rv(r,e,t){let n,s,i,o,{drawingEnabled:a}=e,{filter:l}=e,{preferredDrawingMode:c}=e,{state:h}=e,{style:u=void 0}=e,{toolName:d=Gn()[0]}=e,{user:f}=e,{viewer:p}=e,g;const{store:m,selection:_,hover:b}=h;Vs(r,_,A=>t(20,o=A));let y,x,S;const k=A=>{m.unobserve(y);const F=A.filter(({editable:D})=>D).map(({id:D})=>D);F.length>0?(t(6,x=F.map(D=>m.getAnnotation(D))),y=D=>{const{updated:V}=D.changes;t(6,x=(V||[]).map(K=>K.newValue))},m.observe(y,{annotations:F})):t(6,x=void 0)},P=(A,F)=>{const{x:D,y:V}=p.viewport.viewerElementToImageCoordinates(new Fe.Point(A,F));return[D,V]},T=A=>{p.setMouseNavEnabled(!1),S=A.timeStamp},E=A=>{if(p.setMouseNavEnabled(!0),performance.now()-(S||0)<300){const{offsetX:D,offsetY:V}=A.detail,[K,N]=P(D,V),U=m.getAt(K,N);U&&(!l||l(U))&&!x.find(H=>H.id===U.id)&&(b.set(U.id),_.setSelected(U.id))}},v=A=>F=>{var N;const{target:D}=A,V=10*60*1e3,K=((N=D.creator)==null?void 0:N.id)!==f.id||!D.created||new Date().getTime()-D.created.getTime()>V;m.updateTarget({...D,selector:F.detail,created:K?D.created:new Date,updated:K?new Date:void 0,updatedBy:K?f:void 0})},R=A=>{const F=Q0(),D={id:F,bodies:[],target:{annotation:F,selector:A.detail,creator:f,created:new Date}};m.addAnnotation(D),_.setSelected(D.id),p.setMouseNavEnabled(!0)},I=A=>Pa(A);function C(A){zn[A?"unshift":"push"](()=>{g=A,t(5,g)})}return r.$$set=A=>{"drawingEnabled"in A&&t(0,a=A.drawingEnabled),"filter"in A&&t(15,l=A.filter),"preferredDrawingMode"in A&&t(16,c=A.preferredDrawingMode),"state"in A&&t(17,h=A.state),"style"in A&&t(1,u=A.style),"toolName"in A&&t(2,d=A.toolName),"user"in A&&t(18,f=A.user),"viewer"in A&&t(3,p=A.viewer)},r.$$.update=()=>{r.$$.dirty[0]&4&&t(7,{tool:n,opts:s}=Un(d)||{tool:void 0,opts:void 0},n,(t(19,s),t(2,d))),r.$$.dirty[0]&589824&&t(4,i=(s==null?void 0:s.drawingMode)||c),r.$$.dirty[0]&25&&(a&&i==="drag"?p.setMouseNavEnabled(!1):p.setMouseNavEnabled(!0)),r.$$.dirty[0]&1&&a&&_.clear(),r.$$.dirty[0]&1048601&&o.selected.length===0&&i==="drag"&&a&&p.setMouseNavEnabled(!1),r.$$.dirty[0]&1048576&&k(o.selected)},[a,u,d,p,i,g,x,n,_,P,T,E,v,R,I,l,c,h,f,s,o,C]}class kv extends je{constructor(e){super(),Ye(this,e,Rv,Bv,He,{drawingEnabled:0,filter:15,preferredDrawingMode:16,state:17,style:1,toolName:2,user:18,viewer:3},null,[-1,-1])}}function Iv(r){let e,t,n,s,i,o,a,l=r[2].appearance.label+"",c,h,u,d;return{c(){e=me("g"),t=me("rect"),a=me("text"),c=Ys(l),B(t,"class","a9s-presence-label-bg svelte-1rehw2p"),B(t,"x",r[0]),B(t,"y",n=r[1]-18/r[3]),B(t,"height",s=18/r[3]),B(t,"fill",i=r[2].appearance.color),B(t,"stroke",o=r[2].appearance.color),B(a,"font-size",h=12/r[3]),B(a,"x",u=r[0]+Math.round(5/r[3])),B(a,"y",d=r[1]-5/r[3]),B(a,"class","svelte-1rehw2p"),B(e,"class","a9s-presence-label")},m(f,p){Q(f,e,p),Ct(e,t),Ct(e,a),Ct(a,c),r[6](e)},p(f,[p]){p&1&&B(t,"x",f[0]),p&10&&n!==(n=f[1]-18/f[3])&&B(t,"y",n),p&8&&s!==(s=18/f[3])&&B(t,"height",s),p&4&&i!==(i=f[2].appearance.color)&&B(t,"fill",i),p&4&&o!==(o=f[2].appearance.color)&&B(t,"stroke",o),p&4&&l!==(l=f[2].appearance.label+"")&&Zm(c,l),p&8&&h!==(h=12/f[3])&&B(a,"font-size",h),p&9&&u!==(u=f[0]+Math.round(5/f[3]))&&B(a,"x",u),p&10&&d!==(d=f[1]-5/f[3])&&B(a,"y",d)},i:St,o:St,d(f){f&&Z(e),r[6](null)}}}function Gv(r,e,t){let{x:n}=e,{y:s}=e,{user:i}=e,{scale:o}=e,{hAlign:a=null}=e,l;const c=u=>{const d=l.querySelector("text"),f=l.querySelector("rect"),p=d.getBBox().width+10/u;a==="CENTER"&&l.setAttribute("style",`transform: translateX(-${p/2}px)`),f.setAttribute("width",`${p}`)};function h(u){zn[u?"unshift":"push"](()=>{l=u,t(4,l)})}return r.$$set=u=>{"x"in u&&t(0,n=u.x),"y"in u&&t(1,s=u.y),"user"in u&&t(2,i=u.user),"scale"in u&&t(3,o=u.scale),"hAlign"in u&&t(5,a=u.hAlign)},r.$$.update=()=>{r.$$.dirty&24&&l&&c(o)},[n,s,i,o,l,a,h]}class Pd extends je{constructor(e){super(),Ye(this,e,Gv,Iv,He,{x:0,y:1,user:2,scale:3,hAlign:5})}}function Uv(r){let e,t,n,s,i,o;return t=new Pd({props:{scale:r[1],user:r[0],x:r[3][0],y:r[3][1],hAlign:"CENTER"}}),{c(){e=me("g"),ze(t.$$.fragment),n=me("polygon"),B(n,"class","a9s-presence-shape a9s-presence-polygon svelte-fgq4n0"),B(n,"stroke",s=r[0].appearance.color),B(n,"fill","transparent"),B(n,"points",i=r[2].points.map(Ad).join(" ")),B(e,"class","a9s-presence-overlay")},m(a,l){Q(a,e,l),Le(t,e,null),Ct(e,n),o=!0},p(a,[l]){const c={};l&2&&(c.scale=a[1]),l&1&&(c.user=a[0]),l&8&&(c.x=a[3][0]),l&8&&(c.y=a[3][1]),t.$set(c),(!o||l&1&&s!==(s=a[0].appearance.color))&&B(n,"stroke",s),(!o||l&4&&i!==(i=a[2].points.map(Ad).join(" ")))&&B(n,"points",i)},i(a){o||(j(t.$$.fragment,a),o=!0)},o(a){J(t.$$.fragment,a),o=!1},d(a){a&&Z(e),Ne(t)}}}const Ad=r=>r.join(",");function Fv(r,e,t){let n,s,{annotation:i}=e,{user:o}=e,{scale:a}=e;const l=c=>{let[h,...u]=c.points;return u.forEach(([d,f])=>{f<h[1]&&(h=[d,f])}),h};return r.$$set=c=>{"annotation"in c&&t(4,i=c.annotation),"user"in c&&t(0,o=c.user),"scale"in c&&t(1,a=c.scale)},r.$$.update=()=>{r.$$.dirty&16&&t(2,n=i.target.selector.geometry),r.$$.dirty&4&&t(3,s=l(n))},[o,a,n,s,i]}class Ov extends je{constructor(e){super(),Ye(this,e,Fv,Uv,He,{annotation:4,user:0,scale:1})}}function Dv(r){let e,t,n,s,i,o,a,l,c;return t=new Pd({props:{scale:r[1],user:r[0],x:r[2].x,y:r[2].y}}),{c(){e=me("g"),ze(t.$$.fragment),n=me("rect"),B(n,"class","a9s-presence-shape a9s-presence-rectangle svelte-gze948"),B(n,"stroke",s=r[0].appearance.color),B(n,"fill","transparent"),B(n,"x",i=r[2].x),B(n,"y",o=r[2].y),B(n,"width",a=r[2].w),B(n,"height",l=r[2].h),B(e,"class","a9s-presence-overlay")},m(h,u){Q(h,e,u),Le(t,e,null),Ct(e,n),c=!0},p(h,[u]){const d={};u&2&&(d.scale=h[1]),u&1&&(d.user=h[0]),u&4&&(d.x=h[2].x),u&4&&(d.y=h[2].y),t.$set(d),(!c||u&1&&s!==(s=h[0].appearance.color))&&B(n,"stroke",s),(!c||u&4&&i!==(i=h[2].x))&&B(n,"x",i),(!c||u&4&&o!==(o=h[2].y))&&B(n,"y",o),(!c||u&4&&a!==(a=h[2].w))&&B(n,"width",a),(!c||u&4&&l!==(l=h[2].h))&&B(n,"height",l)},i(h){c||(j(t.$$.fragment,h),c=!0)},o(h){J(t.$$.fragment,h),c=!1},d(h){h&&Z(e),Ne(t)}}}function Lv(r,e,t){let n,{annotation:s}=e,{user:i}=e,{scale:o}=e;return r.$$set=a=>{"annotation"in a&&t(3,s=a.annotation),"user"in a&&t(0,i=a.user),"scale"in a&&t(1,o=a.scale)},r.$$.update=()=>{r.$$.dirty&8&&t(2,n=s.target.selector.geometry)},[i,o,n,s]}class Nv extends je{constructor(e){super(),Ye(this,e,Lv,Dv,He,{annotation:3,user:0,scale:1})}}const{Boolean:Hv}=qm;function Md(r,e,t){const n=r.slice();return n[8]=e[t],n}function Cd(r){let e,t;return e=new vd({props:{viewer:r[0],$$slots:{default:[Wv,({transform:n,scale:s})=>({6:n,7:s}),({transform:n,scale:s})=>(n?64:0)|(s?128:0)]},$$scope:{ctx:r}}}),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,s){const i={};s&1&&(i.viewer=n[0]),s&2244&&(i.$$scope={dirty:s,ctx:n}),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}function Bd(r){let e,t,n=Ar(r[2]),s=[];for(let o=0;o<n.length;o+=1)s[o]=Rd(Md(r,n,o));const i=o=>J(s[o],1,1,()=>{s[o]=null});return{c(){for(let o=0;o<s.length;o+=1)s[o].c();e=$t()},m(o,a){for(let l=0;l<s.length;l+=1)s[l]&&s[l].m(o,a);Q(o,e,a),t=!0},p(o,a){if(a&132){n=Ar(o[2]);let l;for(l=0;l<n.length;l+=1){const c=Md(o,n,l);s[l]?(s[l].p(c,a),j(s[l],1)):(s[l]=Rd(c),s[l].c(),j(s[l],1),s[l].m(e.parentNode,e))}for(Rt(),l=n.length;l<s.length;l+=1)i(l);kt()}},i(o){if(!t){for(let a=0;a<n.length;a+=1)j(s[a]);t=!0}},o(o){s=s.filter(Hv);for(let a=0;a<s.length;a+=1)J(s[a]);t=!1},d(o){o&&Z(e),Xs(s,o)}}}function zv(r){let e,t;return e=new Ov({props:{annotation:r[8].annotation,user:r[8].selectedBy,scale:r[7]}}),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,s){const i={};s&4&&(i.annotation=n[8].annotation),s&4&&(i.user=n[8].selectedBy),s&128&&(i.scale=n[7]),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}function $v(r){let e,t;return e=new Nv({props:{annotation:r[8].annotation,user:r[8].selectedBy,scale:r[7]}}),{c(){ze(e.$$.fragment)},m(n,s){Le(e,n,s),t=!0},p(n,s){const i={};s&4&&(i.annotation=n[8].annotation),s&4&&(i.user=n[8].selectedBy),s&128&&(i.scale=n[7]),e.$set(i)},i(n){t||(j(e.$$.fragment,n),t=!0)},o(n){J(e.$$.fragment,n),t=!1},d(n){Ne(e,n)}}}function Rd(r){let e,t,n,s;const i=[$v,zv],o=[];function a(l,c){return l[8].annotation.target.selector.type===fe.RECTANGLE?0:l[8].annotation.target.selector.type===fe.POLYGON?1:-1}return~(e=a(r))&&(t=o[e]=i[e](r)),{c(){t&&t.c(),n=$t()},m(l,c){~e&&o[e].m(l,c),Q(l,n,c),s=!0},p(l,c){let h=e;e=a(l),e===h?~e&&o[e].p(l,c):(t&&(Rt(),J(o[h],1,1,()=>{o[h]=null}),kt()),~e?(t=o[e],t?t.p(l,c):(t=o[e]=i[e](l),t.c()),j(t,1),t.m(n.parentNode,n)):t=null)},i(l){s||(j(t),s=!0)},o(l){J(t),s=!1},d(l){l&&Z(n),~e&&o[e].d(l)}}}function Wv(r){let e,t,n,s,i=r[2].length>0&&Bd(r);return{c(){e=me("svg"),t=me("g"),i&&i.c(),B(t,"transform",n=r[6]),B(e,"class","a9s-osd-presencelayer svelte-1krwc4m")},m(o,a){Q(o,e,a),Ct(e,t),i&&i.m(t,null),s=!0},p(o,a){o[2].length>0?i?(i.p(o,a),a&4&&j(i,1)):(i=Bd(o),i.c(),j(i,1),i.m(t,null)):i&&(Rt(),J(i,1,1,()=>{i=null}),kt()),(!s||a&64&&n!==(n=o[6]))&&B(t,"transform",n)},i(o){s||(j(i),s=!0)},o(o){J(i),s=!1},d(o){o&&Z(e),i&&i.d()}}}function Vv(r){let e=!!r[1],t,n,s=e&&Cd(r);return{c(){s&&s.c(),t=$t()},m(i,o){s&&s.m(i,o),Q(i,t,o),n=!0},p(i,[o]){o&2&&(e=!!i[1]),e?s?(s.p(i,o),o&2&&j(s,1)):(s=Cd(i),s.c(),j(s,1),s.m(t.parentNode,t)):s&&(Rt(),J(s,1,1,()=>{s=null}),kt())},i(i){n||(j(s),n=!0)},o(i){J(s),n=!1},d(i){i&&Z(t),s&&s.d(i)}}}function Xv(r,e,t){let{store:n}=e,{viewer:s}=e,{provider:i}=e,o=[],a;const l=(c,h)=>{t(2,o=[...o.filter(({selectedBy:u})=>u.presenceKey!==c.presenceKey),...(h||[]).map(u=>({annotation:n.getAnnotation(u),selectedBy:c}))].filter(({annotation:u})=>(u||console.warn("Selection event on unknown annotation"),!!u))),a&&n.unobserve(a),a=u=>{const{deleted:d,updated:f}=u.changes,p=new Set((d||[]).map(m=>m.id)),g=o.filter(({annotation:m})=>!p.has(m.id)).map(m=>{const _=(f||[]).find(b=>b.oldValue.id===m.annotation.id);return _?{selectedBy:m.selectedBy,annotation:_.newValue}:m});t(2,o=g)},n.observe(a,{annotations:o.map(u=>u.annotation.id)})};return Jm(()=>{a&&n.unobserve(a)}),r.$$set=c=>{"store"in c&&t(3,n=c.store),"viewer"in c&&t(0,s=c.viewer),"provider"in c&&t(1,i=c.provider)},r.$$.update=()=>{r.$$.dirty&2&&i&&i.on("selectionChange",l)},[s,i,o,n]}class Yv extends je{constructor(e){super(),Ye(this,e,Xv,Vv,He,{store:3,viewer:0,provider:1})}}const kd=(r,e)=>{e==="auto"?r.addHandler("open",t=>{const n=r.world.getItemCount();r.world.getItemAt(n-1).addOnceHandler("fully-loaded-change",i=>{const{fullyLoaded:o}=i;if(o){const a=r.canvas.querySelector("canvas"),l=Ya(a);r.element.setAttribute("data-theme",l)}})}):r.element.setAttribute("data-theme",e)},Id=(r,e,t)=>(n,s={})=>{const i=typeof n=="string"?n:n.id,o=e.getAnnotation(i);if(!o)return;const a=r.container.getBoundingClientRect(),{padding:l}=s;let[c,h,u,d]=l?Array.isArray(l)?l:[l,l,l,l]:[0,0,0,0];c=c/a.height,h=h/a.width,u=u/a.height,d=d/a.width;const{minX:f,minY:p,maxX:g,maxY:m}=o.target.selector.geometry.bounds,_=g-f,b=m-p,y=f-d*_,x=p-c*b,S=_+(h+d)*_,k=b+(c+u)*b,P=r.viewport.imageToViewportRectangle(y,x,S,k);r.viewport[t](P,s.immediately)},jv=(r,e)=>Id(r,e,"fitBounds"),qv=(r,e)=>Id(r,e,"fitBoundsWithConstraints"),Kv=(r,e={})=>{const t=qa(e,{drawingEnabled:!1,drawingMode:Ta?"drag":"click",pointerSelectAction:Ps.EDIT,theme:"light"}),n=Xa(t),{hover:s,selection:i,store:o}=n,a=ff(o),l=pf(n,a,t.adapter,t.autoSave);let c=wf(),h=t.drawingEnabled,u=t.drawingMode;const d=Za(a,r.element),f=new j0({target:r.element,props:{state:n,viewer:r,style:t.style,filter:void 0}}),p=new Yv({target:r.element.querySelector(".openseadragon-canvas"),props:{provider:void 0,store:o,viewer:r}}),g=new kv({target:r.element.querySelector(".openseadragon-canvas"),props:{drawingEnabled:!!h,filter:void 0,preferredDrawingMode:u,state:n,style:t.style,user:c,viewer:r}});f.$on("click",F=>{const{originalEvent:D,annotation:V}=F.detail;V&&!(u==="click"&&h)?i.clickSelect(V.id,D):i.isEmpty()||i.clear()}),r.element.addEventListener("pointerdown",F=>{if(s.current){const D=o.getAnnotation(s.current);l.emit("clickAnnotation",D,F)}}),kd(r,t.theme);const m=gf(n,a,t.adapter),_=()=>{f.$destroy(),p.$destroy(),g.$destroy(),d.destroy(),a.destroy()},b=jv(r,o),y=qv(r,o),x=()=>c,S=(F,D,V)=>Ia(F,D,V),k=(F,D)=>Aa(F,D),P=F=>{if(!Un(F))throw`No drawing tool named ${F}`;g.$set({toolName:F})},T=F=>{h=F,g.$set({drawingEnabled:h})},E=F=>{f.$set({filter:F}),g.$set({filter:F})},v=F=>{f.$set({style:F}),g.$set({style:F})},R=F=>p.$set({provider:F}),I=F=>kd(r,F),C=F=>{c=F,g.$set({user:F})},A=F=>f.$set({visible:F});return{...m,destroy:_,fitBounds:b,fitBoundsWithConstraints:y,getUser:x,listDrawingTools:Gn,on:l.on,off:l.off,registerDrawingTool:S,registerShapeEditor:k,setDrawingEnabled:T,setDrawingTool:P,setFilter:E,setPresenceProvider:R,setStyle:v,setTheme:I,setUser:C,setVisible:A,state:n,viewer:r}},Zv=Tf,Qv=Ps,Jv=nf,e1=Xm,t1=fe,r1=Ip;re.add(hc),Se.mixin(c_),re.add(Tc),re.add(Ec),re.add(jc),Se.mixin(Yy),re.add(ju),re.add(Ji),re.add(Ku),re.add(ud),re.add(ld),re.add(nd,T0,S0),re.add(zo),re.add(id),re.add(Ju),re.add(Qu),re.add(Zc),re.add(qc);const n1=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"})),s1=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));Te.PointerSelectAction=Qv,Te.ShapeType=t1,Te.W3CImageFormat=r1,Te.createBody=Jv,Te.createImageAnnotator=e1,Te.createOSDAnnotator=Kv,Te.defaultColorProvider=Zv,Object.defineProperty(Te,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious-openseadragon.js.map
